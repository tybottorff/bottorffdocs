---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: pdf_document
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install necessary packages

```{r}

#remotes::install_github("mojaveazure/seurat-disk")

```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

melanoma_T_cells_filtered <- readRDS("../saved_data/batch_a_filtered.rds")

```

# Split data by sample before integrating by finding anchors

```{r}

# split the dataset into a list of 13 seurat objects (for each patient sample)
melanoma_T_cells_filtered.list <- SplitObject(melanoma_T_cells_filtered, split.by = "patient.ID")

# normalize and identify variable features for each dataset independently
melanoma_T_cells_filtered.list <- lapply(X = melanoma_T_cells_filtered.list, FUN = function(x) {
    x <- SCTransform(x, variable.features.n = 2000)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = melanoma_T_cells_filtered.list)

# prep step
melanoma_T_cells_filtered.list <- PrepSCTIntegration(
  melanoma_T_cells_filtered.list,
  anchor.features = features
)

```

# Integrate via anchors

```{r}

immune.anchors <- FindIntegrationAnchors(object.list = melanoma_T_cells_filtered.list, normalization.method = "SCT", anchor.features = features)

# this command creates an 'integrated' data assay
immune.combined <- IntegrateData(anchorset = immune.anchors, normalization.method = "SCT")

```

# Specify integration

```{r}

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

```

# PCA using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)

```

# UMAP using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)

```

# Find clusters

```{r}

immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 3)

# resolution parameter of 3

```

# Visualize UMAP by patient ID

```{r}

DimPlot(immune.combined, reduction = "umap", group.by = "patient.ID", shuffle = TRUE, seed = 992)

ggsave("../figures/umap_patient_id.svg")

```

# Visualize UMAP by cluster

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)

ggsave("../figures/umap_cluster.svg")

```

# Find cluster biomarkers

```{r}

# find markers for every cluster compared to all remaining cells
immune.markers <- FindAllMarkers(immune.combined)

```

# Look at relevant cluster biomarkers

```{r}

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY", "IL7R", "CD14", "FCGR3A", "FCER1A", "MS4A1", "HBB", "PPBP", "CD36")) %>%
  arrange(gene)

```

# Plot marker distribution across clusters to identify CD8 T cells

```{r}

# CD3D/CD3Ehi and CD8A/CD8Bhi and NKG7/GNLYlo = CD8 T cells

#3D: 0, 3, 5, 11-12, 14-15, 17, 20-21
#3E: 0, 3, 5, 11-12, 14-15, 17, 19-21
#8B: 0, 3, 5, 11-12, 14-15, 17, 20-21
#NKG7: 3, 10, 14, 16, 17, 19
#GNLY: 3, 10, 14, 16, 17, 19

# potentials: 15

VlnPlot(immune.combined, features = c("GNLY"), pt.size = 0)

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify CD4 T cells

```{r}

VlnPlot(immune.combined, features = c("IL7R", "CD8B"), pt.size = 0)
# CD3D/CD3Ehi non-CD8 T cells with high IL7R expression and low NKG7/GNLY = CD4 T cells

#3D: 0, 3, 5, 11-12, 14-15, 17, 20-21
#3E: 0, 3, 5, 11-12, 14-15, 17, 19-21
#8B: 0, 3, 5, 11-12, 14-15, 17, 20-21
#NKG7: 3, 10, 14, 16, 17, 19
#GNLY: 3, 10, 14, 16, 17, 19

#IL7R: 0, 5, 11-12, 14-15, 17, 20-21

# potentials: 0, 5, 11-12, 20-21

```

# Plot marker distribution across clusters to identify NK cells

```{r}

# NKG7/GNLYhi and CD3D/CD3Elo = NK cells

#3D: 0, 3, 5, 11-12, 14-15, 17, 20-21
#3E: 0, 3, 5, 11-12, 14-15, 17, 19-21
#8B: 0, 3, 5, 11-12, 14-15, 17, 20-21
#NKG7: 3, 10, 14, 16, 17, 19
#GNLY: 3, 10, 14, 16, 17, 19

# potentials: 10, 16

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "NKG7", "GNLY")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify DCs

```{r}

#VlnPlot(immune.combined, features = c("FCER1A"), pt.size = 0)
# FCER1Ahi = dendritic cells (DCs)

#immune.markers %>%
#  group_by(cluster) %>%
#  filter(gene %in% c("FCER1A")) %>%
#  arrange(cluster)

```

# Plot marker distribution across clusters to identify B cells

```{r}

VlnPlot(immune.combined, features = c("MS4A1"), pt.size = 0)
# MS4A1hi = B cells

# potentials: 2, 8, 13, 23, 24

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("MS4A1")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify monocytes

```{r}

VlnPlot(immune.combined, features = c("FCGR3A", "CD14"), pt.size = 0)
# CD14 or FCGR3Ahi = monocytes

# CD14hi = 4, 6-7, 9, 18, 23
# FCGR3Ahi = 1

# potentials: 1, 4, 6-7, 9, 18, 23

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("FCGR3A", "CD14")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify RBCs and platelets

```{r}

#VlnPlot(immune.combined, features = c("HBB"), pt.size = 0)
# HBBhi = red blood cells

#immune.markers %>%
#  group_by(cluster) %>%
#  filter(gene %in% c("HBB")) %>%
#  arrange(cluster)

#VlnPlot(immune.combined, features = c("PPBP"), pt.size = 0)
# PPBPhi = platelets

#immune.markers %>%
#  group_by(cluster) %>%
#  filter(gene %in% c("PPBP")) %>%
#  arrange(cluster)

```

# Plot marker distribution across clusters to identify T/NKT

```{r}

#VlnPlot(immune.combined, features = c("IL7R"), pt.size = 0)
# T/NKT: high expression of CD3D/E and GNLY/NKG7 that were not annotated as CD8/CD4 T cells

#3D: 0, 3, 5, 11-12, 14-15, 17, 20-21
#3E: 0, 3, 5, 11-12, 14-15, 17, 19-21
#8B: 0, 3, 5, 11-12, 14-15, 17, 20-21
#NKG7: 3, 10, 14, 16, 17, 19
#GNLY: 3, 10, 14, 16, 17, 19

# potentials: 3, 14, 17, 19

```

# Name cell types for clusters

```{r}

new.cluster.ids <- c("CD4 T cell",
                     #0
                     
                     "Monocyte",
                     #1
                     
                     "B cell",
                     #2
                     
                     "T/NKT",
                     #3
                     
                     "Monocyte",
                     #4
                     
                     "CD4 T cell",
                     #5
                     
                     "Monocyte",
                     #6
                     
                     "Monocyte",
                     #7

                     "B cell",
                     #8
                     
                     "Monocyte",
                     #9
                     
                     "NK",
                     #10
                     
                     "CD4 T cell",
                     #11
                     
                     "CD4 T cell",
                     #12
                     
                     "B cell",
                     #13
                     
                     "T/NKT",
                     #14
                     
                     "CD8 T cell",
                     #15

                     "NK",
                     #16
                     
                     "T/NKT",
                     #17
                     
                     "Monocyte",
                     #18
                     
                     "T/NKT",
                     #19
                     
                     "CD4 T cell",
                     #20
                     
                     "CD4 T cell",
                     #21
                     
                     "DC",
                     #22
                     
                     "B cell",
                     #23
                     
                     "B cell"
                     #24
                     )

names(new.cluster.ids) <- levels(immune.combined)
immune.combined <- RenameIdents(immune.combined, new.cluster.ids)

```

# Plot UMAP with cell clusters

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, pt.size = 0.5)
ggsave("../figures/umap_cell_type.svg")

# they also have some CD8 assigned T cells clustering inside large CD4 T cell cluster

```

# Plot marker distribution across cell type assigned clusters

```{r}

VlnPlot(immune.combined, features = c("IL7R", "GNLY", "NKG7", "CD14"), pt.size = 0, ncol = 2)

ggsave("../figures/IL7R_GNLY_NKG7_CD14_across_cell_types.svg")

VlnPlot(immune.combined, features = c("MS4A1", "FCER1A", "CD8A", "CD8B"), pt.size = 0, ncol = 2)

ggsave("../figures/MS4A1_FCER1A_CD8A_CD8B_across_cell_types.svg")

VlnPlot(immune.combined, features = c("CD3D", "CD3E", "HBB", "PPBP"), pt.size = 0, ncol = 2)

ggsave("../figures/CD3D_CD3E_HBB_PPBP_across_cell_types.svg")

```

# Save cell type clustered Seurat object

```{r}

saveRDS(immune.combined, file="../saved_data/cell_type_clustered.rds")

```