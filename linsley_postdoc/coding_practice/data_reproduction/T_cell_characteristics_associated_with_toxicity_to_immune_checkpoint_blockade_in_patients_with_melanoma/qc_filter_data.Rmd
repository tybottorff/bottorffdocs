---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: html_document
date: "2023-09-08"
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Use specific version of Seurat that authors use

```{r}

#remotes::install_version("Seurat", version = "3.1.5")

# Check Seurat version

library(Seurat)

packageVersion("Seurat")

```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(readr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Process metadata

```{r}

batch_a_metadata <- read.table("./raw_data/GSE189125_5prime_scRNAseq_seqbatchA_metadata.txt", sep = "\t")

# rename columns with first row values
colnames(batch_a_metadata) <- batch_a_metadata[1, ]

# remove first row
batch_a_metadata <- batch_a_metadata[-1, ]

# Set row names from the values in the 'barcode' column
rownames(batch_a_metadata) <- batch_a_metadata$barcode

# Remove the 'barcode' column from the data frame
batch_a_metadata <- select(batch_a_metadata, -barcode)

# make rownames from metadata match colnames from count data
rownames(batch_a_metadata) <- gsub("-", ".", rownames(batch_a_metadata))

batch_b_metadata <- read.table("./raw_data/GSE189125_5prime_scRNAseq_seqbatchB_metadata.txt", sep = "\t")

colnames(batch_b_metadata) <- batch_b_metadata[1, ]

batch_b_metadata <- batch_b_metadata[-1, ]

rownames(batch_b_metadata) <- batch_b_metadata$barcode

batch_b_metadata <- select(batch_b_metadata, -barcode)

rownames(batch_b_metadata) <- gsub("-", ".", rownames(batch_b_metadata))

```

# Import supplementary data

```{r}

# Load the readxl package
library(readxl)

# Read the specific sheet into a data frame
supp_data <- read_excel("./raw_data/supp_tables.xlsx", sheet = "Table S1")

supp_data

```

# Create a Seurat object for each scRNAseq sample

```{r}

batch_a <- CreateSeuratObject(counts = read.table("./raw_data/GSE189125_5prime_scRNAseq_seqbatchA_counts.txt", sep = ""), project = "batch_a", assay = "RNA", meta.data = batch_a_metadata)

batch_b <- CreateSeuratObject(counts = read.table("./raw_data/GSE189125_5prime_scRNAseq_seqbatchB_counts.txt", sep = ""), project = "batch_b", assay = "RNA", meta.data = batch_b_metadata)

```

# Merge batches to perform QC

```{r}

melanoma_T_cells <- merge(batch_a, y = batch_b)

```

# Calculate percent mitochondrial, ribosomal, hemoglobin features

```{r}

melanoma_T_cells[["percent_mito"]] <- PercentageFeatureSet(melanoma_T_cells, pattern = "^MT-")
melanoma_T_cells[["percent_ribo"]] <- PercentageFeatureSet(melanoma_T_cells, pattern = "^RP[SL]")
melanoma_T_cells[["percent_hb"]] <- PercentageFeatureSet(melanoma_T_cells, pattern = "HB[^(P)]")

```

# View metadata

```{r}

View(melanoma_T_cells@meta.data)

```

# Count number of cells from all samples

```{r}

length(colnames(melanoma_T_cells)) # 30213 cells

```

# Count cells per each of the 16 samples

 - they say n = 13 for scRNAseq, so I'm not sure where I got extra 3 samples

```{r}

cell_capture <- melanoma_T_cells@meta.data %>%
  group_by(patient.ID) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Visualize QC metrics across batches

```{r}

VlnPlot(melanoma_T_cells, features = c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo", "percent_hb"), ncol = 5, pt.size=0)


```

# Set author QC metric thresholds

```{r}

qcMetricsThresholds <-
  c(
    "nFeature_RNA_min" = 100,
    "nFeature_RNA_max" = 1500,
    "percent_mito" = 25,
    "percent_hb" = 100
  )

# Author statement on methods: "Outlier cells were identified and removed based on the following criteria: (1) >25% mitochondrial content or (2) cells with less than 100 or greater than 1,500â€“3,000 expressed genes, depending on sample-level distributions"

# they didn't mention a percent_hb cutoff but one sample has rather high percent_hb

```

# Plot distributions of nFeature_RNA across samples

```{r}

nFeature_RNA_QC <- ggplot(melanoma_T_cells@meta.data, mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_max"],
             color = "red", linetype = "dashed")
ggsave(nFeature_RNA_QC, file = "./figures/nFeature_RNA.tiff", device = "tiff")

nFeature_RNA_QC

```

# Plot distributions of nCount_RNA across samples

```{r}

nCount_RNA_QC <- ggplot(melanoma_T_cells@meta.data, mapping = aes(x = nCount_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10()
ggsave(nCount_RNA_QC, file = "./figures/nCount_RNA.tiff", device = "tiff")

nCount_RNA_QC

```

# Plot distributions of percent mito across samples

```{r}

percent_mt_QC <- ggplot(melanoma_T_cells@meta.data, mapping = aes(x = percent_mito + 1/length(colnames(melanoma_T_cells)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["percent_mito"],
             color = "red", linetype = "dashed") +
  xlab("percent_mito (with pseudocount)")
ggsave(percent_mt_QC, file = "./figures/percent_mt.tiff", device = "tiff")

percent_mt_QC

```

# Plot distributions of percent ribo across samples

```{r}

percent_rb_QC <- ggplot(melanoma_T_cells@meta.data, mapping = aes(x = percent_ribo + 1/length(colnames(melanoma_T_cells)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  xlab("percent_ribo (with pseudocount)")
ggsave(percent_rb_QC, file = "./figures/percent_rb.tiff", device = "tiff")

percent_rb_QC

```

# Plot distributions of percent hemoglobin across samples

```{r}

percent_hb_QC <- ggplot(melanoma_T_cells@meta.data, mapping = aes(x = percent_hb + 1/length(colnames(melanoma_T_cells)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  xlab("percent_hb (with pseudocount)") +
  geom_vline(xintercept = qcMetricsThresholds["percent_hb"],
             color = "red", linetype = "dashed")


ggsave(percent_hb_QC, file = "./figures/percent_hb.tiff", device = "tiff")

percent_hb_QC

# authors didn't mention cutoff for this

```

# Filter cells based on QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    melanoma_T_cells, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      melanoma_T_cells, expression = nFeature_RNA <= qcMetricsThresholds["nFeature_RNA_max"])) %>%
  intersect(
    WhichCells(
      melanoma_T_cells, expression = percent_hb <= qcMetricsThresholds["percent_hb"])) %>%
    intersect(
    WhichCells(
      melanoma_T_cells, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(melanoma_T_cells), cellsKeep)
length(cellsDrop) # 214 cells dropped from analysis

# X cells dropped due to nFeature_RNA threshold
cellsDropped_nFeature <- sum(
  melanoma_T_cells$nFeature_RNA < qcMetricsThresholds["nFeature_RNA"]
)

# X cells dropped due to percent_mito threshold
cellsDropped_percentMito <- sum(
  melanoma_T_cells$percent_mito > qcMetricsThresholds["percent_mito"]
)

melanoma_T_cells_filtered <-
  subset(melanoma_T_cells, cells = cellsKeep)

length(colnames(melanoma_T_cells_filtered)) # 29999 cells left behind in filtered data

```

# Count cells per batch after QC filtering

```{r}

cell_capture <- melanoma_T_cells_filtered@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Count cells per sample after QC filtering

```{r}

cell_capture <- melanoma_T_cells_filtered@meta.data %>%
  group_by(patient.ID) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Save the resulting QC filtered Seurat object

```{r}

saveRDS(melanoma_T_cells_filtered, file="./saved_data/melanoma_T_cells_filtered.rds")

```