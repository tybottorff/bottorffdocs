---
title: "Lineage tracing reveals clonal progenitors and long-term persistence of tumor-specific T cells during immune checkpoint blockade"
output: pdf_document
---

 - data reproduction of https://www.sciencedirect.com/science/article/pii/S153561082300082X

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

melanoma_T_cells_filtered <- readRDS("../saved_data/merged_seurats_filtered.rds")

```

# Split data by sample before integrating by finding anchors

```{r}

# split the dataset into a list of 13 seurat objects (for each patient sample)
melanoma_T_cells_filtered.list <- SplitObject(melanoma_T_cells_filtered, split.by = "sample_name")

# normalize and identify variable features for each dataset independently
melanoma_T_cells_filtered.list <- lapply(X = melanoma_T_cells_filtered.list, FUN = function(x) {
    x <- SCTransform(x, variable.features.n = 2000)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = melanoma_T_cells_filtered.list)

# prep step
melanoma_T_cells_filtered.list <- PrepSCTIntegration(
  melanoma_T_cells_filtered.list,
  anchor.features = features
)

```

# Integrate via anchors

```{r}

immune.anchors <- FindIntegrationAnchors(object.list = melanoma_T_cells_filtered.list, normalization.method = "SCT", anchor.features = features)

# this command creates an 'integrated' data assay
immune.combined <- IntegrateData(anchorset = immune.anchors, normalization.method = "SCT")

```

# Specify integration

```{r}

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

```

# PCA using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)

```

# UMAP using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)

```

# Find clusters

```{r}

immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 3)

# resolution parameter of 3

```

# Visualize UMAP by sample name

```{r}

DimPlot(immune.combined, reduction = "umap", group.by = "sample_name", shuffle = TRUE, seed = 992)

ggsave("../figures/umap_patient_id.svg")

```

# Visualize UMAP by cluster

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)

ggsave("../figures/umap_cluster.svg")

```

# Find cluster biomarkers

```{r}

# find markers for every cluster compared to all remaining cells
immune.markers <- FindAllMarkers(immune.combined)

```

# Look at relevant cluster biomarkers

```{r}

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY", "IL7R", "CD14", "FCGR3A", "FCER1A", "MS4A1", "HBB", "PPBP", "CD36")) %>%
  #filter(gene %in% c("CD235A", "CD41", "CD42A", "CD42B", "CD61", "CD36", "GPIIB", "GPIIIA")) %>%
  arrange(gene)

```

# Plot marker distribution across clusters to identify CD8 T cells

```{r}

# CD3D/CD3Ehi and CD8A/CD8Bhi and NKG7/GNLYlo = CD8 T cells

# 0, 4, 5, 9, 10, 12, 16, 20, 22, 23, 25 high in CD3D
# 0, 4, 5, 9, 10, 12, 14-16, 20, 22, 23, 25 high in CD3E
# clusters 9, 10, 16, 23 highest in CD8A
# 10, 16, 23 highest in CD8B

# 9-11, 14-16 high in NKG7
# 9-11, 14-16 high in GNLY

VlnPlot(immune.combined, features = c("CD8B"), pt.size = 0)

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY")) %>%
  arrange(cluster)

# clusters 16, 23
# 16 is kind of iffy to me (high in NKG7 and GNLY AND CD8A/B but authors had this cluster as CD8 T cell)

```

# Plot marker distribution across clusters to identify CD4 T cells

```{r}

VlnPlot(immune.combined, features = c("IL7R"), pt.size = 0)
# CD3D/CD3Ehi non-CD8 T cells with high IL7R expression and low NKG7/GNLY = CD4 T cells

# 0, 4, 5, 9, 10, 12, 16, 20, 22, 23, 25 high in CD3D
# 0, 4, 5, 9, 10, 12, 14-16, 20, 22, 23, 25 high in CD3E

# clusters 9, 10, 16, 23 highest in CD8A
# 10, 16, 23 highest in CD8B
# 9-11, 14-16 high in NKG7
# 9-11, 14-16 high in GNLY

# clusters 0, 4, 5, 10, 12, 20, 22, 23, 25 high in IL7R

# clusters 0, 4, 5, 12, 20, 22 for CD4 T cells

```

# Plot marker distribution across clusters to identify NK cells

```{r}

# NKG7/GNLYhi and CD3D/CD3Elo = NK cells

# 0, 4, 5, 9, 10, 12, 16, 20, 22, 23, 25 high in CD3D
# 0, 4, 5, 9, 10, 12, 14-16, 20, 22, 23, 25 high in CD3E

# 9-11, 14-16 high in NKG7
# 9-11, 14-16 high in GNLY

# clusters 11, 14 for NK cells

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "NKG7", "GNLY")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify DCs

```{r}

VlnPlot(immune.combined, features = c("FCER1A"), pt.size = 0)
# FCER1Ahi = dendritic cells (DCs)
# cluster 26 is DCs

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("FCER1A")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify B cells

```{r}

VlnPlot(immune.combined, features = c("MS4A1"), pt.size = 0)
# MS4A1hi = B cells

# 1, 18, 19 for B cell clusters

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("MS4A1")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify monocytes

```{r}

VlnPlot(immune.combined, features = c("FCGR3A", "CD14"), pt.size = 0)
# CD14 or FCGR3Ahi = monocytes

# CD14hi = clusters 2, 3, 6, 13, 21, 26, 27
# FCGR3Ahi = clusters 8 and 17 mostly, also 9 and 11 and 13-15?

# 2, 3, 6, 8, 13, 15, 17, 21, 27 = monocytes

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("FCGR3A", "CD14")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify RBCs and platelets

```{r}

VlnPlot(immune.combined, features = c("HBB", "CD36"), pt.size = 0)
# HBBhi = red blood cells
# looks like clusters 24 and 25 are RBCs (24 may be platelets), also 3, 6, 15, 17?

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("HBB")) %>%
  arrange(cluster)

VlnPlot(immune.combined, features = c("PPBP"), pt.size = 0)
# PPBPhi = platelets
# looks like cluster 24 is platelets/RBCs, also 7?

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("PPBP")) %>%
  arrange(cluster)

# RBs/platelets = clusters 24, 25
# let's try just 24-25, reroute 15 & 17

```

# Plot marker distribution across clusters to identify T/NKT

```{r}

VlnPlot(immune.combined, features = c("IL7R"), pt.size = 0)
# T/NKT: high expression of CD3D/E and GNLY/NKG7 that were not annotated as CD8/CD4 T cells

# 0, 4, 5, 9, 10, 12, 16, 20, 22, 23, 25 high in CD3D
# 0, 4, 5, 9, 10, 12, 14-16, 20, 22, 23, 25 high in CD3E

# 9-11, 14-16 high in NKG7
# 9-11, 14-16 high in GNLY

# 9, 10, 15

```

# Name cell types for clusters

```{r}

new.cluster.ids <- c("CD4 T cell",
                     #0
                     
                     "B cell",
                     #1
                     
                     "Monocyte",
                     #2
                     
                     "Monocyte",
                     #3
                     
                     "CD4 T cell",
                     #4
                     
                     "CD4 T cell",
                     #5
                     
                     "Monocyte",
                     #6
                     
                     "RBC/platelet",
                     #7

                     "Monocyte",
                     #8
                     
                     "T/NKT",
                     #9
                     
                     "T/NKT",
                     #10
                     
                     "NK",
                     #11
                     
                     "CD4 T cell",
                     #12
                     
                     "Monocyte",
                     #13
                     
                     "NK",
                     #14
                     
                     "T/NKT",
                     #15

                     "CD8 T cell",
                     #16
                     
                     "Monocyte",
                     #17
                     
                     "B cell",
                     #18
                     
                     "B cell",
                     #19
                     
                     "CD4 T cell",
                     #20
                     
                     "Monocyte",
                     #21
                     
                     "CD4 T cell",
                     #22
                     
                     "CD8 T cell",
                     #23
                     
                     "RBC/platelet",
                     #24

                     "RBC/platelet",
                     #25
                     
                     "DC",
                     #26
                     
                     "Monocyte"
                     #27
                     )

names(new.cluster.ids) <- levels(immune.combined)
immune.combined <- RenameIdents(immune.combined, new.cluster.ids)

```

# Plot UMAP with cell clusters

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, pt.size = 0.5)
ggsave("../figures/umap_cell_type.svg")

# they also have some CD8 assigned T cells clustering inside large CD4 T cell cluster

```

# Exclude clusters annotated as red blood cells or platelets from further analysis

```{r}

rbc_filtered_immune.combined <- subset(immune.combined, idents = "RBC/platelet", invert = TRUE)

```

# Plot marker distribution across cell type assigned clusters

```{r}

VlnPlot(immune.combined, features = c("IL7R", "GNLY", "NKG7", "CD14"), pt.size = 0, ncol = 2)

ggsave("../figures/IL7R_GNLY_NKG7_CD14_across_cell_types.svg")

VlnPlot(immune.combined, features = c("MS4A1", "FCER1A", "CD8A", "CD8B"), pt.size = 0, ncol = 2)

ggsave("../figures/MS4A1_FCER1A_CD8A_CD8B_across_cell_types.svg")

VlnPlot(immune.combined, features = c("CD3D", "CD3E", "HBB", "PPBP"), pt.size = 0, ncol = 2)

ggsave("../figures/CD3D_CD3E_HBB_PPBP_across_cell_types.svg")

```

# Plot UMAP with cell clusters after excluding RBC/platelet clusters

```{r}

DimPlot(rbc_filtered_immune.combined, reduction = "umap", label = TRUE, pt.size = 0.1, cols = c('CD4 T cell' = 'red', 'B cell' = 'brown', 'Monocyte' = 'blue', 'T/NKT' = 'darkcyan', 'NK' = 'purple', 'CD8 T cell' = 'green', 'DC' = 'orange'), repel = TRUE, shuffle = TRUE, seed = 992)

ggsave("../figures/rbc_filtered_umap_cell_type.svg")

# they also have some CD8 assigned T cells clustering inside large CD4 T cell cluster
```

# Save cell type clustered Seurat object

```{r}

saveRDS(rbc_filtered_immune.combined, file="../saved_data/cell_type_clustered.rds")

```