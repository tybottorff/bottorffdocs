---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: pdf_document
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(patchwork)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(forcats)
library(vegan)
library(readxl)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

cleaned_seurat <- readRDS("../saved_data/mono_dc_rbc_platelet_filtered_tcr_bcr_checked_cell_type_clustered.rds")

```

# Prep hydrophobicity calculator

```{r}

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

```

# Create features for UMAP overlay

```{r}

# Create clonal expansion count buckets
feature_df <- as_tibble(cleaned_seurat@meta.data)

feature_df$cell_type <- Idents(cleaned_seurat)
feature_df$severe_irAE <- cleaned_seurat@meta.data$Severe.irAE.status..1.Yes..0.No.
feature_df$cluster_number <- as.numeric(cleaned_seurat@meta.data$seurat_clusters)

feature_df <- feature_df %>%
  select(patient.ID, Chain, severe_irAE, cell_type, CDR3.AA.Sequence, CDR3.NT.Sequence, CR.type, cluster_number) %>%
  mutate(severe_irAE = if_else(severe_irAE == 1, "Yes", "No")) %>%
  group_by(patient.ID, CDR3.NT.Sequence) %>%
  mutate(cdr3_nt_count = n()) %>%
  mutate(expansion_group = if_else(
        is.na(CR.type), "no TCR/BCR info",
        ifelse(cdr3_nt_count <= 1, "single",
        ifelse(cdr3_nt_count <= 5, "small",
          ifelse(cdr3_nt_count <= 20, "medium",
            ifelse(cdr3_nt_count <= 100, "large",
              "hyperexpanded")))))) %>%
  ungroup() %>%
  mutate(CDR3_length = as.numeric(nchar(CDR3.AA.Sequence))) %>%
  rowwise() %>%
  mutate(CDR3_hydrophobicity = as.numeric(calculate_hydrophobicity(CDR3.AA.Sequence, hydrophobicity_df))) %>%
  mutate(CDR3_hydrophobicity_rounded = round(as.numeric(calculate_hydrophobicity(CDR3.AA.Sequence, hydrophobicity_df)))) %>%
  ungroup()

# copy mapping from earlier analysis
cell_type_mapping <- c("B cells 1",
                     # 0
                     
                     "CD4 T cells 1",
                     "CD4 T cells 2",
                     "CD4 T cells 3",
                     "B cells 2",
                     "T/NKTs 1",
                     "T/NKTs 2",
                     "CD4 T cells 4",
                     "B cells 3",
                     "T/NKTs 3",
                     
                     "B cells 4",
                     # 10
                     
                     "CD8 T cells 1",
                     "T/NKTs 4",
                     "CD4 T cells 5",
                     "CD4 T cells 6",
                     "T/NKTs 5",
                     "T/NKTs 6",
                     "T/NKTs 7",
                     "CD4 T cells 7",
                     "T/NKTs 8",
                     
                     "CD4 T cells 8",
                     # 20
                     
                     "B cells 5",
                     "NKs 1"
                     )

# Create a new column 'cell_type' based on the mapping
feature_df$cell_type_subcluster <- cell_type_mapping[feature_df$cluster_number]

# bring back features to seurat metadata
cleaned_seurat@meta.data$expansion_group <- feature_df$expansion_group
cleaned_seurat@meta.data$cdr3_aa_length <- feature_df$CDR3_length
cleaned_seurat@meta.data$cdr3_hydrophobicity_rounded <- feature_df$CDR3_hydrophobicity_rounded
cleaned_seurat@meta.data$cdr3_hydrophobicity <- feature_df$CDR3_hydrophobicity
cleaned_seurat@meta.data$cell_type_subcluster <- feature_df$cell_type_subcluster

```

# Plot UMAP with color of patient ID

```{r}

DimPlot(cleaned_seurat, reduction = "umap", group.by = "patient.ID", shuffle = TRUE, seed = 992, pt.size = 0)

ggsave("../figures/umap_patient_id_no_mono_dc.svg")

```

# Plot UMAP with color of expansion count (bucketed)

```{r}

# Reorder factor levels so that "no TCR group" is plotted first
cleaned_seurat@meta.data$expansion_group <- factor(cleaned_seurat@meta.data$expansion_group, levels = c("no TCR/BCR info", "single", "small", "medium", "large", "hyperexpanded"))

DimPlot(cleaned_seurat, reduction = "umap", group.by = "expansion_group", shuffle = TRUE, seed = 992, pt.size = 0)

ggsave("../figures/umap_expansion_group_no_mono_dc.svg")

```

# Plot UMAP with color of CDR3 AA length

```{r}

DimPlot(cleaned_seurat, reduction = "umap", group.by = "cdr3_aa_length", shuffle = TRUE, seed = 992, pt.size = 0)

ggsave("../figures/umap_cdr3_aa_length_no_mono_dc.svg")

```

# Plot UMAP with color of CDR3 hydrophobicity

```{r}

DimPlot(cleaned_seurat, reduction = "umap", group.by = "cdr3_hydrophobicity_rounded", shuffle = TRUE, seed = 992, pt.size = 0)

ggsave("../figures/umap_cdr3_hydrophobicity_no_mono_dc.svg")

```

# Analyze TCR/BCR length and unique counts as a function of severe irAE development, cell type

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion"))

length_expansion_boxplot_df <- feature_df %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster) %>%
  filter(cell_type != "NKs") %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(length_expansion_boxplot_df, aes(x = cell_type, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "Value")

ggsave("../figures/cdr3_aa_length_expansion_by_cell_type_no_mono_dc.svg")

```

# Analyze TCR/BCR hydrophobicty as a function of severe irAE development, cell type

```{r}

custom_labeller <- as_labeller(c("CDR3_hydrophobicity" = "CDR3\nhydrophobicity"))

hydrophobicity_boxplot_df <- feature_df %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_length, -cdr3_nt_count, -cluster_number, -cell_type_subcluster) %>%
  filter(cell_type != "NKs") %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(hydrophobicity_boxplot_df, aes(x = cell_type, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Cell Type", y = "Value")

ggsave("../figures/cdr3_hydrophobicity_by_cell_type_no_mono_dc.svg")

```

# Investigate patient bias for B cell effects

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion"))

b_cell_boxplot_df <- feature_df %>%
  select(-CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster) %>%
  filter(cell_type == "B cells") %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type, -patient.ID)

# Create a custom list of patient IDs in the order you want
custom_order <- c("YUCARD", "YUFURL", "YUPIXEL", "YUTAUR", "YUTORY", "YUVARDO", "YUENZO", "YUFUB", "YUGRUS", "YUKEND", "YUHERN", "YUROD", "YUTHEA")

# Reorder the patient.ID based on the custom order
b_cell_boxplot_df$patient.ID <- factor(b_cell_boxplot_df$patient.ID, levels = custom_order)

# Create the box plot with facets
ggplot(b_cell_boxplot_df, aes(x = patient.ID, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6)) +
  labs(x = "Patient ID", y = "Value")

ggsave("../figures/b_cell_features_by_patient.svg")

```

# Analyze TCR/BCR length and unique counts as a function of severe irAE development, cell type without YUROD outlier patient

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion"))

no_yurod_boxplot_df <- feature_df %>%
  filter(patient.ID != "YUROD") %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster) %>%
  filter(cell_type != "NKs") %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(no_yurod_boxplot_df, aes(x = cell_type, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "Value")

ggsave("../figures/cdr3_aa_length_expansion_by_cell_type_no_yurod_outlier_no_mono_dc.svg")

```

# Analyze TCR CDR3 AA hydrophobicity as a function of chain and severe irAE development

```{r}

no_yurod_boxplot_df <- feature_df %>%
  filter(Chain %in% c("TRA", "TRB"),
         cell_type != "B cells") %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -cluster_number, -cell_type_subcluster, -cdr3_nt_count, -CDR3_length) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(no_yurod_boxplot_df, aes(x = Chain, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ cell_type, ncol = 3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "CDR3 hydrophobicity")

ggsave("../figures/tcr_cdr3_aa_hydrophobicity_by_chain_cell_type_no_mono_dc.svg")

```

# Analyze TCR CDR3 AA length as a function of chain and severe irAE development

```{r}

boxplot_df <- feature_df %>%
  filter(Chain %in% c("TRA", "TRB"),
         cell_type != "B cells") %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster, -cdr3_nt_count) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(boxplot_df, aes(x = Chain, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ cell_type, ncol = 3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "CDR3 AA length")

ggsave("../figures/tcr_cdr3_aa_length_by_chain_cell_type_no_mono_dc.svg")

```

# Analyze TCR unique counts as a function of chain and severe irAE development

```{r}

boxplot_df <- feature_df %>%
  filter(Chain %in% c("TRA", "TRB"),
         cell_type != "B cells") %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster, -CDR3_length) %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(boxplot_df, aes(x = Chain, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ cell_type, ncol = 3, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "CDR3 expansion")

ggsave("../figures/tcr_cdr3_expansion_by_chain_cell_type_no_mono_dc.svg")

# Filter the data for CD8 T cell (cell type) and TRB (Chain) groups
test_data <- boxplot_df %>%
  filter(cell_type == "CD8 T cells", Chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$Value ~ test_data$severe_irAE)

# Print the results
print(wilcox_result)

```

# Analyze CD8 T cell TCRB unique counts as a function of patient ID and severe irAE development

```{r}

boxplot_df <- feature_df %>%
  filter(Chain %in% c("TRB"),
         cell_type == "CD8 T cells") %>%
  select(-CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -CDR3_hydrophobicity, -cluster_number, -cell_type_subcluster, -CDR3_length) %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type, -patient.ID) %>%
  mutate(patient.ID = factor(patient.ID, levels = unique(patient.ID[order(severe_irAE)])))

# Create the box plot with facets
ggplot(boxplot_df, aes(x = patient.ID, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Patient.ID", y = "CD8 T cell beta\nchain CDR3 expansion")

ggsave("../figures/cd8_tcrb_cdr3_expansion_by_patient.svg")

```

# Analyze BCR CDR3 length, hydrophobicity and unique counts as a function of severe irAE development, cell type without YUROD outlier patient

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion", "CDR3_hydrophobicity" = "CDR3\nhydro-\nphobicity"))

no_yurod_boxplot_df <- feature_df %>%
  filter(patient.ID != "YUROD",
         cell_type == "B cells",
         Chain %in% c("IGH", "IGK", "IGL")) %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -cluster_number, -cell_type_subcluster) %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type)

# Create the box plot with facets
ggplot(no_yurod_boxplot_df, aes(x = Chain, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Chain", y = "Value")

ggsave("../figures/bcr_cdr3_length_hydrophobicity_expansion_by_chain_cell_type_no_yurod_outlier_no_mono_dc.svg")

```

# Re-look at UMAP to estimate CD4 T cell subclusters of interest, looks like 2, 4, 7 are potentially what the paper found interesting (CD4 effector memory)

```{r}

DimPlot(cleaned_seurat, reduction = "umap", group.by = "cell_type_subcluster", shuffle = TRUE, seed = 992, pt.size = 0, cols = c('B cells 1' = 'brown', 'B cells 2' = 'brown', 'B cells 3' = 'brown', 'B cells 4' = 'brown', 'B cells 5' = 'brown', 'T/NKTs 1' = 'darkcyan', 'T/NKTs 2' = 'darkcyan', 'T/NKTs 3' = 'darkcyan', 'T/NKTs 4' = 'darkcyan', 'T/NKTs 5' = 'darkcyan', 'T/NKTs 6' = 'darkcyan', 'T/NKTs 7' = 'darkcyan', 'T/NKTs 8' = 'darkcyan', 'NKs 1' = 'purple', 'CD8 T cells 1' = 'pink', 'CD4 T cells 1' = 'blue', 'CD4 T cells 2' = 'green', 'CD4 T cells 3' = 'red', 'CD4 T cells 4' = 'blue', 'CD4 T cells 5' = 'red', 'CD4 T cells 6' = 'red', 'CD4 T cells 7' = 'black', 'CD4 T cells 8' = 'red'))

```

# Analyze CD4 TCR CDR3 hydrophobicity and AA length as a function of severe irAE development, cell cluster

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion", "CDR3_hydrophobicity" = "CDR3\nhydrophobicity"))

cd4_hydrophobicity_length_boxplot_df <- feature_df %>%
  filter(cell_type == "CD4 T cells") %>%
  mutate(cell_type_subcluster = str_extract(cell_type_subcluster, "\\d+$")) %>%
  select(-patient.ID, -cell_type, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -cluster_number, -cdr3_nt_count) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type_subcluster)

# Create the box plot with facets
ggplot(cd4_hydrophobicity_length_boxplot_df, aes(x = cell_type_subcluster, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  labs(x = "CD4 subcluster", y = "Value")

ggsave("../figures/cdr3_aa_length_hydrophobicity_by_cd4_subcluster_no_mono_dc.svg")

```

# Analyze CD4 TCR expansion as a function of severe irAE development, cell cluster

```{r}

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion", "CDR3_hydrophobicity" = "CDR3\nhydrophobicity"))

cd4_expansion_boxplot_df <- feature_df %>%
  filter(cell_type == "CD4 T cells",
         Chain %in% c("TRA", "TRB")) %>%
  mutate(cell_type_subcluster = str_extract(cell_type_subcluster, "\\d+$")) %>%
  select(-patient.ID, -cell_type, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -cluster_number, -CDR3_length, -CDR3_hydrophobicity) %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type_subcluster)

# Create the box plot with facets
ggplot(cd4_expansion_boxplot_df, aes(x = cell_type_subcluster, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  labs(x = "CD4 subcluster", y = "CDR3 expansion")

ggsave("../figures/expansion_by_cd4_subcluster_no_mono_dc.svg")

```

# Analyze CD4 T cell subcluster 4 TCR expansion as a function of severe irAE development, chain

```{r}

cd4_subcluster_4_expansion_boxplot_df <- feature_df %>%
  filter(cell_type == "CD4 T cells",
         cell_type_subcluster == "CD4 T cells 4",
         # one B cell snuck through somehow, many NAs
         Chain %in% c("TRA", "TRB")) %>%
  select(-patient.ID, -cell_type, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -CR.type, -expansion_group, -CDR3_hydrophobicity_rounded, -cluster_number, -CDR3_length, -CDR3_hydrophobicity) %>%
  mutate(cdr3_nt_count = if_else(is.na(Chain), NA, cdr3_nt_count)) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type_subcluster)

# Create the box plot with facets
ggplot(cd4_subcluster_4_expansion_boxplot_df, aes(x = Chain, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  labs(x = "Chain", y = "CDR3 expansion")

ggsave("../figures/cd4_subcluster_4_expansion_by_chain_no_mono_dc.svg")

```

# Restore patient IDs/full barcodes (with suffixes) to IGoR output data

```{r}

# List of file names
file_names <- c(
  "../raw_data/GSM5694801_YUFURL_TCR.csv.gz",
  "../raw_data/GSM5694811_YUALOE_TCR.csv.gz",
  "../raw_data/GSM5694802_YUGRUS_TCR.csv.gz",
  "../raw_data/GSM5694812_YUHONEY_TCR.csv.gz",
  "../raw_data/GSM5694803_YUHERN_TCR.csv.gz",
  "../raw_data/GSM5694804_YUKEND_TCR.csv.gz",
  "../raw_data/GSM5694805_YUPIXEL_TCR.csv.gz",
  "../raw_data/GSM5694806_YUROD_TCR.csv.gz",
  "../raw_data/GSM5694798_YUCARD_TCR.csv.gz",
  "../raw_data/GSM5694808_YUTHEA_TCR.csv.gz",
  "../raw_data/GSM5694799_YUENZO_TCR.csv.gz",
  "../raw_data/GSM5694800_YUFUB_TCR.csv.gz",
  "../raw_data/GSM5694810_YUVARDO_TCR.csv.gz",
  "../raw_data/GSM5694809_YUTORY_TCR.csv.gz",
  "../raw_data/GSM5694807_YUTAUR_TCR.csv.gz",
  "../raw_data/GSM5694813_YUNANCY_TCR.csv.gz"
#  "../raw_data/GSM5694821_YUPIXEL_BCR.csv.gz",
#  "../raw_data/GSM5694822_YUROD_BCR.csv.gz",
#  "../raw_data/GSM5694823_YUTAUR_BCR.csv.gz",
#  "../raw_data/GSM5694814_YUCARD_BCR.csv.gz",
#  "../raw_data/GSM5694824_YUTHEA_BCR.csv.gz",
#  "../raw_data/GSM5694815_YUENZO_BCR.csv.gz",
#  "../raw_data/GSM5694825_YUTORY_BCR.csv.gz",
#  "../raw_data/GSM5694816_YUFUB_BCR.csv.gz",
#  "../raw_data/GSM5694826_YUVARDO_BCR.csv.gz",
#  "../raw_data/GSM5694817_YUFURL_BCR.csv.gz",
#  "../raw_data/GSM5694818_YUGRUS_BCR.csv.gz",
#  "../raw_data/GSM5694819_YUHERN_BCR.csv.gz",
#  "../raw_data/GSM5694820_YUKEND_BCR.csv.gz"
)

# Create an empty data frame to store the combined data
combined_data <- data.frame()

# Process each file and append it to the combined_data data frame
for (file_name in file_names) {
  # Read the CSV file
  data <- read_csv(file_name)
  
  # Extract patient ID and CR type (TCR or BCR) from the file name
  patient_ID <- gsub(".*_(Y[A-Z]+)_.*", "\\1", file_name)
  
  # Add patient ID as new column
  data$patient.ID <- patient_ID
  
  # Append the data to the combined_data data frame
  combined_data <- bind_rows(combined_data, data)
}

```

# Combine stitched TCR IGoR alpha and beta pgen results, restore full barcodes (with suffixes)

```{r}

tcr_alpha_igor <- read_csv("../saved_data/igor_output_alpha.csv") %>%
  filter(!(is.na(pgen))) %>%
  rename(pgen_alpha = pgen)

# Create a mapping of patient.ID to their respective suffixes
suffix_mapping <- data.frame(
  patient.ID = c(
    "YUCARD", "YUPIXEL", "YUENZO", "YUKEND", "YUTHEA", 
    "YUFUB", "YUTAUR", "YUVARDO", "YUGRUS", "YUFURL", 
    "YUTORY", "YUHERN", "YUROD"
  ),
  suffix = c(
    ".1_1", ".1_2", ".1_3", ".1_4", ".1_5", ".1_6", ".1_7", ".1_8", ".1_9", ".1_10", ".1_11", ".1_12", ".1_13"
  )
)

tcr_igor <- read_csv("../saved_data/igor_output_beta.csv") %>%
  filter(!(is.na(pgen))) %>%
  rename(pgen_beta = pgen) %>%
  left_join(tcr_alpha_igor, by = c("TCR_name", "TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "TRAV", "TRAJ", "TRA_CDR3", "TRBV", "TRBJ", "TRB_CDR3", "TRAC", "TRBC", "TRA_leader", "TRB_leader", "Linker", "Link_order", "TRA_5_prime_seq", "TRA_3_prime_seq", "TRB_5_prime_seq", "TRB_3_prime_seq", "Linked_nt", "Linked_aa", "Warnings/Errors")) %>%
  select(TCR_name, pgen_alpha, pgen_beta) %>%
  rename(Barcode = TCR_name)

tcr_igor_metadata <- tcr_igor %>%
  mutate(neg_log_pgen_alpha = -log10(pgen_alpha),
         neg_log_pgen_beta = -log10(pgen_beta)) %>%
  left_join(combined_data, by = "Barcode") %>%
  # join suffixes
  left_join(suffix_mapping, by = "patient.ID") %>%
  filter(!(is.na(suffix))) %>%
  mutate(Barcode = paste(Barcode, suffix, sep = "")) %>%
  select(-suffix) %>%
  group_by(Barcode) %>%
  slice(1) %>%
  ungroup()

rownames(tcr_igor_metadata) <- tcr_igor_metadata$Barcode

tcr_igor_pivoted <- tcr_igor %>%
  pivot_longer(cols = starts_with("pgen"), 
               names_to = "Chain", 
               values_to = "pgen") %>%
  mutate(Chain = ifelse(grepl("alpha", Chain), "alpha", "beta"),
         neg_log_pgen = -log10(pgen))

# lose ~40ish cells/barcodes with NaN pgen values

```

# Join pivoted IGoR TCR data with irAE development

```{r}

supp_data <- read_excel("../raw_data/supp_tables.xlsx", sheet = "cleaned_table_s1") %>%
  rename(patient.ID = `Patient ID`) %>%
  mutate(severe_irAE = if_else(`Highest irAE grade` > 2, "Yes", "No")) %>%
  select(patient.ID, severe_irAE)

tcr_igor_pivoted_with_irAE <- tcr_igor_pivoted %>%
  left_join(combined_data, by = "Barcode") %>%
  left_join(supp_data, by = "patient.ID")

tcr_igor_pivoted_with_irAE

```

# Plot alpha vs. beta pgen (-log) scores by severe irAE development

```{r}

ggplot(tcr_igor_pivoted_with_irAE, aes(x = Chain, y = neg_log_pgen, color = severe_irAE)) +
  geom_violin() +
  labs(x = "Chain", y = "-log10(pgen, higher is\nless germline-like)")

# Filter the data for CD8 T cell (cell type) and TRB (Chain) groups
test_data <- tcr_igor_pivoted_with_irAE %>%
  filter(Chain == "alpha")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$neg_log_pgen ~ test_data$severe_irAE)

test_data

# Print the results
print(wilcox_result)

```

# Look at pgen scores overlayed onto UMAP, too sparse to make conclusions

```{r}

cleaned_seurat_with_igor <- AddMetaData(object = cleaned_seurat, metadata = tcr_igor_metadata)

plot <- DimPlot(cleaned_seurat_with_igor, reduction = "umap", group.by = "neg_log_pgen_beta", shuffle = TRUE, seed = 992, pt.size = 0)

plot + theme(legend.position = "None")

```

# Plot alpha vs. beta pgen (-log) scores faceted by cell type, irAE development

```{r}

tcr_igor_with_seurat_pivoted <- as_tibble(cleaned_seurat_with_igor@meta.data) %>%
  select(Severe.irAE.status..1.Yes..0.No., cell_type_subcluster, pgen_alpha, pgen_beta) %>%
  mutate(severe_irAE = if_else(Severe.irAE.status..1.Yes..0.No. == 1, "Yes", "No")) %>%
  select(-Severe.irAE.status..1.Yes..0.No.) %>%
  mutate(cell_type = sub("\\s\\d+$", "", cell_type_subcluster)) %>%
  filter(cell_type %in% c("CD4 T cells", "CD8 T cells", "T/NKTs")) %>%
  pivot_longer(cols = starts_with("pgen"), 
               names_to = "Chain", 
               values_to = "pgen") %>%
  mutate(Chain = ifelse(grepl("alpha", Chain), "alpha", "beta"),
         neg_log_pgen = -log10(pgen))

ggplot(tcr_igor_with_seurat_pivoted, aes(x = Chain, y = neg_log_pgen, color = severe_irAE)) +
  geom_violin() +
  facet_wrap(~ cell_type) +
  labs(x = "Chain", y = "-log10(pgen, higher is\nless germline-like)")

```

# Find CDR3 sequences differentially encountered in +/- severe irAE development

```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup() %>%
  filter(irae_seq_differential > 6)

diff_seq_boxplot_df <- diff_seq_df %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -irae_specific_sequence_count) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type, -irae_seq_differential)

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion", "CDR3_hydrophobicity" = "CDR3\nhydrophobicity"))

# Create the box plot with facets
ggplot(diff_seq_boxplot_df, aes(x = cell_type, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "Value")

```

# Look at differential histogram

```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup() %>%
  arrange(-irae_seq_differential)

diff_seq_df

# Create a histogram for irae_seq_differential
ggplot(diff_seq_df, aes(x = irae_seq_differential)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(x = "irAE CDR3 AA sequence differential", y = "Frequency")

```

# Look at histogram for each yes/no severe irAE CD3 AA seq counts

```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(severe_irAE) %>%
  mutate(irae_total_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup()

diff_seq_df

# Create a histogram for irae_seq_differential
ggplot(diff_seq_df, aes(x = irae_specific_sequence_count, fill = severe_irAE)) +
  geom_histogram(binwidth = 1) +
  labs(x = "irAE CDR3 AA sequence counts", y = "Frequency")

```