---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: pdf_document
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install necessary packages

```{r}

#remotes::install_github("mojaveazure/seurat-disk")

#install.packages('BiocManager')
#BiocManager::install('limma')

```

# Load necessary libraries

```{r}

library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

melanoma_T_cells_filtered <- readRDS("../saved_data/batch_a_filtered.rds")

```

# Split data by sample before integrating by finding anchors

```{r}

# split the dataset into a list of 13 seurat objects (for each patient sample)
melanoma_T_cells_filtered.list <- SplitObject(melanoma_T_cells_filtered, split.by = "patient.ID")

# normalize and identify variable features for each dataset independently
melanoma_T_cells_filtered.list <- lapply(X = melanoma_T_cells_filtered.list, FUN = function(x) {
    x <- NormalizeData(x)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = melanoma_T_cells_filtered.list)

```

# Integrate via anchors

```{r}

immune.anchors <- FindIntegrationAnchors(object.list = melanoma_T_cells_filtered.list, anchor.features = features)

# this command creates an 'integrated' data assay
immune.combined <- IntegrateData(anchorset = immune.anchors)

```

# Specify integration, scale data

```{r}

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

# scale data
immune.combined <- ScaleData(immune.combined, verbose = FALSE)

```

# PCA using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)

```

# UMAP using 2000 most variable genes and top 30 PCs

```{r}

immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)

```

# Find clusters

```{r}

immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 3)

# resolution parameter of 3, see 28 instead of 37 clusters

```

# Visualize UMAP by patient ID

```{r}

DimPlot(immune.combined, reduction = "umap", group.by = "patient.ID", dims = c(2, 1))

ggsave("../figures/umap_patient_id.svg")

```

# Visualize UMAP by cluster

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)

ggsave("../figures/umap_cluster.svg")

```

# Find cluster biomarkers

```{r}

# find markers for every cluster compared to all remaining cells
immune.markers <- FindAllMarkers(immune.combined)
#immune.markers <- FindAllMarkers(immune.combined, only.pos = FALSE, min.pct = 0.1, logfc.threshold = 0.25)

```

# Look at relevant cluster biomarkers for cells to filter out (RBCs/platelets)

```{r}

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("HPP", "PPBP", "CD62P", "PAC-1", "CD63", "CD41", "CD61", "CD63", "CD71", "CD235A")) %>%
  arrange(gene)

```

# Plot marker distribution across clusters to identify RBCs and platelets

```{r}

VlnPlot(immune.combined, features = c("CD63"), pt.size = 0)
# PPBPhi = platelets
# HBBhi = RBCs

immune.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD63")) %>%
  arrange(cluster)

# 28 highest and off UMAP

```

# Name cell types for clusters (RBC/platlet vs. other)

```{r}

new.cluster.ids <- c("Other",
                     # 0
                     
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     
                     "Other",
                     # 10
                     
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     
                     "Other",
                     # 20
                     
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "Other",
                     "RBC/platelet",
                     
                     "Other")
                     # 29

names(new.cluster.ids) <- levels(immune.combined)
immune.combined <- RenameIdents(immune.combined, new.cluster.ids)

```

# Plot UMAP with cell clusters

```{r}

DimPlot(immune.combined, reduction = "umap", label = TRUE, pt.size = 0.5)
ggsave("../figures/umap_cell_type.svg")

```

# Eliminate RBCs/platelets

```{r}

no_rbcs_platelets <- immune.combined[, !(immune.combined@active.ident %in% c("RBC/platelet"))]

```

# Repeat dimensional reduction (PCA, UMAP) and FindClusters since filtering out RBCs, platelets

```{r}

no_rbcs_platelets <- RunPCA(no_rbcs_platelets, npcs = 30, verbose = FALSE)
no_rbcs_platelets <- RunUMAP(no_rbcs_platelets, reduction = "pca", dims = 1:30)
no_rbcs_platelets <- FindNeighbors(no_rbcs_platelets, reduction = "pca", dims = 1:30)
no_rbcs_platelets <- FindClusters(no_rbcs_platelets, resolution = 3)

```

# Visualize UMAP by cluster

```{r}

DimPlot(no_rbcs_platelets, reduction = "umap", label = TRUE, repel = TRUE)

ggsave("../figures/umap_cluster_no_rbcs.svg")

```

# Find markers for every cluster compared to all remaining cells

```{r}

no_rbcs_platelets.markers <- FindAllMarkers(no_rbcs_platelets)

```

# Look at relevant cluster biomarkers

```{r}

no_rbcs_platelets.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY", "IL7R", "CD14", "FCGR3A", "FCER1A", "MS4A1")) %>%
  arrange(gene)

```

# Plot marker distribution across clusters to identify CD4/8 T cells, T/NKTs, NKs

```{r}

# CD3D/CD3Ehi and CD8A/CD8Bhi and NKG7/GNLYlo = CD8 T cells
# CD3D/CD3Ehi non-CD8 T cells with high IL7R expression and low NKG7/GNLY = CD4 T cells
# T/NKT: high expression of CD3D/E and GNLY/NKG7 that were not annotated as CD4/CD8 T cells
# NKG7/GNLYhi and CD3D/CD3Elo = NK cells

#3D: 0, 2, 5, 12, 13, 17, 20-23
#3E: 0, 2, 5, 9-13, 17, 20-23, 25?
#8A: 17, 20, 21
#8B: 17, 20, 21
#NKG7: 9-12, 17, 20, 21
#GNLY: 9-12, 17, 20, 21
#IL7R: 0, 2, 5, 13, 17, 22, 23, 25?

# CD4s: 0, 2, 5, 13, 22, 23, 25?

# CD8s: 21

# T/NKTs: 12, 17, 20

# NKs: 9-11

VlnPlot(no_rbcs_platelets, features = c("CD8A", "CD8B"), pt.size = 0)

no_rbcs_platelets.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify DCs

```{r}

VlnPlot(no_rbcs_platelets, features = c("FCER1A"), pt.size = 0)
# FCER1Ahi = dendritic cells (DCs)

# 26

no_rbcs_platelets.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("FCER1A")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify B cells

```{r}

VlnPlot(no_rbcs_platelets, features = c("MS4A1"), pt.size = 0)
# MS4A1hi = B cells

# 1, 7, 15, 18

no_rbcs_platelets.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("MS4A1")) %>%
  arrange(cluster)

```

# Plot marker distribution across clusters to identify monocytes

```{r}

VlnPlot(no_rbcs_platelets, features = c("CD14"), pt.size = 0)
# CD14 or FCGR3Ahi = monocytes

# CD14hi = 3, 4, 6, 14, 19, 24, 27
# FCGR3Ahi = 8, 16

# 3, 4, 6, 8, 14, 16, 19, 24, 27

no_rbcs_platelets.markers %>%
  group_by(cluster) %>%
  filter(gene %in% c("FCGR3A", "CD14")) %>%
  arrange(cluster)

```

# Name cell types for clusters

```{r}

new.cluster.ids <- c("CD4 T cells",
                     # 0
                     
                     "B cells",
                     "CD4 T cells",
                     "Monocytes",
                     "Monocytes",
                     "CD4 T cells",
                     "Monocytes",
                     "B cells",
                     "Monocytes",
                     "NKs",
                     
                     "NKs",
                     # 10
                     
                     "NKs",
                     "T/NKT",
                     "CD4 T cells",
                     "Monocytes",
                     "B cells",
                     "Monocytes",
                     "T/NKT",
                     "B cells",
                     "Monocytes",
                     
                     "T/NKT",
                     # 20
                     
                     "CD8 T cells",
                     "CD4 T cells",
                     "CD4 T cells",
                     "Monocytes",
                     "CD4 T cells",
                     "DCs",
                     
                     "Monocytes")
                     # 27)

names(new.cluster.ids) <- levels(no_rbcs_platelets)
no_rbcs_platelets <- RenameIdents(no_rbcs_platelets, new.cluster.ids)

```

# Plot UMAP with cell clusters

```{r}

DimPlot(no_rbcs_platelets, reduction = "umap", label = TRUE, pt.size = 0.5)
ggsave("../figures/umap_cell_type_no_rbcs.svg")

```

# Plot marker distribution across cell type assigned clusters

```{r}

VlnPlot(no_rbcs_platelets, features = c("IL7R", "GNLY", "NKG7", "CD14"), pt.size = 0, ncol = 2)

ggsave("../figures/IL7R_GNLY_NKG7_CD14_across_cell_types_no_rbcs.svg")

VlnPlot(no_rbcs_platelets, features = c("MS4A1", "FCER1A", "CD8A", "CD8B"), pt.size = 0, ncol = 2)

ggsave("../figures/MS4A1_FCER1A_CD8A_CD8B_across_cell_types_no_rbcs.svg")

VlnPlot(no_rbcs_platelets, features = c("CD3D", "CD3E", "HBB", "PPBP"), pt.size = 0, ncol = 2)

ggsave("../figures/CD3D_CD3E_HBB_PPBP_across_cell_types_no_rbcs.svg")

```

# Save cell type clustered, RBC/platelet filtered Seurat object

```{r}

saveRDS(no_rbcs_platelets, file="../saved_data/rbc_platelet_filtered_cell_type_clustered.rds")

```