---
title: "Distinct mechanisms of mismatch repair deficiency delineate two modes of response to PD-1 immunotherapy in endometrial carcinoma"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9905265/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SingleR)
library(ggplot2)
library(dplyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

tdat = readRDS("../saved_data/seurat_T_cells_pre_reduction.rds")

```

# Repeat dimensional reduction FindClusters since subsetting for T cells

```{r}

# exclude V/J genes that would otherwise dominate dimensional reduction and clustering
excluded_genes <- grep("^TRAV|^TRBV|^TRAJ|^TRBJ", rownames(tdat), value = TRUE)
included_genes <- setdiff(rownames(tdat), excluded_genes)

tdat <- RunPCA(tdat, npcs = 30, verbose = FALSE, genes.use = included_genes)
tdat <- RunUMAP(tdat, reduction = "pca", dims = 1:30, genes.use = included_genes)
tdat <- FindNeighbors(tdat, reduction = "pca", dims = 1:30, genes.use = included_genes)
tdat <- FindClusters(tdat)

```

# Visualize UMAP by cluster

```{r}

DimPlot(tdat, reduction = "umap", label = TRUE, repel = TRUE)

```

# Re-check mito % across clusters, re-dimensional reduce/cluster if I remove any clusters

```{r}

DimPlot(tdat, reduction = "umap", group.by = "mito_perc", label = TRUE, repel = TRUE)

```

# Begin by trying to just use their figure 3B UMAP to assign my cell clusters... (I don't know what markers they used for manual assigning and I don't know what reference they used for SingleR)

```{r}

# dimplot but have everything 1 color (non-black) except for 1 cluster being black at a time

```

# Find markers for every cluster compared to all remaining cells

```{r}

tdat.markers <- FindAllMarkers(tdat)

```

# Look at relevant cluster biomarkers for manual anaylsis of marker genes to assign cell types

```{r}

tdat.markers %>%
  group_by(cluster) %>%
  #filter(gene %in% c("CD3D", "CD3E", "CD8A", "CD8B", "NKG7", "GNLY", "IL7R", "MS4A1")) %>%
  arrange(gene)

VlnPlot(no_mono_dc_rbcs_platelets, features = c("GNLY"), pt.size = 0)

```

# Use automatic SingleR to help assign cell types

```{r}

# Not sure what they used as reference map...

# SingleCellExperiment objects can be used directly. Seurat objects can be converted to SingleCellExperiment objects via Seurat's as.SingleCellExperiment() function or their normalized counts can be retrieved via GetAssayData or FetchData.

# SingleR results labels can be easily added back to the metadata of these objects as well:

# seurat.obj[["SingleR.labels"]] <- singler.results$labels

# Or if `method="cluster"` was used:
#seurat.obj[["SingleR.cluster.labels"]] <- 
#        singler.results$labels[match(seurat.obj[[]][["my.input.clusters"]], rownames(singler.results))]

```