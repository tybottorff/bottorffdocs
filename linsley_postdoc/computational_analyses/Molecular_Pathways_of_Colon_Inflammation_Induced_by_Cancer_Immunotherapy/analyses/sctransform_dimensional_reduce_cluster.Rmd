---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in RDS of QC filtered data

```{r}

colon_t_cells_filtered <- readRDS("../saved_data/qc_filtered.rds")

```

# Create metadata for CD3 vs. CD45 type

```{r}

colon_t_cells_filtered$cd_type <- ifelse(grepl("-CD3$", colon_t_cells_filtered$orig.ident), "CD3", 
                                         ifelse(grepl("-CD45$", colon_t_cells_filtered$orig.ident), "CD45", "Other"))

```

# Subset Seurat for just T cells

```{r}

colon_qc_just_t_cells <- subset(colon_t_cells_filtered, subset = cd_type == "CD3")

```

# Split data by sample, prepare (normalize, find variable features, etc.) before integrating by finding anchors

```{r}

# split the dataset into a list of seurat objects (for each patient sample)
colon_qc_just_t_cells.list <- SplitObject(colon_qc_just_t_cells, split.by = "orig.ident")

# normalize and identify variable features for each dataset independently
colon_qc_just_t_cells.list <- lapply(X = colon_qc_just_t_cells.list, FUN = SCTransform, method = "glmGamPoi")

```

# Find integration features

```{r}

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = colon_qc_just_t_cells.list, nfeatures = 3000)

# prep step
colon_qc_just_t_cells.list <- PrepSCTIntegration(object.list = colon_qc_just_t_cells.list, anchor.features = features)

# run PCA to allow rpca use later
colon_qc_just_t_cells.list <- lapply(X = colon_qc_just_t_cells.list, FUN = RunPCA, features = features)

```

# Randomly select a single sample per group to use as a reference

```{r}

# Set a random seed for reproducibility
set.seed(123)

# Extract the starting letters from the names
starting_letters_list <- substr(names(colon_qc_just_t_cells.list), 1, 2)

# Create a data frame with Seurat object names and their starting letters
seurat_info <- data.frame(name = names(colon_qc_just_t_cells.list), starting_letters = starting_letters_list)

# Randomly sample one Seurat object from each starting letters group
randomly_selected_seurat <- seurat_info %>%
  group_by(starting_letters) %>%
  sample_n(1) %>%
  ungroup() %>%
  select(name)

randomly_selected_seurat

```

# Find integration anchors using the above single sample/group as references

```{r}

# first integrates these references, then aligns other samples within each group to that integrated reference
# this command creates an 'integrated' data assay

immune.anchors <- FindIntegrationAnchors(object.list = colon_qc_just_t_cells.list, reference = which(names(colon_qc_just_t_cells.list) %in% randomly_selected_seurat$name), normalization.method = "SCT", anchor.features = features, reduction = "rpca", k.anchor = 10, dims = 1:30)

```

# Integrate the data

```{r}

immune.combined <- IntegrateData(anchorset = immune.anchors, normalization.method = "SCT")

```

# Save RDS

```{r}

saveRDS(immune.combined, "../saved_data/integrated.rds")

```

# Specify integration, scale data

```{r}

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

# scale data
immune.combined <- ScaleData(immune.combined, verbose = FALSE)

```

# Remove TCR genes

 - these dominate clustering

```{r}

# Example regex to match TCR gene names
tcr_gene_regex <- "^TR[ABCDG][VDJC]"

# Extract TCR genes using the regex
tcr_genes <- grep(tcr_gene_regex, rownames(immune.combined), value = TRUE)

# Print or use the resulting TCR gene list
print(tcr_genes)

# Filter out TCR genes from the Seurat object
immune.combined_no_tcr_genes <- subset(immune.combined, features = !rownames(immune.combined) %in% tcr_genes)

```

# PCA using 2000 most variable genes and top 30 PCs

```{r}

immune.combined_no_tcr_genes <- RunPCA(immune.combined_no_tcr_genes, npcs = 30, verbose = FALSE)

```

# UMAP using 2000 most variable genes and top 30 PCs

```{r}

immune.combined_no_tcr_genes <- RunUMAP(immune.combined_no_tcr_genes, reduction = "pca", dims = 1:30)

```

# Find clusters

```{r}

immune.combined_no_tcr_genes <- FindNeighbors(immune.combined_no_tcr_genes, reduction = "pca", dims = 1:30)
immune.combined_no_tcr_genes <- FindClusters(immune.combined_no_tcr_genes, resolution = 3)

```

# Visualize UMAP by patient ID

```{r}

DimPlot(immune.combined_no_tcr_genes, reduction = "umap", group.by = "orig.ident")

ggsave("../figures/umap_patient_id.svg")

```

# Visualize UMAP by cluster

```{r}

DimPlot(immune.combined_no_tcr_genes, reduction = "umap", label = TRUE, repel = TRUE)

ggsave("../figures/umap_cluster.svg")

```

# Save RDS

```{r}

saveRDS(immune.combined_no_tcr_genes, "../saved_data/integrated_transformed_reduced_clustered.rds")

```