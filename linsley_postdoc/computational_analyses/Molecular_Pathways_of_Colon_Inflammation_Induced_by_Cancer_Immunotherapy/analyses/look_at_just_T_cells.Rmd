---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in scRNAseq RDS

```{r}

immune.combined <- readRDS("../saved_data/cell_type_ref_mapped_integrated_transformed_reduced_clustered.rds")

```

# Look at just T cells

```{r}

T_cells <- immune.combined[, immune.combined@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & immune.combined@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

```

# Re-do dimensional reduction, clustering

```{r}

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

```

# Read in reference to use for mapping

```{r}

reference <- LoadH5Seurat("../../pbmc_multimodal.h5seurat")

```

# Find reference transfer anchors

```{r}

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

```

# Map reference onto my object

```{r}

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)

```

# Plot mapping results

```{r}

p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Re-look at just T cells

```{r}

T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)


p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Re-look at just T cells

```{r}

T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)


p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Not many non-T cells leftover

```{r}

just_T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Make some UMAP overlays

```{r}

t_cell_metadata <- as_tibble(just_T_cells@meta.data) %>%
    mutate(group = case_when(
    startsWith(orig.ident, "CT") ~ "no ICI",
    startsWith(orig.ident, "C") ~ "ICI colitis",
    startsWith(orig.ident, "NC") ~ "ICI no colitis"))

t_cell_metadata

just_T_cells <- AddMetaData(just_T_cells, metadata = t_cell_metadata)

DimPlot(just_T_cells, reduction = "umap", group.by = "group", shuffle = TRUE, seed = 728)

DimPlot(just_T_cells, reduction = "umap", group.by = "orig.ident", shuffle = TRUE, seed = 728) + NoLegend()

```

# Save RDS

```{r}

saveRDS(just_T_cells, "../saved_data/T_cells.rds")

```

# See if there might be cell types not well mapped (due to reference being PBMCs and query being colon tissue)

```{r}

just_T_cells <- readRDS("../saved_data/T_cells.rds")

#reference <- ScaleData(reference, verbose = FALSE)

#reference <- RunPCA(reference, npcs = 30, verbose = FALSE)
#just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
# reference
#reference <- DietSeurat(reference, counts = FALSE, dimreducs = "pca")

# query
#just_T_cells <- DietSeurat(just_T_cells, counts = FALSE, dimreducs = "ref.pca")

#reference@assays$SCT

#just_T_cells@assays$integrated

#merge reference and query
#reference$id <- 'reference'
#just_T_cells$id <- 'query'
#refquery <- merge(reference@assays$SCT, just_T_cells@assays$integrated)
#refquery[["pca"]] <- merge(reference[["pca"]], just_T_cells[["ref.pca"]])
#refquery <- RunUMAP(refquery, reduction = 'pca', dims = 1:50)
#DimPlot(refquery, group.by = 'id', shuffle = TRUE)

```

# Look for clusters with high Trm marker expression

 - take home is I'll change clusters 25 and 27 (CD4 TCM) to CD4 Trm and 3, 7, 9, 15-16 (CD8 TEM) to CD8 Trm in abundance, feature, linkage analyses

```{r}

# Human TRM are typically associated with the expression of the surface markers CD69 and CD103 (ITGAE, integrin αE), maybe also CD49a (integrin α1, ITGA1)

VlnPlot(just_T_cells, features = c("CD69"), pt.size = 0)

# CD69
# 25 (CD4 TCM) and 29 (only MAIT) highest --> I think I'll just take 25 & 27 (previously CD4 TCM NOW CD4 Trm!)
# 27 (CD4 TCM), 36 (CD8 TCM), 37, 6 somewhat as well

# ITGAE/CD103
# 15, 16, 9, 7, 2, 3 highest --> I think I'll just take 15, 16, 7, 9, 3 (all CD8 TEM --> now CD8 Trm?)
# also 22, 28, 34, 35, 37, 38 a bit
# ITGA1/CD49a
# 16 highest
# also 15, 7, 9-10, 2-3
# CD101
# highest in 3, 7, 9, 15, 16

#FeaturePlot(just_T_cells, features = "CD69")

#FeaturePlot(just_T_cells, features = "ITGAE")

#FeaturePlot(just_T_cells, features = "ITGA1")

#FeaturePlot(just_T_cells, features = "CD101")

#DimPlot(just_T_cells, reduction = "umap", label.size = 1)

```

```{r}
rows_with_CD103 <- grep("ITGA1", rownames(just_T_cells))

rows_with_CD103
```

```{r}
just_T_cells@meta.data %>%
  group_by(seurat_clusters) %>%
  slice(1) %>%
  select(seurat_clusters, predicted.celltype.l2) %>%
  filter(seurat_clusters %in% c(15, 16, 9, 7, 2, 3))

```