---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)
library(Seurat)
library(purrr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in TCRseq data

```{r}

tcrs <- read.csv("../saved_data/rna_tcr_no_na_good_cell_typing.csv") %>%
  select(patient, predicted.celltype.l1, predicted.celltype.l2, group, barcode, Chain, v_gene, j_gene, c_gene, cdr3, cdr3_nt)

tcrs

```

# Read in RNAseq data for UMAP coordinates

```{r}

seurat_obj <- readRDS("../saved_data/T_cells.rds")

```

# Extract UMAP coordinates

```{r}

umap_coords <- Embeddings(object = seurat_obj[["umap"]])[(colnames(seurat_obj)), c(1, 2)]
umap_coords <- as.data.frame(umap_coords)
umap_coords$celltype <- seurat_obj@meta.data$predicted.celltype.l2

umap_coords$barcode <- rownames(umap_coords)

rownames(umap_coords) <- NULL

umap_coords <- umap_coords %>%
  left_join(tcrs %>% group_by(barcode) %>% slice(1) %>% ungroup() %>% select(barcode, group), by = "barcode")

umap_coords

```

# Find TCR linkages

```{r}

alpha_tcrs_split <- tcrs %>%
  filter(Chain == "TRA") %>%
  group_by(cdr3) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  split(.$cdr3)

alpha_linkages_list <- lapply(alpha_tcrs_split, function(df) {
  df %>%
    summarise(linkages = list(t(combn(barcode, 2, simplify = TRUE)))) %>%
    pull(linkages) %>%
    as.data.frame() %>%
    rename(barcode1 = X1, barcode2 = X2)
})

alpha_linkages <- bind_rows(alpha_linkages_list)

alpha_linkages

beta_tcrs_split <- tcrs %>%
  filter(Chain == "TRB") %>%
  group_by(cdr3) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  split(.$cdr3)

beta_linkages_list <- lapply(beta_tcrs_split, function(df) {
  df %>%
    summarise(linkages = list(t(combn(barcode, 2, simplify = TRUE)))) %>%
    pull(linkages) %>%
    as.data.frame() %>%
    rename(barcode1 = X1, barcode2 = X2)
})

beta_linkages <- bind_rows(beta_linkages_list)

beta_linkages

```

# Get UMAP coordinates for barcodes in linkages

```{r}

barcode1 <- umap_coords %>%
  rename(barcode1 = barcode,
         celltype1 = celltype,
         group1 = group)

barcode2 <- umap_coords %>%
  rename(barcode2 = barcode,
         celltype2 = celltype,
         group2 = group)

alpha_links_with_coords <- alpha_linkages %>%
  left_join(barcode1, by = "barcode1") %>%
  rename(x_start = umap_1,
         y_start = umap_2) %>%
  left_join(barcode2, by = c("barcode2")) %>%
  rename(x_end = umap_1,
         y_end = umap_2)

alpha_links_with_coords

beta_links_with_coords <- beta_linkages %>%
  left_join(barcode1, by = "barcode1") %>%
  rename(x_start = umap_1,
         y_start = umap_2) %>%
  left_join(barcode2, by = c("barcode2")) %>%
  rename(x_end = umap_1,
         y_end = umap_2)

beta_links_with_coords

```

# Plot UMAP, add segments for linked TCRs (TRA, CD4 proliferating)

```{r}

coords <- alpha_links_with_coords %>%
  filter(celltype1 == "CD4 Proliferating" | celltype2 == "CD4 Proliferating")

p <- ggplot(umap_coords) +
  geom_point(aes(x=umap_1, y=umap_2, color=celltype), show.legend = TRUE, size = 0.01) +
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 12))

set.seed(123)
shuffled_indices <- sample(nrow(coords))
coords_shuffled <- coords[shuffled_indices, ]

# Plot the randomly selected rows
for (i in 1:1500) {
  p <- p + annotate(
    "segment",
    x = coords_shuffled$x_start[i],
    y = coords_shuffled$y_start[i],
    xend = coords_shuffled$x_end[i],
    yend = coords_shuffled$y_end[i],
    color = "black",
    size = 0.025
  )
}

p + guides(color = guide_legend(override.aes = list(size = 4)))

```

# Plot UMAP, add segments for linked TCRs (TRB, CD4 proliferating)

```{r}

coords <- beta_links_with_coords %>%
  filter(celltype1 == "CD4 Proliferating" | celltype2 == "CD4 Proliferating")

p <- ggplot(umap_coords) +
  geom_point(aes(x=umap_1, y=umap_2, color=celltype), show.legend = TRUE, size = 0.01) +
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 12))

set.seed(123)
shuffled_indices <- sample(nrow(coords))
coords_shuffled <- coords[shuffled_indices, ]

# Plot the randomly selected rows
for (i in 1:1500) {
  p <- p + annotate(
    "segment",
    x = coords_shuffled$x_start[i],
    y = coords_shuffled$y_start[i],
    xend = coords_shuffled$x_end[i],
    yend = coords_shuffled$y_end[i],
    color = "black",
    size = 0.025
  )
}

p + guides(color = guide_legend(override.aes = list(size = 4)))

```

# Plot UMAP, add segments for linked TCRs (TRA, CD8 naive)

```{r}

coords <- alpha_links_with_coords %>%
  filter(celltype1 == "CD8 Naive" | celltype2 == "CD8 Naive")

p <- ggplot(umap_coords) +
  geom_point(aes(x=umap_1, y=umap_2, color=celltype), show.legend = TRUE, size = 0.01) +
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 12))

set.seed(123)
shuffled_indices <- sample(nrow(coords))
coords_shuffled <- coords[shuffled_indices, ]

# Plot the randomly selected rows
for (i in 1:1500) {
  p <- p + annotate(
    "segment",
    x = coords_shuffled$x_start[i],
    y = coords_shuffled$y_start[i],
    xend = coords_shuffled$x_end[i],
    yend = coords_shuffled$y_end[i],
    color = "black",
    size = 0.025
  )
}

p + guides(color = guide_legend(override.aes = list(size = 4)))

```

# Plot UMAP, add segments for linked TCRs (TRB, CD8 naive)

```{r}

coords <- beta_links_with_coords %>%
  filter(celltype1 == "CD8 Naive" | celltype2 == "CD8 Naive")

p <- ggplot(umap_coords) +
  geom_point(aes(x=umap_1, y=umap_2, color=celltype), show.legend = TRUE, size = 0.01) +
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 12))

set.seed(123)
shuffled_indices <- sample(nrow(coords))
coords_shuffled <- coords[shuffled_indices, ]

# Plot the randomly selected rows
for (i in 1:1500) {
  p <- p + annotate(
    "segment",
    x = coords_shuffled$x_start[i],
    y = coords_shuffled$y_start[i],
    xend = coords_shuffled$x_end[i],
    yend = coords_shuffled$y_end[i],
    color = "black",
    size = 0.025
  )
}

p + guides(color = guide_legend(override.aes = list(size = 4)))

```

# Summarize degree of cell type junction crossover sharing

```{r}

cd4_prolif_links_tra <- alpha_links_with_coords %>%
  select(celltype1, celltype2) %>%
  mutate(celltype_combo = apply(across(c(celltype1, celltype2)), 1, function(x) paste(sort(x), collapse = "_"))) %>%
  group_by(celltype_combo) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  filter(grepl("CD4 Proliferating", celltype_combo))

cd4_prolif_links_tra

cd4_prolif_links_trb <- beta_links_with_coords %>%
  select(celltype1, celltype2) %>%
  mutate(celltype_combo = apply(across(c(celltype1, celltype2)), 1, function(x) paste(sort(x), collapse = "_"))) %>%
  group_by(celltype_combo) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  filter(grepl("CD4 Proliferating", celltype_combo))

cd4_prolif_links_trb

cd8_naive_links_tra <- alpha_links_with_coords %>%
  select(celltype1, celltype2) %>%
  mutate(celltype_combo = apply(across(c(celltype1, celltype2)), 1, function(x) paste(sort(x), collapse = "_"))) %>%
  group_by(celltype_combo) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  filter(grepl("CD8 Naive", celltype_combo))

cd8_naive_links_tra

cd8_naive_links_trb <- beta_links_with_coords %>%
  select(celltype1, celltype2) %>%
  mutate(celltype_combo = apply(across(c(celltype1, celltype2)), 1, function(x) paste(sort(x), collapse = "_"))) %>%
  group_by(celltype_combo) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  filter(grepl("CD8 Naive", celltype_combo))

cd8_naive_links_trb

```