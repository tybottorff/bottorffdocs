---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(VennDiagram)
library(scales)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

combined_data <- read.csv("../saved_data/rna_tcr_no_na_good_cell_typing.csv")

combined_data

```
  
# Examine patient sampling depth bias

```{r}

seq_depth <- combined_data %>%
  group_by(patient, group) %>%
  summarize(seq_depth = n()) %>%
  arrange(seq_depth) %>%
  print()

seq_depth

# Choose ~2512/2 seqs from non B10 samples to downsample all to 2512/2

```

# Downsample

```{r}

desired_rows_per_patient <- 1249
# ~/2 to get equal numbers of each Chain (TRA and TRB)

set.seed(123)

# Downsample the dataframe
downsampled_df <- combined_data %>%
  group_by(patient, Chain) %>%
  sample_n(desired_rows_per_patient, replace = FALSE) %>%
  ungroup() %>%
  filter(predicted.celltype.l1 == "CD4 T",
         predicted.celltype.l2 == "Treg",
         Chain == "TRA")

downsampled_df

combined_data <- combined_data %>%
  filter(predicted.celltype.l1 == "CD4 T",
         predicted.celltype.l2 == "Treg",
         Chain == "TRA")

```

# Look at public vs. private

```{r}

downsampled_public_df_list <- downsampled_df %>%
  group_by(cdr3, v_gene, j_gene, c_gene) %>%
  filter(n_distinct(patient) > 1) %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = ""))

downsampled_public_df_list

downsampled_public_df <- downsampled_df %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  filter(clonotype %in% downsampled_public_df_list$clonotype) %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  mutate(tag = "Public\n(downsampled)")

downsampled_public_df

public_df_list <- combined_data %>%
  group_by(cdr3, v_gene, j_gene, c_gene) %>%
  filter(n_distinct(patient) > 1) %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = ""))

public_df_list

public_df <- combined_data %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  filter(clonotype %in% public_df_list$clonotype) %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  mutate(tag = "Public")

public_df

```

# Look at TCR convergence

```{r}

convergence_within_patients <- combined_data %>%
  select(patient, barcode, Chain, cdr3, cdr3_nt, v_gene, d_gene, j_gene, c_gene) %>%
  group_by(cdr3, patient, v_gene) %>%
  filter(n_distinct(cdr3_nt) > 1) %>%
  group_by(patient, cdr3, cdr3_nt) %>%
  summarize(count = n())

convergence_across_patients <- combined_data %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  group_by(cdr3, v_gene) %>%
  filter(n_distinct(cdr3_nt) > 1)
  #filter(clonotype %in% public_df_list$clonotype)
  #group_by(patient, cdr3, cdr3_nt) %>%
  #summarize(count = n())

# do see more convergence across patients as expected, and they are ~mostly in public TCRs also as expected

convergence_df <- combined_data %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  filter(clonotype %in% convergence_across_patients$clonotype) %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  mutate(tag = "Converged")

convergence_df

```

# Get unique CD8 TEMs TRBs from Top 20 clonotypes per group (normalizing counts by seq depth)

```{r}

unique_cd8_tem_trb <- combined_data %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # calculate clonotype counts within patients to get a sense of expansion
  mutate(count = n()) %>%
  # normalize by sequencing depth
  left_join(seq_depth, by = c("patient", "group")) %>%
  mutate(normalized_count = count / seq_depth) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  arrange(-normalized_count) %>%
  ungroup() %>%
  mutate(tag = "All")

unique_cd8_tem_trb

unique_cd8_tem_trb_top_15 <- unique_cd8_tem_trb %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 15) %>%
  ungroup() %>%
  mutate(tag = "Top 15 clonotypes\n(normalized)")

unique_cd8_tem_trb_top_5 <- unique_cd8_tem_trb %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 5) %>%
  ungroup() %>%
  mutate(tag = "Top 5 clonotypes\n(normalized)")

unique_cd8_tem_trb_top_10 <- unique_cd8_tem_trb %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 10) %>%
  ungroup() %>%
  mutate(tag = "Top 10 clonotypes\n(normalized)")

unique_cd8_tem_trb_top_20 <- unique_cd8_tem_trb %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 20) %>%
  ungroup() %>%
  mutate(tag = "Top 20 clonotypes\n(normalized)")

```

# Get unique CD8 TEMs TRBs from Top 20 clonotypes per group (not normalizing counts by seq depth)

```{r}

unique_cd8_tem_trb_top_15_not_normalized <- combined_data %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # calculate clonotype counts within patients to get a sense of expansion
  mutate(count = n()) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  arrange(-count) %>%
  ungroup() %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 15) %>%
  ungroup() %>%
  mutate(tag = "Top 15 clonotypes\n(not normalized)")

unique_cd8_tem_trb_top_15_not_normalized

```

# Get unique CD8 TEMs TRBs from top 15 clonotypes per group from downsampled data

```{r}

unique_cd8_tem_trb_downsampled <- downsampled_df %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # calculate clonotype counts within patients to get a sense of expansion
  mutate(count = n()) %>%
  # look at just unique TCRs
  dplyr::slice(1) %>%
  arrange(-count) %>%
  ungroup() %>%
  mutate(tag = "Downsampled")

unique_cd8_tem_trb_downsampled

unique_cd8_tem_trb_top_15_downsampled <- unique_cd8_tem_trb_downsampled %>%
  group_by(predicted.celltype.l1, Chain, group) %>%
  filter(row_number() <= 15) %>%
  ungroup() %>%
  mutate(tag = "Top 15 clonotypes\n(downsampled)")

unique_cd8_tem_trb_top_15_downsampled

```

# Join dfs

```{r}

unique_cd8_tem_trb_all <- unique_cd8_tem_trb_top_15 %>%
  full_join(unique_cd8_tem_trb_top_5) %>%
  full_join(unique_cd8_tem_trb_top_10) %>%
  full_join(unique_cd8_tem_trb_top_20)

```

# Plot pgen conclusions

```{r}

unique_cd8_tem_trb_all$tag <- factor(unique_cd8_tem_trb_all$tag, levels = c("Top 5 clonotypes\n(normalized)", "Top 10 clonotypes\n(normalized)", "Top 15 clonotypes\n(normalized)", "Top 20 clonotypes\n(normalized)"))

unique_cd8_tem_trb_all$group <- factor(unique_cd8_tem_trb_all$group, levels = c("no ICI", "ICI no colitis", "ICI colitis"))

p <- ggplot(unique_cd8_tem_trb_all, aes(x = tag, y = log10(pgen), fill = group)) +
  geom_boxplot() +
  labs(x = "", fill = "group", y = "Treg TRA\npgen (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

# Filter the data for statistical test
test_data <- unique_cd8_tem_trb_all %>%
  filter(tag == "Top 15 clonotypes\n(normalized)",
         group != "no ICI")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$group)

# Print the results
print(wilcox_result)

# p = 0.04 for not normalized top 20 clonotypes

```

# Plot length conclusions

```{r}

p <- ggplot(unique_cd8_tem_trb_all, aes(x = tag, y = cdr3_length, fill = group)) +
  geom_boxplot() +
  labs(x = "", fill = "group", y = "Treg TRA\nCDR3 length (AAs)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

# Filter the data for statistical test
test_data <- unique_cd8_tem_trb_all %>%
  filter(tag == "Top 20 clonotypes\n(normalized)",
         group != "no ICI")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$group)

# Print the results
print(wilcox_result)

```