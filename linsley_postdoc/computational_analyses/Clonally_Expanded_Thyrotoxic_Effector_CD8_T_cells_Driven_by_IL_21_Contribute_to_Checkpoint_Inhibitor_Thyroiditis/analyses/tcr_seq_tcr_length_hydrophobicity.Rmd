---
title: "Clonally-Expanded, Thyrotoxic Effector CD8+ T cells Driven by IL-21 Contribute to Checkpoint Inhibitor Thyroiditis"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10227862/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Prep hydrophobicity calculator

```{r}

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

```

# Read in data

```{r}

tcr_seq_with_rna <- read.csv("../saved_data/rna_tcr.csv") %>%
  pivot_longer(cols = matches("(TRA|TRB)$"), names_to = c(".value", "Chain"), names_pattern = "(.*)_([A-Z]+)$") %>%
  filter(!(is.na(cdr3_nt)),
         !(is.na(v_gene)),
         !(is.na(j_gene))) %>%
  select(-X)

tcr_seq_with_rna

```

# Assess cell identity confidence

```{r}

cell_confidence_test <- tcr_seq_with_rna %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n(), score1 = mean(predicted.celltype.l1.score), score2 = mean(predicted.celltype.l2.score))

cell_confidence_test

# unexpected combos have low scores, remove them

```

# Prep feature df

```{r}

feature_df <- tcr_seq_with_rna %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  rowwise() %>%
  mutate(cdr3_length = nchar(cdr3),
         cdr3_hydrophobicity = calculate_hydrophobicity(cdr3, hydrophobicity_df))
  
feature_df

```

# Plot CDR3 length and hydrophobicity by condition status and cell type (l1, l2)

```{r}

ggplot(feature_df, aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 length")

ggplot(feature_df, aes(x = Chain, y = cdr3_hydrophobicity, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- feature_df_doubled %>%
  filter(Chain == "TRA",
         predicted.celltype.l1 == "other T",
         predicted.celltype.l2 == "MAIT")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_hydrophobicity ~ test_data$condition)

# Print the results
print(wilcox_result)

```

# Plot CDR3 length and hydrophobicity by condition status and cell type (l1, l2) for UNIQUE TCRs

```{r}

feature_df_doubled_unique <- feature_df_doubled %>%
  group_by(cdr3, Chain, Patient_ID) %>%
  dplyr::slice(1)

ggplot(feature_df_doubled_unique, aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 length")

ggplot(feature_df_doubled_unique, aes(x = Chain, y = cdr3_hydrophobicity, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 hydrophobicity")

```

# Plot CDR3 length and hydrophobicity by condition status and cell type (l1, l2) for most expanded CDR3s

```{r}

expansion_df <- feature_df %>%
  group_by(Patient_ID, cdr3, Chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

expansion_df %>%
  group_by(predicted.celltype.l1, condition, Chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df, aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 length")

ggplot(expansion_df, aes(x = Chain, y = cdr3_hydrophobicity, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- expansion_df %>%
  filter(Chain == "TRB",
         predicted.celltype.l1 == "CD4 T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$condition)

# Print the results
print(wilcox_result)

```

# Plot CD8 TEM CDR3 length by condition status and expansion degree

```{r}

expansion_df <- feature_df %>%
  group_by(Patient_ID, cdr3, Chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

expansion_df$expansion_degree <- factor(expansion_df$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper\nexpanded"))

ggplot(expansion_df %>% filter(predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 == "CD8 TEM"), aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "condition", y = "CD8 TEM CDR3 length")

expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM") %>%
  group_by(expansion_degree, condition, Chain) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- expansion_df %>%
  filter(Chain == "TRB",
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         expansion_degree == "Hyperexpanded")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$condition)

# Print the results
print(wilcox_result)

```

# Plot CDR3 length and hydrophobicity by condition status and cell type (l1, l2) for most expanded, unique CDR3s

```{r}

expansion_df_unique <- feature_df %>%
  group_by(Patient_ID, cdr3, Chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  group_by(cdr3, Patient_ID, Chain) %>%
  dplyr::slice(1) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

expansion_df_unique %>%
  group_by(predicted.celltype.l1, condition, Chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df_unique, aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 length")

ggplot(expansion_df_unique, aes(x = Chain, y = cdr3_hydrophobicity, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "CDR3 hydrophobicity")

```

# Plot CD8 TEM CDR3 length by condition status and expansion degree for unique TCRs

```{r}

expansion_df_unique <- feature_df %>%
  group_by(Patient_ID, cdr3, Chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  group_by(cdr3, Patient_ID, Chain) %>%
  dplyr::slice(1)

expansion_df_unique$expansion_degree <- factor(expansion_df_unique$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper\nexpanded"))

expansion_df_unique %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         expansion_degree %in% c("Large", "Hyperexpanded")) %>%
  group_by(expansion_degree, condition, Chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df_unique %>% filter(predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 == "CD8 TEM" & expansion_degree %in% c("Large", "Hyperexpanded")), aes(x = Chain, y = cdr3_length, fill = condition)) +
  geom_boxplot() +
  #facet_wrap(~ expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "condition", y = "CD8 TEM CDR3 length")

# Filter the data for statistical test
test_data <- expansion_df_unique %>%
  filter(Chain == "TRB",
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         expansion_degree %in% c("Large", "Hyperexpanded"))

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$condition)

# Print the results
print(wilcox_result)

```

# Investigate Gly and Ala usage

```{r}

feature_df <- feature_df %>%
  mutate(Gly_num = sapply(strsplit(as.character(cdr3), ""), function(x) sum(x == "G")),
         Ala_num = sapply(strsplit(as.character(cdr3), ""), function(x) sum(x == "A")),
         Gly_perc = Gly_num / cdr3_length,
         Ala_perc = Ala_num / cdr3_length)

ggplot(feature_df, aes(x = Chain, y = Gly_perc, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "Glycine usage in CDR3 (%)")

ggplot(feature_df, aes(x = Chain, y = Ala_perc, fill = condition)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "condition", y = "Alanine usage in CDR3 (%)")

```