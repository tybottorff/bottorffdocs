---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in non-control data

```{r}

# List of sample names
sample_names <- c(
"A10-B10-MCE12-MCE13-filtered_feature_bc_matrix", "B2-filtered_feature_bc_matrix", "A1-filtered_feature_bc_matrix", "B3-filtered_feature_bc_matrix", "A2-filtered_feature_bc_matrix", "A3-filtered_feature_bc_matrix", "MCE1-filtered_feature_bc_matrix", "A5-B14-MCL15-filtered_feature_bc_matrix", "MCE2-filtered_feature_bc_matrix", "A6-A9-B13-B9-filtered_feature_bc_matrix", "MCL1-filtered_feature_bc_matrix", "A8-B11-filtered_feature_bc_matrix", "MCL3-filtered_feature_bc_matrix", "B12-NCE6-NCE7-filtered_feature_bc_matrix", "B1-filtered_feature_bc_matrix"
)

output_dir = "../raw_data/"

# Create Seurat objects for each sample
heart_t_cells_objects <- list()

for (sample_name in sample_names) {
  # Construct file paths
  counts_file <- paste0(output_dir, sample_name, "/matrix.mtx.gz")
  barcodes_file <- paste0(output_dir, sample_name, "/barcodes.tsv.gz")
  genes_file <- paste0(output_dir, sample_name, "/features.tsv.gz")
  
  # Read data files
  counts <- readMM(counts_file)
  barcodes <- read.table(barcodes_file, stringsAsFactors = FALSE)[, 1]
  features <- read.csv(genes_file, stringsAsFactors = FALSE, sep = "\t", header = FALSE)
  rownames(counts) <- make.unique(features[, 2])
  colnames(counts) <- barcodes
  
  # Create Seurat object
  heart_t_cells <- CreateSeuratObject(counts, project = sample_name)
  
  # Store Seurat object in the list
  heart_t_cells_objects[[sample_name]] <- heart_t_cells
}

```

# Dehash samples

```{r}
#matrix <- readMM("../raw_data/A10-B10-MCE12-MCE13-filtered_feature_bc_matrix/matrix.mtx.gz")

#file_path <- "../raw_data/A10-B10-MCE12-MCE13-filtered_feature_bc_matrix/features.tsv.gz"  # Replace with the actual file path
#features_data <- read.table(gzfile(file_path), sep = "\t", header = TRUE)

# Close the gzipped file connection
#close(gzfile(file_path))

#file_path <- "../raw_data/A10-B10-MCE12-MCE13-filtered_feature_bc_matrix/barcodes.tsv.gz"  # Replace with the actual file path
#barcodes_data <- read.table(gzfile(file_path), sep = "\t", header = TRUE)

# Close the gzipped file connection
#close(gzfile(file_path))

#matrix
# 36608 by 12649

matrix[c(36602, 36603, 36604, 36605), ]
# want 1st 4 from 7 last
# generally see one number much higher, so this is the correct hash call ?!
# ok good, now just need to track this somehow...
# WHY DOESNT THIS GET PUT INTO SEURAT OBJECT?

#filt_feat_dat <- features_data %>%
#  tail(10)

#filt_feat_dat

#features_data
# 36607 rows

# rows 36601-4 have hashes in features_data, look at same rows in matrix to see values? would be values for all 

#barcodes_data
# 12648 rows

```

```{r}

test <- heart_t_cells_objects[["A10-B10-MCE12-MCE13-filtered_feature_bc_matrix"]]

subset_seurat_obj <- subset(test, features = c("Hash1-TotalSeqC", "Hash2-TotalSeqC", "Hash3-TotalSeqC", "Hash4-TotalSeqC"))

View(subset_seurat_obj)

```

# Read in control data, add to Seurat list

```{r}

# Define the list of control file paths
control_paths <- c(
  "../raw_data/hc_rds/GSM4557334_HIP002_cell.counts.matrices.rds",
  "../raw_data/hc_rds/GSM4557335_HIP015_cell.counts.matrices.rds",
  "../raw_data/hc_rds/GSM4557336_HIP023_cell.counts.matrices.rds",
  "../raw_data/hc_rds/GSM4557337_HIP043_cell.counts.matrices.rds",
  "../raw_data/hc_rds/GSM4557338_HIP044_cell.counts.matrices.rds",
  "../raw_data/hc_rds/GSM4557339_HIP045_cell.counts.matrices.rds"
)

# Load and store Seurat objects in the list
for (i in 1:length(control_paths)) {
  control_seurat <- readRDS(control_paths[i])
  sample_name <- paste0("control_", i)
  heart_t_cells_objects[[sample_name]] <- CreateSeuratObject(counts = control_seurat$exon, project = sample_name)
  # could also choose intron or spanning (exon + intron?), but I think exon is the best choice here...
}

```

# Merge Seurat objects from all samples to perform QC

```{r}

# Merge the first element with a sublist of the rest excluding the first element
heart_t_cells <- merge(heart_t_cells_objects[[1]], y = heart_t_cells_objects[-1])

```

# Metadata

```{r}

# Group A: 3/8 accounted for

#GSM5449974	Group A - Patient 1 - A1-filtered GSM5449974_A1-filtered_feature_bc_matrix.tar.gz
#GSM5449986	Group A - Patient 1-TCR GSM5449986_A1-filtered_contig_annotations.csv.gz
#GSM5449998	Group A - Patient 1-Feature

#GSM5449975	Group A - Patient 2 - A2-filtered GSM5449975_A2-filtered_feature_bc_matrix.tar.gz
#GSM5449987	Group A - Patient 2-TCR GSM5449987_A2-filtered_contig_annotations.csv.gz
#GSM5449999	Group A - Patient 2-Feature

#GSM5449976	Group A - Patient 3 - A3-filtered GSM5449976_A3-filtered_feature_bc_matrix.tar.gz
#GSM5449988	Group A - Patient 3-TCR GSM5449988_A3-filtered_contig_annotations.csv.gz
#GSM5450000	Group A - Patient 3-Feature

# Group B: 3/8 accounted for

#GSM5449978	Group B - Patient 1 - B1-filtered GSM5449978_B1-filtered_feature_bc_matrix.tar.gz
#GSM5449990	Group B - Patient 1-TCR GSM5449990_B1-filtered_contig_annotations.csv.gz
#GSM5450002	Group B - Patient 1-Feature

#GSM5449979	Group B - Patient 2 - B2-filtered GSM5449979_B2-filtered_feature_bc_matrix.tar.gz
#GSM5449991	Group B - Patient 2-TCR GSM5449991_B2-filtered_contig_annotations.csv.gz
#GSM5450003	Group B - Patient 2-Feature

#GSM5449980	Group B - Patient 3 - B3-filtered GSM5449980_B3-filtered_feature_bc_matrix.tar.gz
#GSM5449992	Group B - Patient 3-TCR GSM5449992_B3-filtered_contig_annotations.csv.gz
#GSM5450004	Group B - Patient 3-Feature

# Group C: 3/8 accounted for

#GSM5449981	Group C - Patient 1 Early GSM5449981_MCE1-filtered_feature_bc_matrix.tar.gz
#GSM5449993	Group C - Patient 1 Early-TCR GSM5449993_MCE1-filtered_contig_annotations.csv.gz
#GSM5450005	Group C - Patient 1 Early-Feature

#GSM5449984	Group C - Patient 1 Late GSM5449984_MCL1-filtered_feature_bc_matrix.tar.gz
#GSM5449996	Group C - Patient 1 Late-TCR GSM5449996_MCL1-filtered_contig_annotations.csv.gz
#GSM5450008	Group C - Patient 1 Late-Feature 

#GSM5449982	Group C - Patient 2 GSM5449982_MCE2-filtered_feature_bc_matrix.tar.gz
#GSM5449994	Group C - Patient 2-TCR GSM5449994_MCE2-filtered_contig_annotations.csv.gz
#GSM5450006	Group C - Patient 2-Feature

#GSM5449985	Group C - Patient 3 GSM5449985_MCL3-filtered_feature_bc_matrix.tar.gz
#GSM5449997	Group C - Patient 3-TCR GSM5449997_MCL3-filtered_contig_annotations.csv.gz
#GSM5450009	Group C - Patient 3-Feature

# More A, B, and C... kinda get to #s said by paper I guess...

#GSM6346296	A5-B14 GSM6346296_A5-B14-filtered_feature_bc_matrix.tar.gz
#GSM6346301	A5-B14-TCR GSM6346301_A5-B14-filtered_contig_annotations.csv.gz
#GSM6346306	A5-B14-Feature
# A5 (Group A, Hash4-TotalSeqC), B14 (Group B, Hash3-TotalSeqC)

#GSM6346297	A6-A9-B13-B9-TCR GSM6346297_A6-A9-B13-B9-filtered_contig_annotations.csv.gz
#GSM6346302	A6-A9-B13-B9-Feature 
#GSM6346292	A6-A9-B13-B9 GSM6346292_A6-A9-B13-B9-filtered_feature_bc_matrix.tar.gz
# A6 (Group A, Hash1-TotalSeqC), A9 (Group A, Hash2-TotalSeqC), B9 (Group B, Hash3-TotalSeqC), B13 (Group B, Hash4-TotalSeqC)

#GSM6346303	A8-B11-Feature
#GSM6346293	A8-B11 GSM6346293_A8-B11-filtered_feature_bc_matrix.tar.gz
#GSM6346298	A8-B11-TCR GSM6346298_A8-B11-filtered_contig_annotations.csv.gz
# A8 (Group A, Hash4-TotalSeqC), B11 (Group B, Hash3-TotalSeqC)

#GSM6346304	B12-MCE6-MCE7-Feature
#GSM6346299	B12-MCE6-MCE7-TCR GSM6346299_B12-MCE6-MCE7-filtered_contig_annotations.csv.gz
#GSM6346294	B12-MCE6-MCE7 GSM6346294_B12-MCE6-MCE7-filtered_feature_bc_matrix.tar.gz
# B12 (Group B, Hash4-TotalSeqC), MCE6 (Group C, Hash 1-TotalSeqC), MCE7 (Group C, Hash2-TotalSeqC)

#GSM6346300	A10-B10-MCE12-MCE13-TCR GSM6346300_A10-B10-MCE12-MCE13-filtered_contig_annotations.csv.gz
#GSM6346305	A10-B10-MCE12-MCE13-Feature
#GSM6346295	A10-B10-MCE12-MCE13 GSM6346295_A10-B10-MCE12-MCE13-filtered_feature_bc_matrix.tar.gz
# A10 (Group A, Hash3-TotalSeqC), B10 (Group B, Hash4-TotalSeqC), MCE12 (Group C, Hash1-TotalSeqC), MCE13 (Group C, Hash2-TotalSeqC)

# 6/6 no ICI controls accounted for (.rds files in hc_rds subfolder)

```

# Calculate percent mitochondrial, ribosomal, hemoglobin features

```{r}

heart_t_cells[["percent_mito"]] <- PercentageFeatureSet(heart_t_cells, pattern = "^MT-")
heart_t_cells[["percent_ribo"]] <- PercentageFeatureSet(heart_t_cells, pattern = "^RP[SL]")
heart_t_cells[["percent_hb"]] <- PercentageFeatureSet(heart_t_cells, pattern = "HB[^(P)]")

```

# Count number of cells from all samples

```{r}

length(colnames(heart_t_cells)) # 278794 cells

View(heart_t_cells)

```

# Count cells per each of the 21 (yet to be dehashed) samples

```{r}

cell_capture <- heart_t_cells@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Visualize QC metrics across all patient samples

```{r}

vln_plot <- VlnPlot(heart_t_cells, features = c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo"), ncol = 4, pt.size=0)

# Loop through each panel and remove x-axis text
for (i in 1:4) {
  vln_plot[[i]] <- vln_plot[[i]] + theme(axis.text.x = element_blank())
}

vln_plot

ggsave(vln_plot, file = "../figures/vln_plot_qc.svg")

```

# Set author QC metric thresholds

```{r}

qcMetricsThresholds <-
  c(
    "nFeature_RNA_min" = 500,
    
    "percent_mito" = 15
  )

```

# Plot distributions of nFeature_RNA across samples

```{r}

nFeature_RNA_QC <- ggplot(heart_t_cells@meta.data, mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed")
ggsave(nFeature_RNA_QC, file = "../figures/nFeature_RNA.svg")

nFeature_RNA_QC

```

# Plot distributions of nCount_RNA across samples

```{r}

nCount_RNA_QC <- ggplot(heart_t_cells@meta.data, mapping = aes(x = nCount_RNA)) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10()
ggsave(nCount_RNA_QC, file = "../figures/nCount_RNA.svg")

nCount_RNA_QC

```

# Plot distributions of percent mito across samples

```{r}

percent_mt_QC <- ggplot(heart_t_cells@meta.data, mapping = aes(x = percent_mito + 1/length(colnames(heart_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["percent_mito"],
             color = "red", linetype = "dashed") +
  xlab("percent_mito (with pseudocount)")
ggsave(percent_mt_QC, file = "../figures/percent_mt.svg")

percent_mt_QC

```

# Plot distributions of percent ribo across samples

```{r}

percent_rb_QC <- ggplot(heart_t_cells@meta.data, mapping = aes(x = percent_ribo + 1/length(colnames(heart_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  xlab("percent_ribo (with pseudocount)")
ggsave(percent_rb_QC, file = "../figures/percent_rb.svg")

percent_rb_QC

```

# Plot distributions of percent hemoglobin across samples

```{r}

percent_hb_QC <- ggplot(heart_t_cells@meta.data, mapping = aes(x = percent_hb + 1/length(colnames(heart_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  xlab("percent_hb (with pseudocount)")

ggsave(percent_hb_QC, file = "../figures/percent_hb.svg")

percent_hb_QC

```

# Filter cells based on QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    heart_t_cells, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      heart_t_cells, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(heart_t_cells), cellsKeep)
length(cellsDrop) # 55,079 cells dropped from analysis

heart_t_cells_filtered <-
  subset(heart_t_cells, cells = cellsKeep)

length(colnames(heart_t_cells_filtered)) # 223,715 cells left behind in filtered data

```

# Count cells by (yet to be dehashed) sample after QC filtering

```{r}

cell_capture <- heart_t_cells_filtered@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Normalize cell numbers across samples
 - retain a final number of ~48k cells

# Save RDS file

```{r}

saveRDS(heart_t_cells_filtered, "../saved_data/qc_filtered.rds")

```