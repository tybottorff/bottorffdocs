---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Find CDR3 sequences differentially encountered in yes/no irAE

```{r}

diff_df <- feature_df %>%
  select(cdr3, chain, Patient_ID, irAE, predicted.celltype.l1) %>%
  filter(cdr3 != "None",
         chain != "Multi") %>%
  select(-Patient_ID) %>%
  group_by(cdr3, irAE, chain) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = c(irAE, chain), values_from = count, values_fill = 0) %>%
  rowwise() %>%
  mutate(tra_diff = abs(No_TRA - Yes_TRA),
         trb_diff = abs(No_TRB - Yes_TRB)) %>%
  ungroup()

diff_df_tra <- diff_df %>%
  select(-No_TRB, -Yes_TRB, -trb_diff) %>%
  filter(tra_diff > 3) %>%
  arrange(-tra_diff)

diff_df_tra

diff_df_trb <- diff_df %>%
  select(-No_TRA, -Yes_TRA, -tra_diff) %>%
  filter(trb_diff > 3) %>%
  arrange(-trb_diff)

diff_df_trb

```

# Test patient bias (TRA, expect same for TRB)

```{r}

# looks like most dramatically differentially encountered CDR3 sequences are due to single patient bias

bias_df_tra <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3,
         chain == "TRA") %>%
  group_by(Patient_ID, cdr3) %>%
  summarize(count = n()) %>%
  arrange(cdr3, -count) %>%
  filter(cdr3 %in% head(diff_df_tra$cdr3))

bias_df_tra

```

# Plot CDR3 hydrophobicity and length by irAE development for differentially encountered CDR3 sequences

```{r}

plot_df <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB",
         predicted.celltype.l1 != "other T")

plot_df %>%
  group_by(predicted.celltype.l1, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(plot_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(plot_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRA",
         predicted.celltype.l1 == "CD8 T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot CDR3 hydrophobicity and length by irAE development for differentially encountered UNIQUE CDR3 sequences

```{r}

plot_df <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB",
         predicted.celltype.l1 != "other T") %>%
  group_by(cdr3, chain, Patient_ID) %>%
  slice(1)

plot_df %>%
  group_by(predicted.celltype.l1, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(plot_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(plot_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRA",
         predicted.celltype.l1 == "CD4 T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```