---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in non-control TCR-seq data

```{r}

data_directory <- "../raw_data"

# Identify the pattern to extract patient IDs using regular expressions
pattern <- "GSM\\d+_([A-Z\\d\\-]+)-filtered_contig_annotations"

# Get a list of CSV files in the directory
csv_files <- list.files(data_directory, pattern = ".csv", full.names = TRUE)

# Initialize an empty list to store data frames
data_frames <- list()

# Loop through the list of CSV files
for (file in csv_files) {
  # Extract patient ID from the file name using regex
  patient_id <- gsub("GSM(\\d+)_(.*?)\\-filtered_contig_annotations.csv", "\\2", basename(file))
  
  # Read the CSV file into a data frame
  df <- read.csv(file)
  
  # Add a column for patient ID
  df$Patient_ID <- patient_id
  
  # Append the data frame to the list
  data_frames[[patient_id]] <- df
  
}

# Combine all data frames into a single data frame
combined_tcr_seq <- bind_rows(data_frames)

```

# Read in dehashed RDS

```{r}

dehashed <- readRDS("../saved_data/dehashed.rds")

```

# Dehash TCRseq data, lose some barcodes in process (0-lets, multiplets, no hash marker)

```{r}

A6 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A6-A9-B13-B9"),
         barcode %in% colnames(dehashed$A6)) %>%
  mutate(Patient_ID = "A6")

A9 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A6-A9-B13-B9"),
         barcode %in% colnames(dehashed$A9)) %>%
  mutate(Patient_ID = "A9")

B13 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A6-A9-B13-B9"),
         barcode %in% colnames(dehashed$B13)) %>%
  mutate(Patient_ID = "B13")

B9 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A6-A9-B13-B9"),
         barcode %in% colnames(dehashed$B9)) %>%
  mutate(Patient_ID = "B9")

A8 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A8-B11"),
         barcode %in% colnames(dehashed$A8)) %>%
  mutate(Patient_ID = "A8")

B11 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A8-B11"),
         barcode %in% colnames(dehashed$B11)) %>%
  mutate(Patient_ID = "B11")

B12 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("B12-MCE6-MCE7"),
         barcode %in% colnames(dehashed$B12)) %>%
  mutate(Patient_ID = "B12")

MCE6 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("B12-MCE6-MCE7"),
         barcode %in% colnames(dehashed$MCE6)) %>%
  mutate(Patient_ID = "MCE6")

MCE7 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("B12-MCE6-MCE7"),
         barcode %in% colnames(dehashed$MCE7)) %>%
  mutate(Patient_ID = "MCE7")

A10 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A10-B10-MCE12-MCE13"),
         barcode %in% colnames(dehashed$A10)) %>%
  mutate(Patient_ID = "A10")

B10 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A10-B10-MCE12-MCE13"),
         barcode %in% colnames(dehashed$B10)) %>%
  mutate(Patient_ID = "B10")

MCE12 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A10-B10-MCE12-MCE13"),
         barcode %in% colnames(dehashed$MCE12)) %>%
  mutate(Patient_ID = "MCE12")

MCE13 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A10-B10-MCE12-MCE13"),
         barcode %in% colnames(dehashed$MCE13)) %>%
  mutate(Patient_ID = "MCE13")

A5 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A5-B14"),
         barcode %in% colnames(dehashed$A5)) %>%
  mutate(Patient_ID = "A5")

B14 <- combined_tcr_seq %>%
  filter(Patient_ID %in% c("A5-B14"),
         barcode %in% colnames(dehashed$B14)) %>%
  mutate(Patient_ID = "B14")

dehashed_combined_tcr_seq <- combined_tcr_seq %>%
  filter(!(Patient_ID %in% c("A5-B14", "A10-B10-MCE12-MCE13", "B12-MCE6-MCE7", "A6-A9-B13-B9", "A8-B11")),
         productive != "False")

# Define a list of data frames for each patient or barcode
patient_dataframes <- list(A6, A9, B13, B9, A8, B11, B12, MCE6, MCE7, A10, B10, MCE12, MCE13, A5, B14)

# Concatenate the data frames into a single data frame
dehashed_combined_tcr_seq <- bind_rows(dehashed_combined_tcr_seq, patient_dataframes)

dehashed_combined_tcr_seq <- dehashed_combined_tcr_seq %>%
  mutate(irAE = case_when(
    startsWith(Patient_ID, "A") ~ "No",
    startsWith(Patient_ID, "B") ~ "Yes",
    startsWith(Patient_ID, "M") ~ "Yes"))

dehashed_combined_tcr_seq

write.csv(dehashed_combined_tcr_seq, "../saved_data/dehashed_tcr_seq.csv")

```

# Prep for stitchr

```{r}
stitchr_data <- dehashed_combined_tcr_seq %>%
  filter(chain %in% c("TRA", "TRB")) %>%
  group_by(barcode) %>%
  filter(sum(chain == "TRA") == 1 & sum(chain == "TRB") == 1) %>%
  ungroup() %>%
  select(barcode, v_gene, d_gene, j_gene, c_gene, chain, cdr3_nt) %>%
  rename(TCR_name = barcode,
         CDR3 = `cdr3_nt`,
         V = `v_gene`,
         J = `j_gene`,
         C = `c_gene`) %>%
  pivot_wider(names_from = chain, values_from = c(V, J, C, CDR3)) %>%
  # rename, reorder, create cols for stitchr
  rename(TRAV = V_TRA, TRAJ = J_TRA, TRBV = V_TRB, TRBJ = J_TRB, TRAC = C_TRA, TRBC = C_TRB, TRA_CDR3 = CDR3_TRA, TRB_CDR3 = CDR3_TRB) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC) %>%
  filter_all(all_vars(!is.na(.))) %>%
  filter_all(all_vars(. != "None")) %>%
  mutate(TRA_leader	= NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA)

stitchr_data

# 32,089 rows

write.table(stitchr_data, file = "../saved_data/tcrseq_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE)

```

# Read in stitchr output

```{r}

stitchr_output <- read.delim("../saved_data/stitchr_out.tsv", header = TRUE, sep = "\t")

# Columns that need further separation by space
columns_to_split_by_space <- c("TRA_nt", "TRA_aa", "TRB_nt", "TRB_aa", "Linked_nt")

# Split the specified columns by space
for (col_name in columns_to_split_by_space) {
  stitchr_output[[col_name]] <- sapply(stitchr_output[[col_name]], function(x) unlist(strsplit(x, " ")))
}

# Assign the column names
colnames(stitchr_output) <- c("TCR_name", "TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "TRAV", "TRAJ", "TRA_CDR3", "TRBV", "TRBJ",
                    "TRB_CDR3", "TRAC", "TRBC", "TRA_leader", "TRB_leader", "Linker", "Link_order", 
                    "TRA_5_prime_seq", "TRA_3_prime_seq", "TRB_5_prime_seq", "TRB_3_prime_seq", "Linked_nt", 
                    "Linked_aa", "Warnings.Errors")

# Define a function to replace with NA if length is 0
replace_empty_with_na <- function(x) {
  if (length(x) == 0) {
    return(NA)
  } else {
    return(x)
  }
}

# Replace values in the specified columns with real NA
cols_to_update <- c("TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "Linked_nt")

for (col_name in cols_to_update) {
  stitchr_output[[col_name]] <- lapply(stitchr_output[[col_name]], replace_empty_with_na)
}

stitchr_output$TRA_nt <- sapply(stitchr_output$TRA_nt, as.character)
stitchr_output$TRA_aa <- sapply(stitchr_output$TRA_aa, as.character)
stitchr_output$TRB_nt <- sapply(stitchr_output$TRB_nt, as.character)
stitchr_output$TRB_aa <- sapply(stitchr_output$TRB_aa, as.character)
stitchr_output$Linked_nt <- sapply(stitchr_output$Linked_nt, as.character)

```

# Analyze stitchr errors. "Unable to locate N terminus of CDR3 in V gene correctly. Please ensure sequence plausibility" is main error for TRA/TRB

```{r}

filtered_results_list <- list()

for (i in 1:nrow(stitchr_output)) {
  # Split the row using the specified pattern and extract the relevant elements
  split_result <- strsplit(stitchr_output$Warnings.Errors[i], "\\(TRA\\)|\\(TRB\\)")[[1]]
  filtered_list <- split_result[grep("Cannot stitch", split_result)]
  
  # Store the filtered list for this row in the results list
  filtered_results_list[[i]] <- filtered_list
}

your_df <- data.frame(Column1 = unlist(unlist(filtered_results_list)))

# Optionally, rename the column
colnames(your_df) <- c("errors")

count_df <- your_df %>%
  group_by(errors) %>%
  summarize(count = n()) %>%
  arrange(-count)

count_df

# try to see if there are commonalities to V genes/CDR3s for issue-causing rows

errors <- stitchr_output %>%
  mutate(common_error = if_else(str_detect(Warnings.Errors, "Unable to locate N terminus of CDR3 in V gene correctly"), "Yes", "No")) %>%
  arrange(common_error) %>%
  select(TRA_CDR3, TRAV, TRB_CDR3, TRBV, common_error)

```

# Prep IGoR input

```{r}

stitchr_output_alpha_df <- stitchr_output %>%
  filter(!(is.na(TRA_nt)))

stitchr_output_alpha_df
# 9,475 rows

write.csv(stitchr_output_alpha_df, file = "../saved_data/igor_alpha_input.csv", row.names = FALSE)

stitchr_output_beta_df <- stitchr_output %>%
  filter(!(is.na(TRB_nt)))

stitchr_output_beta_df
# 22,053 rows

write.csv(stitchr_output_beta_df, file = "../saved_data/igor_beta_input.csv", row.names = FALSE)

```

# Read in IGoR output

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  rename(barcode = TCR_name) %>%
  left_join(dehashed_combined_tcr_seq, by = "barcode") %>%
  mutate(patient_group = case_when(
    startsWith(Patient_ID, "A") ~ "ici_no_irae",
    startsWith(Patient_ID, "B") ~ "ici_non_myocarditis_irae",
    startsWith(Patient_ID, "M") ~ "ici_myocarditis_irae")) %>%
  mutate(irAE = case_when(
    startsWith(Patient_ID, "A") ~ "No",
    startsWith(Patient_ID, "B") ~ "Yes",
    startsWith(Patient_ID, "M") ~ "Yes")) %>%
  select(patient_group, irAE, chain, pgen, barcode, cdr3) %>%
  filter(chain == "TRA",
         pgen != "NaN")

igor_combined <- read.csv("../saved_data/igor_output_beta.csv") %>%
  rename(barcode = TCR_name) %>%
  left_join(dehashed_combined_tcr_seq, by = "barcode") %>%
  mutate(patient_group = case_when(
    startsWith(Patient_ID, "A") ~ "ici_no_irae",
    startsWith(Patient_ID, "B") ~ "ici_non_myocarditis_irae",
    startsWith(Patient_ID, "M") ~ "ici_myocarditis_irae")) %>%
  mutate(irAE = case_when(
    startsWith(Patient_ID, "A") ~ "No",
    startsWith(Patient_ID, "B") ~ "Yes",
    startsWith(Patient_ID, "M") ~ "Yes")) %>%
  select(Patient_ID, patient_group, irAE, chain, pgen, barcode, cdr3) %>%
  filter(chain == "TRB",
         pgen != "NaN") %>%
  full_join(igor_alpha, by = c("barcode", "chain", "patient_group", "pgen", "cdr3", "irAE"))

igor_combined

```

# Plot pgen scores across all TCRs by irAE development

```{r}

ggplot(igor_combined, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "Chain", y = "-log10(pgen)")

# Filter the data for statistical test
test_data <- igor_combined %>%
  filter(chain == "TRA")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Prep IMGT/HighV-Quest input

```{r}

fasta_prep <- stitchr_output %>%
  rename(barcode = TCR_name) %>%
  left_join(dehashed_combined_tcr_seq, by = "barcode")

fasta_df_alpha <- fasta_prep %>%
  filter(!(is.na(TRA_nt)),
         chain == "TRA") %>%
  mutate(barcode = paste(barcode, Patient_ID, sep = "_")) %>%
  ungroup()

# Function to convert a data frame to FASTA format
df_to_fasta_alpha <- function(df, output_file) {
  # Open/create the output file for writing
  fasta_file <- file(output_file, "w")
  
  # Iterate through rows of the data frame
  for (i in 1:nrow(df)) {
    # Combine name columns and add a suffix numbering
    label <- df$barcode[i]

    # Write the sequence and label to the FASTA file
    writeLines(paste(">", label), con = fasta_file)
    writeLines(df$TRA_nt[i], con = fasta_file)
  }
  
  # Close the output file
  close(fasta_file)
}

# Call the function to convert the data frame to FASTA format
df_to_fasta_alpha(fasta_df_alpha, "../saved_data/vdjseq_alpha.fasta")

fasta_df_beta <- fasta_prep %>%
  filter(!(is.na(TRB_nt)),
         chain == "TRB") %>%
  mutate(barcode = paste(barcode, Patient_ID, sep = "_")) %>%
  ungroup()

# Function to convert a data frame to FASTA format
df_to_fasta_beta <- function(df, output_file) {
  # Open/create the output file for writing
  fasta_file <- file(output_file, "w")
  
  # Iterate through rows of the data frame
  for (i in 1:nrow(df)) {
    # Combine name columns and add a suffix numbering
    label <- df$barcode[i]

    # Write the sequence and label to the FASTA file
    writeLines(paste(">", label), con = fasta_file)
    writeLines(df$TRB_nt[i], con = fasta_file)
  }
  
  # Close the output file
  close(fasta_file)
}

# Call the function to convert the data frame to FASTA format
df_to_fasta_beta(fasta_df_beta, "../saved_data/vdjseq_beta.fasta")

```

# Analyze IMGT/HighV-Quest output 1: summary

```{r}

imgt_df_1_alpha <- read.csv("../saved_data/myocarditis_alpha/1_Summary.csv")
  #group_by(V.REGION.potential.ins.del) %>%
  #summarize(count = n())

imgt_df_1_alpha
# 7 productive
# 1762 rearranged but no junction found
# 4104 + 3602 (stop codons) unproductive

imgt_df_1_beta <- read.csv("../saved_data/myocarditis_beta/1_Summary.csv")
  #group_by(V.DOMAIN.Functionality) %>%
  #summarize(count = n())

imgt_df_1_beta
# 3502 productive
# 14592 rearranged but no junction found
# 2621 + 1338 (stop codons) unproductive

```

# Analyze IMGT/HighV-Quest output 8: V region nt mutation statistics

```{r}

imgt_df_8_alpha <- read.table("../saved_data/myocarditis_alpha/8_V-REGION-nt-mutation-statistics.txt", header = TRUE, sep = "\t") %>%
  select(-Sequence.number) %>%
  rename(Barcode = Sequence.ID)

colnames(imgt_df_8_alpha)[colnames(imgt_df_8_alpha) != "Barcode"] <- paste0(colnames(imgt_df_8_alpha)[colnames(imgt_df_8_alpha) != "Barcode"], "_alpha")

imgt_df_8_beta <- read.table("../saved_data/myocarditis_beta/8_V-REGION-nt-mutation-statistics.txt", header = TRUE, sep = "\t") %>%
  select(-Sequence.number) %>%
  rename(Barcode = Sequence.ID)

colnames(imgt_df_8_beta)[colnames(imgt_df_8_beta) != "Barcode"] <- paste0(colnames(imgt_df_8_beta)[colnames(imgt_df_8_beta) != "Barcode"], "_beta")
  
imgt_df_8 <- imgt_df_8_alpha %>%
  full_join(imgt_df_8_beta, by = "Barcode") %>%
  # too many columns, focus on CDR3 ones for now
  select(matches("^CDR3|^Barcode"))

# join with patient ID to get patient group --> plots

imgt_df_8

```