---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Prep hydrophobicity calculator

```{r}

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

```

# Read in final RNA T cell Seurat with TCR metadata

```{r}

tcr_rna <- readRDS("../saved_data/final_seurat_T_cells.rds")

```

# Tibble metadata, add rownames

```{r}

dehashed_combined_tcr_seq <- as_tibble(tcr_rna@meta.data)

dehashed_combined_tcr_seq$barcode <- colnames(tcr_rna)

dehashed_combined_tcr_seq <- dehashed_combined_tcr_seq %>%
  pivot_longer(cols = matches("(TRA|TRB)$"), names_to = c(".value", "Chain"), names_pattern = "(.*)_([A-Z]+)$")

dehashed_combined_tcr_seq

write.csv(dehashed_combined_tcr_seq, "../saved_data/dehashed_tcr_seq_with_rna.csv")

```

# Assess cell identity confidence

```{r}

cell_confidence_test <- dehashed_combined_tcr_seq %>%
  select(barcode, chain, cdr3, Patient_ID, irAE, predicted.celltype.l1, predicted.celltype.l1.score, predicted.celltype.l2, predicted.celltype.l2.score) %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n(), score1 = mean(predicted.celltype.l1.score), score2 = mean(predicted.celltype.l2.score))

cell_confidence_test

# unexpected combos have low scores, remove them

```

# Prep feature df

```{r}

feature_df <- dehashed_combined_tcr_seq %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  select(-cdr3_nt) %>%
  rowwise() %>%
  mutate(cdr3_length = nchar(cdr3),
         middle_5_cdr3 = substr(cdr3, ((nchar(cdr3) - 4) %/% 2 + 1), ((nchar(cdr3) - 4) %/% 2 + 1) + 4),
         cdr3_hydrophobicity = calculate_hydrophobicity(cdr3, hydrophobicity_df)) %>%
  mutate(middle_5_cdr3_hydrophobicity = calculate_hydrophobicity(middle_5_cdr3, hydrophobicity_df)) %>%
  ungroup()

write.csv(feature_df, "../saved_data/tcr_seq_features.csv")

feature_df_doubled <- feature_df %>%
  bind_rows(mutate(feature_df, predicted.celltype.l1 = "All T cells"))

feature_df_doubled

```

# Compare CDR3 hydrophobicitiy overall vs. middle 5 AAs

```{r}

ggplot(feature_df, aes(x = cdr3_hydrophobicity, y = middle_5_cdr3_hydrophobicity)) +
  geom_point(size = 0.1, alpha = 0.1) +
  labs(x = "CDR3 hydrophobicity\n(all AAs)",
       y = "CDR3 hydrophobicity\n(middle 5 AAs)") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red")

```

# Plot CDR3 length by irAE status and cell type (l1, l2)

```{r}

feature_df_doubled %>%
  group_by(chain, irAE, predicted.celltype.l1) %>%
  summarize(count = n()) %>%
  print()

feature_df %>%
  filter(str_detect(predicted.celltype.l2, "CD8")) %>%
  group_by(chain, irAE, predicted.celltype.l2) %>%
  summarize(count = n()) %>%
  print()

ggplot(feature_df_doubled, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(feature_df %>% filter(predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8")), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

# Filter the data for statistical test
test_data <- feature_df_doubled %>%
  filter(chain == "TRA",
         predicted.celltype.l1 == "other T",
         predicted.celltype.l2 == "MAIT")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_hydrophobicity ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Check for patient bias in CDR3 length conclusion for all TCRs

```{r}

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- feature_df_doubled %>%
  filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", chain == "TRA") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
feature_df_doubled <- feature_df_doubled %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(feature_df_doubled %>% filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", chain == "TRA"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRA CD8 CDR3 length") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- feature_df_doubled %>%
  filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", chain == "TRB") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
feature_df_doubled <- feature_df_doubled %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(feature_df_doubled %>% filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", chain == "TRB"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRB CD8 CDR3 length") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- feature_df_doubled %>%
  filter(predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 Proliferating", chain == "TRA") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
feature_df_doubled <- feature_df_doubled %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(feature_df_doubled %>% filter(predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 Proliferating", chain == "TRA"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRA CD8 Proliferating\nCDR3 length") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- feature_df_doubled %>%
  filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 TEM", chain == "TRA") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
feature_df_doubled <- feature_df_doubled %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(feature_df_doubled %>% filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 TEM", chain == "TRA"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRA CD8 TEM\nCDR3 length") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- feature_df_doubled %>%
  filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 TEM", chain == "TRB") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
feature_df_doubled <- feature_df_doubled %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(feature_df_doubled %>% filter(!(is.na(Patient_ID)), predicted.celltype.l1 == "CD8 T", predicted.celltype.l2 == "CD8 TEM", chain == "TRB"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRB CD8 TEM\nCDR3 length") +
  scale_x_discrete(limits = mean_values)

```

# Check N region and CDR3 length correlation

 - slopes not really close to 1 so... 1 nt longer N region would mean 1 nt longer CDR3 if they tightly correlated I'd think

```{r}

n_regions <- read.csv("../saved_data/imgt_n_regions.csv") %>%
  select(-X) %>%
  pivot_longer(cols = matches("(TRA|TRB)$"),
               names_to = c(".value", "Chain"),
               names_pattern = "(.*)_(TRA|TRB)$")

n_regions

merged_df <- feature_df %>%
  full_join(n_regions, by = c("barcode", "Chain")) %>%
  mutate(N.REGION_length = nchar(N.REGION),
         N1.REGION_length = nchar(N1.REGION),
         N2.REGION_length = nchar(N2.REGION),
         N3.REGION_length = nchar(N3.REGION))

merged_df

ggplot(merged_df %>% filter(N.REGION_length != 0), 
       aes(x = cdr3_length, y = N.REGION_length)) +
  geom_jitter(size = 0.25, alpha = 0.25) +
  facet_wrap(~ Chain) +
  labs(x = "CDR3 length",
       y = "N region length") +
  geom_smooth(method = "lm", se = FALSE, color = "blue")

```

# Plot N region length irAE status and cell type (l1)

```{r}

plot_df <- merged_df %>%
  filter(predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T"))

ggplot(plot_df, aes(x = chain, y = N.REGION_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "N region length (nt)")

plot_df <- merged_df %>%
  filter(predicted.celltype.l1 == "CD8 T")

ggplot(plot_df, aes(x = chain, y = N.REGION_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "N region length (nt)")

```

# Plot CDR3 hydrophobicity by irAE status and cell type (l1, l2)

```{r}

ggplot(feature_df_doubled, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(all AAs)")

ggplot(feature_df_doubled, aes(x = chain, y = middle_5_cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(middle 5 AAs)")

ggplot(feature_df_doubled %>% filter(predicted.celltype.l1 == "other T"), aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(all As)")

ggplot(feature_df_doubled %>% filter(predicted.celltype.l1 == "other T"), aes(x = chain, y = middle_5_cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(middle 5 AAs)")

ggplot(feature_df_doubled %>% filter(predicted.celltype.l1 == "CD8 T"), aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(all As)")

ggplot(feature_df_doubled %>% filter(predicted.celltype.l1 == "CD8 T"), aes(x = chain, y = middle_5_cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity\n(middle 5 AAs)")

```

# Investigate Treg hydrophobicity

 - hypothesis: more hydrophobic Tregs might be more crossreactive and more often be shunted into Treg fate during development in the thymus (i.e. rather than be deleted be shunted to Treg fate if too high affinity to self pMHC)
 
 - doesn't seem to differ at all though

```{r}

tregs <- feature_df %>%
  mutate(is_treg = if_else(predicted.celltype.l2 == "Treg", "Yes", "No"))

ggplot(tregs, aes(x = is_treg, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  labs(x = "Treg status", fill = "irAE", y = "CDR3 hydrophobicity\n(all As)")

```

# Plot CDR3 length and hydrophobicity by irAE status and cell type (l1, l2) for UNIQUE TCRs

```{r}

feature_df_doubled_unique <- feature_df_doubled %>%
  group_by(cdr3, chain, Patient_ID) %>%
  slice(1)

ggplot(feature_df_doubled_unique, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(feature_df_doubled_unique, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

```

# Plot CDR3 length and hydrophobicity by irAE status and cell type (l1, l2) for most expanded CDR3s

```{r}

expansion_df <- feature_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

expansion_df %>%
  group_by(predicted.celltype.l1, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(expansion_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- expansion_df %>%
  filter(chain == "TRB",
         predicted.celltype.l1 == "CD4 T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot CD8 TEM CDR3 length by irAE status and expansion degree

```{r}

expansion_df <- feature_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

expansion_df$expansion_degree <- factor(expansion_df$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper\nexpanded"))

ggplot(expansion_df %>% filter(predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 == "CD8 TEM"), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CD8 TEM CDR3 length")

expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM") %>%
  group_by(expansion_degree, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- expansion_df %>%
  filter(chain == "TRB",
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         expansion_degree == "Hyperexpanded")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Check for patient bias in CDR3 length conclusion for highly expanded CD8s

```{r}

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T", expansion_degree %in% c("Large", "Hyperexpanded"), chain == "TRA") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
expansion_df <- expansion_df %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(expansion_df %>% filter(predicted.celltype.l1 == "CD8 T", expansion_degree %in% c("Large", "Hyperexpanded"), chain == "TRA"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRA CD8\nCDR3 length") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T", expansion_degree %in% c("Large", "Hyperexpanded"), chain == "TRB") %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(cdr3_length)) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
expansion_df <- expansion_df %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(expansion_df %>% filter(predicted.celltype.l1 == "CD8 T", expansion_degree %in% c("Large", "Hyperexpanded"), chain == "TRB"), aes(x = Patient_ID, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRB CD8\nCDR3 length") +
  scale_x_discrete(limits = mean_values)

```

# Plot CDR3 length and hydrophobicity by irAE status and cell type (l1, l2) for most expanded, unique CDR3s

```{r}

expansion_df_unique <- feature_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  slice(1)

expansion_df_unique %>%
  group_by(predicted.celltype.l1, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df_unique, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(expansion_df_unique, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

```

# Plot CD8 TEM CDR3 length by irAE status and expansion degree for unique TCRs

```{r}

expansion_df_unique <- feature_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  group_by(cdr3, Patient_ID, chain) %>%
  slice(1)

expansion_df_unique$expansion_degree <- factor(expansion_df_unique$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper\nexpanded"))

expansion_df_unique %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM") %>%
  group_by(expansion_degree, irAE, chain) %>%
  summarize(count = n()) %>%
  print()

ggplot(expansion_df_unique %>% filter(predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 == "CD8 TEM"), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CD8 TEM CDR3 length")

# Filter the data for statistical test
test_data <- expansion_df_unique %>%
  filter(chain == "TRB",
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         expansion_degree == "Large")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Import pgen data

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  rename(TRA_pgen = pgen) %>%
  filter(!(is.na(TRA_pgen)),
         TRA_pgen != "NaN")

igor_combined <- read.csv("../saved_data/igor_output_beta.csv") %>%
  rename(TRB_pgen = pgen) %>%
  filter(!(is.na(TRB_pgen)),
         TRB_pgen != "NaN") %>%
  full_join(igor_alpha, by = c("TCR_name", "TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "TRAV", "TRAJ", "TRA_CDR3", "TRBV", "TRBJ", "TRB_CDR3", "TRAC", "TRBC", "TRA_leader", "TRB_leader", "Linker", "Link_order", "TRA_5_prime_seq", "TRA_3_prime_seq", "TRB_5_prime_seq", "TRB_3_prime_seq", "Linked_nt", "Linked_aa", "Warnings.Errors")) %>%
  select(TCR_name, TRA_CDR3, TRB_CDR3, TRA_pgen, TRB_pgen) %>%
  mutate(TRA_pgen = as.character(TRA_pgen),
         TRB_pgen = as.character(TRB_pgen))

igor_combined <- igor_combined %>%
  pivot_longer(cols = matches("^(TRA|TRB)"),
               names_to = c("Chain", ".value"),
               names_pattern = "^(TRA|TRB)_(.*)$") %>%
  rename(barcode = TCR_name,
         cdr3 = CDR3) %>%
  mutate(pgen = as.numeric(pgen)) %>%
  full_join(feature_df, by = c("barcode", "Chain", "cdr3"))

igor_combined

```

# Plot pgen scores by cell type for all TCRs

```{r}

plot_df <- igor_combined %>%
  filter(!(is.na(predicted.celltype.l1)))

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

# Filter the data for statistical test
test_data <- igor_combined %>%
  filter(!(is.na(predicted.celltype.l1))) %>%
  filter(chain == "TRA",
         predicted.celltype.l1 == "other T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

plot_df <- igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T")

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

# Filter the data for statistical test
test_data <- igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T") %>%
  filter(chain == "TRA",
         predicted.celltype.l2 == "CD8 TEM")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

# Higher log10(pgen) means lower pgen which means less germline-like
# lower log10(pgen) means higher pgen which means more germline-like

```

# Plot pgen scores by cell type for highly expanded T cells

```{r}

plot_df <- igor_combined %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 %in% c("CD4 T", "CD8 T"))

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

plot_df <- igor_combined %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 %in% c("CD4 T", "CD8 T")) %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  slice(1)

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

# Higher log10(pgen) means lower pgen which means less germline-like
# lower log10(pgen) means higher pgen which means more germline-like

```

# Check for patient bias in pgen conclusion

```{r}

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T", chain == "TRA", !(is.na(pgen))) %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(log10(pgen))) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
igor_combined <- igor_combined %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(igor_combined %>% filter(predicted.celltype.l1 == "CD8 T", chain == "TRA"), aes(x = Patient_ID, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRA CD8\nlog10(pgen)") +
  scale_x_discrete(limits = mean_values)

# Calculate mean values for each combination of Patient_ID and chain
mean_values <- igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T", chain == "TRB", !(is.na(pgen))) %>%
  group_by(Patient_ID) %>%
  summarize(Mean = mean(log10(pgen))) %>%
  arrange(Mean) %>%
  pull(Patient_ID)

# Reorder the levels of the Patient_ID variable based on mean values within each chain
igor_combined <- igor_combined %>%
  mutate(Patient_ID = factor(Patient_ID, levels = mean_values))

# Create the boxplot
ggplot(igor_combined %>% filter(predicted.celltype.l1 == "CD8 T", chain == "TRB"), aes(x = Patient_ID, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) +
  labs(x = "Patient ID", fill = "irAE", y = "TRB CD8\nlog10(pgen)") +
  scale_x_discrete(limits = mean_values)

```

# Check CDR1/2s for length/hydrophobicity trends by irAE development/cell type

```{r}

cdr1_2 <- read.csv("../saved_data/imgt_cdr1_2.csv") %>%
  select(-X)

new_colnames <- c("barcode", "cdr1", "cdr2", "Chain")

colnames(cdr1_2) <- new_colnames

merged_df <- cdr1_2 %>%
  left_join(feature_df %>% select(-cdr1, -cdr2), by = c("barcode", "Chain")) %>%
  rowwise() %>%
  mutate(cdr1_hydrophobicity = calculate_hydrophobicity(cdr1, hydrophobicity_df),
         cdr2_hydrophobicity = calculate_hydrophobicity(cdr2, hydrophobicity_df)) %>%
  ungroup() %>%
  filter(predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T"),
         Chain %in% c("TRA", "TRB"))

merged_df

```

# Plot CDR1/2 features by irAE status and cell type (l1, l2)

```{r}

ggplot(merged_df, aes(x = chain, y = nchar(cdr1), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR1 length")

ggplot(merged_df, aes(x = chain, y = nchar(cdr2), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR2 length")

ggplot(merged_df, aes(x = chain, y = cdr1_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR1 hydrophobicity")

ggplot(merged_df, aes(x = chain, y = cdr2_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR2 hydrophobicity")

```

# Plot CDR1/2 features by irAE status and cell type (l1, l2) for most expanded T cells

```{r}

expansion_df <- merged_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

ggplot(expansion_df, aes(x = chain, y = nchar(cdr1), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR1 length")

ggplot(expansion_df, aes(x = chain, y = nchar(cdr2), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR2 length")

ggplot(expansion_df, aes(x = chain, y = cdr1_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR1 hydrophobicity")

ggplot(expansion_df, aes(x = chain, y = cdr2_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR2 hydrophobicity")

```