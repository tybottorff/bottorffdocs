---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Prep hydrophobicity calculator

```{r}

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

```

# Read in data

```{r}

dehashed_combined_tcr_seq <- as_tibble(readRDS("../saved_data/final_seurat_T_cells.rds")@meta.data) %>%
  pivot_longer(cols = matches("(TRA|TRB)$"), names_to = c(".value", "Chain"), names_pattern = "(.*)_([A-Z]+)$")

dehashed_combined_tcr_seq

write.csv(dehashed_combined_tcr_seq, "../saved_data/dehashed_tcr_seq_with_rna.csv")

```

# Prep feature df

```{r}

feature_df <- dehashed_combined_tcr_seq %>%
  select(-cdr3_nt) %>%
  rowwise() %>%
  mutate(cdr3_length = nchar(cdr3),
         cdr3_hydrophobicity = calculate_hydrophobicity(cdr3, hydrophobicity_df)) %>%
  ungroup()

feature_df

```

# Plot CDR3 length and hydrophobicity by irAE status and cell type (l1, l2)

```{r}

feature_df %>%
  group_by(chain, irAE, predicted.celltype.l1) %>%
  summarize(count = n()) %>%
  print()

ggplot(feature_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(feature_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

ggplot(feature_df %>% filter(predicted.celltype.l1 != "CD4 T"), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(feature_df %>% filter(predicted.celltype.l1 != "CD4 T"), aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- feature_df %>%
  filter(chain == "TRA",
         predicted.celltype.l1 == "CD8 T")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot CDR3 length and hydrophobicity by irAE status and cell type (l1, l2) for most expanded CDR3s

```{r}

expansion_df <- feature_df %>%
  group_by(Patient_ID, cdr3) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Medium", "Large", "Hyperexpanded"))

ggplot(expansion_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(expansion_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

ggplot(expansion_df %>% filter(predicted.celltype.l1 != "CD4 T"), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(expansion_df %>% filter(predicted.celltype.l1 != "CD4 T"), aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

```

# Find CDR3 sequences differentially encountered in yes/no irAE

```{r}

diff_df <- feature_df %>%
  select(barcode, cdr3, chain, Patient_ID) %>%
  filter(cdr3 != "None",
         chain != "Multi") %>%
  mutate(irAE = case_when(
    startsWith(Patient_ID, "A") ~ "No",
    startsWith(Patient_ID, "B") ~ "Yes",
    startsWith(Patient_ID, "M") ~ "Yes")) %>%
  select(-Patient_ID) %>%
  group_by(cdr3, irAE, chain) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = c(irAE, chain), values_from = count, values_fill = 0) %>%
  rowwise() %>%
  mutate(tra_diff = abs(No_TRA - Yes_TRA),
         trb_diff = abs(No_TRB - Yes_TRB)) %>%
  ungroup()

diff_df_tra <- diff_df %>%
  select(-No_TRB, -Yes_TRB, -trb_diff) %>%
  filter(tra_diff > 3) %>%
  arrange(-tra_diff)

diff_df_tra

diff_df_trb <- diff_df %>%
  select(-No_TRA, -Yes_TRA, -tra_diff) %>%
  filter(trb_diff > 3) %>%
  arrange(-trb_diff)

diff_df_trb

```

# Test patient bias (TRA, expect same for TRB)

```{r}

# looks like most dramatically differentially encountered CDR3 sequences are due to single patient bias

bias_df_tra <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3,
         chain == "TRA") %>%
  group_by(Patient_ID, cdr3) %>%
  summarize(count = n()) %>%
  arrange(cdr3, -count) %>%
  filter(cdr3 %in% head(diff_df_tra$cdr3))

bias_df_tra

```

# Plot CDR3 hydrophobicity and length by irAE development for differentially encountered CDR3 sequences

```{r}

custom_labeller <- as_labeller(c("cdr3_length" = "CDR3\nAA length", "cdr3_hydrophobicity" = "CDR3\nhydrophobicity"))

plot_df <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB") %>%
  pivot_longer(cols = starts_with("cdr3_"), values_to = "value") %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = value, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "Value")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRB",
         name == "cdr3_hydrophobicity")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$value ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot CDR3 hydrophobicity and length by irAE development for differentially encountered CDR3 sequences IGNORING HOW MANY TIMES EACH APPEARS

```{r}

custom_labeller <- as_labeller(c("cdr3_length" = "CDR3\nAA length", "cdr3_hydrophobicity" = "CDR3\nhydrophobicity"))

plot_df <- feature_df %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB") %>%
  group_by(cdr3, chain, irAE) %>%
  slice(1) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("cdr3_"), values_to = "value") %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = value, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "Value")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRB",
         name == "cdr3_length")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$value ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot pgen for differentially encountered CDR3 sequences

```{r}

plot_df <- igor_combined %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB")

ggplot(plot_df, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "Chain", y = "-log10(pgen)")

```

# Plot pgen for differentially encountered CDR3 sequences IGNORING HOW MANY TIMES EACH APPEARS

```{r}

plot_df <- igor_combined %>%
  filter(cdr3 %in% diff_df_tra$cdr3 & chain == "TRA" | cdr3 %in% diff_df_trb$cdr3 & chain == "TRB") %>%
  group_by(cdr3, chain, patient_group) %>%
  slice(1) %>%
  ungroup()

ggplot(plot_df, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "Chain", y = "-log10(pgen)")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Look at public TCRs only

```{r}

alpha_public_df <- feature_df %>%
  select(barcode, cdr3, chain, Patient_ID) %>%
  filter(cdr3 != "None",
         chain == "TRA") %>%
  group_by(cdr3, Patient_ID) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(presence = if_else(count > 0, 1, 0)) %>%
  # 1 for yes, 0 for no for presence, then later filter for sum across rows > 1 look for public TCRs
  select(-count) %>%
  pivot_wider(names_from = c(Patient_ID), values_from = presence, values_fill = 0) %>%
  rowwise() %>%
  filter(sum(c_across(-cdr3)) > 1)

alpha_public_df

beta_public_df <- feature_df %>%
  select(barcode, cdr3, chain, Patient_ID) %>%
  filter(cdr3 != "None",
         chain == "TRB") %>%
  group_by(cdr3, Patient_ID) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  mutate(presence = if_else(count > 0, 1, 0)) %>%
  # 1 for yes, 0 for no for presence, then later filter for sum across rows > 1 look for public TCRs
  select(-count) %>%
  pivot_wider(names_from = c(Patient_ID), values_from = presence, values_fill = 0) %>%
  rowwise() %>%
  filter(sum(c_across(-cdr3)) > 1)

beta_public_df

public_feature_df <- feature_df %>%
  filter(cdr3 %in% alpha_public_df$cdr3 & chain == "TRA" | cdr3 %in% beta_public_df$cdr3 & chain == "TRB")

public_igor_df <- igor_combined %>%
  filter(cdr3 %in% alpha_public_df$cdr3 & chain == "TRA" | cdr3 %in% beta_public_df$cdr3 & chain == "TRB")

```

# Plot CDR3 hydrophobicity and length by irAE status for public TCRs

```{r}

custom_labeller <- as_labeller(c("cdr3_length" = "CDR3\nAA length", "cdr3_hydrophobicity" = "CDR3\nhydrophobicity"))

plot_df <- public_feature_df %>%
  pivot_longer(cols = starts_with("cdr3_"), values_to = "value") %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = value, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "Value")

```

# Plot CDR3 hydrophobicity and length by irAE status for public TCRs IGNORING HOW MANY TIMES EACH APPEARS

```{r}

custom_labeller <- as_labeller(c("cdr3_length" = "CDR3\nAA length", "cdr3_hydrophobicity" = "CDR3\nhydrophobicity"))

plot_df <- public_feature_df %>%
  filter(chain != "Multi") %>%
  group_by(cdr3, chain, irAE) %>%
  slice(1) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("cdr3_"), values_to = "value")

ggplot(plot_df, aes(x = chain, y = value, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "Value")

```

# Plot pgen scores by irAE development for public TCRs

```{r}

ggplot(public_igor_df, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "Chain", y = "-log10(pgen)")

```

# Stratify analysis by expansion degree

```{r}

feature_df <- feature_df %>%
  group_by(Patient_ID, cdr3) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

feature_df$expansion_degree <- factor(feature_df$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper-\nexpanded"))

plot_df <- feature_df %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length (AA)")

ggplot(plot_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRA",
         expansion_degree == "Large")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

igor_combined <- igor_combined %>%
  group_by(Patient_ID, cdr3) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

igor_combined$expansion_degree <- factor(igor_combined$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

ggplot(igor_combined, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree) +
  labs(x = "Chain", y = "-log10(pgen)")

```

# Stratify analysis by expansion degree FOR JUST UNIQUE TCRs

```{r}

unique_feature_df <- feature_df %>%
  group_by(Patient_ID, cdr3) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  group_by(cdr3, chain, Patient_ID) %>%
  slice(1) %>%
  ungroup()

unique_feature_df$expansion_degree <- factor(unique_feature_df$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

custom_labeller <- as_labeller(c("Single" = "Single", "Small" = "Small", "Medium" = "Medium", "Large" = "Large", "Hyperexpanded" = "Hyper-\nexpanded"))

plot_df <- unique_feature_df %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length (AA)")

ggplot(plot_df, aes(x = chain, y = cdr3_hydrophobicity, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "irAE", y = "CDR3 hydrophobicity")

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(chain == "TRB",
         expansion_degree == "Large")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

unique_igor_combined <- igor_combined %>%
  group_by(Patient_ID, cdr3) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  slice(1) %>%
  ungroup()

unique_igor_combined$expansion_degree <- factor(unique_igor_combined$expansion_degree, levels = c("Single", "Small", "Medium", "Large", "Hyperexpanded"))

ggplot(unique_igor_combined, aes(x = chain, y = -log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~expansion_degree) +
  labs(x = "Chain", y = "-log10(pgen)")

```

# Compare normalized abundances of dual alpha TCRs by irAE development

```{r}

multiple_tra_trb_df <- feature_df %>%
  filter(chain %in% c("TRA", "TRB")) %>%
  group_by(barcode, Patient_ID) %>%
  mutate(alphas_per_cell = sum(chain == "TRA"),
         betas_per_cell = sum(chain == "TRB")) %>%
  ungroup() %>%
  group_by(Patient_ID) %>%
  mutate(one_one = sum(alphas_per_cell == 1 & betas_per_cell == 1) / n(),
         alpha_over_one = sum(alphas_per_cell > 1) / n(),
         beta_over_one = sum(betas_per_cell > 1) / n()) %>%
  ungroup() %>%
  select(Patient_ID, irAE, one_one, alpha_over_one, beta_over_one, expansion_degree) %>%
  group_by(Patient_ID) %>%
  slice(1) %>%
  ungroup() %>%
  pivot_longer(cols = -c(Patient_ID, irAE, expansion_degree), values_to = "value")

multiple_tra_trb_df

ggplot(multiple_tra_trb_df, aes(x = name, y = value, fill = irAE)) +
  geom_boxplot() +
  #facet_wrap(~ expansion_degree) +
  labs(x = "Category", fill = "irAE", y = "Frequency") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Filter the data for statistical test
test_data <- multiple_tra_trb_df %>%
  filter(name == "alpha_over_one")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$value ~ test_data$irAE)

# Print the results
print(wilcox_result)

```