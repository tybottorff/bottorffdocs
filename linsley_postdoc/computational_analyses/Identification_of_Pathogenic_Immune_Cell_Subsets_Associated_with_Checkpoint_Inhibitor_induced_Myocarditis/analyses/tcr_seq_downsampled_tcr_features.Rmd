---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)
library(scales)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in final RNA T cell Seurat with TCR metadata

```{r}

tcr_rna <- readRDS("../saved_data/final_seurat_T_cells.rds")

```

# Tibble metadata, add rownames

```{r}

dehashed_combined_tcr_seq <- as_tibble(tcr_rna@meta.data)

dehashed_combined_tcr_seq$barcode <- colnames(tcr_rna)

dehashed_combined_tcr_seq <- dehashed_combined_tcr_seq %>%
  pivot_longer(cols = matches("(TRA|TRB)$"), names_to = c(".value", "Chain"), names_pattern = "(.*)_([A-Z]+)$") %>%
  mutate(time_point = ifelse(grepl("[EL]", Patient_ID), sub(".*([EL]).*", "\\1", Patient_ID), NA), Patient_ID = gsub("[EL]", "", Patient_ID))

dehashed_combined_tcr_seq

write.csv(dehashed_combined_tcr_seq, "../saved_data/dehashed_tcr_seq_with_rna.csv")

```

# Assess cell identity confidence

```{r}

cell_confidence_test <- dehashed_combined_tcr_seq %>%
  select(barcode, chain, cdr3, Patient_ID, irAE, predicted.celltype.l1, predicted.celltype.l1.score, predicted.celltype.l2, predicted.celltype.l2.score) %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n(), score1 = mean(predicted.celltype.l1.score), score2 = mean(predicted.celltype.l2.score))

cell_confidence_test

# unexpected combos have low scores, remove them

```

# Prep feature df

```{r}

feature_df <- dehashed_combined_tcr_seq %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  select(-cdr3_nt) %>%
  rowwise() %>%
  mutate(cdr3_length = nchar(cdr3)) %>%
  ungroup() %>%
  mutate(group = case_when(
    startsWith(Patient_ID, "B") ~ "non-myocarditis irAE",
    startsWith(Patient_ID, "M") ~ "myocarditis irAE",
    startsWith(Patient_ID, "A") ~ "no irAE",
    TRUE ~ "other"  # Add a default condition if none of the above match
  ))

write.csv(feature_df, "../saved_data/tcr_seq_features.csv")

feature_df

```

# Examine patient sampling depth bias

```{r}

feature_df %>%
  group_by(Patient_ID, irAE) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  print()

# Choose 328 seqs from non B10 samples to downsample all to 328

```

# Normalize cell numbers across samples

```{r}

desired_rows_per_patient <- 328/2
# /2 to get equal numbers of each chain (TRA and TRB)

set.seed(123)

# Downsample the dataframe
downsampled_df <- feature_df %>%
  group_by(Patient_ID, Chain) %>%
  sample_n(desired_rows_per_patient, replace = FALSE) %>%
  ungroup()

downsampled_df

downsampled_df_doubled <- downsampled_df %>%
  bind_rows(mutate(downsampled_df, predicted.celltype.l1 = "All T cells"))

downsampled_df_doubled

```

# Look at public vs. private

```{r}

downsampled_public_df <- downsampled_df %>%
  group_by(cdr3, v_gene, j_gene, c_gene) %>%
  filter(n_distinct(Patient_ID) > 1) %>%
  select(Patient_ID, cdr3) %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = ""))

downsampled_public_df

downsampled_df <- downsampled_df %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  mutate(publicness = if_else(clonotype %in% downsampled_public_df$clonotype, "public", "private"))

downsampled_df

public_df <- feature_df %>%
  group_by(cdr3, v_gene, j_gene, c_gene) %>%
  filter(n_distinct(Patient_ID) > 1) %>%
  select(Patient_ID, cdr3) %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = ""))

public_df

feature_df <- feature_df %>%
  mutate(clonotype = paste(cdr3, v_gene, j_gene, c_gene, sep = "")) %>%
  mutate(publicness = if_else(clonotype %in% public_df$clonotype, "public", "private"))

feature_df
  
```

# Plot CDR3 length by irAE status and cell type (l1, l2)

```{r}

ggplot(downsampled_df_doubled, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

ggplot(downsampled_df %>% filter(predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8")), aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

downsampled_df %>%
  filter(predicted.celltype.l1 == "CD8 T", 
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  group_by(irAE, Chain) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- downsampled_df %>%
  filter(predicted.celltype.l1 == "CD8 T") %>%
  filter(chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Plot CDR3 length by irAE status and cell type (l1, l2) for most expanded CDR3s

```{r}

expansion_df <- downsampled_df %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded")) %>%
  filter(expansion_degree %in% c("Medium", "Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

ggplot(expansion_df, aes(x = chain, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "CDR3 length")

expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T", 
         Chain == "TRB") %>%
  group_by(irAE, Chain) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- expansion_df %>%
  filter(predicted.celltype.l1 == "CD8 T") %>%
  filter(chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

```

# Import pgen data

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  rename(TRA_pgen = pgen) %>%
  filter(!(is.na(TRA_pgen)),
         TRA_pgen != "NaN")

igor_combined <- read.csv("../saved_data/igor_output_beta.csv") %>%
  rename(TRB_pgen = pgen) %>%
  filter(!(is.na(TRB_pgen)),
         TRB_pgen != "NaN") %>%
  full_join(igor_alpha, by = c("TCR_name", "TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "TRAV", "TRAJ", "TRA_CDR3", "TRBV", "TRBJ", "TRB_CDR3", "TRAC", "TRBC", "TRA_leader", "TRB_leader", "Linker", "Link_order", "TRA_5_prime_seq", "TRA_3_prime_seq", "TRB_5_prime_seq", "TRB_3_prime_seq", "Linked_nt", "Linked_aa", "Warnings.Errors")) %>%
  select(TCR_name, TRA_CDR3, TRB_CDR3, TRA_pgen, TRB_pgen) %>%
  mutate(TRA_pgen = as.character(TRA_pgen),
         TRB_pgen = as.character(TRB_pgen))

downsampled_igor_combined <- igor_combined %>%
  pivot_longer(cols = matches("^(TRA|TRB)"),
               names_to = c("Chain", ".value"),
               names_pattern = "^(TRA|TRB)_(.*)$") %>%
  rename(barcode = TCR_name,
         cdr3 = CDR3) %>%
  mutate(pgen = as.numeric(pgen)) %>%
  right_join(downsampled_df, by = c("barcode", "Chain", "cdr3")) %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

downsampled_igor_combined

full_igor_combined <- igor_combined %>%
  pivot_longer(cols = matches("^(TRA|TRB)"),
               names_to = c("Chain", ".value"),
               names_pattern = "^(TRA|TRB)_(.*)$") %>%
  rename(barcode = TCR_name,
         cdr3 = CDR3) %>%
  mutate(pgen = as.numeric(pgen)) %>%
  right_join(feature_df, by = c("barcode", "Chain", "cdr3")) %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_degree = case_when(
    count == 1 ~ "Single",
    count > 1 & count <= 5 ~ "Small",
    count > 5 & count <= 20 ~ "Medium",
    count > 20 & count <= 100 ~ "Large",
    count > 100 ~ "Hyperexpanded"))

full_igor_combined

```

# Plot pgen scores by cell type for all TCRs

```{r}

plot_df <- downsampled_igor_combined %>%
  filter(!(is.na(predicted.celltype.l1)))

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

plot_df <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T")

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

plot_df %>%
  filter(predicted.celltype.l1 == "CD8 T", 
         predicted.celltype.l2 == "CD8 TCM",
         Chain == "TRB") %>%
  group_by(irAE, Chain) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM") %>%
  filter(chain == "TRA")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

# Higher log10(pgen) means lower pgen which means less germline-like
# lower log10(pgen) means higher pgen which means more germline-like

```

# Plot pgen scores by cell type for highly expanded TCRs

```{r}

plot_df <- downsampled_igor_combined %>%
  filter(!(is.na(predicted.celltype.l1))) %>%
  filter(expansion_degree %in% c("Medium", "Large", "Hyperexpanded"),
         predicted.celltype.l1 != "other T")

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

ggplot(plot_df, aes(x = Chain, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2, scales = "free_y") +
  labs(x = "Chain", y = "log10(pgen)")

plot_df %>%
  filter(predicted.celltype.l1 == "CD8 T",
         Chain == "TRB") %>%
  group_by(irAE) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- plot_df %>%
  filter(predicted.celltype.l1 == "CD8 T") %>%
  filter(chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

# Higher log10(pgen) means lower pgen which means less germline-like
# lower log10(pgen) means higher pgen which means more germline-like

```

```{r}

downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         Chain == "TRB") %>%
  group_by(predicted.celltype.l2) %>%
  summarize(count = n())

```

# Create df of just solid conclusions +/- downsampling

```{r}

downsampled_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  mutate(specific_label = "All",
         label = "All")
  
downsampled_unique_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  mutate(label = "All",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

downsampled_public_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "public",
         Chain == "TRB") %>%
  mutate(label = "Public",
         specific_label = "All")

downsampled_unique_public_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "public",
         Chain == "TRB") %>%
  mutate(label = "Public",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

downsampled_private_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "private",
         Chain == "TRB") %>%
  mutate(label = "Private",
         specific_label = "All")

downsampled_unique_private_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "private",
         Chain == "TRB") %>%
  mutate(label = "Private",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

downsampled_expanded_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  filter(expansion_degree %in% c("Medium", "Large", "Hyperexpanded")) %>%
  mutate(label = "Highly expanded",
         specific_label = "All")

downsampled_unique_expanded_cd8_tems <- downsampled_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  filter(expansion_degree %in% c("Medium", "Large", "Hyperexpanded")) %>%
  mutate(label = "Highly expanded",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

downsampled_joined_df <- downsampled_cd8_tems %>%
  full_join(downsampled_expanded_cd8_tems) %>%
  full_join(downsampled_unique_cd8_tems) %>%
  full_join(downsampled_unique_expanded_cd8_tems) %>%
  full_join(downsampled_public_cd8_tems) %>%
  full_join(downsampled_unique_public_cd8_tems) %>%
  full_join(downsampled_private_cd8_tems) %>%
  full_join(downsampled_unique_private_cd8_tems)

cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  mutate(specific_label = "All",
         label = "All")
  
unique_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  mutate(label = "All",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

public_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "public",
         Chain == "TRB") %>%
  mutate(label = "Public",
         specific_label = "All")

unique_public_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "public",
         Chain == "TRB") %>%
  mutate(label = "Public",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

private_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "private",
         Chain == "TRB") %>%
  mutate(label = "Private",
         specific_label = "All")

unique_private_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         publicness == "private",
         Chain == "TRB") %>%
  mutate(label = "Private",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

expanded_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded")) %>%
  mutate(label = "Highly expanded",
         specific_label = "All")

unique_expanded_cd8_tems <- full_igor_combined %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  filter(expansion_degree %in% c("Large", "Hyperexpanded")) %>%
  mutate(label = "Highly expanded",
         specific_label = "Unique") %>%
  group_by(cdr3, Patient_ID, chain) %>%
  dplyr::slice(1)

joined_df <- cd8_tems %>%
  full_join(expanded_cd8_tems) %>%
  full_join(unique_cd8_tems) %>%
  full_join(unique_expanded_cd8_tems) %>%
  full_join(public_cd8_tems) %>%
  full_join(unique_public_cd8_tems) %>%
  full_join(private_cd8_tems) %>%
  full_join(unique_private_cd8_tems)

```

# Plot pgen solid conclusions for downsampling

```{r}

p <- ggplot(downsampled_joined_df, aes(x = specific_label, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "", fill = "irAE", y = "TRB pgen (log10)") +
  facet_wrap(~label, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

downsampled_joined_df %>%
  group_by(label, specific_label, irAE) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- downsampled_joined_df %>%
  filter(label == "Highly expanded",
         specific_label == "All",
         Chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

# all all 8.19e-06
# all unique 0.06779
# private all 0.0001067
# private unique 0.05831
# public all 0.1512
# public unique 0.7392
# highly exp all 0.006624
# highly exp unique 0.7781

# adj: 0.00006552 0.10846400 0.00042680 0.10846400 0.20160000 0.77810000 0.01766400 0.77810000

p_values <- c(8.19e-06, 0.06779, 0.0001067, 0.05831, 0.1512, 0.7392, 0.006624, 0.7781)

# Adjust p-values using the Benjamini-Hochberg method (default method)
adjusted_p_values <- p.adjust(p_values, method = "BH")

# Print the adjusted p-values
print(adjusted_p_values)

```

# Plot pgen solid conclusions without downsampling

```{r}

p <- ggplot(joined_df, aes(x = specific_label, y = log10(pgen), fill = irAE)) +
  geom_boxplot() +
  labs(x = "", fill = "irAE", y = "TRB pgen (log10)") +
  facet_wrap(~label, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

joined_df %>%
  group_by(label, specific_label, irAE) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- joined_df %>%
  filter(label == "Highly expanded",
         specific_label == "All",
         Chain == "TRB")

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$pgen ~ test_data$irAE)

# Print the results
print(wilcox_result)

# all all 2.2e-16
# all unique 0.1088
# private all 2.2e-16
# private unique 0.07769
# public all 2.2e-16
# public unique 0.6044
# highly exp all 2.2e-16
# highly exp unique 0.0926

# adj: 4.400000e-16 1.243429e-01 4.400000e-16 1.234667e-01 4.400000e-16 6.044000e-01 4.400000e-16 1.234667e-01

p_values <- c(2.2e-16, 0.1088, 2.2e-16, 0.07769, 2.2e-16, 0.6044, 2.2e-16, 0.0926)

# Adjust p-values using the Benjamini-Hochberg method (default method)
adjusted_p_values <- p.adjust(p_values, method = "BH")

# Print the adjusted p-values
print(adjusted_p_values)

```

# Plot solid length conclusions for downsampling

```{r}

p <- ggplot(downsampled_joined_df, aes(x = specific_label, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  labs(x = "", fill = "irAE", y = "CD8 TEM CDR3β\nlength (AAs)") +
  facet_wrap(~label, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

downsampled_joined_df %>%
  group_by(label, irAE, specific_label) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- downsampled_joined_df %>%
  filter(label == "Private",
         specific_label == "All",
         Chain == "TRB")

# all all 4.066e-05
# all unique 0.2831
# private all 0.002032
# private unique 0.3092
# public all 0.008271
# public unique 0.5981
# highly exp all 0.00163
# highly exp unique 0.3534

#adj: 0.000325280 0.403885714 0.005418667 0.403885714 0.016542000 0.598100000 0.005418667 0.403885714

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

p_values <- c(4.066e-05, 0.2831, 0.002032, 0.3092, 0.008271, 0.5981, 0.00163, 0.3534)

# Adjust p-values using the Benjamini-Hochberg method (default method)
adjusted_p_values <- p.adjust(p_values, method = "BH")

# Print the adjusted p-values
print(adjusted_p_values)

```

# Plot solid length conclusions without downsampling

```{r}

p <- ggplot(joined_df, aes(x = specific_label, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  labs(x = "", fill = "irAE", y = "CD8 TEM CDR3β\nlength (AAs)") +
  facet_wrap(~label, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12))

# Adjust y-axis scales with a specified number of ticks
p + scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3))

joined_df %>%
  group_by(label, irAE, specific_label) %>%
  summarize(count = n()) %>%
  print()

# Filter the data for statistical test
test_data <- joined_df %>%
  filter(label == "Highly expanded",
         specific_label == "All",
         Chain == "TRB")

# all all 2.2e-16
# all unique 0.9836
# private all 9.978e-11
# private unique 0.8949
# public all 2.2e-16
# public unique 0.7737
# highly exp all 2.2e-16
# highly exp unique 0.5077

# adj: 5.866667e-16 9.836000e-01 1.995600e-10 9.836000e-01 5.866667e-16 9.836000e-01 5.866667e-16 8.123200e-01

# Calculate the Wilcoxon rank-sum test statistic and p-value
wilcox_result <- wilcox.test(test_data$cdr3_length ~ test_data$irAE)

# Print the results
print(wilcox_result)

p_values <- c(2.2e-16, 0.9836, 9.978e-11, 0.8949, 2.2e-16, 0.7737, 2.2e-16, 0.5077)

# Adjust p-values using the Benjamini-Hochberg method (default method)
adjusted_p_values <- p.adjust(p_values, method = "BH")

# Print the adjusted p-values
print(adjusted_p_values)

```

# Create plot of just solid conclusions for CD8 TCM CDR3B length

```{r}

cd8_tcms <- downsampled_df %>%
  filter(predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TCM",
         Chain == "TRB") %>%
  mutate(label = "All CD8 TCMs")

ggplot(cd8_tcms, aes(x = label, y = cdr3_length, fill = irAE)) +
  geom_boxplot() +
  labs(x = "", fill = "irAE", y = "CDR3β length (AAs)") +
  scale_x_discrete(limits = c("All CD8 TCMs"))

```

# Investigate Gly, Ala, Cys usage

```{r}

downsampled_df <- downsampled_df %>%
  mutate(Gly_num = sapply(strsplit(as.character(cdr3), ""), function(x) sum(x == "G")),
         Ala_num = sapply(strsplit(as.character(cdr3), ""), function(x) sum(x == "A")),
         Cys_num = sapply(strsplit(as.character(cdr3), ""), function(x) sum(x == "C")),
         Gly_perc = Gly_num / cdr3_length,
         Ala_perc = Ala_num / cdr3_length,
         Cys_perc = Cys_num / cdr3_length)

ggplot(downsampled_df, aes(x = chain, y = Gly_perc, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "Glycine usage in CDR3 (%)")

ggplot(downsampled_df, aes(x = chain, y = Ala_perc, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "Alanine usage in CDR3 (%)")

ggplot(downsampled_df, aes(x = chain, y = Cys_perc, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain", fill = "irAE", y = "Cysteine usage in CDR3 (%)")

```