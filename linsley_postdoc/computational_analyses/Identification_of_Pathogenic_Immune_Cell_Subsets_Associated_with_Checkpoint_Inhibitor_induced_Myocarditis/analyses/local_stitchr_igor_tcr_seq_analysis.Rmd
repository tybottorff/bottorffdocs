---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data reproduction of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in non-control TCR-seq data

```{r}

data_directory <- "../raw_data"

# Identify the pattern to extract patient IDs using regular expressions
pattern <- "GSM\\d+_([A-Z\\d\\-]+)-filtered_contig_annotations"

# Get a list of CSV files in the directory
csv_files <- list.files(data_directory, pattern = ".csv", full.names = TRUE)

# Initialize an empty list to store data frames
data_frames <- list()

# Loop through the list of CSV files
for (file in csv_files) {
  # Extract patient ID from the file name using regex
  patient_id <- gsub("GSM(\\d+)_(.*?)\\-filtered_contig_annotations.csv", "\\2", basename(file))
  
  # Read the CSV file into a data frame
  df <- read.csv(file)
  
  # Add a column for patient ID
  df$Patient_ID <- patient_id
  
  # Append the data frame to the list
  data_frames[[patient_id]] <- df
  
}

# Combine all data frames into a single data frame
combined_tcr_seq <- bind_rows(data_frames)

combined_tcr_seq

```

# Prep for stitchr

```{r}
stitchr_data <- combined_tcr_seq %>%
  group_by(barcode) %>%
  filter(chain %in% c("TRA", "TRB"),
         # remove multi chain duplicate issues (2 barcodes)
         sum(chain == "TRA") == 1 & sum(chain == "TRB") == 1) %>%
  ungroup() %>%
  select(barcode, v_gene, d_gene, j_gene, c_gene, chain, cdr3) %>%
  rename(TCR_name = barcode,
         CDR3 = `cdr3`,
         V = `v_gene`,
         J = `j_gene`,
         C = `c_gene`) %>%
  pivot_wider(names_from = chain, values_from = c(V, J, C, CDR3)) %>%
  # rename, reorder, create cols for stitchr
  rename(TRAV = V_TRA, TRAJ = J_TRA, TRBV = V_TRB, TRBJ = J_TRB, TRAC = C_TRA, TRBC = C_TRB, TRA_CDR3 = CDR3_TRA, TRB_CDR3 = CDR3_TRB) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC) %>%
  filter_all(all_vars(!is.na(.))) %>%
  filter_all(all_vars(. != "None")) %>%
  mutate(TRA_leader	= NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA)

stitchr_data

# 31,866 rows

write.table(stitchr_data, file = "../saved_data/tcrseq_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE)

```

# Read in stitchr output

```{r}

stitchr_output <- read.delim("../saved_data/stitchr_out.tsv", header = TRUE, sep = "\t")

# Columns that need further separation by space
columns_to_split_by_space <- c("TRA_nt", "TRA_aa", "TRB_nt", "TRB_aa", "Linked_nt")

# Split the specified columns by space
for (col_name in columns_to_split_by_space) {
  stitchr_output[[col_name]] <- sapply(stitchr_output[[col_name]], function(x) unlist(strsplit(x, " ")))
}

# Assign the column names
colnames(stitchr_output) <- c("TCR_name", "TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "TRAV", "TRAJ", "TRA_CDR3", "TRBV", "TRBJ",
                    "TRB_CDR3", "TRAC", "TRBC", "TRA_leader", "TRB_leader", "Linker", "Link_order", 
                    "TRA_5_prime_seq", "TRA_3_prime_seq", "TRB_5_prime_seq", "TRB_3_prime_seq", "Linked_nt", 
                    "Linked_aa", "Warnings.Errors")

# Define a function to replace with NA if length is 0
replace_empty_with_na <- function(x) {
  if (length(x) == 0) {
    return(NA)
  } else {
    return(x)
  }
}

# Replace values in the specified columns with real NA
cols_to_update <- c("TRA_nt", "TRB_nt", "TRA_aa", "TRB_aa", "Linked_nt")

for (col_name in cols_to_update) {
  stitchr_output[[col_name]] <- lapply(stitchr_output[[col_name]], replace_empty_with_na)
}

stitchr_output$TRA_nt <- sapply(stitchr_output$TRA_nt, as.character)
stitchr_output$TRA_aa <- sapply(stitchr_output$TRA_aa, as.character)
stitchr_output$TRB_nt <- sapply(stitchr_output$TRB_nt, as.character)
stitchr_output$TRB_aa <- sapply(stitchr_output$TRB_aa, as.character)
stitchr_output$Linked_nt <- sapply(stitchr_output$Linked_nt, as.character)

stitchr_output

```

# Prep IGoR input

```{r}

stitchr_output_alpha_df <- stitchr_output %>%
  filter(!(is.na(TRA_nt)))

stitchr_output_alpha_df
# 9,571 rows

write.csv(stitchr_output_alpha_df, file = "../saved_data/igor_alpha_input.csv", row.names = FALSE)

stitchr_output_beta_df <- stitchr_output %>%
  filter(!(is.na(TRB_nt)))

stitchr_output_beta_df
# 21,560 rows

write.csv(stitchr_output_beta_df, file = "../saved_data/igor_beta_input.csv", row.names = FALSE)

```

# Read in IGoR output

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  rename(barcode = TCR_name) %>%
  left_join(combined_tcr_seq, by = "barcode") %>%
  mutate(patient_group = case_when(
    startsWith(Patient_ID, "A") ~ "ici_no_irae",
    startsWith(Patient_ID, "B") ~ "ici_non_myocarditis_irae",
    startsWith(Patient_ID, "M") ~ "ici_myocarditis_irae",
    startsWith(Patient_ID, "control") ~ "no_ici")) %>%
  select(patient_group, chain, pgen) %>%
  filter(chain == "TRA",
         pgen != "NaN")

igor_alpha

ggplot(igor_alpha, aes(x = patient_group, y = -log10(pgen))) +
  geom_boxplot() +
  labs(x = "Patient group", y = "TRA -log10(pgen)")

```

# Prep IMGT/HighV-Quest input

```{r}

fasta_prep <- stitchr_output %>%
  rename(barcode = TCR_name) %>%
  left_join(combined_tcr_seq, by = "barcode")

fasta_df_alpha <- fasta_prep %>%
  filter(!(is.na(TRA_nt)),
         chain == "TRA") %>%
  mutate(barcode = paste(barcode, Patient_ID, sep = "_")) %>%
  ungroup()

# Function to convert a data frame to FASTA format
df_to_fasta_alpha <- function(df, output_file) {
  # Open/create the output file for writing
  fasta_file <- file(output_file, "w")
  
  # Iterate through rows of the data frame
  for (i in 1:nrow(df)) {
    # Combine name columns and add a suffix numbering
    label <- df$barcode[i]

    # Write the sequence and label to the FASTA file
    writeLines(paste(">", label), con = fasta_file)
    writeLines(df$TRA_nt[i], con = fasta_file)
  }
  
  # Close the output file
  close(fasta_file)
}

# Call the function to convert the data frame to FASTA format
df_to_fasta_alpha(fasta_df_alpha, "../saved_data/vdjseq_alpha.fasta")

fasta_df_beta <- fasta_prep %>%
  filter(!(is.na(TRB_nt)),
         chain == "TRB") %>%
  mutate(barcode = paste(barcode, Patient_ID, sep = "_")) %>%
  ungroup()

# Function to convert a data frame to FASTA format
df_to_fasta_beta <- function(df, output_file) {
  # Open/create the output file for writing
  fasta_file <- file(output_file, "w")
  
  # Iterate through rows of the data frame
  for (i in 1:nrow(df)) {
    # Combine name columns and add a suffix numbering
    label <- df$barcode[i]

    # Write the sequence and label to the FASTA file
    writeLines(paste(">", label), con = fasta_file)
    writeLines(df$TRB_nt[i], con = fasta_file)
  }
  
  # Close the output file
  close(fasta_file)
}

# Call the function to convert the data frame to FASTA format
df_to_fasta_beta(fasta_df_beta, "../saved_data/vdjseq_beta.fasta")

```

# Calculate CDR3 hydrophobicity and length by patient group

```{r}

# Prep hydrophobicity calculator

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

feature_df <- combined_tcr_seq %>%
  select(cdr3, Patient_ID, chain) %>%
  filter(cdr3 != "None",
         !(Patient_ID %in% c("A6-A9-B13-B9", "A8-B11", "B12-MCE6-MCE7", "A10-B10-MCE12-MCE13", "A5-B14"))) %>%
         # until dehashed, ignore mixed hashed samples
  mutate(cdr3_length = nchar(cdr3)) %>%
  rowwise() %>%
  mutate(cdr3_hydrophobicity = calculate_hydrophobicity(cdr3, hydrophobicity_df)) %>%
  ungroup() %>%
  mutate(patient_group = case_when(
    startsWith(Patient_ID, "A") ~ "ici_no_irae",
    startsWith(Patient_ID, "B") ~ "ici_non_myocarditis_irae",
    startsWith(Patient_ID, "M") ~ "ici_myocarditis_irae",
    startsWith(Patient_ID, "control") ~ "no_ici"))

feature_df

```

# Plot CDR3 hydrophobicity and length by patient group

```{r}

custom_labeller <- as_labeller(c("cdr3_length" = "CDR3\nAA length", "cdr3_hydrophobicity" = "CDR3\nhydrophobicity"))

plot_df <- feature_df %>%
  pivot_longer(cols = starts_with("cdr3_"), values_to = "value") %>%
  filter(chain != "Multi")

ggplot(plot_df, aes(x = chain, y = value, fill = patient_group)) +
  geom_boxplot() +
  facet_wrap(~ name, scales = "free_y", labeller = custom_labeller) +
  labs(x = "Chain", fill = "Patient Group", y = "Value")

```

# Find CDR3 sequences differentially encountered in different patient groups

```{r}

diff_df <- combined_tcr_seq %>%
  select(barcode, cdr3, chain, Patient_ID) %>%
  filter(cdr3 != "None") %>%
  mutate(patient_group = case_when(
    startsWith(Patient_ID, "A") ~ "ici_no_irae",
    startsWith(Patient_ID, "B") ~ "ici_non_myocarditis_irae",
    startsWith(Patient_ID, "M") ~ "ici_myocarditis_irae",
    startsWith(Patient_ID, "control") ~ "no_ici")) %>%
  select(-Patient_ID) %>%
  group_by(cdr3, patient_group) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  pivot_wider(names_from = patient_group, values_from = count, values_fill = 0) %>%
  rowwise() %>%
  mutate(p_value = chisq.test(c(ici_no_irae, ici_non_myocarditis_irae, ici_myocarditis_irae))$p.value) %>%
  ungroup() %>%
  filter(p_value < 10^-2) %>%
  arrange(p_value)

diff_df

```

# Test patient bias

```{r}

# looks like most dramatically differentially encountered CDR3 sequences are due to single patient bias

bias_df <- combined_tcr_seq %>%
  filter(cdr3 %in% diff_df$cdr3) %>%
  group_by(Patient_ID, cdr3) %>%
  summarize(count = n()) %>%
  arrange(cdr3) %>%
  filter(cdr3 %in% head(diff_df$cdr3))

bias_df

```



```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup() %>%
  filter(irae_seq_differential > 6)

diff_seq_boxplot_df <- diff_seq_df %>%
  select(-patient.ID, -CDR3.AA.Sequence, -CDR3.NT.Sequence, -irae_specific_sequence_count) %>%
  gather(key = "Category", value = "Value", -severe_irAE, -Chain, -cell_type, -irae_seq_differential)

custom_labeller <- as_labeller(c("CDR3_length" = "CDR3\nAA length", "cdr3_nt_count" = "CDR3\nexpansion", "CDR3_hydrophobicity" = "CDR3\nhydrophobicity"))

# Create the box plot with facets
ggplot(diff_seq_boxplot_df, aes(x = cell_type, y = Value, color = severe_irAE)) +
  geom_boxplot() +
  facet_wrap(~ Category, ncol = 2, scales = "free_y", labeller = custom_labeller) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Cell type", y = "Value")

```

# Look at differential histogram

```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup() %>%
  arrange(-irae_seq_differential)

diff_seq_df

# Create a histogram for irae_seq_differential
ggplot(diff_seq_df, aes(x = irae_seq_differential)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(x = "irAE CDR3 AA sequence differential", y = "Frequency")

```

# Look at histogram for each yes/no severe irAE CD3 AA seq counts

```{r}

diff_seq_df <- feature_df %>%
  select(patient.ID, CDR3.NT.Sequence, CDR3.AA.Sequence, severe_irAE, Chain, CDR3_length, CDR3_hydrophobicity, cell_type) %>%
  filter(!(is.na(CDR3.AA.Sequence)),
         patient.ID != "YUROD") %>%
  group_by(severe_irAE) %>%
  mutate(irae_total_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence, severe_irAE) %>%
  mutate(irae_specific_sequence_count = n()) %>%
  ungroup() %>%
  group_by(CDR3.AA.Sequence) %>%
  mutate(irae_seq_differential = abs(sum(severe_irAE=="Yes")- sum(severe_irAE=="No"))) %>%
  ungroup()

diff_seq_df

# Create a histogram for irae_seq_differential
ggplot(diff_seq_df, aes(x = irae_specific_sequence_count, fill = severe_irAE)) +
  geom_histogram(binwidth = 1) +
  labs(x = "irAE CDR3 AA sequence counts", y = "Frequency")

```