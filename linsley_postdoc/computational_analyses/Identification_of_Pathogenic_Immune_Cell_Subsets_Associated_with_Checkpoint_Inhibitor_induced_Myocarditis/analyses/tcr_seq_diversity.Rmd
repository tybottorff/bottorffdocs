---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)
library(vegan)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

dehashed_combined_tcr_seq <- read.csv("../saved_data/dehashed_tcr_seq_with_rna.csv")
  
dehashed_combined_tcr_seq_doubled <- dehashed_combined_tcr_seq %>%
  bind_rows(mutate(dehashed_combined_tcr_seq, predicted.celltype.l1 = "All T cells"))

```

# Analyze diversity of CDR3 AAs using Shannon metric

```{r}

cdr3_amino_acid_diversity_df <- dehashed_combined_tcr_seq_doubled %>%
  filter(!(is.na(cdr3)),
         chain != "Multi",
         predicted.celltype.l2 != "NK") %>%
  group_by(cdr3, chain, Patient_ID, irAE, predicted.celltype.l1) %>%
  mutate(cdr3_amino_acid_count = n()) %>%
  ungroup() %>%
  group_by(Patient_ID, chain, predicted.celltype.l1) %>%
  # Calculate Shannon diversity index (H)
  mutate(shannon = diversity(cdr3_amino_acid_count),
         inv_shannon = 1/diversity(cdr3_amino_acid_count)) %>%
  slice(1) %>%
  ungroup() %>%
  select(chain, irAE, Patient_ID, shannon, inv_shannon, predicted.celltype.l1)

cdr3_amino_acid_diversity_df

ggplot(cdr3_amino_acid_diversity_df, aes(x = chain, y = shannon, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain",
       y = "Shannon entropy") +
  scale_y_continuous(breaks = pretty_breaks(n = 3))

# Shannon entropy: 0 means monoclonal, higher means polyclonal, weights richness (total # of unique clones) over evenness

ggplot(cdr3_amino_acid_diversity_df, aes(x = chain, y = inv_shannon, fill = irAE)) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l1, scales = "free_y") +
  labs(x = "Chain",
       y = "Inverse Shannon entropy")

# assuming higher inverse means monoclonal, lower inverse means polyclonal

```