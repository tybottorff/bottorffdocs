---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(VennDiagram)
library(scales)
library(ggpubr)
library(ComplexHeatmap)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

feature_df <- read.csv("../saved_data/tcr_seq_features.csv")

feature_df

```
  
# Examine patient sampling depth bias

```{r}

seq_depth <- combined_data %>%
  group_by(Patient_ID, irAE) %>%
  summarize(seq_depth = n()) %>%
  arrange(seq_depth) %>%
  print()

seq_depth

# Choose 324 seqs from non B10 samples to downsample all to 324

```

# Look at public vs. private

```{r}

downsampled_public_df_list <- downsampled_df %>%
  group_by(cdr3) %>%
  filter(n_distinct(Patient_ID) > 1) %>%
  mutate(barc_chain = paste(barcode, chain, sep = ""))

downsampled_public_df_list

downsampled_public_df <- downsampled_df %>%
  mutate(barc_chain = paste(barcode, chain, sep = "")) %>%
  filter(barc_chain %in% downsampled_public_df_list$barc_chain,
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  # look at just unique clonotypes from each patient
  dplyr::slice(1) %>%
  mutate(tag = "Public\n(downsampled)")

downsampled_public_df

public_df_list <- combined_data %>%
  group_by(cdr3) %>%
  filter(n_distinct(Patient_ID) > 1) %>%
  mutate(barc_chain = paste(barcode, chain, sep = ""))

public_df_list

public_df <- combined_data %>%
  mutate(barc_chain = paste(barcode, chain, sep = "")) %>%
  filter(barc_chain %in% public_df_list$barc_chain,
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  # look at just unique clonotypes from each patient
  dplyr::slice(1) %>%
  mutate(tag = "Public")

public_df

```

# Look at TCR convergence

```{r}

convergence_within_patients <- combined_data %>%
  select(Patient_ID, barcode, Chain, cdr3, cdr3_nt, v_gene, d_gene, j_gene, c_gene) %>%
  group_by(cdr3, Patient_ID) %>%
  filter(n_distinct(cdr3_nt) > 1) %>%
  ungroup()

convergence_within_patients

convergence_across_patients <- combined_data %>%
  mutate(barc_chain = paste(barcode, chain, sep = "")) %>%
  group_by(cdr3) %>%
  mutate(distinct_cdr3_nt_count = n_distinct(cdr3_nt)) %>%
  filter(distinct_cdr3_nt_count > 1)

convergence_across_patients

# do see more convergence across patients as expected, and they are mostly in public TCRs also as expected

convergence_df <- combined_data %>%
  mutate(barc_chain = paste(barcode, chain, sep = "")) %>%
  filter(barc_chain %in% convergence_across_patients$barc_chain,
         predicted.celltype.l1 == "CD8 T",
         predicted.celltype.l2 == "CD8 TEM",
         Chain == "TRB") %>%
  group_by(Patient_ID, cdr3, chain, v_gene, j_gene) %>%
  # look at just unique clonotypes from each patient
  dplyr::slice(1) %>%
  mutate(tag = "Converged")

#convergence_df

```

# Plot donors/junction (AA) (x) vs. donors/junction (nt) (y)

```{r}

donor_df <- combined_data %>%
  mutate(barc_chain = paste(barcode, chain, sep = "")) %>%
  mutate(convergence  = if_else(barc_chain %in% convergence_across_patients$barc_chain, "Converged", "Not converged"),
         publicity = if_else(barc_chain %in% public_df_list$barc_chain, "Public", "Private")) %>%
  group_by(cdr3) %>%
  mutate(donors_per_junction_aa = n_distinct(Patient_ID)) %>%
  ungroup() %>%
  group_by(cdr3_nt) %>%
  mutate(donors_per_junction_nt = n_distinct(Patient_ID)) %>%
  ungroup() %>%
  # look at just unique CDR3s nts from each patient
  group_by(cdr3, cdr3_nt, Patient_ID) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(irAE = paste("irAE:", irAE))

ggplot(donor_df, aes(x = donors_per_junction_aa, y = donors_per_junction_nt, color = convergence)) +
  geom_jitter(size = 0.5) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  facet_wrap(~irAE, ncol = 4) +
  labs(x = "Donors/junction (AA)", y = "Donors/junction (nt)", color = "Convergence") +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14))

ggplot(donor_df, aes(x = donors_per_junction_aa, y = donors_per_junction_nt, color = publicity)) +
  geom_jitter(size = 0.5) +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  facet_wrap(~irAE, ncol = 4) +
  labs(x = "Donors/junction (AA)", y = "Donors/junction (nt)", color = "Publicity") +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14))

# how can something be converged on diagonal (on or off (1,1))? I'm pretty sure it's because of intrapatient convergence

```

# Instead look at distribution of unique CDR3 NT seqs / CDR3 (AA) by irAE group

```{r}

new_convergence_df <- combined_data %>%
  group_by(cdr3) %>%
  mutate(nts_per_aa = n_distinct(cdr3_nt)) %>%
  # look at just unique CDR3s from each irAE group (to deal with cases with same CDR3 in both groups, don't want to slice and just have it in 1 group)
  # also don't want to group by patient because then I'd be double counting some CDR3s in group comparisons?
  group_by(cdr3, irAE) %>%
  slice(1) %>%
  ungroup()

new_convergence_df_hist <- new_convergence_df %>%
  group_by(nts_per_aa, irAE, predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(irAE, predicted.celltype.l1, predicted.celltype.l2) %>%
  mutate(count = count / sum(count))

# Calculate mean values
means <- new_convergence_df_hist %>%
  group_by(predicted.celltype.l1, irAE) %>%
  summarize(mean_val = mean(nts_per_aa))

means

p <- ggplot(new_convergence_df_hist, aes(x = nts_per_aa, y = sqrt(count), fill = irAE)) +
  geom_density(stat = "identity", position = "dodge", alpha = 0.75) +
  facet_wrap(~predicted.celltype.l1) +
  labs(x = "CDR3 NT sequences/\nCDR3 AA sequence", y = "Group normalized\ncount (sqrt)") +
  scale_x_continuous(breaks = pretty_breaks(n = 3))

p + geom_vline(data = means, aes(xintercept = mean_val, color = irAE),
             linetype = "solid", size = 0.5) +
    scale_color_manual(values = c("red", "blue"))  # Adjust colors as needed

#wilcox.test(nts_per_aa ~ irAE, data = new_convergence_df %>% filter(predicted.celltype.l1 == "other T"))
# CD4 T: 0.00062 (padj)
# higher in No irAE

#p.adjust(c(0.0002063, 0.75, 0.1772), method = "BH")

```

# Instead look at distribution of unique CDR3 NT seqs / CDR3 (AA) by irAE group (INTRAPATIENT CONVERGENCE ONLY)

```{r}

new_convergence_df <- combined_data %>%
  group_by(cdr3, Patient_ID) %>%
  mutate(nts_per_aa = n_distinct(cdr3_nt)) %>%
  slice(1) %>%
  ungroup()

new_convergence_df_hist <- new_convergence_df %>%
  group_by(nts_per_aa, irAE, predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(irAE, predicted.celltype.l1, predicted.celltype.l2) %>%
  mutate(count = count / sum(count))

# Calculate mean values
means <- new_convergence_df_hist %>%
  group_by(predicted.celltype.l1, irAE) %>%
  summarize(mean_val = mean(nts_per_aa))

means

p <- ggplot(new_convergence_df_hist, aes(x = nts_per_aa, y = sqrt(count), fill = irAE)) +
  geom_density(stat = "identity", position = "dodge", alpha = 0.75) +
  facet_wrap(~predicted.celltype.l1) +
  labs(x = "CDR3 NT sequences/\nCDR3 AA sequence", y = "Group normalized\ncount (sqrt)") +
  scale_x_continuous(breaks = pretty_breaks(n = 3))

p + geom_vline(data = means, aes(xintercept = mean_val, color = irAE),
             linetype = "solid", size = 0.5) +
    scale_color_manual(values = c("red", "blue"))

#wilcox.test(nts_per_aa ~ irAE, data = new_convergence_df %>% filter(predicted.celltype.l1 == "CD4 T"))

```

# Try to differentiate between seq errors and intrapatient convergence, or at least see if intrapatient convergence seems to be dominated by seq errors

```{r}

new_convergence_df <- combined_data %>%
  group_by(cdr3, Patient_ID) %>%
  mutate(nts_per_aa = n_distinct(cdr3_nt)) %>%
  ungroup()

seq_errors_estimate <- new_convergence_df %>%
  select(barcode, Chain, cdr3, cdr3_nt, Patient_ID, nts_per_aa) %>%
  arrange(-nts_per_aa) %>%
  group_by(cdr3_nt, cdr3, Patient_ID, nts_per_aa) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(Patient_ID, cdr3, nts_per_aa) %>%
  summarize(max_frac = max(count)/sum(count))

seq_errors_estimate

ggplot(seq_errors_estimate, aes(x = nts_per_aa, y = max_frac)) +
  geom_jitter(size = 0.5, alpha = 0.75, position = position_jitter(width = 0.05, height = 0.05)) +
  geom_function(fun = function(x) 1/x, color = "red", linetype = "dashed") +
  labs(x = "CDR3 NT sequences/\nCDR3 AA sequence", y = "Max dominance\nof CDR3 NT")

```

# Look at overlap between public and converged

```{r}

# Create a Venn diagram
#venn.plot <- venn.diagram(
#  x = list(A = public_df$barcode, B = convergence_df$barcode),
#  category.names = c("Public TCRs", "Converged TCRs"),
#  filename = NULL,
#  output = TRUE
#)

# Display the Venn diagram
#grid.draw(venn.plot)

```