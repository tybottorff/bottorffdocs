---
title: "Molly Fisher Thomas colitis data"
output: pdf_document
---

 - data mining of https://villani.mgh.harvard.edu/ircolitis/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Metadata

```{r}

metadata <- data.frame(
  patient_id = c("MC_2", "SIC_13", "SIC_19", "SIC_31", "SIC_32", "SIC_36", "SIC_40", "SIC_43", "SIC_53", "MC_1", "MC_9", "SIC_71", "SIC_89", "SIC_76", "SIC_94", "SIC_97", "SIC_100", "SIC_100", "SIC_109", "SIC_121", "SIC_126", "SIC_134", "SIC_140", "SIC_141", "SIC_172", "SIC_186", "SIC_187", "SIC_188", "SIC_196"),
  simplified_patient_id = c("HC7", "HC1", "IHC3", "IHC4", "C7", "C8", "C9", "C10", "IHC5", "HC6", "HC8", "C11", "C12", "C14", "IHC6", "C13", "C1", "C1", "IHC1", "C2", "C3", "C4", "C5", "C6", "IHC2", "HC2", "HC3", "HC4", "HC5")) %>%
  mutate(group = case_when(
    startsWith(simplified_patient_id, "H") ~ "No ICI",
    startsWith(simplified_patient_id, "I") ~ "ICI no colitis",
    startsWith(simplified_patient_id, "C") ~ "ICI colitis"))

filtered_metadata <- metadata %>%
  filter(group != "No ICI")

filtered_metadata

# C14 depleted for B cells

```

# Get file names for CD45 sorted/pos ICI samples (just colon tissue)

```{r}

# Path to the directory containing your samples
base_dir <- "../raw_data/rna/"

# List all subdirectories in the base directory
sample_directories <- list.dirs(base_dir, full.names = TRUE, recursive = FALSE)

filter_filenames <- function(file_names, values) {
  pattern <- paste0(values, collapse = '|')
  
  # look for ICI files that are CD45 sorted
  matching_files <- file_names[grepl(pattern, file_names) & grepl("CD45", file_names)]
  
  return(matching_files)
}

filtered_files <- filter_filenames(sample_directories, filtered_metadata$patient_id)

filtered_files

```

# Read in RNAseq data from colon tissue from ICI patients

```{r}

# Create a list to store Seurat objects
seurat_objects_list <- list()

# Loop through each sample directory
for (sample_dir in filtered_files) {
  # Extract the sample name from the directory path
  sample_name <- tools::file_path_sans_ext(basename(sample_dir))

  # Construct file paths
  counts_file <- file.path(sample_dir, "raw_feature_bc_matrix.h5")

  # Create Seurat object
  seurat_obj <- CreateSeuratObject(Read10X_h5(counts_file), project = sample_name)

  # Store Seurat object in the list
  seurat_objects_list[[sample_name]] <- seurat_obj
  }

```

# Merge Seurat objects from all samples

```{r}

# Merge the first element with a sublist of the rest excluding the first element
colon_t_cells <- merge(seurat_objects_list[[1]], y = seurat_objects_list[-1])

```

# Save merged Seurat RDS

```{r}

saveRDS(colon_t_cells, "../saved_data/merged.rds")

```

# Calculate percent mitochondrial, ribosomal, hemoglobin features

```{r}

colon_t_cells <- readRDS("../saved_data/merged.rds")

colon_t_cells[["percent_mito"]] <- PercentageFeatureSet(colon_t_cells, pattern = "^MT-")
colon_t_cells[["percent_ribo"]] <- PercentageFeatureSet(colon_t_cells, pattern = "^RP[SL]")
colon_t_cells[["percent_hb"]] <- PercentageFeatureSet(colon_t_cells, pattern = "HB[^(P)]")

```

# Count number of cells from all samples

```{r}

length(colnames(colon_t_cells)) # 17,694,720 cells

```

# Count cells per each of the 24 samples

```{r}

cell_capture <- colon_t_cells@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(orig.ident)

```

# Visualize QC metrics across all patient samples

```{r}

vln_plot <- VlnPlot(colon_t_cells, features = c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo"), ncol = 4, pt.size=0)

# Loop through each panel and remove x-axis text
for (i in 1:4) {
  vln_plot[[i]] <- vln_plot[[i]] + theme(axis.text.x = element_blank())
}

vln_plot

ggsave(vln_plot, file = "../figures/vln_plot_qc.svg")

# show plots with QC cutoffs

VlnPlot(colon_t_cells, features = c("nFeature_RNA"), pt.size = 0) +
  geom_hline(yintercept = 200, linetype = "dashed", color = "red") +
  NoLegend() +
  theme(axis.text.x = element_blank())

VlnPlot(colon_t_cells, features = c("percent_mito"), pt.size = 0) +
  geom_hline(yintercept = 11, linetype = "dashed", color = "red") +
  NoLegend() +
  theme(axis.text.x = element_blank())

```

# Set author QC metric thresholds

```{r}

qcMetricsThresholds <-
  c(
    "nFeature_RNA_min" = 500,
    
    "percent_mito" = 30
  )

```

# Plot distributions of nFeature_RNA across samples

```{r}

nFeature_RNA_QC <- ggplot(colon_t_cells@meta.data, mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed") +
  theme(legend.text = element_blank())
ggsave(nFeature_RNA_QC, file = "../figures/nFeature_RNA.svg")

nFeature_RNA_QC

```

# Plot distributions of nCount_RNA across samples

```{r}

nCount_RNA_QC <- ggplot(colon_t_cells@meta.data, mapping = aes(x = nCount_RNA)) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  theme(legend.text = element_blank())
ggsave(nCount_RNA_QC, file = "../figures/nCount_RNA.svg")

nCount_RNA_QC

```

# Plot distributions of percent mito across samples

```{r}

percent_mt_QC <- ggplot(colon_t_cells@meta.data, mapping = aes(x = percent_mito + 1/length(colnames(colon_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["percent_mito"],
             color = "red", linetype = "dashed") +
  xlab("percent_mito (with pseudocount)") +
  theme(legend.text = element_blank())
ggsave(percent_mt_QC, file = "../figures/percent_mt.svg")

percent_mt_QC

```

# Plot distributions of percent ribo across samples

```{r}

percent_rb_QC <- ggplot(colon_t_cells@meta.data, mapping = aes(x = percent_ribo + 1/length(colnames(colon_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  xlab("percent_ribo (with pseudocount)") +
  theme(legend.text = element_blank())
ggsave(percent_rb_QC, file = "../figures/percent_rb.svg")

percent_rb_QC

```

# Plot distributions of percent hemoglobin across samples

```{r}

percent_hb_QC <- ggplot(colon_t_cells@meta.data, mapping = aes(x = percent_hb + 1/length(colnames(colon_t_cells)))) +
  geom_density(mapping = aes(color = orig.ident), size = 0.5) +
  scale_x_log10() +
  xlab("percent_hb (with pseudocount)") +
  theme(legend.text = element_blank())

ggsave(percent_hb_QC, file = "../figures/percent_hb.svg")

percent_hb_QC

```

# Filter cells based on QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    colon_t_cells, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      colon_t_cells, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(colon_t_cells), cellsKeep)
length(cellsDrop) # 17,618,429 cells dropped from analysis

colon_t_cells_filtered <-
  subset(colon_t_cells, cells = cellsKeep)

length(colnames(colon_t_cells_filtered)) # 76,291 cells left behind in filtered data, expected ~85k based on their figure 1

```

# Count cells by sample after QC filtering

```{r}

cell_capture <- colon_t_cells_filtered@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Save RDS file

```{r}

saveRDS(colon_t_cells_filtered, "../saved_data/qc_filtered.rds")

```