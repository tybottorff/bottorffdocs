---
title: "Identification of Pathogenic Immune Cell Subsets Associated with Checkpoint Inhibitor-induced Myocarditis"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9397491/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in scRNAseq RDS

```{r}

immune.combined <- readRDS("../saved_data/final_seurat.rds")

```

# Read in scTCRseq, process to be added as metadata to scRNAseq

```{r}

dehashed_combined_tcr_seq <- read.csv("../saved_data/dehashed_tcr_seq.csv")
  
suffix_lookup <- tibble(
  Patient_ID = c("B1", "A10", "MCE12", "B10", "MCE13", "B12", "MCE7", "MCE6", "A8", "B11", "A9", "A6", "B9", "B13", "A5", "B14", "B2", "A1", "B3", "A2", "A3", "MCE1", "MCE2", "MCL1", "MCL3"),
  suffix = c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "1", "2", "3", "4", "5", "6", "7", "8", "9")
)

# Merge the lookup table to add the suffix column to the main data frame
dehashed_combined_tcr_seq <- dehashed_combined_tcr_seq %>%
  left_join(suffix_lookup, by = "Patient_ID") %>%
  mutate(barcode = paste(barcode, suffix, sep = "_")) %>%
  filter(chain != "Multi") %>%
  # pivot to combine 1 alpha and 1 beta (or 0 and 1) barcodes together
  select(-X) %>%
  # if a cell had two or more qualified chains of the same type, only that chain with the highest UMI count was qualified and retained
  group_by(barcode, chain) %>%
  arrange(-umis) %>%
  slice(1) %>%
  ungroup() %>%
  pivot_wider(id_cols = c(barcode, Patient_ID, irAE, suffix), names_from = chain, values_from = -c(barcode, Patient_ID, irAE, suffix))

dehashed_combined_tcr_seq <- as.data.frame(dehashed_combined_tcr_seq)

# Set row names based on the "Barcode" column
rownames(dehashed_combined_tcr_seq) <- dehashed_combined_tcr_seq$barcode

dehashed_combined_tcr_seq <- dehashed_combined_tcr_seq %>% select(-barcode)

dehashed_combined_tcr_seq

```

# Add TCRseq metadata to RNAseq

```{r}

rna_and_tcr <- AddMetaData(object = immune.combined, metadata = dehashed_combined_tcr_seq)

```

# Look at just T cells

```{r}

T_cells <- rna_and_tcr[, !(is.na(rna_and_tcr@meta.data$cdr3_TRA) | is.na(rna_and_tcr@meta.data$cdr3_TRB)) & rna_and_tcr@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & rna_and_tcr@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

```

# Re-do dimensional reduction, clustering

```{r}

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

```

# Read in reference to use for mapping

```{r}

reference <- LoadH5Seurat("../../pbmc_multimodal.h5seurat")

```

# Find reference transfer anchors

```{r}

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

```

# Map reference onto my object

```{r}

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)

```

# Plot mapping results

```{r}

p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Relook just at T cells again

```{r}

just_T_cells <- T_cells[, !(is.na(T_cells@meta.data$cdr3_TRA) | is.na(T_cells@meta.data$cdr3_TRB)) & T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
just_T_cells <- RunUMAP(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindNeighbors(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindClusters(just_T_cells, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)
just_T_cells <- MapQuery(
  anchorset = anchors,
  query = just_T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

```

# Plot cell type assignments

```{r}

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Save RDS

```{r}

saveRDS(just_T_cells, "../saved_data/final_seurat_T_cells.rds")

```

# Compare clusters when excluding TCR genes

```{r}

# Example regex to match TCR gene names
tcr_gene_regex <- "^TR[ABCDG][VDJC]"

# Extract TCR genes using the regex
tcr_genes <- grep(tcr_gene_regex, rownames(just_T_cells), value = TRUE)

# Print or use the resulting TCR gene list
print(tcr_genes)

# Filter out TCR genes from the Seurat object
just_T_cells_filtered <- subset(just_T_cells, features = !rownames(just_T_cells) %in% tcr_genes)

```

```{r}

#just_T_cells_filtered <- RunPCA(just_T_cells_filtered, npcs = 30, verbose = FALSE)
#just_T_cells_filtered <- RunUMAP(just_T_cells_filtered, reduction = "pca", dims = 1:30)
#just_T_cells_filtered <- FindNeighbors(just_T_cells_filtered, reduction = "pca", dims = 1:30)
#just_T_cells_filtered <- FindClusters(just_T_cells_filtered, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells_filtered,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50,
  recompute.residuals = FALSE
)
just_T_cells_filtered <- MapQuery(
  anchorset = anchors,
  query = just_T_cells_filtered,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

p1 = DimPlot(just_T_cells_filtered, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells_filtered, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

```{r}

#just_T_cells <- just_T_cells_filtered[, !(is.na(just_T_cells_filtered@meta.data$cdr3_TRA) | is.na(just_T_cells_filtered@meta.data$cdr3_TRB)) & just_T_cells_filtered@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & just_T_cells_filtered@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

#just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
#just_T_cells <- RunUMAP(just_T_cells, reduction = "pca", dims = 1:30)
#just_T_cells <- FindNeighbors(just_T_cells, reduction = "pca", dims = 1:30)
#just_T_cells <- FindClusters(just_T_cells, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50,
  recompute.residuals = FALSE
)
just_T_cells <- MapQuery(
  anchorset = anchors,
  query = just_T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

```

```{r}

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

```{r}

just_T_cells <- just_T_cells[, !(is.na(just_T_cells@meta.data$cdr3_TRA) | is.na(just_T_cells@meta.data$cdr3_TRB)) & just_T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & just_T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
just_T_cells <- RunUMAP(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindNeighbors(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindClusters(just_T_cells, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50,
  recompute.residuals = FALSE
)
just_T_cells <- MapQuery(
  anchorset = anchors,
  query = just_T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

```{r}

saveRDS(just_T_cells, "../saved_data/final_seurat_T_cells.rds")

```

# Make plot of UMAP colored by expansion

```{r}

metadata <- just_T_cells@meta.data %>%
  mutate(clonotype = paste(v_gene_TRA, v_gene_TRB, j_gene_TRA, j_gene_TRB, cdr3_TRA, cdr3_TRB, sep = "_")) %>%
  group_by(Patient_ID, clonotype) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_bin = case_when(
    count == 1 ~ "1",
    count > 1 & count < 5 ~ "2-4",
    count >= 5 & count < 20 ~ "5-19",
    count >= 20 & count < 40 ~ "20-39",
    count >= 40 & count < 100 ~ "40-99",
    count >= 100 ~ "> 100"
  ))

just_T_cells$expansion_bin <- metadata$expansion_bin

just_T_cells$expansion_bin <- factor(just_T_cells$expansion_bin, levels = c("1", "2-4", "5-19", "20-39", "40-99", "> 100"))

DimPlot(just_T_cells, reduction = "umap", group.by = "expansion_bin", shuffle = TRUE, seed = 123)

```

# Look at UMAP colored by irAE group

```{r}

# standardize colors with UMAP for irAE groups from colitis dataset

DimPlot(just_T_cells, reduction = "umap", group.by = "irAE", shuffle = TRUE, seed = 455, cols = c("#F8766D", "#619CFF"))

```

# Look at markers across cell types

```{r}

VlnPlot(just_T_cells, features = c("FOXP3"), pt.size = 0, group.by = "predicted.celltype.l2")
# CCR7 high for naive matches ok
# this seems to match ok
# CD8 TCM. CCR7+. CD62L+ (SELL). # CD8 TEM. CCR7-. CD62L-
VlnPlot(just_T_cells, features = c("CCR7", "SELL"), pt.size = 0, group.by = "predicted.celltype.l2")

```

# Look at how good cell type scores are

```{r}

cell_type_score_histograms <- just_T_cells@meta.data %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  select(predicted.celltype.l1, predicted.celltype.l2, predicted.celltype.l2.score)

cell_type_score_histograms

ggplot(cell_type_score_histograms %>% filter(predicted.celltype.l1 == "CD8 T"), aes(x = predicted.celltype.l2.score)) +
  geom_histogram() +
  facet_wrap(~ predicted.celltype.l2, scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(n = 2))

```