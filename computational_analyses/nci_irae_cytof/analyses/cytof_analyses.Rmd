---
title: "CyTOF analyses for NCI irAE project"
output: pdf_document
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(beeswarm)
library(Matrix)
library(ggplot2)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(Seurat)
library(factoextra)
library(lmerTest)
library(gtsummary)
library(ica)
library(CytoExploreR)
library(dplyr)
library(ggrepel)
library(purrr)
library(compareGroups)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in baseline data to look at group differences
 - may want to work with dates later, use as.Date(date, origin = "1899-12-30")

```{r}

baseline_flow_data <- read_excel("../raw_data/2024_10_17_flow_data.xlsx") %>%
  # CTCAE Grade (Highest) is the column for (ir)AE grade
  rename(patient_id = `Subject ID`, ctcae_grade = `CTCAE Grade (Highest)`, group = `General irAE Classification`, cancer_type = `Primary Cancer Type`, age = `Age at Draw`, thyroid_cat = `Thyroid Category (JB)`, data_source = `Data Source`, ici_drug = `Immune Checkpoint Inhibitor`) %>%
  mutate(`Infusion date` = as.Date(as.numeric(`Infusion date`), origin = "1899-12-30"),
         `First irAE Onset or Thyroid Test Date` = as.Date(as.numeric(`First irAE Onset or Thyroid Test Date`), origin = "1899-12-30"),
         days_to_irae = as.numeric(difftime(`First irAE Onset or Thyroid Test Date`, `Infusion date`, units = "days")),
         # will subset for only baseline visits
         cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+"),
         # fix 1 patient with NA cancer type but looks like lung from other column info
         cancer_type = if_else(patient_id == "LinsleyLab732066", "Lung", cancer_type),
         # combine multiple irAE cols
         irae_ex = paste(`irAE Documented (if any)`, `Documented irAE's (9/6/2024)`, sep = "_"),
         # if CTCAE grade is not-NA, group should be irAE... (some grade 1-2 ctcae were in non-irAE group before using updated category 9/6/24, using `General irAE Classification` as its cleaner metadata though otherwise
         group = if_else(!is.na(ctcae_grade), "irAE/SAE", group),
         thyroid_cat = if_else(is.na(thyroid_cat), "None", thyroid_cat),
         thyroid_irae_including_oor = if_else(str_detect(irae_ex, regex("thyroid", ignore_case = TRUE)) | str_detect(thyroid_cat, regex("Abnormal", ignore_case = TRUE)),
                                "Thyroid irAE", 
                                "No thyroid irAE"),
         thyroid_irae = if_else(str_detect(irae_ex, regex("thyroid", ignore_case = TRUE)),
                                "Thyroid irAE", 
                                "No thyroid irAE"),
         skin_irae = if_else(str_detect(irae_ex, regex("rash|itch|skin|dermatitis|Pruritis|Pruritus", ignore_case = TRUE)),
                                "Skin irAE", 
                                "No skin irAE"),
         pneumonitis_irae = if_else(str_detect(irae_ex, regex("pneumonitis", ignore_case = TRUE)),
                                "Pneumonitis", 
                                "No pneumonitis"),
         pneumonitis_irae_including_effusion = if_else(str_detect(irae_ex, regex("pneumonitis|effusion", ignore_case = TRUE)),
                                "Pneumonitis", 
                                "No pneumonitis"),
         gastro_irae = if_else(str_detect(irae_ex, regex("nausea|esophagitis|diarrhea", ignore_case = TRUE)),
                                "Gastrointestinal irAE", 
                                "No gastrointestinal irAE"),
         rheumatoid_irae = if_else(str_detect(irae_ex, regex("arthritis|arthralgia|Arthalgia|edema", ignore_case = TRUE)),
                                "Rheumatoid irAE", 
                                "No rheumatoid irAE"),
         # clean up cancer types and ICI drugs
        cancer_type = case_when(
          cancer_type %in% c("head-neck", "head_and_neck") ~ "Head/neck",
          cancer_type %in% c("lung", "Lung") ~ "Lung",
          cancer_type == "urinary_tract" ~ "Urinary tract",
          cancer_type == "esophageal" ~ "Esophageal",
          cancer_type == "gastric" ~ "Gastric"),
               ici_drug = case_when(
                 ici_drug == "avelumab" ~ "Avelumab",
                 ici_drug == "cemiplimab" ~ "Cemiplimab",
                 ici_drug == "durvalumab" ~ "Durvalumab",
                 ici_drug %in% c("nivolumab", "nivolumab, other_antidpl") ~ "Nivolumab/other",
                 ici_drug == "pembrolizumab" ~ "Pembrolizumab",
         )) %>%
  # subset for only baseline visits, this also subsets for only cancer group
  dplyr::filter(cleaned_visit_num == 1) %>%
  select(patient_id, group, ctcae_grade, cancer_type, cleaned_visit_num, Batch, age, irae_ex, days_to_irae, thyroid_cat, thyroid_irae_including_oor, thyroid_irae, skin_irae, pneumonitis_irae, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae, data_source, ici_drug, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  dplyr::filter(freq > 0) %>%
  # get rid of technically variable features
  dplyr::filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")))
    
# only 2 patients with serious (grade > 2) irAEs

baseline_flow_data

```

# Summarize cohort metadata

```{r}

cohort_metadata_long <- baseline_flow_data %>%
  # ignore pivoted freq info
  group_by(patient_id) %>%
  slice(1) %>%
  ungroup() %>%
  # standardize irae_ex for non-irAE group
  mutate(irae_ex = if_else(group == "non-irAE", "None", irae_ex)) %>%
  # Split irae_ex into multiple rows for multiple irAEs/patient
  separate_rows(irae_ex, sep = ";\\s*|_|,\\s*") %>%
  # standardize values for toxicities, here are irAE keywords
  # rash, Arthralgia, Fatigue, pneumonitis, esophagitis, nausea, itching, Hypothyroidism/hyper, edema, Pruritus, Arthritis, skin, Encephalitis, AKI, hepatitis, diarrhea, dermatitis, Pericardial/Pleural effusion
  mutate(
    irae_ex = case_when(
      grepl("rash|itch|skin|dermatitis|Pruritis|Pruritus", irae_ex, ignore.case = TRUE) ~ "Skin",
      grepl("Thyroid", irae_ex, ignore.case = TRUE) ~ "Thyroid",
      grepl("Arthritis", irae_ex, ignore.case = TRUE) ~ "Arthritis",
      grepl("Encephalitis", irae_ex, ignore.case = TRUE) ~ "Encephalitis",
      grepl("Pericardial/Pleural effusion", irae_ex, ignore.case = TRUE) ~ "Pericardial/pleural effusion",
      grepl("edema", irae_ex, ignore.case = TRUE) ~ "Edema",
      grepl("Arthalgia|Arthralgia", irae_ex, ignore.case = TRUE) ~ "Arthralgia",
      grepl("Fatigue", irae_ex, ignore.case = TRUE) ~ "Fatigue",      
      grepl("esophagitis", irae_ex, ignore.case = TRUE) ~ "Esophagitis",
      grepl("pneumonitis", irae_ex, ignore.case = TRUE) ~ "Pneumonitis",
      grepl("nausea", irae_ex, ignore.case = TRUE) ~ "Nausea",      
      grepl("AKI", irae_ex, ignore.case = TRUE) ~ "AKI",      
      grepl("hepatitis", irae_ex, ignore.case = TRUE) ~ "Hepatitis",    
      grepl("diarrhea", irae_ex, ignore.case = TRUE) ~ "Diarrhea",      
      # everything else is just redundant/useless info I believe
      TRUE ~ NA
    ),
    patient_id = gsub("LinsleyLab", "", patient_id),
    ctcae_grade = as.character(ctcae_grade),
    age = as.character(age),
    days_to_irae = as.character(days_to_irae)
  ) %>%
  # get rid of redundant/unnecessary irAE info
  group_by(patient_id, irae_ex) %>%
  slice(1) %>%
  ungroup() %>%
  # gather variables into long format for plotting
  pivot_longer(cols = c(cancer_type, irae_ex, ctcae_grade, data_source, ici_drug),
               names_to = "variable", values_to = "value") %>%
  dplyr::filter(!(is.na(value))) %>%
  mutate(variable = case_when(
    variable == "cancer_type" ~ "Cancer\ntype",
    variable == "irae_ex" ~ "irAE\ntype",
    variable == "ctcae_grade" ~ "CTCAE\ngrade",
    variable == "data_source" ~ "Data\nsource",
    variable == "ici_drug" ~ "ICI\ndrug",
    TRUE ~ variable
  ))

cohort_metadata_long$variable <- factor(
  cohort_metadata_long$variable, 
  levels = c("Data\nsource", "Cancer\ntype", "ICI\ndrug", "irAE\ntype", "CTCAE\ngrade")
)

p <- ggplot(cohort_metadata_long, aes(x = patient_id, y = value)) +
  geom_point(aes(color = group), size = 2) +
  facet_grid(variable ~ group, scales = "free", space = "free_y") +
  labs(x = "Patient ID", y = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
        strip.text = element_text(size = 10),
        legend.text = element_text(size = 12))

p

ggsave("../figures/metadata.png", p, width = 10, height = 9)

```

# Define logit transform func

```{r}

logitNorm <- function(v){
  newVals <- v
  # Check to see if it's 0 to 1 or 0 to 100, and then switch it to 0 to 1
  if( any(v>1) & all(v<=100) ){
    newVals <- v/100
  }
  # if there are 0s or 1s, add/subtract a small value
  # so the logit norm is defined
  epsilon <- min(newVals[newVals!=0])/2
  newVals[newVals==0] <- epsilon
  newVals[newVals==1] <- 1-epsilon
  # Do the logit norm
  newVals <- log2(newVals/(1-newVals))
  if( any(is.na(newVals))){
    print(head(data.frame(v,newVals)))
  }
  return(newVals)
}

```

# Look at DP (feature lost in regressing out covars)

```{r}

plot_data <- baseline_flow_data %>%
  mutate(freq = logitNorm(freq)) %>%
  dplyr::filter(sort == "DP of Tcells")

p <- plot_data %>%
  ggplot(aes(x = group, y = freq, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  #facet_wrap(~ sort, ncol = 3) +
  geom_jitter(color = "grey", size = 0.5) +
  labs(x = "", y = "DP of Tcells freq (logit-\ntransformed % of parent)") +
  scale_fill_manual(values = c("Healthy_Control" = "purple", "AID_Patient" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  theme(axis.text.x = element_blank(),
        strip.text = element_text(size = 8))

p

```

# Regress out confounding batch in baseline data

```{r}

# lose some features because of NA (don't drop patients, drop features) due to 0 freq in parent

regressing_out_confounders_df <- baseline_flow_data %>%
  mutate(freq = logitNorm(freq)) %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num, irae_ex, ici_drug, data_source)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  # don't drop NA rows, instead remove features (cols) with an NA
  mutate(Batch = as.factor(Batch),
         age = as.factor(age),
         cancer_type = as.factor(cancer_type)) %>%
  dplyr::filter(!(is.na(patient_id)))

metadata_cols <- regressing_out_confounders_df[, 1:15]
feature_cols <- regressing_out_confounders_df[, 16:ncol(regressing_out_confounders_df)] %>%
  # Z-score normalize across patients for each feature
  mutate(across(where(is.numeric), ~ scale(.)))

# remove 15/71 features with NAs
na_count_per_feature <- colSums(is.na(feature_cols))
feature_cols_filtered <- feature_cols[, na_count_per_feature == 0]

# Function to regress out confounders (batch) for each feature
regress_out_confounders <- function(feature, batch) {
  # Build the linear model and get residuals
  model <- lm(feature ~ batch)
  residuals(model)
}

adjusted_features <- as.data.frame(lapply(feature_cols_filtered, 
                                          regress_out_confounders, 
                                          batch = regressing_out_confounders_df$Batch))

adjusted_data <- cbind(metadata_cols, adjusted_features)

adjusted_data

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, color by cancer type

```{r}

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)]

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = cancer_type), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = cancer_type), size = 1, linetype = 2) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_primary_cancer_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      group = pcaData$group)
res <- compareGroups(group ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

```

# Stats now with batch-corrected data

```{r}

stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae, days_to_irae, thyroid_cat, cancer_type), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[group == "non-irAE"])$p.value > 0.05,
                       shapiro.test(value[group == "irAE/SAE"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  arrange(pval) %>%
  filter(pval < 0.07)

stats_df

```

# Try module approach from "top" features

```{r}

wide_baseline_flow_data_confounders_regressed_out <- adjusted_data %>%
  # take "top" features
  select("patient_id", "group", stats_df$sort) %>%
  rowwise() %>%
  mutate(mean_value = mean(c_across(-c(patient_id, group)), na.rm = TRUE)) %>%
  ungroup() %>%
  select(patient_id, group, mean_value)

wide_baseline_flow_data_confounders_regressed_out %>%
  summarize(
    # Perform Shapiro-Wilk test for normality in each group
    shapiro_non_irae = shapiro.test(mean_value[group == "non-irAE"])$p.value,
    shapiro_irae = shapiro.test(mean_value[group == "irAE/SAE"])$p.value,
    
    # Choose between t-test and Wilcoxon test based on normality
    pval = ifelse(
      shapiro_non_irae > 0.05 & shapiro_irae > 0.05,
      t.test(mean_value[group == "non-irAE"], 
             mean_value[group == "irAE/SAE"], 
             paired = FALSE)$p.value,
      wilcox.test(mean_value[group == "non-irAE"], 
                  mean_value[group == "irAE/SAE"], 
                  paired = FALSE, exact = FALSE)$p.value
    )
  )

ggplot(wide_baseline_flow_data_confounders_regressed_out, aes(x = group, y = mean_value, color = group)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "Top features module score", x = "")

```

# Plot PCA results for baseline data with batch (+/- age) regressed out

```{r}

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_general <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(5)

top_contributing_features_PC2_general <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = group), size = 1, linetype = 2) +
  #scale_color_manual(values = c("HC" = "purple", "AID" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  #scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = median(pcaData$age, na.rm = TRUE), limits = c(min(pcaData$age), max(pcaData$age))) +  # Blue-White-Red gradient with median age as white
  #xlim(-limits[1], limits[1]) +
  #ylim(-limits[2], limits[2]) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      group = pcaData$group)
res <- compareGroups(group ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

p <- ggplot(pcaData, aes(x = group, y = PC1, color = group)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "PC1", x = "")

p

ggsave("../figures/baseline_pc1_boxplot_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 5, height = 3.5)

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, thyroid irAEs specifically

```{r}

thyroid_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[thyroid_irae == "Thyroid irAE"])$p.value > 0.05,
                       shapiro.test(value[thyroid_irae == "No thyroid irAE"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] #%>% select(thyroid_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_thyroid <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(15)

top_contributing_features_PC2_thyroid <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = thyroid_irae), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = thyroid_irae), size = 1, linetype = 2) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_thyroid_irae_groups_all_features_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      thyroid_irae = pcaData$thyroid_irae)
res <- compareGroups(thyroid_irae ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

p <- ggplot(pcaData, aes(x = thyroid_irae, y = PC1, color = thyroid_irae)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "PC1", x = "")

p

ggsave("../figures/baseline_pc1_boxplot_thyroid_irae_groups_all_features_batch_regressed_out.png", plot = p, width = 5, height = 3.5)

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, thyroid irAEs (including OOR) specifically

```{r}

thyroid_with_oor_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[thyroid_irae_including_oor == "Thyroid irAE"])$p.value > 0.05,
                       shapiro.test(value[thyroid_irae_including_oor == "No thyroid irAE"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(thyroid_with_oor_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_thyroid_with_oor <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(10)

top_contributing_features_PC2_thyroid_with_oor <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = thyroid_irae_including_oor), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = thyroid_irae_including_oor), size = 1, linetype = 2) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_thyroid_irae_with_oor_groups_all_features_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      thyroid_irae_including_oor = pcaData$thyroid_irae_including_oor)
res <- compareGroups(thyroid_irae_including_oor ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

p <- ggplot(pcaData, aes(x = thyroid_irae_including_oor, y = PC1, color = thyroid_irae_including_oor)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "PC1", x = "")

p

ggsave("../figures/baseline_pc1_boxplot_thyroid_irae_with_oor_groups_all_features_batch_regressed_out.png", plot = p, width = 5, height = 3.5)

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, skin irAEs specifically

```{r}

skin_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[skin_irae == "Skin irAE"])$p.value > 0.05,
                       shapiro.test(value[skin_irae == "No skin irAE"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

skin_stats_df

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(skin_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_skin <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(15)

top_contributing_features_PC2_skin <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = skin_irae), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = skin_irae), size = 1, linetype = 2) +
  #scale_color_manual(values = c("HC" = "purple", "AID" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  #scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = median(pcaData$age, na.rm = TRUE), limits = c(min(pcaData$age), max(pcaData$age))) +  # Blue-White-Red gradient with median age as white
  #xlim(-limits[1], limits[1]) +
  #ylim(-limits[2], limits[2]) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_skin_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      skin_irae = pcaData$skin_irae)
res <- compareGroups(skin_irae ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

p <- ggplot(pcaData, aes(x = skin_irae, y = PC1, color = skin_irae)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "PC1", x = "")

p

ggsave("../figures/baseline_pc1_boxplot_skin_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 5, height = 3.5)

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, pneumonitis specifically

```{r}

pneumonitis_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[pneumonitis_irae == "Pneumonitis"])$p.value > 0.05,
                       shapiro.test(value[pneumonitis_irae == "No pneumonitis"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

pneumonitis_stats_df

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(pneumonitis_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_pneumonitis <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(15)

top_contributing_features_PC2_pneumonitis <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = pneumonitis_irae), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = pneumonitis_irae), size = 1, linetype = 2) +
  #scale_color_manual(values = c("HC" = "purple", "AID" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  #scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = median(pcaData$age, na.rm = TRUE), limits = c(min(pcaData$age), max(pcaData$age))) +  # Blue-White-Red gradient with median age as white
  #xlim(-limits[1], limits[1]) +
  #ylim(-limits[2], limits[2]) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_pneumonitis_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 3, height = 3.5)

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      pneumonitis_irae = pcaData$pneumonitis_irae)
res <- compareGroups(pneumonitis_irae ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

p <- ggplot(pcaData, aes(x = pneumonitis_irae, y = PC1, color = pneumonitis_irae)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(y = "PC1", x = "")

p

ggsave("../figures/baseline_pc1_boxplot_pneumonitis_irae_groups_top_features_batch_regressed_out.png", plot = p, width = 5, height = 3.5)

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, pneumonitis specifically (including effusion)

```{r}

pneumonitis_including_effusion_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[pneumonitis_irae_including_effusion == "Pneumonitis"])$p.value > 0.05,
                       shapiro.test(value[pneumonitis_irae_including_effusion == "No pneumonitis"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

pneumonitis_including_effusion_stats_df

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(pneumonitis_including_effusion_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_pneumonitis_including_effusion <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(15)

top_contributing_features_PC2_pneumonitis_including_effusion <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = pneumonitis_irae_including_effusion), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = pneumonitis_irae_including_effusion), size = 1, linetype = 2) +
  #scale_color_manual(values = c("HC" = "purple", "AID" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  #scale_color_gradient2(low = "blue", mid = "grey", high = "red", midpoint = median(pcaData$age, na.rm = TRUE), limits = c(min(pcaData$age), max(pcaData$age))) +  # Blue-White-Red gradient with median age as white
  #xlim(-limits[1], limits[1]) +
  #ylim(-limits[2], limits[2]) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      pneumonitis_irae_including_effusion = pcaData$pneumonitis_irae_including_effusion)
res <- compareGroups(pneumonitis_irae_including_effusion ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, rheumatoid irAEs

```{r}

rheumatoid_irae_stats_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type, pneumonitis_irae_including_effusion, gastro_irae, rheumatoid_irae), names_to = "sort", values_to = "value") %>%
  group_by(sort) %>%
  summarize(
    Test_Type = if(all(shapiro.test(value[rheumatoid_irae == "Rheumatoid irAE"])$p.value > 0.05,
                       shapiro.test(value[rheumatoid_irae == "No rheumatoid irAE"])$p.value > 0.05)) "t-test" else "Wilcoxon",
    pval = if(Test_Type == "t-test") t.test(value ~ group)$p.value else wilcox.test(value ~ group)$p.value,
    .groups = "drop"
  ) %>%
  mutate(padj = p.adjust(pval, method = "BH")) %>%
  filter(pval < 0.1)

rheumatoid_irae_stats_df

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:15] %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_num_data_confounders_regressed_out <- (adjusted_data)[, 16:ncol(adjusted_data)] %>% select(pneumonitis_including_effusion_stats_df$sort)

#dim(wide_baseline_flow_num_data_confounders_regressed_out)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

# find features contributing most to variation

top_contributing_features_PC1_rheumatoid_irae <- pca_contributions %>%
    arrange(desc(Dim.1)) %>%
    select(Dim.1) %>%
    head(15)

top_contributing_features_PC2_rheumatoid_irae <- pca_contributions %>%
    arrange(desc(Dim.2)) %>%
    select(Dim.2) %>%
    head(10)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = rheumatoid_irae), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = rheumatoid_irae), size = 1, linetype = 2) +
  labs(color = "") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

compVar <- data.frame(PC1 = pcaData$PC1,
                      PC2 = pcaData$PC2,
                      PC3 = pcaData$PC3,
                      rheumatoid_irae = pcaData$rheumatoid_irae)
res <- compareGroups(rheumatoid_irae ~ PC1 + PC2 + PC3, data = compVar, p.corrected = TRUE, method = 1)
res

# using "top" features, PC1 pops out as differential:

```

# Plot PCA results for baseline data with batch (+/- age) regressed out, gastrointestinal irAEs
 - only 2 patients with gastrointestinal irAEs...

# Compare contributing features above
 - complicated by different top features/top vs. all features
 
```{r}

all_features <- unique(c(
  rownames(top_contributing_features_PC1_thyroid),
  rownames(top_contributing_features_PC1_skin),
  rownames(top_contributing_features_PC1_general)
))

merged_data <- data.frame(
  PC1_thyroid = top_contributing_features_PC1_thyroid$Dim.1[match(all_features, rownames(top_contributing_features_PC1_thyroid))],
  PC1_skin = top_contributing_features_PC1_skin$Dim.1[match(all_features, rownames(top_contributing_features_PC1_skin))],
  PC1_general = top_contributing_features_PC1_general$Dim.1[match(all_features, rownames(top_contributing_features_PC1_general))]
)

rownames(merged_data) <- all_features

merged_data[is.na(merged_data)] <- 0

merged_data <- merged_data %>%
  mutate(Sum = rowSums(.)) %>%
  arrange(desc(Sum)) %>%
  select(-Sum)

rownames(merged_data) <- gsub("\\.", " ", rownames(merged_data))

Heatmap(merged_data, 
        name = "Contribution (%)", 
        col = colorRamp2(c(0, max(merged_data)), c("white", "darkred")),
        row_names_gp = gpar(fontsize = 10),
        column_names_gp = gpar(fontsize = 10),
        cluster_rows = FALSE, 
        cluster_columns = FALSE,
        cell_fun = function(j, i, x, y, width, height, fill) {
          # Display raw contribution percentages in each cell
          grid.text(sprintf("%.2f", merged_data[i, j]), x, y, gp = gpar(fontsize = 8, col = "black"))
        })

```

# Look for correlation b/w irAE grade/time to irAE and freq for each feature/subset (baseline)

```{r}

ctcae_cor_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type), names_to = "sort", values_to = "freq") %>%
  # replace non-irAE CTCAE grade (NA) with 0 to include in correlation analysis
  # if not doing this, 1 feature weakly correlates (so just within irAE group with irAE severity)
  mutate(ctcae_grade = if_else(is.na(ctcae_grade), 0, ctcae_grade)) %>%
  group_by(sort) %>%
  summarize(cor_result = list(cor.test(ctcae_grade, freq, method = "spearman")), .groups = 'drop') %>%
  mutate(
    estimate = map_dbl(cor_result, ~ .x$estimate),
    p.value = map_dbl(cor_result, ~ .x$p.value)
  ) %>%
  mutate(p.adj = p.adjust(p.value, method = "BH")) %>%
  select(sort, estimate, p.adj) %>%
  arrange(p.adj) %>%
  print()

time_to_irae_df <- adjusted_data %>%
  pivot_longer(cols = -c(patient_id, group, ctcae_grade, Batch, age, thyroid_irae, thyroid_irae_including_oor, skin_irae, pneumonitis_irae, days_to_irae, thyroid_cat, cancer_type), names_to = "sort", values_to = "freq") %>%
  filter(group == "irAE/SAE") %>%
  group_by(sort) %>%
  summarize(cor_result = list(cor.test(days_to_irae, freq, method = "spearman")), .groups = 'drop') %>%
  mutate(
    estimate = map_dbl(cor_result, ~ .x$estimate),
    p.value = map_dbl(cor_result, ~ .x$p.value)
  ) %>%
  mutate(p.adj = p.adjust(p.value, method = "BH")) %>%
  select(sort, estimate, p.adj) %>%
  arrange(p.adj) %>%
  print()

```

# Determine clusters in PCA space, then test for enrichment of study groups in clusters

```{r}

# Elbow method to determine optimal number of clusters
set.seed(123)
wss <- sapply(1:10, function(k) {
  kmeans(pcaData[, c("PC1", "PC2", "PC3")], centers = k, nstart = 25)$tot.withinss
})

# Plot the Elbow curve
plot(1:10, wss, type = "b", pch = 19, frame = FALSE, xlab = "Number of clusters", ylab = "Total within-cluster sum of squares")

kmeans_result <- kmeans(pcaData[, c("PC1", "PC2", "PC3")], centers = 10, nstart = 25)

# Add cluster assignments to the data
pcaData$cluster <- factor(kmeans_result$cluster)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = cluster), size = 2, alpha = 0.8) +  # Color by cluster
  labs(color = "Cluster") +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

table_result <- table(pcaData$cluster, pcaData$group)

chisq_test <- chisq.test(table_result)
chisq_test
fisher_test <- fisher.test(table_result)
fisher_test

```

# Make VP of changes between irAE and no irAE groups

```{r}

df <- adjusted_data

irae_group <- df %>% dplyr::filter(group == "irAE/SAE")
no_irae_group <- df %>% dplyr::filter(group == "non-irAE")

non_feature_cols <- c("patient_id", "group", "specific_group", "irae_ex", "Batch", 
                      "age", "ctcae_grade", "thyroid_irae", "thyroid_irae_including_oor", "skin_irae", "days_to_irae", "thyroid_cat")
feature_columns <- setdiff(colnames(df), non_feature_cols)

# Calculate mean residuals for each feature
irae_means <- (irae_group %>% select(all_of(feature_columns)) %>% summarise_all(mean))
no_irae_means <- no_irae_group %>% select(all_of(feature_columns)) %>% summarise_all(mean)

abs_diff <- (as.numeric(irae_means) - as.numeric(no_irae_means))
#log2_fc <- sign(fc) * log2(abs(fc))

pvals <- sapply(feature_columns, function(feature) {
  wilcox.test(irae_group[[feature]], no_irae_group[[feature]])$p.value
})

padj <- p.adjust(pvals, method = "BH")

volcano_df <- data.frame(
  feature = feature_columns,
  abs_diff = abs_diff,
  padj = padj,
  neg_log10_padj = -log10(padj)
)

ggplot(volcano_df, aes(x = abs_diff, y = neg_log10_padj)) +
  geom_point(aes(color = padj < 0.1)) +
  theme_minimal() +
  labs(x = "irAE/SAE vs. no irAE (absolute difference in mean of residuals)", y = "-log10(padj)") +
  geom_vline(xintercept = 0, linetype = "dashed") + # Vertical line at 0 fold change +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed") + # horizontal line at sig threshold
  geom_text_repel(data = subset(volcano_df, padj < 0.35), 
                  aes(label = feature), size = 3, box.padding = 0.5, max.overlaps = 10)

```

# Make a boxplot for features of interest after regressing out batch

```{r}

# features of interest from literature
# DN of Bcells"                    "CD8 of Tcells"                   "CD38hiCD127neg of NN CD8 Tcells"

plot_data <- adjusted_data %>% select(group, DN.of.Bcells, CD8.of.Tcells, CD38hiCD127neg.of.NN.CD8.Tcells) %>%
  pivot_longer(cols = c(DN.of.Bcells, CD8.of.Tcells, CD38hiCD127neg.of.NN.CD8.Tcells), names_to = "sort", values_to = "freq") %>%
  mutate(sort = case_when(
    sort == "CD8.of.Tcells" ~ "CD8 of Tcells",
    sort == "CD38hiCD127neg.of.NN.CD8.Tcells" ~ "CD38hiCD127-\nof NN CD8s",
    sort == "DN.of.Bcells" ~ "DN of Bcells"
  ))

p <- plot_data %>%
  ggplot(aes(x = group, y = freq, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~ sort, ncol = 3) +
  geom_jitter(color = "grey", size = 0.5) +
  labs(x = "", y = "Residuals (batch\nregressed out)") +
  scale_fill_manual(values = c("Healthy_Control" = "purple", "AID_Patient" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  theme(axis.text.x = element_blank(),
        strip.text = element_text(size = 8))

p

ggsave("../figures/batch_regressed_out_residuals_by_feature_hits.png", plot = p, width = 7, height = 3.5)

```

# Find optimal number of components for ICA

```{r}

### Show example of one splitting iteration
# Split the features into 2 ~equal sets
## Set seed for reproducibility
feats1 <- sample(colnames(wide_baseline_flow_num_data_confounders_regressed_out),round(ncol(wide_baseline_flow_num_data_confounders_regressed_out)/2) )
feats2 <- colnames(wide_baseline_flow_num_data_confounders_regressed_out)[!colnames(wide_baseline_flow_num_data_confounders_regressed_out) %in% feats1]
print( paste0("Num features: ", length(feats1), ", ", length(feats2)) )

# Generate 2 ICA models with the split genes with 8 components
ncomps <- 6
ica1 <- icafast(wide_baseline_flow_num_data_confounders_regressed_out[,feats1], ncomps, center = FALSE, maxit = 5000, tol = 1e-6, Rmat = diag(ncomps), alg = "par", fun = "logcosh", alpha = 1)
print(paste0("Sample ICA Weight Matrix Dimensions: ", nrow(ica1$S)," by ", ncol(ica1$S)) )
ica2 <- icafast(wide_baseline_flow_num_data_confounders_regressed_out[,feats2], ncomps, center = FALSE, maxit = 5000, tol = 1e-6, Rmat = diag(ncomps), alg = "par", fun = "logcosh", alpha = 1)

## Correlate the components together
cormat <- cor(ica1$S, ica2$S,method="spearman")
rowMaxes <- apply(abs(cormat),1,max)
rownames(cormat) <- as.character( signif(rowMaxes,3))
Heatmap(abs(cormat), name="Pearson\nCorrelation",column_title="Pairwise Correlations Between Split ICA Models")
# Get the worst best correlation
minMaxR <- min( apply(abs(cormat),1,max) )
print( paste0("Worst best component correlation: ",minMaxR) )

## Function to compute worst best component correlation for a sequence of component numbers
getSplitMinMaxR <- function(nCompsSequence, data.tmp=wide_baseline_flow_num_data_confounders_regressed_out){ # get the minimum spearman correlation between the ICA components from the two splits
  
  # Split the features into 2 equal sets
  feats1 <- sample(colnames(wide_baseline_flow_num_data_confounders_regressed_out),round(ncol(wide_baseline_flow_num_data_confounders_regressed_out)/2) )
  feats2 <- colnames(wide_baseline_flow_num_data_confounders_regressed_out)[!colnames(wide_baseline_flow_num_data_confounders_regressed_out) %in% feats1]
  
  getMinMaxR <- function(ncomps){
    print(ncomps)
    ica1 <- icafast(wide_baseline_flow_num_data_confounders_regressed_out[,feats1], ncomps, center = FALSE, maxit = 5000, tol = 1e-6, Rmat = diag(ncomps), alg = "par", fun = "logcosh", alpha = 1)
    ica2 <- icafast(wide_baseline_flow_num_data_confounders_regressed_out[,feats2], ncomps, center = FALSE, maxit = 5000, tol = 1e-6, Rmat = diag(ncomps), alg = "par", fun = "logcosh", alpha = 1)
    cormat <- cor(ica1$S, ica2$S,method="spearman")
    vals <- c( minMaxR = min( apply(abs(cormat),2,max)), ncomps=ncomps )
  }
  
  minMaxRs <- data.frame( t(sapply( nCompsSequence, getMinMaxR)) )
  return(minMaxRs)
}

# Do two splits
nCompsSequence <- 2:15
numShuffles <- 2
minMaxRs <- lapply(1:numShuffles, function(i) getSplitMinMaxR(nCompsSequence, wide_baseline_flow_num_data_confounders_regressed_out) )
for( i in 1:length(minMaxRs) ){
  minMaxRs[[i]]$shuffleNumber <- i
}
print("Min Max Rs: ")
print(minMaxRs)
numShuffles <- length(minMaxRs)

getCorDiffs <- function( minMaxR ){
  corDiffs <- minMaxR$minMaxR[2:nrow(minMaxR)] - minMaxR$minMaxR[1:(nrow(minMaxR)-1) ]
  biggestDecline <- minMaxR$ncomps[ which( corDiffs == min(corDiffs)) ]
  print( paste0("Biggest Correlation Decline: ", biggestDecline, " to ", biggestDecline+1 ) )
  return(biggestDecline)
}

biggestDeclines <- sapply(minMaxRs,getCorDiffs)
biggestDeclineTab <- table(biggestDeclines)
ggplot() + geom_histogram( aes(x=biggestDeclines)) + labs(x="# of components before the largest decline")
optimalCompNum <- as.numeric( names(biggestDeclineTab)[biggestDeclineTab==max(biggestDeclineTab)] )
print(optimalCompNum)

## Make boxplot of results of correlations for all 50 subsamples
minMaxRsLong <- do.call(rbind,minMaxRs)
ggplot(minMaxRsLong,aes(x=ncomps,y=minMaxR)) + geom_boxplot(aes(group=ncomps)) + geom_line(aes(group=shuffleNumber), alpha=0.1,color="red") + labs(x="number of ICA components",y="Lowest Component\nSpearman Correlation",title=paste0( numShuffles," Feature 2-Way Splits\nMinMax Component Correlation")) + geom_vline(xintercept = optimalCompNum, linetype="dashed",color="blue")

```

# Run ICA with optimal num of components

```{r}

optimalCompNum <- 6  # or set to your identified number of components
ica_model <- icafast(wide_baseline_flow_num_data_confounders_regressed_out, optimalCompNum, center = FALSE, maxit = 5000, tol = 1e-6, Rmat = diag(optimalCompNum), alg = "par", fun = "logcosh", alpha = 1)

# Extract the ICA components
ica_components <- ica_model$S

wide_baseline_flow_metadata_confounders_regressed_out$patient_id_simple <- as.character(wide_baseline_flow_metadata_confounders_regressed_out$patient_id_simple)

# Create a data frame with the first 2 or 3 components for visualization
ica_df <- data.frame(Comp1 = ica_components[,1], Comp2 = ica_components[,2], patient_id_simple = as.character(rownames(wide_baseline_flow_num_data_confounders_regressed_out))) %>%
  left_join(wide_baseline_flow_metadata_confounders_regressed_out, by = "patient_id_simple") %>%
  # just look at cancer patients (baseline)
  filter(!(is.na(group)))

# Plot the first 2 components
ggplot(ica_df, aes(x=Comp1, y=Comp2)) +
  geom_point(aes(color=group), size=2) + 
  labs(x="ICA Component 1", y="ICA Component 2")

```

# Cluster baseline cancer samples in ICA space, test for enrichment of irAE groups

```{r}

wss <- sapply(1:10, function(k) {
  kmeans(ica_df[, c("Comp1", "Comp2")], centers = k, nstart = 25)$tot.withinss
})

# Plot the Elbow curve
plot(1:10, wss, type = "b", pch = 19, frame = FALSE, xlab = "Number of clusters", ylab = "Total within-cluster sum of squares")

kmeans_result <- kmeans(ica_df[, c("Comp1", "Comp2")], centers = 6, nstart = 25)

# Add cluster assignments to the data
ica_df$cluster <- factor(kmeans_result$cluster)

ggplot(ica_df, aes(x = Comp1, y = Comp2, color = cluster)) +
  geom_point(size = 2, alpha = 0.8) +
  labs(x = "ICA Component 1", y = "ICA Component 2", color = "Cluster") +
  theme_minimal()

# Create contingency table for clusters vs. group
table_result <- table(ica_df$cluster, ica_df$group)

# Perform Chi-square and Fisher's Exact tests
chisq_test <- chisq.test(table_result)
fisher_test <- fisher.test(table_result)

# Display results
chisq_test
fisher_test

```

# Find features associating with age in HC/AID groups (to see if those who develop irAEs have older immunotypes)

```{r}

non_cancer_data <- adjusted_data %>%
  mutate(age = as.numeric(as.character(age))) %>%
  filter(group %in% c("AID_Patient", "Healthy_Control"))

immune_features <- non_cancer_data[, 10:ncol(non_cancer_data)]

correlation_results <- immune_features %>%
  summarise(across(everything(), ~ cor.test(.x, non_cancer_data$age, method = "spearman")$estimate)) %>%
  pivot_longer(cols = everything(), names_to = "feature", values_to = "correlation")

p_values <- immune_features %>%
  summarise(across(everything(), ~ cor.test(.x, non_cancer_data$age, method = "spearman")$p.value)) %>%
  pivot_longer(cols = everything(), names_to = "feature", values_to = "p_value")

correlation_summary <- left_join(correlation_results, p_values, by = "feature") %>%
  mutate(padj = p.adjust(p_value, method = "BH")) %>%
  arrange(padj) %>%
  filter(padj < 0.05)

correlation_summary

ggplot(non_cancer_data, aes(x = age, y = naive.of.CD8.Tcells, color = group)) +
  geom_point(alpha = 0.6) +  # Scatter points
  geom_smooth(method = "lm", color = "black", se = FALSE)

```

# Use LMs from non-cancer group (with age as factor) on cancer data to predict immunotype scores for features associating with age in non-cancer group

```{r}

# Fit a linear model for each age-correlated feature
models <- lapply(correlation_summary$feature, function(feature) {
  lm(as.formula(paste(feature, "~ age")), data = non_cancer_data)
})
names(models) <- correlation_summary$feature  # Name each model with its corresponding feature

models

cancer_data <- adjusted_data %>%
  mutate(age = as.numeric(as.character(age))) %>%
  filter(!(group %in% c("AID_Patient", "Healthy_Control")))

predict_immunotype_score <- function(model, age) {
  intercept <- coef(model)[1]
  slope <- coef(model)[2]
  return(intercept + slope * age)
}

predicted_scores <- data.frame(patient_id = cancer_data$patient_id)

# Loop through each model and predict scores for cancer patients
for (feature in names(models)) {
  predicted_scores[[feature]] <- sapply(cancer_data$age, function(age) predict_immunotype_score(models[[feature]], age))
}

# Rename the scores column to a more descriptive name
colnames(predicted_scores)[-1] <- paste0("immunotype_age_score_", names(models))

predicted_scores_with_metadata <- left_join(cancer_data %>% select(patient_id, group), predicted_scores, by = "patient_id")

predicted_scores_with_metadata

# Reshape data to long format for ggplot
predicted_scores_with_metadata_long <- predicted_scores_with_metadata %>%
  pivot_longer(cols = starts_with("immunotype_age_score"), 
               names_to = "immunotype", 
               values_to = "score") %>%
  mutate(immunotype = gsub("immunotype_age_score_", "", immunotype))

ggplot(predicted_scores_with_metadata_long, aes(x = immunotype, y = score, color = group)) +
  geom_point(position = position_jitter(width = 0.2), size = 1) +  # Add jitter for better visibility
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  labs(x = "", y = "Predicted score based\non HC/AID data")

```