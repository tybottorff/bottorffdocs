---
title: "Molly Fisher Thomas colitis data"
output: pdf_document
---

 - data mining of https://villani.mgh.harvard.edu/ircolitis/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Matrix)
library(ggplot2)
library(dplyr)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(Seurat)
library(factoextra)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in baseline data to look at group differences

```{r}

baseline_flow_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  # subset for only baseline visits
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`) %>%
  filter(cleaned_visit_num == 1 | is.na(cleaned_visit_num) & group %in% c("AID_Patient", "Healthy_Control")) %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  filter(freq > 0) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis") ~ "Not severe",
    group == "non-irAE" ~ "Cancer group - no irAE",
    group %in% c("AID_Patient", "Healthy_Control") ~ "HC/AID - no irAE"),
    pneumonitis = if_else(str_detect(irae_ex, "pneumonitis"), "Pneumonitis", "No pneumonitis"),
    thyroid_irae = if_else(str_detect(irae_ex, "thyroid|Thyroid"), "Thyroid irAE", "No thyroid irAE"),
    skin_irae = if_else(str_detect(irae_ex, "skin|Rash|Pruritus|dermatitis"), "Skin irAE", "No skin irAE")
  )

baseline_flow_data

```

# Stats tests for baseline data

```{r}

stats_test <- baseline_flow_data %>%
  mutate(simpler_group = case_when(
    group %in% c("non-irAE", "irAE/SAE") ~ "Cancer",
    group == "Healthy_Control" ~ "HC",
    group == "AID_Patient" ~ "AID")) %>%
  filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  group_by(sort) %>%
  summarize(pval = wilcox.test(freq[irae_severity_category == "Severe"], freq[irae_severity_category != "Severe"], paired = FALSE, exact = FALSE)$p.value) %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval)

stats_test

```

# Prepare data for PCA from baseline data

```{r}

wide_baseline_flow_num_data <- baseline_flow_data %>%
  filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category)) %>%
  select(-c(patient_id, group, specific_group, irae_ex, irae_severity_category))

wide_baseline_flow_num_data

wide_baseline_flow_metadata <- baseline_flow_data %>%
  filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category)) %>%
  select(c(patient_id, group, specific_group, irae_ex, irae_severity_category)) %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_metadata

```

# Make PCA plots for baseline data

```{r}

#dim(wide_baseline_flow_num_data)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores= as.data.frame(pca$x)

pcaScores

pcaScores$patient_id_simple = row.names(pcaScores)

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = irae_severity_category), size = 2, alpha = 0.8) + 
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  labs(color = "irAE severity") +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7)  # Make legend text smaller
  ) +
  guides(color = guide_legend(nrow = 6)) +  # Adjust legend to 2 rows
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/pca_specific_group.png", plot = p, width = 7, height = 8)

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for HC vs. cancer (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group != "AID")

# Define the order of groups
group_order <- c("HC", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("HC" = "black", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (HC vs. cancer, 2)
sig_list <- c("CD38hiCD127neg of NN CD8 Tcells", "Treg of CD4 Tcells")

# Create a dataframe for sorting rows based on if significant for HC vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(69, 2)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nHC vs. cancer", "Significant HC\nvs. cancer"), row.subsections))
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_HC_vs_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for AID vs. cancer (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group != "HC")

# Define the order of groups
group_order <- c("AID", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID" = "blue", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. cancer, 13)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "Tcells of nonGrans", "NKcells of nonGrans", "Tfh of NN Tconv Tcells", "CXCR3pos of NN CD8 Tcells", "CD11cpos of Bcells", "MAIT of NN CD8 Tcells", "naive of Treg Tcells", "CRTH2pos of NN CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CCR4pos of NN Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(58, 13)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. cancer", "Significant AID\nvs. cancer"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_AID_vs_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for irAE vs. AID (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("AID_Patient", "irAE/SAE"))

# Define the order of groups
group_order <- c("AID_Patient", "irAE/SAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID_Patient" = "blue", "irAE/SAE" = "red")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. irAE/SAE, 11)
sig_list <- c("CD11cpos of Bcells", "NKcells of nonGrans", "Tcells of nonGrans", "Tfh of NN Tconv Tcells", "Tfh of NN Tconv Tcells", "naive of CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CXCR3pos of NN CD8 Tcells", "naive of Treg Tcells", "DN of Bcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(69, 11)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. irAE", "Significant AID\nvs. irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/holly_wip_heatmap_z_scores_AID_vs_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. AID (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("AID_Patient", "non-irAE"))

# Define the order of groups
group_order <- c("AID_Patient", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID_Patient" = "blue", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. non-irAE, 10)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "CCR4pos of NN Tconv Tcells", "CRTH2pos of NN CD8 Tcells", "ICOSpos of Tfh Tconv Tcells", "CRTH2pos of NN Tconv Tcells", "SCM of Tconv Tcells", "EMRA of CD8 Tcells", "KLRG1posTIGITpos of CD8 Tcells", "Tcells of nonGrans")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(70, 10)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. non-irAE", "Significant AID\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/holly_wip_heatmap_z_scores_AID_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. HC (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("Healthy_Control", "non-irAE"))

# Define the order of groups
group_order <- c("Healthy_Control", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("Healthy_Control" = "black", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (HC vs. non-irAE, 5)
sig_list <- c("CRTH2pos of NN Tconv Tcells", "Treg of CD4 Tcells", "CD38hiCD127neg of NN CD8 Tcells", "CRTH2pos of NN CD8 Tcells", "SCM of Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(75, 5)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nHC vs. non-irAE", "Significant HC\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/holly_wip_heatmap_z_scores_HC_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Read in all visits' cancer patient data to look at baseline vs. post-ICI and non-irAE vs. irAE in post ICI

```{r}

cancer_flow_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  # subset for only cancer patients
  filter(`General Patient Type` == "Cancer_Patient",
         `Visit Descriptor` %in% c("Visit 1", "visit 1", "Visit 2", "Visit 2, irAE", "Visit 3", "Visit 3, irAE")) %>%
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  # group by patient and handle cases with 1 (exclude), 2 (keep both), or 3 (keep visits 1 and 3 only, exclude visit 2) visits
  # rationale here is to take later post-ICI visit if possible (i.e. if we have 3), but may want to reconsider this
  group_by(`Subject ID`) %>%
  filter(n() >= 2, if (n() == 3) cleaned_visit_num %in% c(1, 3) else TRUE) %>%
  ungroup() %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`) %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  )

cancer_flow_data
  
```

# Stats tests including post-baseline data

```{r}

cancer_stats_test <- cancer_flow_data %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis") ~ "Not severe",
    group == "non-irAE" ~ "Cancer group - no irAE",
    group %in% c("AID_Patient", "Healthy_Control") ~ "HC/AID - no irAE")) %>%
  filter(cleaned_visit_num != 1, irae_severity_category %in% c("Severe", "Cancer group - no irAE")) %>%
  group_by(sort) %>%
  # paired TRUE for pre/post, FALSE for group comparisons
  summarize(pval = wilcox.test(freq[irae_severity_category == "Severe"], freq[irae_severity_category == "Cancer group - no irAE"], paired = FALSE, exact = FALSE)$p.value) %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval) %>%
  filter(adj_pval < 0.05)

cancer_stats_test

# no differences in subset freqs between irAE and no irAE groups looking only at post-ICI data, nor for severe vs. no irAE

# there are a good number of pre/post ICI subset freq differneces in irAE group
# 0.01 < padj < 0.05
# ICOSpos of Tfh Tconv Tcells, PD1pos of CM CD8 Tcells, PD1pos of CM Treg Tcells, PD1pos of EM CD8 Tcells, PD1pos of EMRA CD8 Tcells, SCM of Tconv Tcells, PD1posCD27neg of EMRA CD8 Tcells, CXCR6posGrzmBpos of NN CD8 Tcells, CD38hiCD127neg of NN CD8 Tcells, PD1pos of CM Tconv Tcells, PDL1pos of classical monocytes, PD1pos of EM Tconv Tcells, PD1pos of EM Treg Tcells

irae_ici_effects <- c("ICOSpos of Tfh Tconv Tcells", "PD1pos of CM CD8 Tcells", "PD1pos of CM Treg Tcells", "PD1pos of EM CD8 Tcells", "PD1pos of EMRA CD8 Tcells", "SCM of Tconv Tcells", "PD1posCD27neg of EMRA CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells", "CD38hiCD127neg of NN CD8 Tcells", "PD1pos of CM Tconv Tcells", "PDL1pos of classical monocytes", "PD1pos of EM Tconv Tcells", "PD1pos of EM Treg Tcells")

# there are a good number of pre/post ICI subset freq differneces in non-irAE group too
# padj < 0.01
# ICOSpos of Tfh Tconv Tcells, PD1pos of CM CD8 Tcells, PD1pos of CM Tconv Tcells, PD1pos of EM CD8 Tcells, PD1pos of EM Tconv Tcells, PD1pos of EMRA CD8 Tcells, PD1posCD27neg of EMRA CD8 Tcells, PD1pos of NKcells, Tph of NN Tconv Tcells	
# 0.01 < padj < 0.05
# PD1pos of EM Treg Tcells, PD1pos of CM Treg Tcells, PD1posTIGITpos of EM Tconv Tcells, basophils of nonGrans

non_irae_ici_effects <- c("ICOSpos of Tfh Tconv Tcells", "PD1pos of CM CD8 Tcells", "PD1pos of CM Tconv Tcells", "PD1pos of EM CD8 Tcells", "PD1pos of EM Tconv Tcells", "PD1pos of EMRA CD8 Tcells", "PD1posCD27neg of EMRA CD8 Tcells", "PD1pos of NKcells", "Tph of NN Tconv Tcells", "PD1pos of EM Treg Tcells", "PD1pos of CM Treg Tcells", "PD1posTIGITpos of EM Tconv Tcells", "basophils of nonGrans")

# many (20) subsets differnet between pre/post ICI if grouping all cancer subjects together (irAE or no irAE)

```

# Make boxplots for subsets different over ICI treatment in either irAE or non-irAE group

```{r}

ggplot_data <- cancer_flow_data %>%
  filter(sort %in% intersect(non_irae_ici_effects, irae_ici_effects),
         freq > 0) %>%
  mutate(visit = case_when(
           cleaned_visit_num == 1 ~ "Pre-ICI",
           cleaned_visit_num %in% c(2, 3) ~ "Post-ICI"
         ),
         visit_group = paste(visit, group, sep = "_"))

ggplot_data

ggplot_data$visit <- factor(ggplot_data$visit, levels = c("Pre-ICI", "Post-ICI"))
ggplot_data$group <- factor(ggplot_data$group, levels = c("non-irAE", "irAE/SAE"))
ggplot_data$visit_group <- factor(ggplot_data$visit_group, levels = c("Pre-ICI_non-irAE", "Post-ICI_non-irAE", "Post-ICI_irAE/SAE", "Pre-ICI_irAE/SAE"))

p <- ggplot(ggplot_data, aes(x = visit_group, y = freq, color = group, shape = visit)) +
  geom_boxplot() +
  geom_point() +
  geom_line(aes(group = patient_id), color = "grey", alpha = 0.5) +
  facet_wrap( ~sort, ncol = 3) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.text = element_text(size = 6)) +
  labs(y = "Percent of parent")

p

ggsave("../figures/ici_effect_on_subsets.png", plot = p, width = 7, height = 6)

```

# Prepare data for PCA from cancer data

```{r}

wide_cancer_flow_num_data <- cancer_flow_data %>%
  select(-c(parent_population, parent_parent_population)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id)) %>%
  select(-c(patient_id, group, specific_group, cleaned_visit_num))

wide_cancer_flow_num_data

wide_cancer_flow_metadata <- cancer_flow_data %>%
  select(-c(parent_population, parent_parent_population)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id)) %>%
  select(c(patient_id, group, specific_group, cleaned_visit_num)) %>%
  mutate(patient_id_simple = row_number(),
         visit = case_when(
           cleaned_visit_num == 1 ~ "Pre-ICI",
           cleaned_visit_num %in% c(2, 3) ~ "Post-ICI"
         )) %>%
  mutate(patient_id = gsub("LinsleyLab", "", patient_id))

wide_cancer_flow_metadata

```

# Make PCA plots for cancer data

```{r}

#dim(wide_cancer_flow_num_data)

pca = prcomp(as.data.frame((na.omit(wide_cancer_flow_num_data)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores= as.data.frame(pca$x)

pcaScores

pcaScores$patient_id_simple = row.names(pcaScores)

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_cancer_flow_metadata, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = patient_id, shape = group), size = 2, alpha = 0.8) + 
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  labs(color = "Patient ID") +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7)  # Make legend text smaller
  ) +
  guides(color = guide_legend(nrow = 6)) +  # Adjust legend to 2 rows
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/pca_cancer_timepoint.png", plot = p, width = 9, height = 10)

```