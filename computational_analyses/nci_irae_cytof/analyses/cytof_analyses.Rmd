---
title: "Molly Fisher Thomas colitis data"
output: pdf_document
---

 - data mining of https://villani.mgh.harvard.edu/ircolitis/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(beeswarm)
library(Matrix)
library(ggplot2)
library(dplyr)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(Seurat)
library(factoextra)
library(lmerTest)
library(gtsummary)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in baseline data to look at group differences

```{r}

baseline_flow_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") #%>%
  # subset for only baseline visits

baseline_flow_data

```
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`) %>%
  filter(cleaned_visit_num == 1 | is.na(cleaned_visit_num) & group %in% c("AID_Patient", "Healthy_Control")) %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  filter(freq > 0) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Not severe",
    group == "non-irAE" ~ "Cancer group - no irAE",
    group %in% c("AID_Patient", "Healthy_Control") ~ "HC/AID - no irAE"),
    pneumonitis = if_else(str_detect(irae_ex, "pneumonitis"), "Pneumonitis", "No pneumonitis"),
    thyroid_irae = if_else(str_detect(irae_ex, "thyroid|Thyroid"), "Thyroid irAE", "No thyroid irAE"),
    skin_irae = if_else(str_detect(irae_ex, "skin|Rash|Pruritus|dermatitis"), "Skin irAE", "No skin irAE")
  ) %>%
  filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")))

baseline_flow_data

```

# Stats tests for baseline data

```{r}

stats_test <- baseline_flow_data %>%
  mutate(simpler_group = case_when(
    group %in% c("non-irAE", "irAE/SAE") ~ "Cancer",
    group == "Healthy_Control" ~ "HC",
    group == "AID_Patient" ~ "AID")) %>%
  filter(simpler_group == "Cancer") %>%
  group_by(sort) %>%
  summarize(pval = wilcox.test(freq[irae_severity_category == "Severe"], freq[irae_severity_category == "Cancer group - no irAE"], paired = FALSE, exact = FALSE)$p.value) %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval)

stats_test

# (severe) irAE vs. no irAE: none

# AID vs. HC, none
# AID vs. cancer:
# naive of CD8 Tcells, Treg of CD4 Tcells, Tcells of nonGrans, Tfh of NN Tconv Tcells, NKcells of nonGrans, CXCR3pos of NN CD8 Tcells, CD11cpos of Bcells, naive of Treg Tcells, MAIT of NN CD8 Tcells, unswMem of Bcells, CRTH2pos of NN CD8 Tcells
# AID vs. non-irAE: Treg of CD4 Tcells, naive of CD8 Tcells, CRTH2pos of NN CD8 Tcells, CCR4pos of NN Tconv Tcells, ICOSpos of Tfh Tconv Tcells
# AID vs. irAE: CD11cpos of Bcells, NKcells of nonGrans, Tcells of nonGrans, Tfh of NN Tconv Tcells, naive of CD8 Tcells, unswMem of Bcells, Bcells of nonGrans, CXCR3pos of NN CD8 Tcells

# HC vs. cancer: CD38hiCD127neg of NN CD8 Tcells, Treg of CD4 Tcells
# HC vs. non-irAE: CRTH2pos of NN Tconv Tcells, Treg of CD4 Tcells, CD38hiCD127neg of NN CD8 Tcells, CRTH2pos of NN CD8 Tcells, SCM of Tconv Tcells
# HC vs. irAE: none

```

# Prepare data for PCA from baseline data

```{r}

wide_baseline_flow_num_data <- baseline_flow_data %>%
  #filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category, pneumonitis, thyroid_irae, skin_irae)) %>%
  select(-c(patient_id, group, specific_group, irae_ex, irae_severity_category, pneumonitis, thyroid_irae, skin_irae))

wide_baseline_flow_num_data

wide_baseline_flow_metadata <- baseline_flow_data %>%
 #filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category, pneumonitis, thyroid_irae, skin_irae)) %>%
  select(c(patient_id, group, specific_group, irae_ex, irae_severity_category)) %>%
  mutate(patient_id_simple = row_number())

wide_baseline_flow_metadata

```

# Make PCA plots for baseline data

```{r}

#dim(wide_baseline_flow_num_data)

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores= as.data.frame(pca$x)

pcaScores

pcaScores$patient_id_simple = row.names(pcaScores)

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group), size = 2, alpha = 0.8) + 
  scale_color_manual(values = c("Healthy_Control" = "purple", "AID_Patient" = "blue", "non-irAE" = "black", "irAE/SAE" = "red")) +
  #scale_color_manual(values = c("Cancer group - no irAE" = "black", "Not severe" = "green", "Severe" = "red")) +
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  labs(color = "Group") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/baseline_pca_general_group.png", plot = p, width = 3, height = 3.5)

```

# Heatmap (using Z scores of freqs in subsets across patients) for cancer subgroups (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("non-irAE", "irAE/SAE"))

# Define the order of groups
group_order <- c("Cancer group - no irAE", "Not severe", "Severe")

# Reorder the patient_group factor by irae_severity_category
flow_data_filtered$irae_severity_category <- factor(flow_data_filtered$irae_severity_category, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$irae_severity_category, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + irae_severity_category)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("Cancer group - no irAE" = "black", "Not severe" = "green", "Severe" = "red")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# Create a dataframe for sorting rows based
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat)),
  parent_parent_population = str_extract(gsub(".* of ", "", rownames(mat)), "[^ ]+$")
) %>%
  # Reorder rows based on parent pop
  arrange(parent_parent_population)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentparentPop = row_info$parent_parent_population)

# Alphabetize the unique parent_parent_population values
sorted_parent_parent_pops <- sort(unique(row_info$parent_parent_population))

# Define Viridis colors for the alphabetized parent_parent_population values
viridis_colors <- viridis::viridis(length(sorted_parent_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentparentPop <- factor(row_annotations$ParentparentPop, levels = sorted_parent_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentparentPop = row_annotations$ParentparentPop,
  col = list(ParentparentPop = row_annotation_colors)
)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 7),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score")
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_baseline_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for all baseline groups

```{r}

flow_data_filtered <- baseline_flow_data

# Define the order of groups
group_order <- c("HC", "AID", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("HC" = "black", "AID" = "blue", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# Create a dataframe for sorting rows based on if significant for HC vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat)),
  parentparent_pop = str_extract(gsub(".* of ", "", rownames(mat)), "[^ ]+$")
) %>%
# Trim leading/trailing spaces and standardize capitalization
  mutate(
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(parentparent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentparentPop = row_info$parentparent_pop)

# Alphabetize the unique parent_pop values
sorted_parentparent_pops <- sort(unique(row_info$parentparent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parentparent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parentparent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentparentPop <- factor(row_annotations$ParentparentPop, levels = sorted_parentparent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentparentPop,
  col = list(ParentparentPop = row_annotation_colors)
)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score")
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_all_baseline.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for AID vs. cancer (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group != "HC")

# Define the order of groups
group_order <- c("AID", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID" = "blue", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. cancer, 13)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "Tcells of nonGrans", "NKcells of nonGrans", "Tfh of NN Tconv Tcells", "CXCR3pos of NN CD8 Tcells", "CD11cpos of Bcells", "MAIT of NN CD8 Tcells", "naive of Treg Tcells", "CRTH2pos of NN CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CCR4pos of NN Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(58, 13)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. cancer", "Significant AID\nvs. cancer"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_AID_vs_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for irAE vs. AID (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("AID_Patient", "irAE/SAE"))

# Define the order of groups
group_order <- c("AID_Patient", "irAE/SAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID_Patient" = "blue", "irAE/SAE" = "red")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. irAE/SAE, 11)
sig_list <- c("CD11cpos of Bcells", "NKcells of nonGrans", "Tcells of nonGrans", "Tfh of NN Tconv Tcells", "Tfh of NN Tconv Tcells", "naive of CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CXCR3pos of NN CD8 Tcells", "naive of Treg Tcells", "DN of Bcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(69, 11)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. irAE", "Significant AID\nvs. irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_AID_vs_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. AID (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("AID_Patient", "non-irAE"))

# Define the order of groups
group_order <- c("AID_Patient", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID_Patient" = "blue", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. non-irAE, 10)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "CCR4pos of NN Tconv Tcells", "CRTH2pos of NN CD8 Tcells", "ICOSpos of Tfh Tconv Tcells", "CRTH2pos of NN Tconv Tcells", "SCM of Tconv Tcells", "EMRA of CD8 Tcells", "KLRG1posTIGITpos of CD8 Tcells", "Tcells of nonGrans")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(70, 10)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. non-irAE", "Significant AID\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_AID_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. HC (baseline)

```{r}

flow_data_filtered <- baseline_flow_data %>%
  filter(group %in% c("Healthy_Control", "non-irAE"))

# Define the order of groups
group_order <- c("Healthy_Control", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("Healthy_Control" = "black", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (HC vs. non-irAE, 5)
sig_list <- c("CRTH2pos of NN Tconv Tcells", "Treg of CD4 Tcells", "CD38hiCD127neg of NN CD8 Tcells", "CRTH2pos of NN CD8 Tcells", "SCM of Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(75, 5)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nHC vs. non-irAE", "Significant HC\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_HC_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Read in visits 1-3 cancer patient data to look at baseline vs. post-ICI and non-irAE vs. irAE in post ICI (visit 3 only, later look at irAE visit if that's different than visit 3)

```{r}

cancer_flow_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  # subset for only cancer patients
  filter(`General Patient Type` == "Cancer_Patient",
         `Visit Descriptor` %in% c("Visit 1", "visit 1", "Visit 2", "Visit 2, irAE", "Visit 3", "Visit 3, irAE")) %>%
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  # group by patient and handle cases with 1 (exclude), 2 (keep both), or 3 (keep visits 1 and 3 only, exclude visit 2) visits
  # rationale here is to take later post-ICI visit if possible (i.e. if we have 3), but may want to reconsider this
  group_by(`Subject ID`) %>%
  filter(n() >= 2, if (n() == 3) cleaned_visit_num %in% c(1, 3) else TRUE) %>%
  ungroup() %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`) %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Not severe",
    TRUE ~ "no irAE")) %>%
  filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")),
         !str_detect(sort,))

cancer_flow_data
  
```

# Stats tests including post-baseline data

```{r}

cancer_stats_test <- cancer_flow_data %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Not severe",
    group == "non-irAE" ~ "Cancer group - no irAE",
    group %in% c("AID_Patient", "Healthy_Control") ~ "HC/AID - no irAE")) %>%
  group_by(sort, group) %>%
  # paired TRUE for pre/post, FALSE for group comparisons!
  summarize(pval = wilcox.test(freq[cleaned_visit_num == 1], freq[cleaned_visit_num != 1], paired = TRUE, exact = FALSE)$p.value) %>%
  # ungroup to make sure pval adjusting is done over all tests not just tests/group
  ungroup() %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval) %>%
  filter(adj_pval < 0.05)

cancer_stats_test

# no differences in subset freqs between irAE and no irAE groups looking only at post-ICI data, nor for severe vs. no irAE

# there are a good number of pre/post ICI subset freq differneces in irAE group (none if split by severity)
# 0.01 < padj < 0.05
# excluded PD1 ones
# ICOSpos of Tfh Tconv Tcells, SCM of Tconv Tcells, CXCR6posGrzmBpos of NN CD8 Tcells, CD38hiCD127neg of NN CD8 Tcells

# there are some pre/post ICI subset freq differneces in non-irAE group too
# excluded PD1 ones
# padj < 0.01
# Tph of NN Tconv Tcells, ICOSpos of Tfh Tconv Tcells
# 0.01 < padj < 0.05
# basophils of nonGrans	

# 5 subsets different between pre/post ICI if grouping all cancer subjects together (irAE or no irAE)
# excluded PD1 ones

```

# Make boxplots for subsets different over ICI treatment in either irAE or non-irAE group

```{r}

ggplot_data <- cancer_flow_data %>%
  filter(sort %in% cancer_stats_test$sort,
         !str_detect(sort, "PD"),
         freq > 0) %>%
  mutate(visit = case_when(
           cleaned_visit_num == 1 ~ "Pre-ICI",
           cleaned_visit_num %in% c(2, 3) ~ "Post-ICI"
         ),
         visit_group = paste(visit, irae_severity_category, sep = "_"))

ggplot_data$visit <- factor(ggplot_data$visit, levels = c("Pre-ICI", "Post-ICI"))
ggplot_data$irae_severity_category <- factor(ggplot_data$irae_severity_category, levels = c("no irAE", "Not severe", "Severe"))
ggplot_data$visit_group <- factor(ggplot_data$visit_group, levels = c("Pre-ICI_no irAE", "Post-ICI_no irAE", "Pre-ICI_Not severe", "Post-ICI_Not severe", "Pre-ICI_Severe", "Post-ICI_Severe"))

p <- ggplot(ggplot_data, aes(x = visit_group, y = log10(freq), color = irae_severity_category, shape = visit)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(size = 0.75) +
  scale_color_manual(values = c("no irAE" = "black", "Not severe" = "green", "Severe" = "red")) +
  geom_line(aes(group = patient_id), color = "grey", alpha = 0.5) +
  facet_wrap( ~sort, ncol = 3) +
  theme(axis.title.x = element_blank(),
        strip.text = element_text(size = 7),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.y = element_text(size = 13)) +
  labs(y = "Percent of\nparent (log10)",
       color = "irAE severity") +
  scale_x_discrete(labels = rep(c("Pre", "Post"), 3)) +  # Set alternating "Pre", "Post" labels
  coord_cartesian(ylim = c(min(log10(ggplot_data$freq)), max(log10(ggplot_data$freq)) * 1.5))  # Add 20% whitespace above

p

ggsave("../figures/ici_effect_on_non_pd_subsets.png", plot = p, width = 7, height = 2.5)

```

# Prepare data for PCA from cancer data (visits 3/2 vs. 1)

```{r}

wide_cancer_flow_num_data <- cancer_flow_data %>%
  select(-c(parent_population, parent_parent_population)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id)) %>%
  select(-c(patient_id, group, specific_group, cleaned_visit_num, irae_ex, irae_severity_category))

wide_cancer_flow_num_data

wide_cancer_flow_metadata <- cancer_flow_data %>%
  select(-c(parent_population, parent_parent_population)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex)) %>%
  select(c(patient_id, group, specific_group, cleaned_visit_num)) %>%
  mutate(patient_id_simple = row_number(),
         visit = case_when(
           cleaned_visit_num == 1 ~ "Pre-ICI",
           cleaned_visit_num %in% c(2, 3) ~ "Post-ICI"
         )) %>%
  mutate(patient_id = gsub("LinsleyLab", "", patient_id))

wide_cancer_flow_metadata

wide_cancer_flow_metadata$visit <- factor(wide_cancer_flow_metadata$visit, levels = c("Pre-ICI", "Post-ICI"))

```

# Make PCA plots for cancer data (visits 3/2 vs. 1)

```{r}

#dim(wide_cancer_flow_num_data)

pca = prcomp(as.data.frame((na.omit(wide_cancer_flow_num_data)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores= as.data.frame(pca$x)

pcaScores

pcaScores$patient_id_simple = row.names(pcaScores)

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_cancer_flow_metadata, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = patient_id, shape = visit), size = 2, alpha = 0.8) + 
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  labs(color = "Patient ID",
       shape = "Visit") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = "none",  # Use 2 rows for color legend
    shape = guide_legend(nrow = 1)  # Use 1 row for shape legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/pca_cancer_timepoint.png", plot = p, width = 3, height = 3.5)

p <- ggplot(data = pcaData) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group, shape = visit), size = 2, alpha = 0.8) + 
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  labs(color = "irAE group",
       shape = "Visit") +
  theme_bw() +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
    shape = guide_legend(nrow = 1)  # Use 1 row for shape legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/pca_cancer_group.png", plot = p, width = 3, height = 3.5)

```

# Look past visit 3 if necessary for irAE data
 - want to compare irAE visit (3 or not quantified) (or irAE F/U if that's all avail) vs. Visit/visit 1 to see effects of ICI + irAE development on freqs, saw no differences
 - also found nothing looking for late irAE visit (not necesarily 3) vs. late no irAE visit (3, or 2)

```{r}

late_cancer_flow_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`) %>%
  # subset for only cancer patients and late visit data
  filter(`General Patient Type` == "Cancer_Patient",
         !(cleaned_visit_num %in% c(1, "other", "Other"))) %>%
  # group by patient and handle cases with 1 (include), > 1 (keep best one)
  group_by(patient_id) %>%
  filter(
    n() >= 1,
    case_when(
      n() >= 2 & group == "non-irAE" ~ cleaned_visit_num %in% c(3),
      n() >= 2 & group == "irAE/SAE" ~ `Visit Descriptor` == "irAE")) %>%
  ungroup() %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Not severe",
    TRUE ~ "no irAE")) %>%
  filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")),
         !str_detect(sort, "PD"))

late_cancer_flow_data
  
```

# Stats tests including post-baseline data

```{r}

late_cancer_stats_test <- late_cancer_flow_data %>%
  filter(irae_severity_category %in% c("no irAE", "Severe")) %>%
  group_by(sort) %>%
  # paired TRUE for pre/post, FALSE for group comparisons
  summarize(pval = wilcox.test(freq[irae_severity_category == "Severe"], freq[irae_severity_category == "no irAE"], paired = FALSE, exact = FALSE)$p.value) %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval) %>%
  filter(adj_pval < 0.05)

late_cancer_stats_test

```

# PCA from all visits of cancer patients + AID baseline

```{r}

longitudinal_data <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  # subset for only cancer + AID patients
  filter(`General Patient Type` %in% c("Cancer_Patient", "AID_Patient")) %>%
  mutate(cleaned_visit_num = str_extract(`Visit Descriptor`, "\\d+")) %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`, visit_info = `Visit Descriptor`) %>%
  select(patient_id, group, specific_group, cleaned_visit_num, irae_ex, visit_info, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe irAE",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Non-severe irAE",
    group == "non-irAE" ~ "no irAE",
    TRUE ~ "AID"),
    visit_info = case_when(
      str_detect(visit_info, "1") | visit_info == "AID_Patient" ~ "Baseline",
      visit_info %in% c("other", "Other") ~ "Other",
      #visit_info != "irAE F/U" & str_detect(visit_info, "irAE") ~ "irAE",
      #visit_info == "irAE F/U" ~ "irAE F/U",
      TRUE ~ visit_info
    )) %>%
  filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")),
         !str_detect(sort, "PD"))

longitudinal_data
  
```

# Prepare data for PCA from longitudinal + AID data

```{r}

wide_longitudinal_num_data <- longitudinal_data %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category, visit_info)) %>%
  select(-c(patient_id, group, specific_group, irae_ex, irae_severity_category, visit_info))

wide_longitudinal_num_data

wide_longitudinal_metadata <- longitudinal_data %>%
  select(-c(parent_population, parent_parent_population, cleaned_visit_num)) %>%
  pivot_wider(names_from = sort, values_from = freq) %>%
  drop_na(-c(group, patient_id, irae_ex, irae_severity_category)) %>%
  select(c(patient_id, group, specific_group, irae_ex, irae_severity_category, visit_info)) %>%
  mutate(patient_id_simple = row_number())

wide_longitudinal_metadata

```

# Make PCA plots for longitudinal + AID data

```{r}

#dim(wide_longitudinal_num_data)

pca = prcomp(as.data.frame((na.omit(wide_longitudinal_num_data)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

#head(var$coord)

pca_contributions = as.data.frame((var$contrib))

sumPCA = summary(pca)

#summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores= as.data.frame(pca$x)

pcaScores

pcaScores$patient_id_simple = row.names(pcaScores)

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_longitudinal_metadata, pcaScores, by = "patient_id_simple")

pcas = list()
pcas[["fullData"]] = pcaData

pcaLabels = list()
pcaLabels[["fullData"]] = pcaLabels_

pcaCorrelations = list()

limits = c(max(abs(pcaData$PC1)), max(abs(pcaData$PC2)))

pcaData$visit_info <- factor(pcaData$visit_info, 
                             levels = c("Baseline", "Visit 2", "Visit 2, irAE", "Visit 3", "Visit 3, irAE", "Visit 3, irAE F/U", "irAE", "irAE F/U", "Other"))

p <- ggplot(data = pcaData %>% filter(irae_severity_category %in% c("Severe irAE", "AID"))) +
  geom_hline(yintercept = 1, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, shape = irae_severity_category, color = visit_info), size = 1.5, alpha = 0.8) + 
  scale_color_manual(values = c("Baseline" = "#440154FF", "Visit 2" = "#414487FF", "Visit 2, irAE" = "#414487FF", "Visit 3" = "#2A788EFF", "Visit 3, irAE" = "#2A788EFF", "Visit 3, irAE F/U" = "#2A788EFF", "irAE" = "#22A884FF", "irAE F/U" = "#7AD151FF", "Other" = "#FDE725FF")) +  # Set custom colors
  xlim(-limits[1], limits[1]) +
  ylim(-limits[2], limits[2]) +
  #labs(color = "Visit") +
  theme_bw() +
  theme(
    legend.position = "right", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  #guides(
  #  color = guide_legend(nrow = 1, byrow = TRUE),  # Use 2 rows for color legend
  #  shape = guide_legend(nrow = 1, byrow = TRUE)
  #) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/longitudinal_pca_general_group.png", plot = p, width = 4.5, height = 3.5)

```

# Heatmap (using Z scores of freqs in subsets across patients) for cancer subgroups (longitudinal) + AID

```{r}

flow_data_filtered <- longitudinal_data

# Define the order of groups & visits
group_order <- c("no irAE", "Non-severe irAE", "Severe irAE", "AID")
visit_order <- c("Baseline", "Visit 2", "Visit 2, irAE", "Visit 3", "Visit 3, irAE", "Visit 3, irAE F/U", "irAE", "irAE F/U", "Other", "AID")

# Reorder irae_severity_category & visit_info
flow_data_filtered$irae_severity_category <- factor(flow_data_filtered$irae_severity_category, levels = group_order)
flow_data_filtered$visit_info <- factor(flow_data_filtered$visit_info, levels = visit_order)

# Recreate the patient_group_visit column to reflect the new order
flow_data_filtered$patient_group_visit <- paste(flow_data_filtered$patient_id, flow_data_filtered$irae_severity_category, flow_data_filtered$visit_info, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + irae_severity_category + visit)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group_visit, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)

patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_([^_]*)_.*", "\\1", col_names)
visits <- sub("^[^_]*_[^_]*_(.*)", "\\1", col_names)

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  visit = factor(visits, levels = visit_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, visit)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group, Visit = sorted_col_info$visit)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("no irAE" = "black", "Non-severe irAE" = "green", "Severe irAE" = "red", "AID" = "blue"),
  Visit = c("Baseline" = "#440154FF", "Visit 2" = "#414487FF", "Visit 2, irAE" = "#414487FF", "Visit 3" = "#2A788EFF", "Visit 3, irAE" = "#2A788EFF", "Visit 3, irAE F/U" = "#2A788EFF", "irAE" = "#22A884FF", "irAE F/U" = "#7AD151FF", "Other" = "#FDE725FF"))

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  Visit = col_annotations$Visit,
  col = annotation_colors
)

# Create a dataframe for sorting rows based
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat)),
  parent_parent_population = str_extract(gsub(".* of ", "", rownames(mat)), "[^ ]+$")
) %>%
  # Reorder rows based on parent pop
  arrange(parent_parent_population)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentparentPop = row_info$parent_parent_population)

# Alphabetize the unique parent_parent_population values
sorted_parent_parent_pops <- sort(unique(row_info$parent_parent_population))

# Define Viridis colors for the alphabetized parent_parent_population values
viridis_colors <- viridis::viridis(length(sorted_parent_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentparentPop <- factor(row_annotations$ParentparentPop, levels = sorted_parent_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentparentPop = row_annotations$ParentparentPop,
  col = list(ParentparentPop = row_annotation_colors)
)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 7),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score")
)

# Save the heatmap to a PDF file
pdf(file = "../figures/heatmap_z_scores_longitudinal_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Try mixed effects modeling (linear first, then GAMs if nonlinear) like in https://www.biorxiv.org/content/10.1101/2022.06.05.494592v1.full.pdf from longitudinal data

 - need to reduce correlating variables? group and visit likely don't correlate so no worries

```{r}

mixed_effects_model_df <- read_excel("../raw_data/holly_flow_data_all_visits.xlsx") %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, specific_group = `Patient Type`, irae_ex = `Documented irAE's (9/6/2024)`, visit_info = `Visit Descriptor`) %>%
  select(patient_id, group, specific_group, irae_ex, visit_info, starts_with("pct_")) %>%
  pivot_longer(
    cols = starts_with("pct_"), 
    names_to = "sort",
    values_to = "freq") %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         parent_parent_population = str_extract(parent_population, "[^ ]+$"),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort)
  ) %>%
  mutate(irae_severity_category = case_when(
    group == "irAE/SAE" & str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Severe irAE",
    group == "irAE/SAE" & !str_detect(irae_ex, "Encephalitis|Pleural effusion|pneumonitis|hepatitis|esophagitis|thyroid|Thyroid") ~ "Non-severe irAE",
    group == "non-irAE" ~ "no irAE",
    group == "Healthy_Control" ~ "HC",
    TRUE ~ "AID"),
    visit_info = case_when(
      str_detect(visit_info, "1") | visit_info %in% c("AID_Patient", "Healthy_Control") ~ "Baseline",
      visit_info %in% c("other", "Other") ~ "Other",
      visit_info %in% c("Visit 2", "Visit 2, irAE") ~ "Visit 2",
      visit_info %in% c("Visit 3", "Visit 3, irAE", "Visit 3, irAE F/U") ~ "Visit 3",
      #visit_info != "irAE F/U" & str_detect(visit_info, "irAE") ~ "irAE",
      #visit_info == "irAE F/U" ~ "irAE F/U",
      TRUE ~ visit_info
    )) %>%
  filter(!(sort %in% c("granulocytes of live", "PD1pos of DN Bcells", "PD1pos of naive Bcells", "PD1pos of swMem Bcells", "PD1pos of unswMem Bcells", "basophils of nonGrans", "EMRA of Tconv Tcells", "CXCR6pos of NN CD8 Tcells", "CXCR6posGrzmBpos of NN CD8 Tcells")),
         !str_detect(sort, "PD")) %>%
  filter(freq > 0,
         visit_info != "Other")
  # getting rid of any sorts with any NA freqs gets rid of some sorts

visit_levels <- c("Baseline", "Visit 2", "Visit 3", "irAE", "irAE F/U")
group_levels <- c("Healthy_Control", "AID_Patient", "non-irAE", "irAE/SAE")

mixed_effects_model_df$visit_info <- factor(mixed_effects_model_df$visit_info, levels = visit_levels)
mixed_effects_model_df$group <- factor(mixed_effects_model_df$group, levels = group_levels)

# mixed effects model, allow for variation between subjects in ref, 1|patient_id doesn't account for variation b/w subjects in response but group*time does (variation between irAE groups in response to ICI over time)

sorts <- unique(mixed_effects_model_df$sort)

results <- list()

for (s in sorts) {
  subset_data <- mixed_effects_model_df %>% filter(sort == s)
  
  fit <- lmer(freq ~ group * visit_info + (1 | patient_id), data = subset_data)
  
  results[[s]] <- summary(fit)
}

results

```

# Plot significant results

```{r}

# potential issue with only getting 1 irAE group interacting with visits at a time, but below are potentially interesting sorts

# specific visit info: Tfr of NN Treg Tcells visit 3 irAE interaction effect, ICOSpos of Tfh Tconv Tcells and naive of Tconv Tcells visit 2 irAE interaction and EM of CD8 Tcells

# general visit info: naive of Tconv Tcells no irAE visit 2 interaction, ICOSpos of Tfh Tconv Tcells no irAE visits 2-3, EM of CD8 Tcells visit 2 no irAE int, CD56bright of NKcells visit 3 no irAE int
# $`naive of Tconv Tcells`, ICOSpos of Tfh Tconv Tcells, EM of CD8 Tcells, CD56bright of NKcells

# heamtap interesting hits
#Low in irAEs? GrzmBpos of NN CD8 Tcells, CCR6pos of NN CD8 Tcells, EMRA of CD8 Tcells, CD8 of Tcells, intermediate/nonclassical of monocytes
#Tcells of nonGrans, CCR6pos of NN Tconv Cells, CXCR3posCCR6pos of NN Tconv Tcells, CXCR3pos of NN Tconv Tcells, CXCR3pos of NN CD8 Tcells

# high in irAEs?
#CCR4pos of NN CD8 Tcells, CM of CD8 Tcells, CD4 of Tcells, CM of Treg Tcells, CM of Tconv Tcells, CCR6pos of NN CD8 Tcells, EMRA of CD8 Tcells, CD8 of Tcells

mixed_effects_model_df$irae_severity_category <- factor(mixed_effects_model_df$irae_severity_category, levels = c("HC", "AID", "no irAE", "Non-severe irAE", "Severe irAE"))

p <- ggplot(mixed_effects_model_df %>% filter(sort %in% c("CD56bright of NKcells", "EM of CD8 Tcells", "ICOSpos of Tfh Tconv Tcells", "Tfr of NN Treg Tcells")), aes(x = interaction(visit_info, irae_severity_category), y = log10(freq), color = irae_severity_category)) +
  geom_boxplot(aes(group = interaction(visit_info, irae_severity_category)), outlier.shape = NA, position = position_dodge(width = 0.75)) +  # Boxplots dodge by group
  geom_point(size = 0.5, alpha = 0.5) +
  geom_line(aes(group = interaction(patient_id, irae_severity_category)), color = "grey", alpha = 0.25) +
  geom_smooth(aes(group = irae_severity_category, color = irae_severity_category), method = "lm", se = FALSE, linetype = "dashed") +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Visit Information", y = "Percent of parent (log10)", color = "Group") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        axis.title.x = element_blank(),
        strip.text = element_text(size = 12)) +
  scale_color_manual(values = c("HC" = "purple", "AID" = "blue", "no irAE" = "black", "Non-severe irAE" = "green", "Severe irAE" = "red"))

ggsave("../figures/mixed_modeling_hits.png", plot = p, width = 8, height = 5)

```