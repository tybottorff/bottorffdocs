---
title: "CyTOF analyses for NCI irAE project"
output: pdf_document
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(beeswarm)
library(Matrix)
library(ggplot2)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(factoextra)
library(lmerTest)
library(gtsummary)
library(ica)
library(dplyr)
library(ggrepel)
library(purrr)
library(compareGroups)
library(reshape2)
library(limma)
library(mgcv)
library(tibble)
library(tidyverse)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Bring in actual days from baseline metadata

```{r}

# "easier" to just re-extract

days_from_baseline_metadata <- read_excel("../raw_data/2024_10_17_flow_data.xlsx") %>%
  rename(patient_id = `Subject ID`) %>%
  dplyr::filter(!(`Visit Descriptor` %in% c("AID_Patient", "Healthy_Control"))) %>%
  mutate(draw_date = as.Date(as.numeric(`Draw Date`))) %>%
  select(patient_id, `Visit Descriptor`, draw_date) %>%
  group_by(patient_id) %>%
  mutate(days_from_baseline = draw_date - draw_date[`Visit Descriptor` %in% c("visit 1", "Visit 1")]) %>%
  mutate(days_from_baseline = as.numeric(days_from_baseline)) %>%
  ungroup() %>%
  mutate(cleaned_visit_info = case_when(
          str_detect(`Visit Descriptor`, "Healthy") ~ "baseline",
          str_detect(`Visit Descriptor`, "AID") ~ "baseline",
          str_detect(`Visit Descriptor`, "(?i)visit 1") ~ "baseline",  # Case-insensitive match for "Visit 1"
          str_detect(`Visit Descriptor`, "\\d+") ~ str_extract(`Visit Descriptor`, "\\d+"),
          str_detect(`Visit Descriptor`, "F/U") ~ "irAE F/U",
          str_detect(`Visit Descriptor`, "irAE") ~ "irAE",
          TRUE ~ "Other")) %>%
  select(patient_id, cleaned_visit_info, days_from_baseline)

days_from_baseline_metadata

```

# Read in batch-effect removed data
 - filter for non-HC data

```{r}

adjusted_data <- read.csv("../saved_data/batch_effect_removed_data.csv") %>%
  select(-X) %>%
  mutate(cleaned_visit_info = if_else(cleaned_visit_info == "baseline", "1", cleaned_visit_info)) %>%
  # remove PD1+ sorts (messed up likely with anti-PD1 ICI)
  dplyr::select(-matches("PD1")) %>%
  dplyr::filter(cleaned_visit_info %in% c("1", "2", "3", "irAE", "irAE F/U"),
         group != "Healthy_Control") %>%
  left_join(days_from_baseline_metadata, by = c("patient_id", "cleaned_visit_info")) %>%
  # fix issue of 0 importing as NA
  mutate(days_from_baseline = if_else(is.na(days_from_baseline), 0, days_from_baseline))

adjusted_data <- adjusted_data %>%
  # reorder columns to keep all metadata in front
  select(1:16, ncol(adjusted_data), 17:(ncol(adjusted_data) - 1))

# show features with > 5% NAs, remove them when doing PCA, otherwise replace with mean
na_counts <- colSums(is.na(adjusted_data[, 18:ncol(adjusted_data)]))
na_ridden_features <- names(na_counts[na_counts > 0.05*nrow(adjusted_data)])

adjusted_data

```

# Look at how immmunotypes shift over time in cancer irAE/no irAE groups vs. AID

```{r}

# run PCA on all AID + all cancer data

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:17] %>%
  mutate(patient_id_simple = row_number(),
         # clean up AID group name
         group = case_when(
           group == "AID_Patient" ~ "AID",
           TRUE ~ group
         ))

# instead of filtering for no NA, remove features in na_ridden_features list and impute rest of NAs
wide_baseline_flow_num_data_confounders_regressed_out <- adjusted_data[, 18:ncol(adjusted_data)] %>% select(-na_ridden_features) %>% mutate(across(everything(), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

pca = prcomp(as.data.frame((na.omit(wide_baseline_flow_num_data_confounders_regressed_out)), center=TRUE, scale=FALSE))

var = get_pca_var(pca)

sumPCA = summary(pca)

pca_variance = as.data.frame(t(sumPCA$importance))
pca_variance$pc = factor(row.names(pca_variance), levels = row.names(pca_variance))

pcaScores = as.data.frame(pca$x) %>%
  mutate(patient_id_simple = row_number())

pcaLabels_ = paste0("PC", 1:ncol(pcaScores), " (", round(100*pca_variance$`Proportion of Variance`, 2), "%)")

pcaData = merge(wide_baseline_flow_metadata_confounders_regressed_out, pcaScores, by = "patient_id_simple")

# first will compute centroids in high dim PCA space of baseline groups
baseline_centroids <- pcaData %>%
  filter(days_from_baseline == 0) %>%
  group_by(group) %>%
  summarize(across(starts_with("PC"), mean, .names = "centroid_{.col}"), .groups = "drop")

# get centroids out
aid_centroid <- as.numeric(baseline_centroids %>% filter(group == "AID") %>% select(starts_with("centroid")))
irae_centroid <- as.numeric(baseline_centroids %>% filter(group == "irAE/SAE") %>% select(starts_with("centroid")))
no_irae_centroid <- as.numeric(baseline_centroids %>% filter(group == "non-irAE") %>% select(starts_with("centroid")))

# define function to calculate projection of point (longitudinal immunotype) onto line between 2 centroids (AID and irAE/no irAE)
# point is a vector of PCA coordinates
# centroid1 is starting centroid (cancer baseline one), centroid2 is ending one (AID)
project_to_line <- function(point, centroid1, centroid2) {
  v <- centroid2 - centroid1        # Vector between centroids, same num dimensions as centroids (51 here)
  w <- point - centroid1            # Vector from centroid1 to the point (how far and in what direction point is from centroid1)
  projection <- sum(w * v) / sum(v * v)  # Scalar projection
  # sum(w*v) is dot product (component of w in direction of v)
  # ~dropping perpendicular from point onto line between centroids, scalar projection informs where point's dropped perpendicular is along that line
  projection
}

projection_df <- pcaData %>%
  filter(group %in% c("irAE/SAE", "non-irAE")) %>%
  rowwise() %>%
  mutate(
    projection = project_to_line(
      c_across(PC1:PC51),
      centroid2 = aid_centroid,
      centroid1 = case_when(
        group == "irAE/SAE" ~ irae_centroid,
        group == "non-irAE" ~ no_irae_centroid,
      )
    )
  ) %>%
  ungroup()

# just plot baseline samples on PCA of all samples (to show centroids very close...)

p <- ggplot(data = pcaData %>% filter(days_from_baseline == 0)) +
  geom_hline(yintercept = 0, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group), size = 2, alpha = 0.8) + 
  stat_ellipse(aes(x = PC1, y = PC2, color = group), size = 1, linetype = 2) +
  labs(color = "") +
  theme_bw() +
  scale_color_manual(values = c("AID" = "black", "irAE/SAE" = "#f8766d", "non-irAE" = "#00bfc4")) +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/aid_cancer_baseline_pca.png", p, width = 3, height = 4)

# just show 1 longitudinal point and centroids for projection analysis
no_irae_centroid_df <- data.frame(PC1 = no_irae_centroid[1], PC2 = no_irae_centroid[2], label = "baseline non-irAE\ncentroid")
irae_centroid_df <- data.frame(PC1 = irae_centroid[1], PC2 = irae_centroid[2], label = "baseline irAE\ncentroid")
aid_centroid_df <- data.frame(PC1 = aid_centroid[1], PC2 = aid_centroid[2], label = "AID centroid")

p <- ggplot(data = pcaData %>% filter(patient_id == "LinsleyLab163195" & days_from_baseline != 0)) +
  geom_hline(yintercept = 0, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group), size = 2, alpha = 0.8) + 
  geom_text(aes(x = PC1, y = PC2, color = group, label = "Non-baseline\nsample"), size = 3, vjust = -1, hjust = -0.15) +
  # Add centroids as points
  geom_point(data = no_irae_centroid_df, aes(x = PC1, y = PC2), color = "#00bfc4", size = 3) +
  geom_point(data = aid_centroid_df, aes(x = PC1, y = PC2), color = "black", size = 3) +
  # Add centroid labels
  geom_text(data = no_irae_centroid_df, aes(x = PC1, y = PC2, label = label), 
            vjust = 2, color = "#00bfc4", size = 3) +
  geom_text(data = aid_centroid_df, aes(x = PC1, y = PC2, label = label), 
            vjust = -1, color = "black", size = 3) +
  labs(color = "") +
  theme_bw() +
  scale_color_manual(values = c("AID" = "black", "irAE/SAE" = "#f8766d", "non-irAE" = "#00bfc4")) +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/aid_no_irae_cancer_baseline_pca_example_point.svg", p, width = 3, height = 4)

p <- ggplot(data = pcaData %>% filter(patient_id == "LinsleyLab875525" & days_from_baseline == 70)) +
  geom_hline(yintercept = 0, linetype = 2, color = "grey") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +
  geom_point(aes(x = PC1, y = PC2, color = group), size = 2, alpha = 0.8) + 
  geom_text(aes(x = PC1, y = PC2, color = group, label = "Non-baseline\nsample"), size = 3, vjust = 1, hjust = -0.15) +
  # Add centroids as points
  geom_point(data = irae_centroid_df, aes(x = PC1, y = PC2), color = "#f8766d", size = 3) +
  geom_point(data = aid_centroid_df, aes(x = PC1, y = PC2), color = "black", size = 3) +
  # Add centroid labels
  geom_text(data = irae_centroid_df, aes(x = PC1, y = PC2, label = label), 
            vjust = -1, color = "#f8766d", size = 3) +
  geom_text(data = aid_centroid_df, aes(x = PC1, y = PC2, label = label), 
            vjust = -1, hjust = -0.5, color = "black", size = 3) +
  labs(color = "") +
  theme_bw() +
  scale_color_manual(values = c("AID" = "black", "irAE/SAE" = "#f8766d", "non-irAE" = "#00bfc4")) +
  theme(
    legend.position = "bottom", 
    legend.text = element_text(size = 7),  # Adjust legend text size
    #legend.title = element_blank(),  # Adjust legend title size
    legend.spacing.y = unit(0.1, 'cm'),    # Reduce vertical spacing
    legend.spacing.x = unit(0.3, 'cm')     # Reduce horizontal spacing
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE),  # Use 2 rows for color legend
  ) +
  labs(x = pcaLabels_[1], y = pcaLabels_[2])

p

ggsave("../figures/aid_irae_cancer_baseline_pca_example_point.svg", p, width = 3, height = 4)

```

# Look at how immmunotypes shift over time in cancer irAE/no irAE groups vs. AID
 - not using PCA, using original data (this feels better)

```{r}

wide_baseline_flow_metadata_confounders_regressed_out <- adjusted_data[, 1:17] %>%
  mutate(patient_id_simple = row_number(),
         # clean up AID group name
         group = case_when(
           group == "AID_Patient" ~ "AID",
           TRUE ~ group
         ))

wide_baseline_flow_num_data_confounders_regressed_out <- adjusted_data[, 18:ncol(adjusted_data)] %>%
  select(-na_ridden_features) %>%
  mutate(across(everything(), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

baseline_centroids <- wide_baseline_flow_num_data_confounders_regressed_out %>%
  bind_cols(wide_baseline_flow_metadata_confounders_regressed_out) %>%
  filter(days_from_baseline == 0) %>%
  group_by(group) %>%
  summarize(across(colnames(wide_baseline_flow_num_data_confounders_regressed_out), mean, .names = "centroid_{.col}"), .groups = "drop")

baseline_centroids

aid_centroid <- as.numeric(baseline_centroids %>% filter(group == "AID") %>% select(starts_with("centroid")))
irae_centroid <- as.numeric(baseline_centroids %>% filter(group == "irAE/SAE") %>% select(starts_with("centroid")))
no_irae_centroid <- as.numeric(baseline_centroids %>% filter(group == "non-irAE") %>% select(starts_with("centroid")))

# Define function to calculate projection in the original space (no PCA)
project_to_line <- function(point, centroid1, centroid2) {
  v <- centroid2 - centroid1        # Vector between centroids
  w <- point - centroid1            # Vector from centroid1 to the point
  projection <- sum(w * v) / sum(v * v)  # Scalar projection
  projection
}

projection_df <- wide_baseline_flow_num_data_confounders_regressed_out %>%
  bind_cols(wide_baseline_flow_metadata_confounders_regressed_out) %>%
  filter(group %in% c("irAE/SAE", "non-irAE")) %>%
  rowwise() %>%
  mutate(
    projection = project_to_line(
      c_across(colnames(wide_baseline_flow_num_data_confounders_regressed_out)),
      centroid2 = aid_centroid,
      centroid1 = case_when(
        group == "irAE/SAE" ~ irae_centroid,
        group == "non-irAE" ~ no_irae_centroid,
      )
    )
  ) %>%
  ungroup()

# for sense of scale, calculate centroid-centroid distances
#sqrt(sum((aid_centroid - irae_centroid)^2))
#sqrt(sum((aid_centroid - no_irae_centroid)^2))

p <- ggplot(projection_df, aes(x = days_from_baseline, y = projection, color = group, group = patient_id)) +
  geom_point(alpha = 0.5) +  # Adds points for each data observation
  geom_hline(yintercept = 0.65, linetype = "dashed", color = "black", size = 1) + # about where 2 baseline centroid-AID centroid distances are
  geom_smooth(
    method = "loess",  # You can change to "lm" for linear regression or other methods
    aes(group = group),  # Grouping by the irAE group for separate smoothing lines
    alpha = 0.3,  # Transparency for the confidence interval
    se = TRUE  # Show the confidence interval
  ) +
  labs(
    x = "Days from baseline",
    y = "Projection onto cancer\n(group-specific)-AID line"
  )

p

ggsave("../figures/cancer_aid_projection.png", p, width = 6, height = 4)

# do stats

projection_df <- projection_df %>% 
  mutate(group = factor(group, levels = c("non-irAE", "irAE/SAE")),
         patient_id = factor(patient_id)) # Adjust levels as needed

# Fit the GAM model with interaction between group and time
model_interaction <- gam(projection ~ group + 
                           s(days_from_baseline, k = 5, bs = "cr") + 
                           s(days_from_baseline, k = 5, bs = "cr", by = group) + 
                           s(patient_id, bs = "re"),
                         data = projection_df, method = 'REML')

# Fit the GAM model without the interaction (common smooth for both groups)
model_no_interaction <- gam(projection ~ group + 
                              s(days_from_baseline, k = 5, bs = "cr") + 
                              s(patient_id, bs = "re"),
                            data = projection_df, method = 'REML')

# Compare the models to see if the slopes of how groups differ from baseline is different between the two groups
comparison <- anova(model_no_interaction, model_interaction, test = "Chisq")

# Results
comparison

```

# Filter for cancer data to use for GAMs
 - use transformed data (and then use Batch and cancer_type as covariates in GAMs) rather than residuals ("corrected data")

```{r}

adjusted_data <- read.csv("../saved_data/transformed_data.csv") %>%
  select(-X) %>%
  mutate(cleaned_visit_info = if_else(cleaned_visit_info == "baseline", "1", cleaned_visit_info)) %>%
  # remove PD1+ sorts (messed up likely with anti-PD1 ICI)
  dplyr::select(-matches("PD1")) %>%
  dplyr::filter(cleaned_visit_info %in% c("1", "2", "3", "irAE", "irAE F/U"),
         group != "Healthy_Control") %>%
  # filter for cancer patients
  filter(group %in% c("non-irAE", "irAE/SAE")) %>%
  pivot_longer(cols = -c(patient_id, group, skin_irae, thyroid_irae, pneumonitis_irae, rheumatoid_irae, ctcae_grade, Batch, cleaned_visit_info, cancer_type, age, days_to_irae, thyroid_cat, thyroid_irae_including_oor, pneumonitis_irae_including_effusion, gastro_irae), names_to = "sort", values_to = "freq") %>%
  left_join(days_from_baseline_metadata, by = c("patient_id", "cleaned_visit_info")) %>%
  # fix issue of 0 importing as NA
  mutate(days_from_baseline = if_else(is.na(days_from_baseline), 0, days_from_baseline))

adjusted_data <- adjusted_data %>%
  # reorder columns to keep all metadata in front
  select(1:16, ncol(adjusted_data), 17:(ncol(adjusted_data) - 1))

# show features with > 5% NAs, remove them when doing PCA, otherwise replace with mean
na_counts <- colSums(is.na(adjusted_data[, 18:ncol(adjusted_data)]))
na_ridden_features <- names(na_counts[na_counts > 0.05*nrow(adjusted_data)])

adjusted_data

```

# Model freq changes over visits using GAMs

```{r}

model_data <- adjusted_data %>%
  mutate(cleaned_visit_info = factor(cleaned_visit_info, levels = c("1", "2", "3", "irAE", "irAE F/U")),
         group = factor(group, levels = c("non-irAE", "irAE/SAE")),
         skin_irae = factor(skin_irae, levels = c("No skin irAE", "Skin irAE")),
         thyroid_irae = factor(thyroid_irae, levels = c("No thyroid irAE", "Thyroid irAE")),
         rheumatoid_irae = factor(rheumatoid_irae, levels = c("No rheumatoid irAE", "Rheumatoid irAE")),
         pneumonitis_irae = factor(pneumonitis_irae, levels = c("No pneumonitis", "Pneumonitis")),
         ctcae_grade = if_else(is.na(ctcae_grade), "0", as.character(ctcae_grade)),
         ctcae_grade = factor(ctcae_grade, levels = c("0", "1", "2", "3")),
         patient_id = as.factor(patient_id))

data_by_sort <- split(model_data, model_data$sort)

# Function to fit the GAM for each sort and test for interaction
fit_gam <- function(data) {
  tryCatch(
    {
      # inspired by https://stats.stackexchange.com/questions/576499/how-to-compare-two-time-series-with-a-gam
      
      # Model with interaction between irAE group and time from baseline (separate smooths for each group)
      model_interaction <- gam(freq ~ group + Batch + cancer_type + # include covariates
                                 s(days_from_baseline, k = 5, bs = "cr") + 
                                 s(days_from_baseline, k = 5, bs = "cr", by = group) + 
                                 s(patient_id, bs = "re"),
                               data = data, method = 'REML')
      
      # Model without interaction between irAE group and time from baseline (common smooth for both groups)
      model_no_interaction <- gam(freq ~ group + Batch + cancer_type + # include covariates
                                    s(days_from_baseline, k = 5, bs = "cr") + 
                                    s(patient_id, bs = "re"),
                                  data = data, method = 'REML')
      
      # Compare the models to see if the slopes of how groups differ from baseline is different b/w the 2 groups
      comparison <- anova(model_no_interaction, model_interaction, test = "Chisq")
      
      list(
        interaction_model = summary(model_interaction),
        no_interaction_model = summary(model_no_interaction),
        comparison = comparison,
        plot = model_interaction
      )
    },
    error = function(e) list(error = e$message)
  )
}

# Apply the function to each subset of data
gam_results <- map(data_by_sort, fit_gam)

```

# Check model

```{r}

gam_data <- model_data %>%
  filter(sort == "CD56bright.of.NKcells")

model <- gam(freq ~ group + s(days_from_baseline, k = 5, bs = "cr") + s(days_from_baseline, k = 5, bs = "cr", by = group) + s(patient_id, bs = "re"),
                   data = gam_data, method = 'REML')

gam.check(model)

summary(model)
# looks well-fit (residuals ~straight line on QQ plot), histogram of residuals is normal

```

# Inspect results

```{r}

all_pvals_comparison <- map_dfr(
  names(gam_results),
  function(sort_name) {
    # Check if the sort has a comparison (i.e., no errors in fitting)
    if (!is.null(gam_results[[sort_name]]$comparison)) {
      # Extract the p-value from the comparison table and add sort information
      comparison_pval <- gam_results[[sort_name]]$comparison$`Pr(>Chi)`[2]  # Second row corresponds to the comparison p-value
      
      tibble(
        sort = sort_name,
        comparison_pval = comparison_pval
      )
    } else {
      NULL
    }
  }
)

# Adjust the p-values using BH correction
all_pvals_comparison <- all_pvals_comparison %>%
  mutate(padj = p.adjust(comparison_pval, method = "BH"))

# View the significant p-values (adjusted)
significant_pvals_comparison <- all_pvals_comparison %>%
  filter(padj < 0.05) %>%
  arrange(padj)

significant_pvals_comparison

# just focusing on CD56bright of NK for WIP

# combined has 2 other results besides CD56bright of NK
# skin only has CD56bright of NK
# rheumatoid: NONE
# thyroid: stuff but no CD56bright of NK
# pneumonitis: none

```

# Plot significant results

```{r}

plot_data <- adjusted_data %>%
  dplyr::filter(group %in% c("non-irAE", "irAE/SAE"),
         cleaned_visit_info != "Other") %>%
  mutate(cleaned_visit_info = factor(cleaned_visit_info, levels = c("1", "2", "3", "irAE", "irAE F/U")),
         group = factor(group, levels = c("irAE/SAE", "non-irAE")),
         pneumonitis_irae = factor(pneumonitis_irae, levels = c("Pneumonitis", "No pneumonitis")),
         thyroid_irae = factor(thyroid_irae, levels = c("Thyroid irAE", "No thyroid irAE")),
         skin_irae = factor(skin_irae, levels = c("Skin irAE", "No skin irAE")),
         rheumatoid_irae = factor(rheumatoid_irae, levels = c("Rheumatoid irAE", "No rheumatoid irAE")),
         ctcae_grade = if_else(is.na(ctcae_grade), "0", as.character(ctcae_grade)),
         ctcae_grade = factor(ctcae_grade, levels = c("0", "1", "2", "3"))) %>%
    mutate(sort = gsub("\\.", " ", sort))

# for thyroid
# just plot Bcell ones as this may be related to https://pmc.ncbi.nlm.nih.gov/articles/PMC5785243/

p <- plot_data %>% dplyr::filter(sort %in% c("Bcells of nonGrans", "plasmablasts of Bcells")) %>% ggplot(aes(x = days_from_baseline, y = freq, color = thyroid_irae)) +
  geom_point(alpha = 0.75) +
  geom_smooth(aes(group = thyroid_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Days from baseline", y = "Residuals", color = "Thyroid group") +
  theme(strip.text = element_text(size = 9),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_thyroid.png", p, width = 8, height = 4)

# combined irAE

p <- plot_data %>% filter(sort %in% c("CD56bright of NKcells", "EM of CD8 Tcells", "SCM of Tconv Tcells", "naive of Treg Tcells")) %>% ggplot(aes(x = days_from_baseline, y = freq, color = group)) +
  geom_point(alpha = 0.75) +
  geom_smooth(aes(group = group),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Days from baseline", y = "Residuals", color = "Group") +
  theme(strip.text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_combined_irae.png", p, width = 8, height = 8)

# skin: padj < 0.05

p <- plot_data %>% filter(sort %in% c("CD56bright of NKcells")) %>% ggplot(aes(x = days_from_baseline, y = freq, color = skin_irae)) +
  geom_point(alpha = 0.75) +
  geom_smooth(aes(group = skin_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Days from baseline", y = "Residuals", color = "Skin irAE group") +
  theme(strip.text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_skin.png", p, width = 11, height = 4)

# pneumon

p <- plot_data %>% filter(sort %in% c("swMem of Bcells", "pDC of nonGrans")) %>% ggplot(aes(x = days_from_baseline, y = freq, color = pneumonitis_irae)) +
  geom_point(alpha = 0.75) +
  geom_smooth(aes(group = pneumonitis_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Days from baseline", y = "Residuals", color = "Pneumonitis irAE group") +
  theme(strip.text = element_text(size = 11),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_pneumonitis.png", p, width = 11, height = 4)

```

# Plot CD56bright of NK result across all (facet for different) irAE group comparions

```{r}

plot_df_combined_irae <- plot_data %>% select(patient_id, group, days_from_baseline, sort, freq) %>% mutate(comparison = "group", status = group) %>% filter(sort == "CD56bright of NKcells")
plot_df_thyroid_irae <- plot_data %>% select(patient_id, thyroid_irae, days_from_baseline, sort, freq) %>% mutate(comparison = "thyroid_irae", status = thyroid_irae) %>% filter(sort == "CD56bright of NKcells")
plot_df_skin_irae <- plot_data %>% select(patient_id, skin_irae, days_from_baseline, sort, freq) %>% mutate(comparison = "skin_irae", status = skin_irae) %>% filter(sort == "CD56bright of NKcells")
plot_df_pneumonitis_irae <- plot_data %>% select(patient_id, pneumonitis_irae, days_from_baseline, sort, freq) %>% mutate(comparison = "pneumonitis_irae", status = pneumonitis_irae) %>% filter(sort == "CD56bright of NKcells")
plot_df_rheumatoid_irae <- plot_data %>% select(patient_id, rheumatoid_irae, days_from_baseline, sort, freq) %>% mutate(comparison = "rheumatoid_irae", status = rheumatoid_irae) %>% filter(sort == "CD56bright of NKcells")

plot_df_combined <- bind_rows(plot_df_combined_irae, plot_df_thyroid_irae, plot_df_skin_irae, plot_df_pneumonitis_irae, plot_df_rheumatoid_irae)

plot_df_combined <- plot_df_combined %>%
  mutate(status_color = case_when(
    status %in% c("irAE/SAE", "Thyroid irAE", "Skin irAE", "Pneumonitis", "Rheumatoid irAE") ~ "irAE",
    status %in% c("non-irAE", "No skin irAE", "No thyroid irAE", "No pneumonitis", "No rheumatoid irAE") ~ "non-irAE",
    TRUE ~ as.character(status)  # For any other status, leave it as is
  ))

# set facet order
plot_df_combined <- plot_df_combined %>%
  mutate(comparison = factor(comparison, levels = c(
    "group", 
    "skin_irae", 
    "pneumonitis_irae", 
    "rheumatoid_irae", 
    "thyroid_irae"
  )))

facet_labels <- c(
  group = "Combined irAE",
  thyroid_irae = "Thyroid irAE",
  skin_irae = "Skin irAE",
  pneumonitis_irae = "Pneumonitis",
  rheumatoid_irae = "Rheumatoid irAE"
)

p <- ggplot(plot_df_combined, aes(x = days_from_baseline, y = freq, color = status_color)) +
  geom_point(alpha = 0.75) +
  geom_smooth(aes(group = status_color), method = "gam", formula = y ~ s(x, k = 3, bs = "cr"), se = TRUE) +
  facet_wrap(~ comparison, ncol = 5, labeller = labeller(comparison = facet_labels)) +
  scale_color_manual(values = c("irAE" = "#f8766d", "non-irAE" = "#00bfc4")) +
  labs(x = "Days from baseline", y = "CD56bright of NK\ncells (batch-adjusted,\nnormalized frequency)", color = "") +
  theme(strip.text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/cd56bright_for_all_group_comparisons_longitudinal.png", width = 15, height = 4)

```