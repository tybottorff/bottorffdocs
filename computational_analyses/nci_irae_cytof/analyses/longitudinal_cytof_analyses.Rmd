---
title: "CyTOF analyses for NCI irAE project"
output: pdf_document
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(beeswarm)
library(Matrix)
library(ggplot2)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(factoextra)
library(lmerTest)
library(gtsummary)
library(ica)
library(dplyr)
library(ggrepel)
library(purrr)
library(compareGroups)
library(reshape2)
library(limma)
library(mgcv)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in batch-effect removed data

```{r}

adjusted_data <- read.csv("../saved_data/batch_effect_removed_data.csv") %>%
  select(-X) %>%
  pivot_longer(cols = -c(patient_id, group, skin_irae, thyroid_irae, pneumonitis_irae, rheumatoid_irae, ctcae_grade, Batch, cleaned_visit_info, cancer_type, age, days_to_irae, thyroid_cat, thyroid_irae_including_oor, pneumonitis_irae_including_effusion, gastro_irae), names_to = "sort", values_to = "freq") %>%
  mutate(cleaned_visit_info = if_else(cleaned_visit_info == "baseline", "1", cleaned_visit_info)) %>%
  filter(cleaned_visit_info %in% c("1", "2", "3"),
         group %in% c("non-irAE", "irAE/SAE")) %>%
  mutate(cleaned_visit_info = factor(cleaned_visit_info, levels = c("1", "2", "3")),
         group = factor(group, levels = c("non-irAE", "irAE/SAE")),
         patient_id = as.factor(patient_id))

adjusted_data

```

# Model freq changes over visits using GAMs

```{r}

# Split data by 'sort'
data_by_sort <- split(adjusted_data, adjusted_data$sort)

# Function to fit the GAM for each sort
fit_gam <- function(data) {
  tryCatch(
    {
      model <- gam(freq ~ 0 + group * cleaned_visit_info + s(patient_id, bs = "re"),
                   data = data, method = 'REML')
      list(summary = summary(model), plot = model)
    },
    error = function(e) list(error = e$message)
  )
}

gam_results <- map(data_by_sort, fit_gam)

```

# Inspect results

```{r}

# Create a tibble of parametric results across all sorts
all_pvals <- map_dfr(
  names(gam_results), 
  function(sort_name) {
    # Check if the sort has a summary (i.e., no errors in fitting)
    if (!is.null(gam_results[[sort_name]]$summary)) {
      # Extract p.table and add sort information
      as_tibble(gam_results[[sort_name]]$summary$p.table, rownames = "term") %>%
        mutate(sort = sort_name)
    } else {
      NULL
    }
  }
)

all_pvals <- all_pvals %>%
  mutate(padj = p.adjust(`Pr(>|t|)`, method = "BH"))

significant_pvals <- all_pvals %>%
  filter(padj < 0.05) %>%
  select(sort, term, padj) %>%
  arrange(sort)

significant_pvals

```

# Plot significant results

```{r}

#EM.of.CD8.Tcells group/visit2
#$GrzmBpos.of.NN.CD8.Tcells visit2
#$SCM.of.Tconv.Tcells lots of stuff

p <- adjusted_data %>% filter(sort %in% unique(significant_pvals$sort)) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = group)) +
  geom_point() +
  geom_smooth(aes(group = group),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Visit", y = "Residuals", color = "Group")

p

ggsave("../figures/gam_results.png", p, width = 6, height = 10)

```