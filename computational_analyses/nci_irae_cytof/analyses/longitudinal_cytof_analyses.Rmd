---
title: "CyTOF analyses for NCI irAE project"
output: pdf_document
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(beeswarm)
library(Matrix)
library(ggplot2)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)
library(circlize)
library(factoextra)
library(lmerTest)
library(gtsummary)
library(ica)
library(dplyr)
library(ggrepel)
library(purrr)
library(compareGroups)
library(reshape2)
library(limma)
library(mgcv)
library(tibble)
library(tidyverse)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in batch-effect removed data

```{r}

adjusted_data <- read.csv("../saved_data/batch_effect_removed_data.csv") %>%
  select(-X) %>%
  pivot_longer(cols = -c(patient_id, group, skin_irae, thyroid_irae, pneumonitis_irae, rheumatoid_irae, ctcae_grade, Batch, cleaned_visit_info, cancer_type, age, days_to_irae, thyroid_cat, thyroid_irae_including_oor, pneumonitis_irae_including_effusion, gastro_irae), names_to = "sort", values_to = "freq") %>%
  mutate(cleaned_visit_info = if_else(cleaned_visit_info == "baseline", "1", cleaned_visit_info)) %>%
  # remove PD1+ sorts (messed up likely with anti-PD1 ICI)
  filter(!grepl("PD1pos", sort))

adjusted_data

```

# Model freq changes over visits using GAMs

```{r}

model_data <- adjusted_data %>%
  filter(cleaned_visit_info %in% c("1", "2", "3", "irAE", "irAE F/U"),
         group %in% c("non-irAE", "irAE/SAE")) %>%
  mutate(cleaned_visit_info = factor(cleaned_visit_info, levels = c("1", "2", "3", "irAE", "irAE F/U")),
         group = factor(group, levels = c("non-irAE", "irAE/SAE")),
         ctcae_grade = if_else(is.na(ctcae_grade), "0", as.character(ctcae_grade)),
         ctcae_grade = factor(ctcae_grade, levels = c("0", "1", "2", "3")),
         patient_id = as.factor(patient_id))

# Split data by 'sort'
data_by_sort <- split(model_data, model_data$sort)

# Function to fit the GAM for each sort
fit_gam <- function(data) {
  tryCatch(
    {
      # not using s() for visit as it's not numeric really it's categorical (i.e. visits 2/3 not always at same time from baseline for each patient? or are they?)
      model <- gam(freq ~ thyroid_irae * cleaned_visit_info + s(patient_id, bs = "re"),
                   data = data, method = 'REML')
      list(summary = summary(model), plot = model)
    },
    error = function(e) list(error = e$message)
  )
}

gam_results <- map(data_by_sort, fit_gam)

```

# Check model

```{r}

gam_data <- model_data %>%
  filter(sort == "EMRA.of.CD8.Tcells")

model <- gam(freq ~ group * cleaned_visit_info + s(patient_id, bs = "re"),
                   data = gam_data, method = 'REML')

gam.check(model)
# looks well-fit (residuals ~straight line on QQ plot), histogram of residuals is normal

```

# Inspect results

```{r}

# Create a tibble of parametric results across all sorts
all_pvals <- map_dfr(
  names(gam_results), 
  function(sort_name) {
    # Check if the sort has a summary (i.e., no errors in fitting)
    if (!is.null(gam_results[[sort_name]]$summary)) {
      # Extract p.table and add sort information
      as_tibble(gam_results[[sort_name]]$summary$p.table, rownames = "term") %>%
        mutate(sort = sort_name)
    } else {
      NULL
    }
  }
)

all_pvals <- all_pvals %>%
  mutate(padj = p.adjust(`Pr(>|t|)`, method = "BH"))

# focus away from intercept results, and just treatment effects, so focus on group/group-treatment interaction results
significant_pvals <- all_pvals %>%
  mutate(sort = gsub("\\.", " ", sort)) %>%
  filter(padj < 0.05) %>%
  select(sort, term, padj) %>%
  # filter for visits 2-3/group interactions
  filter(grepl(":", term),
         !grepl("infoirAE", term)) %>%
  arrange(padj) %>%
  # just take top ones for many thyroid group-visit interaction results
  #head(10)
  filter(padj < 0.05) %>%
  arrange(sort)

significant_pvals

# combined irAE interaction effects padj < 0.05:
# SCM of Tconv Tcells at visits 2/3, CD56bright of NK cells at visit 3, EM of CD8s at visit 2, naive of Tregs at visit 2

# pneumonitis padj < 0.05
# swMem of Bcells	interaction at visit 3

# for thyroid, interactions with padj < 0.05
# CM of CD8 Tcells visits 2/3
# CCR6pos of NN CD8 Tcells visit 3
# CD4 of Tcells	visit 3
# CD11cpos of Bcells visit 2
# CRTH2pos of NN Tconv Tcells visit 3
# DP of Tcells visit 3
# EMRA of CD8 Tcells visits 2/3
# NKcells of nonGrans	visits 2/3
# SCM of CD8 Tcells	visits 2/3
# nonclassical of monocytes	visit 2
# Bcells of nonGrans visit 2

# for skin, interactions with padj < 0.05
# CD56bright of NKcells	visit 3

# rheumatoid
# padj < 0.01: CRTH2pos of NN Tconv Tcells	visit 3
# padj < 0.05: DN of Tcells visit 3

```

# Plot significant results

```{r}

plot_data <- adjusted_data %>%
  filter(group %in% c("non-irAE", "irAE/SAE"),
         cleaned_visit_info != "Other") %>%
  mutate(cleaned_visit_info = factor(cleaned_visit_info, levels = c("1", "2", "3", "irAE", "irAE F/U")),
         group = factor(group, levels = c("irAE/SAE", "non-irAE")),
         pneumonitis_irae = factor(pneumonitis_irae, levels = c("Pneumonitis", "No pneumonitis")),
         thyroid_irae = factor(thyroid_irae, levels = c("Thyroid irAE", "No thyroid irAE")),
         skin_irae = factor(skin_irae, levels = c("Skin irAE", "No skin irAE")),
         rheumatoid_irae = factor(rheumatoid_irae, levels = c("Rheumatoid irAE", "No rheumatoid irAE")),
         ctcae_grade = if_else(is.na(ctcae_grade), "0", as.character(ctcae_grade)),
         ctcae_grade = factor(ctcae_grade, levels = c("0", "1", "2", "3"))) %>%
    mutate(sort = gsub("\\.", " ", sort))

# ctcae grade visit interactions

#p <- plot_data %>% filter(sort %in% c("CD38hiCD127neg of NN CD8 Tcells", "CD56bright of NKcells", "cDC of nonGrans", "CM of Tconv Tcells")) %>% ggplot(aes(x = #cleaned_visit_info, y = freq, color = ctcae_grade)) +
#  geom_jitter(width = 0.05, alpha = 0.75) +
#  geom_smooth(aes(group = ctcae_grade),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
#  facet_wrap(~ sort, ncol = 4) +
#  labs(x = "Visit", y = "Residuals", color = "CTCAE grade") +
#  theme(strip.text = element_text(size = 13),
#        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

#p

#ggsave("../figures/gam_results_ctcae_grade_interactions.png", p, width = 13, height = 4)

# for thyroid, interactions with padj < 0.05
# CD11cpos of Bcells visit 2
# CM of CD8 Tcells visits 2/3
# CCR6pos of NN CD8 Tcells visit 3
# EMRA of CD8 Tcells visits 2/3
# CD4 of Tcells	visit 3
# CRTH2pos of NN Tconv Tcells visit 3
# DP of Tcells visit 3
# NKcells of nonGrans	visits 2/3
# SCM of CD8 Tcells	visits 2/3
# nonclassical of monocytes	visit 2
# Bcells of nonGrans visit 2

p <- plot_data %>% filter(sort %in% c("CD11cpos of Bcells", "CM of CD8 Tcells", "CCR6pos of NN CD8 Tcells", "EMRA of CD8 Tcells", "CD4 of Tcells", "CRTH2pos of NN Tconv Tcells", "DP of Tcells", "NKcells of nonGrans", "SCM of CD8 Tcells", "nonclassical of monocytes", "Bcells of nonGrans")) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = thyroid_irae)) +
  geom_jitter(width = 0.05, alpha = 0.75) +
  geom_smooth(aes(group = thyroid_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 6) +
  labs(x = "Visit", y = "Residuals", color = "Thyroid group") +
  theme(strip.text = element_text(size = 9),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_thyroid_interactions.png", p, width = 14, height = 8)

# combined irAE interaction effects padj < 0.05:
# SCM of Tconv Tcells at visits 2/3, CD56bright of NK cells at visit 3, EM of CD8s at visit 2, naive of Tregs at visit 2

p <- plot_data %>% filter(sort %in% c("CD56bright of NKcells", "EM of CD8 Tcells", "SCM of Tconv Tcells", "naive of Treg Tcells")) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = group)) +
  #geom_boxplot(outliers = FALSE) +
  geom_jitter(width = 0.05, alpha = 0.75) +
  geom_smooth(aes(group = group),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort, ncol = 2) +
  labs(x = "Visit", y = "Residuals", color = "Group") +
  theme(strip.text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_combined_irae.png", p, width = 8, height = 8)

# for skin, interaction (group-visit 3 for CD56bright of NK cells, padj = 0.048)

p <- plot_data %>% filter(sort %in% c("CD56bright of NKcells")) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = skin_irae)) +
  geom_jitter(width = 0.05, alpha = 0.75) +
  geom_smooth(aes(group = skin_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  labs(x = "Visit", y = "CD56bright of NK\ncells (residuals)", color = "Skin irAE group") +
  theme(strip.text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_skin.png", p, width = 6, height = 4)

# rheumatoid
# padj < 0.01: CRTH2pos of NN Tconv Tcells	visit 3
# padj < 0.05: DN of Tcells visit 3

p <- plot_data %>% filter(sort %in% c("DN of Tcells", "CRTH2pos of NN Tconv Tcells", "CD38hiCD127neg of NN CD8 Tcells")) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = rheumatoid_irae)) +
  geom_jitter(width = 0.05, alpha = 0.75) +
  geom_smooth(aes(group = rheumatoid_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  facet_wrap(~ sort) +
  labs(x = "Visit", y = "Residuals", color = "Rheumatoid irAE group") +
  theme(strip.text = element_text(size = 11),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_rheumatoid.png", p, width = 11, height = 4)

# pneumonitis padj < 0.05
# swMem of Bcells	interaction at visit 3

p <- plot_data %>% filter(sort %in% c("swMem of Bcells")) %>% ggplot(aes(x = cleaned_visit_info, y = freq, color = pneumonitis_irae)) +
  geom_jitter(width = 0.05, alpha = 0.75) +
  geom_smooth(aes(group = pneumonitis_irae),method = "gam",formula = y ~ s(x,k=3,bs="cr"),se=TRUE) +
  labs(x = "Visit", y = "swMem of Bcells\n(residuals)", color = "Pneumonitis irAE group") +
  theme(strip.text = element_text(size = 11),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

p

ggsave("../figures/gam_results_pneumonitis.png", p, width = 6, height = 4)

```