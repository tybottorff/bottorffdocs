---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(clusterProfiler)
library(enrichplot)
library("org.Hs.eg.db", character.only = TRUE)
library(BiocParallel)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in scRNAseq RDS

```{r}

immune.combined <- readRDS("../saved_data/cell_type_ref_mapped_integrated_transformed_reduced_clustered.rds")

```

# Look at just T cells

```{r}

T_cells <- immune.combined[, immune.combined@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & immune.combined@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

```

# Re-do dimensional reduction, clustering

```{r}

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

```

# Read in reference to use for mapping

```{r}

reference <- LoadH5Seurat("../../pbmc_multimodal.h5seurat")

```

# Find reference transfer anchors

```{r}

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

```

# Map reference onto my object

```{r}

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)

```

# Plot mapping results

```{r}

p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Re-look at just T cells

```{r}

T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)


p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Re-look at just T cells

```{r}

T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

T_cells <- RunPCA(T_cells, npcs = 30, verbose = FALSE)
T_cells <- RunUMAP(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindNeighbors(T_cells, reduction = "pca", dims = 1:30)
T_cells <- FindClusters(T_cells, resolution = 3)

anchors <- FindTransferAnchors(
  reference = reference,
  query = T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

T_cells <- MapQuery(
  anchorset = anchors,
  query = T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)


p1 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Not many non-T cells leftover

```{r}

just_T_cells <- T_cells[, T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Make some UMAP overlays

```{r}

t_cell_metadata <- as_tibble(just_T_cells@meta.data) %>%
    mutate(group = case_when(
    startsWith(orig.ident, "CT") ~ "no ICI",
    startsWith(orig.ident, "C") ~ "ICI colitis",
    startsWith(orig.ident, "NC") ~ "ICI no colitis"))

t_cell_metadata

just_T_cells <- AddMetaData(just_T_cells, metadata = t_cell_metadata)

DimPlot(just_T_cells, reduction = "umap", group.by = "group", shuffle = TRUE, seed = 728)

DimPlot(just_T_cells, reduction = "umap", group.by = "orig.ident", shuffle = TRUE, seed = 728) + NoLegend()

```

# Save RDS

```{r}

saveRDS(just_T_cells, "../saved_data/T_cells.rds")

```

# See if there might be cell types not well mapped (due to reference being PBMCs and query being colon tissue)

```{r}

#just_T_cells <- readRDS("../saved_data/T_cells.rds")

#reference <- ScaleData(reference, verbose = FALSE)

#reference <- RunPCA(reference, npcs = 30, verbose = FALSE)
#just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
# reference
#reference <- DietSeurat(reference, counts = FALSE, dimreducs = "pca")

# query
#just_T_cells <- DietSeurat(just_T_cells, counts = FALSE, dimreducs = "ref.pca")

#reference@assays$SCT

#just_T_cells@assays$integrated

#merge reference and query
#reference$id <- 'reference'
#just_T_cells$id <- 'query'
#refquery <- merge(reference@assays$SCT, just_T_cells@assays$integrated)
#refquery[["pca"]] <- merge(reference[["pca"]], just_T_cells[["ref.pca"]])
#refquery <- RunUMAP(refquery, reduction = 'pca', dims = 1:50)
#DimPlot(refquery, group.by = 'id', shuffle = TRUE)

```

# Look for clusters with high Trm marker expression

 - take home is I'll change clusters 25 and 27 (CD4 TCM) to CD4 Trm and 3, 7, 9, 15-16 (CD8 TEM) to CD8 Trm in abundance, feature, linkage analyses

```{r}

# Human TRM are typically associated with the expression of the surface markers CD69 and CD103 (ITGAE, integrin αE), maybe also CD49a (integrin α1, ITGA1)

VlnPlot(just_T_cells, features = c("CD69"), pt.size = 0)

# CD69
# 25 (CD4 TCM) and 29 (only MAIT) highest --> I think I'll just take 25 & 27 (previously CD4 TCM NOW CD4 Trm!)
# 27 (CD4 TCM), 36 (CD8 TCM), 37, 6 somewhat as well

# ITGAE/CD103
# 15, 16, 9, 7, 2, 3 highest --> I think I'll just take 15, 16, 7, 9, 3 (all CD8 TEM --> now CD8 Trm?)
# also 22, 28, 34, 35, 37, 38 a bit
# ITGA1/CD49a
# 16 highest
# also 15, 7, 9-10, 2-3
# CD101
# highest in 3, 7, 9, 15, 16

#FeaturePlot(just_T_cells, features = "CD69")

#FeaturePlot(just_T_cells, features = "ITGAE")

#FeaturePlot(just_T_cells, features = "ITGA1")

#FeaturePlot(just_T_cells, features = "CD101")

#DimPlot(just_T_cells, reduction = "umap", label.size = 1)

```

# Remake UMAPs with new Trm cell types

```{r}

t_cell_metadata <- just_T_cells@meta.data %>%
  mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD4 T", "CD4 Trm", if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD8 T", "CD8 Trm", predicted.celltype.l2)))

t_cell_metadata

just_T_cells$predicted.celltype.l2 <- t_cell_metadata$predicted.celltype.l2

p1 <- DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", shuffle = TRUE, seed = 728, label = TRUE, repel = TRUE) + NoLegend()

p2 <- DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", shuffle = TRUE, seed = 728, label = TRUE, repel = TRUE) + NoLegend()

p1 + p2

```

# Look at markers across cell types

```{r}

VlnPlot(just_T_cells, features = c("FOXP3"), pt.size = 0, group.by = "predicted.celltype.l2")

# CCR7 high for naive matches ok but only for CD4s...
# CD8 TCM. CCR7+. CD62L+ (SELL). # CD8 TEM. CCR7-. CD62L-
VlnPlot(just_T_cells, features = c("CCR7"), pt.size = 0, group.by = "predicted.celltype.l2")

# Trm
VlnPlot(just_T_cells, features = c("CD69", "ITGAE"), pt.size = 0, group.by = "predicted.celltype.l2")
VlnPlot(just_T_cells, features = c("ITGA1", "CD101"), pt.size = 0, group.by = "predicted.celltype.l2")

```

# Look at how good cell type scores are

```{r}

cell_type_score_histograms <- just_T_cells@meta.data %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  select(predicted.celltype.l1, predicted.celltype.l2, predicted.celltype.l2.score)

cell_type_score_histograms

ggplot(cell_type_score_histograms %>% filter(predicted.celltype.l1 == "other T"), aes(x = predicted.celltype.l2.score)) +
  geom_histogram() +
  facet_wrap(~ predicted.celltype.l2, scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(n = 2))

```

# Prep RNA, read in TCR-seq data

```{r}

t_cell_metadata$barcode <- colnames(just_T_cells)

t_cell_metadata

patient_barcode_connect <- t_cell_metadata %>%
  group_by(orig.ident) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(patient = sub("-.*", "", orig.ident),
         barcode_num = sub(".*_", "", barcode)) %>%
  select(patient, barcode_num)

patient_barcode_connect

tcr <- read.csv("../raw_data/tcr/GSE144469_TCR_filtered_contig_annotations_all.csv") %>%
  select(-X) %>%
  filter(high_confidence == "True",
         productive == "True",
         cdr3 != "None",
         !(is.na(cdr3)),
         !(is.na(v_gene)),
         !(is.na(j_gene)),
         !(is.na(c_gene)),
         full_length == "True",
         is_cell == "True",
         chain != "Multi") %>%
  select(-is_cell, -high_confidence, -length, -full_length, -productive, -raw_clonotype_id, -raw_consensus_id, -contig_id) %>%
  # if a cell had two or more qualified chains of the same type, keep only that chain with the highest UMI count
  group_by(barcode, chain) %>%
  arrange(-umis) %>%
  slice(1) %>%
  ungroup() %>%
  select(-reads, -umis) %>%
  pivot_wider(names_from = "chain", values_from = c("v_gene", "d_gene", "j_gene", "c_gene", "cdr3", "cdr3_nt")) %>%
  mutate(patient = sub(".*-", "", barcode)) %>%
  left_join(patient_barcode_connect, by = "patient") %>%
  mutate(barcode = sub("-.*", "-1_", barcode)) %>%
  mutate(barcode = paste(barcode, barcode_num, sep = "")) %>%
  as.data.frame()

tcr

```

# Add pgen metadata

```{r}

pgen <- read.csv("../saved_data/rna_tcr_no_na_good_cell_typing.csv") %>%
  mutate(pgen = log10(pgen)) %>%
  pivot_wider(id_cols = c(barcode, predicted.celltype.l1, predicted.celltype.l2), names_from = "Chain", values_from = c("v_gene", "d_gene", "j_gene", "c_gene", "cdr3", "cdr3_nt", "pgen", "cdr3_length", "cdr3_hydrophobicity"))

test <- tcr %>%
  left_join(pgen, by = c("barcode", "v_gene_TRA", "v_gene_TRB", "d_gene_TRA", "d_gene_TRB", "j_gene_TRA", "j_gene_TRB", "c_gene_TRA", "c_gene_TRB", "cdr3_TRA", "cdr3_TRB", "cdr3_nt_TRA", "cdr3_nt_TRB")) %>%
  filter(predicted.celltype.l2 == "CD8 Trm") %>%
  filter(!(is.na(pgen_TRA)))

# Find the quantiles for the top and bottom 10%
top_10_percentile <- quantile(test$pgen_TRA, 0.9)
bottom_10_percentile <- quantile(test$pgen_TRA, 0.1)

# Filter the values in the top and bottom 10%
top_10_percentile_values <- test$pgen_TRA[test$pgen_TRA >= top_10_percentile]
bottom_10_percentile_values <- test$pgen_TRA[test$pgen_TRA <= bottom_10_percentile]

# top 10% are from -5.36 to -7.36 so > -7.36
# bot 10% are from -13.36 to -24.03 so < -13.36

ggplot(test, aes(x = pgen_TRA)) +
  geom_histogram(fill = "blue", color = "black", alpha = 0.7)

tcr <- tcr %>%
  left_join(pgen, by = c("barcode", "v_gene_TRA", "v_gene_TRB", "d_gene_TRA", "d_gene_TRB", "j_gene_TRA", "j_gene_TRB", "c_gene_TRA", "c_gene_TRB", "cdr3_TRA", "cdr3_TRB", "cdr3_nt_TRA", "cdr3_nt_TRB")) %>%
  mutate(quantile = case_when(
    pgen_TRA > -7.36 ~ "Top 10%",
    pgen_TRA < -13.36 ~ "Bottom 10%",
    TRUE ~ "Middle 80%"
  ))

rownames(tcr) <- tcr$barcode

tcr <- tcr %>%
  select(-barcode)

```

# Add TCR metadata onto RNA

```{r}

tcr_and_rna <- AddMetaData(just_T_cells, metadata = tcr)

```

# Look at expansion-bin-colored UMAP

```{r}

t_cell_metadata <- tcr_and_rna@meta.data %>%
  mutate(clonotype = paste(v_gene_TRA, v_gene_TRB, j_gene_TRA, j_gene_TRB, cdr3_TRA, cdr3_TRB, sep = "_")) %>%
  group_by(patient, clonotype) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  mutate(expansion_bin = case_when(
    count == 1 ~ "1",
    count > 1 & count < 5 ~ "2-4",
    count >= 5 & count < 20 ~ "5-19",
    count >= 20 & count < 40 ~ "20-39",
    count >= 40 & count < 100 ~ "40-99",
    count >= 100 ~ "> 100"
  )) %>%
  mutate(group = case_when(
    startsWith(orig.ident, "CT") ~ "no ICI",
    startsWith(orig.ident, "C") ~ "ICI colitis",
    startsWith(orig.ident, "NC") ~ "ICI no colitis"))

tcr_and_rna$expansion_bin <- t_cell_metadata$expansion_bin
tcr_and_rna$group <- t_cell_metadata$group

tcr_and_rna$expansion_bin <- factor(tcr_and_rna$expansion_bin, levels = c("1", "2-4", "5-19", "20-39", "40-99", "> 100"))

DimPlot(tcr_and_rna, reduction = "umap", group.by = "expansion_bin", shuffle = TRUE, seed = 123)

```

# Look at UMAP colored by irAE

```{r}

DimPlot(tcr_and_rna, reduction = "umap", group.by = "group", shuffle = TRUE, seed = 455, cols = c("#619CFF", "#F8766D", "#00BA38"))

```

# Look at CD8 Trms with highest and lowest TRA pgen (log10) scores on UMAP

```{r}

cd8_trms <- subset(tcr_and_rna, subset = predicted.celltype.l2 == 'CD8 Trm' & quantile %in% c("Bottom 10%", "Top 10%"))

DimPlot(cd8_trms, reduction = "umap", group.by = "quantile", shuffle = TRUE, seed = 455, pt.size = 0.5)

```

# DEG analysis between CD8 Trms with highest and lowest TRA pgen (log10) scores, pseudobulk to take into account that many cells come from same patient

```{r}

# pseudobulk the counts based on donor-condition-celltype
cd8_trms_pseudobulk <- AggregateExpression(cd8_trms, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "quantile"))

# each 'cell' is a donor-quantile (top or bot) combination
#Cells(cd8_trms_pseudobulk)

cd8_trms_pseudobulk$quantile <- sub(".*_([^_]+)$", "\\1", colnames(cd8_trms_pseudobulk))

cd8_trms_pseudobulk$quantile <- factor(cd8_trms_pseudobulk$quantile, levels = c("Bottom 10%", "Top 10%"))

Idents(cd8_trms_pseudobulk) <- "quantile"

cd8_trms_degs_pseudobulk <- FindMarkers(object = cd8_trms_pseudobulk, 
                         ident.1 = "Bottom 10%", 
                         ident.2 = "Top 10%")

cd8_trms_degs_pseudobulk

```

# DEG analysis for CD4 proliferating T cells between irAE groups, pseudobulk

```{r}

cd4_prolif <- subset(just_T_cells, subset = predicted.celltype.l2 == 'CD4 Proliferating')

cd4_prolif_meta <- cd4_prolif@meta.data %>%
  mutate(group = case_when(
    startsWith(orig.ident, "CT") ~ "no ICI",
    startsWith(orig.ident, "C") ~ "ICI colitis",
    startsWith(orig.ident, "NC") ~ "ICI no colitis"))

cd4_prolif$group <- cd4_prolif_meta$group

cd4_prolif_ici <- subset(cd4_prolif, subset = group != "no ICI")

cd4_prolif_ici_pseudobulk <- AggregateExpression(cd4_prolif_ici, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "group"))

cd4_prolif_ici_pseudobulk$group <- factor(cd4_prolif_ici_pseudobulk$group, levels = c("ICI colitis", "ICI no colitis"))

Idents(cd4_prolif_ici_pseudobulk) <- "group"

#Idents(cd4_prolif_ici_pseudobulk)

cd4_prolif_ici_pseudobulk_degs <- FindMarkers(object = cd4_prolif_ici_pseudobulk, 
                         ident.1 = "ICI colitis", 
                         ident.2 = "ICI no colitis")

cd4_prolif_ici_pseudobulk_degs

```

# DEGs for cell types with differences between irAE groups, finding DEGs between these cell types and all other cell types to nail down what these cell types really are

```{r}

cd4s <- subset(just_T_cells, subset = predicted.celltype.l1 == "CD4 T" & predicted.celltype.l2 %in% c("Treg", "CD4 TEM", "CD4 TCM", "CD4 Naive", "CD4 Proliferating", "CD4 CTL"))

metadata <- cd4s@meta.data %>%
  mutate(is_cd4_tem = if_else(predicted.celltype.l2 == "CD4 TEM", "CD4 TEM", "Not CD4 TEM"),
         is_cd4_prolif = if_else(predicted.celltype.l2 == "CD4 Proliferating", "CD4 Proliferating", "Not CD4 Proliferating"),
         is_cd4_tcm = if_else(predicted.celltype.l2 == "CD4 TCM", "CD4 TCM", "Not CD4 TCM"))

metadata

cd4s$is_cd4_tem <- metadata$is_cd4_tem
cd4s$is_cd4_prolif <- metadata$is_cd4_prolif
cd4s$is_cd4_tcm <- metadata$is_cd4_tcm

cd4_tem_pseudobulk <- AggregateExpression(cd4s, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "is_cd4_tem"))

cd4_tem_pseudobulk$is_cd4_tem <- factor(cd4_tem_pseudobulk$is_cd4_tem, levels = c("CD4 TEM", "Not CD4 TEM"))

Idents(cd4_tem_pseudobulk) <- "is_cd4_tem"

Idents(cd4_tem_pseudobulk)

cd4_tem_pseudobulk_degs <- FindMarkers(object = cd4_tem_pseudobulk, 
                         ident.1 = "CD4 TEM", 
                         ident.2 = "Not CD4 TEM") %>%
  arrange(p_val_adj)

cd4_tem_pseudobulk_degs

cd4_prolif_pseudobulk <- AggregateExpression(cd4s, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "is_cd4_prolif"))

cd4_prolif_pseudobulk$is_cd4_prolif <- factor(cd4_prolif_pseudobulk$is_cd4_prolif, levels = c("CD4 Proliferating", "Not CD4 Proliferating"))

Idents(cd4_prolif_pseudobulk) <- "is_cd4_prolif"

Idents(cd4_prolif_pseudobulk)

cd4_prolif_pseudobulk_degs <- FindMarkers(object = cd4_prolif_pseudobulk, 
                         ident.1 = "CD4 Proliferating", 
                         ident.2 = "Not CD4 Proliferating") %>%
  arrange(p_val_adj)

cd4_prolif_pseudobulk_degs

cd4_tcm_pseudobulk <- AggregateExpression(cd4s, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "is_cd4_tcm"))

cd4_tcm_pseudobulk$is_cd4_tcm <- factor(cd4_tcm_pseudobulk$is_cd4_tcm, levels = c("CD4 TCM", "Not CD4 TCM"))

Idents(cd4_tcm_pseudobulk) <- "is_cd4_tcm"

Idents(cd4_tcm_pseudobulk)

cd4_tcm_pseudobulk_degs <- FindMarkers(object = cd4_tcm_pseudobulk, 
                         ident.1 = "CD4 TCM", 
                         ident.2 = "Not CD4 TCM") %>%
  arrange(p_val_adj)

cd4_tcm_pseudobulk_degs

```

# Try to work from DEGs to get a better sense of what these cell types really are using GSEA: CD4 TEMs

```{r}

cd4_tem_pseudobulk_degs

original_gene_list_tem <- cd4_tem_pseudobulk_degs$avg_log2FC
names(original_gene_list_tem) <- rownames(cd4_tem_pseudobulk_degs)
gene_list_tem <- na.omit(original_gene_list_tem)
gene_list_tem = sort(gene_list_tem, decreasing = TRUE)

gene_list_tem

gse_tem <- gseGO(geneList=gene_list_tem, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

dotplot(gse_tem, showCategory=10, split=".sign", font.size = 5) + facet_grid(.~.sign)

```

# Try to work from DEGs to get a better sense of what these cell types really are using GSEA: CD4 proliferating

```{r}

cd4_prolif_pseudobulk_degs

original_gene_list_prolif <- cd4_prolif_pseudobulk_degs$avg_log2FC
names(original_gene_list_prolif) <- rownames(cd4_prolif_pseudobulk_degs)
gene_list_prolif <- na.omit(original_gene_list_prolif)
gene_list_prolif = sort(gene_list_prolif, decreasing = TRUE)

gene_list_prolif

gse_prolif <- gseGO(geneList=gene_list_prolif, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

dotplot(gse_prolif, showCategory=10, split=".sign", font.size = 5) + facet_grid(.~.sign)

# cell cycle does pop up activated that's a good sign

```

# Try to work from DEGs to get a better sense of what these cell types really are using GSEA: CD4 TCMs

```{r}

cd4_tcm_pseudobulk_degs

original_gene_list_tcm <- cd4_tcm_pseudobulk_degs$avg_log2FC
names(original_gene_list_tcm) <- rownames(cd4_tcm_pseudobulk_degs)
gene_list_tcm <- na.omit(original_gene_list_tcm)
gene_list_tcm = sort(gene_list_tcm, decreasing = TRUE)

gene_list_tcm

gse_tcm <- gseGO(geneList=gene_list_tcm, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

dotplot(gse_tcm, showCategory=10, split=".sign", font.size = 5) + facet_grid(.~.sign)

# IL-6 production activated could be interesting as that's associated with irAEs and TCMs were (very) slightly higher in colitis group

```

# Look at specific memory markers

```{r}

#cd4s <- subset(just_T_cells, subset = predicted.celltype.l2 %in% c("Treg", "CD4 TEM", "CD4 TCM"))

#VlnPlot(cd4s, features = c("PRF1", "GZMB", "KLRG1"), group.by = "predicted.celltype.l2", pt.size = 0)

#VlnPlot(cd4s, features = c("CCR7", "CD28", "CD27"), group.by = "predicted.celltype.l2", pt.size = 0)

#VlnPlot(cd4s, features = c("FOXP3", "CTLA4", "ICOS", "BCL2"), group.by = "predicted.celltype.l2", pt.size = 0)

VlnPlot(cd4s, features = c("CD28", "ICOS", "FAS", "SELL"), group.by = "predicted.celltype.l2", pt.size = 0)

# can't find: CD122

# TEM: KLRG1, CD43, CD95, TNF
# TCM: CD45RA, CCR7, CD62L, CD127, CD122, CD28, IL-2
# Memory Treg: CD25, CD27, FOXP3, CTLA4, CD127-, ICOS, BCL-2, Ki67-

# expected conclusions
# KLRG1 yes higher in TEM
# BCL2 higher in Treg
# CCR7 yes higher in TCM
# CD27 yes higher in Treg
# FOXP3 yes abundantly clearly higher in Treg
# CTLA4 higher in Treg but also present in TCM
# KI67 low for all, only high for proliferating cells
# CD25 (IL2RA) high in Tregs

# unexpected conclusions, kind of support Treg/TCM overlap
# CD28 high in TCM but also in Tregs
# ICOS not higher in Treg, same in TCM/Treg
# CD95 (Fas) not higher in TCM, higher in Treg
# CD62L (SELL) highest in Treg not TCM (TCM kinda high though)

# CD127 (IL7R) higher in TEM not TCM... low in Treg though
# CD43 (SPN) not really higher in TCM

```

# Prepare Seurat object with SingleR (Dice ref) cell label metadata

```{r}

singler_dice_labels <- read.csv("../saved_data/singler_dice_ref_cell_typing.csv") %>%
  dplyr::select(-X)

singler_dice_labels

t_cell_metadata <- as_tibble(just_T_cells@meta.data)

t_cell_metadata$barcode <- colnames(just_T_cells)

t_cell_metadata <- t_cell_metadata %>%
  left_join(singler_dice_labels, by = "barcode")

t_cell_metadata

just_T_cells <- AddMetaData(just_T_cells, metadata = t_cell_metadata)

```

# Re-do DEG GSEA analysis from SingleR (Dice ref) cell labels instead of from Seurat ref cell labels

```{r}

cd4s <- subset(just_T_cells, subset = predicted.celltype.l1 == "CD4 T" & predicted.celltype.l2 %in% c("Treg", "CD4 TEM", "CD4 TCM", "CD4 Naive", "CD4 Proliferating", "CD4 CTL") & dice_singler_label %in% c("T cells, CD4+, Th1", "T cells, CD4+, Th2", "T cells, CD4+, Th17", "T cells, CD4+, memory TREG", "CD4 Naive", "T cells, CD4+, naive TREG", "T cells, CD4+, Th1_17", "T cells, CD4+, TFH", "T cells, CD4+, naive, stimulated"))

metadata <- cd4s@meta.data %>%
  mutate(is_mem_treg = if_else(dice_singler_label == "T cells, CD4+, memory TREG", "Memory Treg", "Not memory Treg"))

metadata

cd4s$is_mem_treg <- metadata$is_mem_treg

cd4_mem_treg_pseudobulk <- AggregateExpression(cd4s, assays = "SCT", return.seurat = T, group.by = c("orig.ident", "is_mem_treg"))

cd4_mem_treg_pseudobulk$is_mem_treg <- factor(cd4_mem_treg_pseudobulk$is_mem_treg, levels = c("Memory Treg", "Not memory Treg"))

Idents(cd4_mem_treg_pseudobulk) <- "is_mem_treg"

Idents(cd4_mem_treg_pseudobulk)

cd4_mem_treg_pseudobulk_degs <- FindMarkers(object = cd4_mem_treg_pseudobulk, 
                         ident.1 = "Memory Treg", 
                         ident.2 = "Not memory Treg") %>%
  arrange(p_val_adj)

cd4_mem_treg_pseudobulk_degs

original_gene_list_mem_treg <- cd4_mem_treg_pseudobulk_degs$avg_log2FC
names(original_gene_list_mem_treg) <- rownames(cd4_mem_treg_pseudobulk_degs)
gene_list_mem_treg <- na.omit(original_gene_list_mem_treg)
gene_list_mem_treg = sort(gene_list_mem_treg, decreasing = TRUE)

gene_list_mem_treg

gse_mem_treg <- gseGO(geneList=gene_list_mem_treg, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             nPerm = 10000, 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db, 
             pAdjustMethod = "none")

dotplot(gse_mem_treg, showCategory=10, split=".sign", font.size = 5) + facet_grid(.~.sign)

```

# Look at Ki67 in SingleR (Dice ref) subsets

```{r}

VlnPlot(cd4s, features = c("MCM2", "MCM4", "MCM5"), group.by = "predicted.celltype.l2", pt.size = 0)

VlnPlot(cd4s, features = c("HDAC9", "CCNG2"), group.by = "dice_singler_label", pt.size = 0)

```

# Look at proliferation vs. activation

```{r}

#prolifs <- subset(just_T_cells, subset = predicted.celltype.l2 %in% c("CD4 Proliferating", "CD8 Proliferating"))

VlnPlot(just_T_cells, features = c("CD40LG", "CD38"), group.by = "predicted.celltype.l2", pt.size = 0)

VlnPlot(just_T_cells, features = c("HLA-DRB1", "HLA-DRA"), group.by = "predicted.celltype.l2", pt.size = 0)

# CD69, not really higher in proliferating cells, also a marker for Trm though? so...
# CD154/CD40LG: kinda high in CD4 prolif but moreso in CD4 CTL/TCM?TEM and MAITs
# EGR1, low in everything except MAITs
# CD44: lowest in proliferating cells
# CD38: yes higher in proliferating cells but really highest in CD4 CTLs, also high in dnTs
# HLA-DR...: B1 yes higher in proliferating cells (also CD8 naive/TEM), A (yes higher in proliferating cells also in CD8 naive), B5 kinda higher in proliferating cells

```