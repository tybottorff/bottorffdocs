---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(scales)
library(ggpubr)
library(ComplexHeatmap)
library(e1071)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in final RNA T cell Seurat with TCR metadata

```{r}

tcr_rna <- read.csv("../saved_data/rna_tcr.csv") %>%
  rename(barcode = X)

tcr_rna

```

# Assess cell identity confidence

```{r}

cell_confidence_test <- tcr_rna %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2) %>%
  summarize(count = n(), score1 = mean(predicted.celltype.l1.score), score2 = mean(predicted.celltype.l2.score))

cell_confidence_test

# unexpected combos have low scores, remove them

```

# Read in IGoR pgen data

```{r}

pgen_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  select(TCR_name, pgen) %>%
  mutate(Chain = "TRA")

pgen <- read.csv("../saved_data/igor_output_beta.csv") %>%
  select(TCR_name, pgen) %>%
  mutate(Chain = "TRB") %>%
  full_join(pgen_alpha, by = c("TCR_name", "Chain", "pgen")) %>%
  rename(barcode = TCR_name)

pgen

```

# Prep hydrophobicity calculator

```{r}

# Define the amino acids and their corresponding Eisenberg hydrophobicity values
amino_acids <- c("A", "R", "N", "D", "C", "Q", "E", "G", "H", "I", "L", "K", "M", "F", "P", "S", "T", "W", "Y", "V")
hydrophobicity_values <- c(0.620, -2.530, -0.780, -0.900, 0.290, -0.850, -0.740, 0.480, -0.400, 1.380, 1.060, -1.500, 0.640, 1.190, 0.120, -0.180, -0.050, 0.81, 0.26, 1.08)

# Create a data frame
hydrophobicity_df <- data.frame(Amino_Acid = amino_acids, Hydrophobicity = hydrophobicity_values)

hydrophobicity_df

calculate_hydrophobicity <- function(sequence, hydrophobicity_df) {
  sequence <- toupper(sequence)
  # Calculate the hydrophobicity scores for each amino acid, and sum them
  scores <- sapply(strsplit(sequence, '')[[1]], function(aa) {
    match_aa <- match(aa, hydrophobicity_df$Amino_Acid)
    if (!is.na(match_aa)) {
      return(hydrophobicity_df$Hydrophobicity[match_aa])
    } else {
      # If an amino acid is not found, return NA
      return(NA)
    }
  })
  # If there are any NAs in the scores, return NA; otherwise, return the sum
  if (any(is.na(scores))) {
    return(NA)
  } else {
    return(sum(scores))
  }
}

```

# Prep feature df (update cell types with Trms), join with IGoR pgen data

```{r}

combined_data <- tcr_rna %>%
  pivot_longer(cols = matches("(TRA|TRB)$"),
               names_to = c(".value", "Chain"),
               names_pattern = "^(.*)_(TRA|TRB)$") %>%
  mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD4 T", "CD4 Trm", if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD8 T", "CD8 Trm", predicted.celltype.l2))) %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  filter(!(is.na(v_gene)),
         !(is.na(d_gene)),
         !(is.na(j_gene)),
         !(is.na(c_gene)),
         !(is.na(cdr3))) %>%
  mutate(group = case_when(
    startsWith(patient, "CT") ~ "no ICI",
    startsWith(patient, "C") ~ "ICI colitis",
    startsWith(patient, "NC") ~ "ICI no colitis")) %>%
  mutate(cdr3_length = nchar(cdr3)) %>%
  ungroup() %>%
  left_join(pgen, by = c("barcode", "Chain")) %>%
  rowwise() %>%
  mutate(cdr3_hydrophobicity = calculate_hydrophobicity(cdr3, hydrophobicity_df)) %>%
  ungroup()

write.csv(combined_data, "../saved_data/rna_tcr_no_na_good_cell_typing.csv")

combined_data

```

# Examine patient sampling depth bias

```{r}

seq_depth <- combined_data %>%
  group_by(patient, group) %>%
  summarize(seq_depth = n()) %>%
  arrange(seq_depth) %>%
  print()

seq_depth

write.csv(seq_depth, "../saved_data/seq_depth.csv")

# Choose ~2512/2 seqs from non B10 samples to downsample all to 2449/2

```

# Downsample

```{r}

desired_rows_per_patient <- 1218
# ~/2 to get equal numbers of each Chain (TRA and TRB)

set.seed(4562)

# Downsample the dataframe
downsampled_df <- combined_data %>%
  group_by(patient, Chain) %>%
  sample_n(desired_rows_per_patient, replace = FALSE) %>%
  ungroup()

downsampled_df

write.csv(downsampled_df, "../saved_data/downsampled_df.csv")

```

# Calculate expansion from full clonotype

```{r}

combined_data <- combined_data %>%
  pivot_wider(id_cols = c(barcode, patient, group, predicted.celltype.l1, predicted.celltype.l2, seurat_clusters), names_from = "Chain", values_from = c("v_gene", "d_gene", "j_gene", "c_gene", "cdr3", "cdr3_nt", "pgen", "cdr3_length", "cdr3_hydrophobicity")) %>%
  filter(!(is.na(v_gene_TRA)),
         !(is.na(j_gene_TRA)),
         !(is.na(cdr3_TRA)),
         !(is.na(v_gene_TRB)),
         !(is.na(j_gene_TRB)),
         !(is.na(cdr3_TRB))) %>%
  mutate(clonotype = paste(v_gene_TRA, v_gene_TRB, j_gene_TRA, j_gene_TRB, cdr3_TRA, cdr3_TRB, sep = "_")) %>%
  group_by(patient, clonotype) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  pivot_longer(cols = matches("(TRA|TRB)$"),
               names_to = c(".value", "Chain"),
               names_pattern = "^(.*)_(TRA|TRB)$")

# just throw out ~5k seqs that aren't paired TRA/TRB?

combined_data

write.csv(combined_data, "../saved_data/pre_feature_heatmap_data.csv")

```

# Prep data for summary plots (normalized method)

```{r}

prepped_data <- combined_data %>%
  filter(group != "no ICI") %>%
  # normalize by sequencing depth
  left_join(seq_depth, by = c("patient", "group")) %>%
  mutate(normalized_count = count / seq_depth) %>%
  # look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2, Chain) %>%
  arrange(-normalized_count) %>%
  mutate(chunk_size = ceiling(n() * 0.05),
         chunk = 5*ceiling(row_number() / chunk_size))

prepped_data

```

# Define test functions

```{r}

# Function to perform the test within a specific bin of clonotype abundances
perform_wilcox_test <- function(data, cutoff) {
  result <- data %>%
    filter(chunk == cutoff) %>%
    group_by(predicted.celltype.l1, predicted.celltype.l2, Chain) %>%    
    summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
    ungroup()
  
  return(result)
}

# Function to perform the test cumulativley up to a specific bin of clonotype abundances
perform_wilcox_test_cumulatively <- function(data, cutoff) {
  result <- data %>%
    filter(chunk <= cutoff) %>%
    group_by(predicted.celltype.l1, predicted.celltype.l2, Chain) %>%    
    summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
    ungroup()
  
  return(result)
}

```

# Perform wilcox rank sum tests within chunks of 5% clonotypes (normalized method)

```{r}

# List to store results
results_list <- list()

# Iterate through chunk cutoffs
for (num in 1:5) {
  result <- prepped_data %>%
    perform_wilcox_test_cumulatively(cutoff = num*5)

  results_list[[as.character(num*5)]] <- result
}

# Combine results into a single dataframe
results_df <- bind_rows(results_list, .id = "Chunk")

results_df <- results_df %>%
  pivot_longer(cols = c("p_val_pgen", "p_val_cdr3_length", "p_val_cdr3_hydrophobicity"), names_to = "p_val") %>%
  rename(p_val_category = p_val) %>%
  mutate(p_val_category = gsub("p_val_", "", p_val_category)) %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category)) %>%
  # adjust pvals for multiple comparisons
  mutate(value = p.adjust(value, method = "BH")) %>%
  arrange(value)

results_df

```

# Make heatmap (normalized method)

```{r}

top_results <- results_df %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category))

filtered_results_df <- results_df %>%
  filter(category %in% top_results$category) %>%
  mutate(log_val = -log10(value))

filtered_results_df$Chunk <- factor(filtered_results_df$Chunk, levels = c("5", "10", "15", "20", "25"))

heatmap_df <- filtered_results_df %>%
  select(-value, -category) %>%
  rename(value = log_val) %>%
  mutate(p_val_category = case_when(
    p_val_category == "pgen" ~ "Probability of generation",
    p_val_category == "cdr3_length" ~ "CDR3 length (AAs)",
    p_val_category == "cdr3_hydrophobicity" ~ "CDR3 hydrophobicity"
  )) %>%
  mutate(predicted.celltype.l2 = gsub("CD4 |CD8 ", "", predicted.celltype.l2))

heatmap_df

# Prepare the data in matrix form
heatmap_data <- reshape2::dcast(heatmap_df, predicted.celltype.l1 + predicted.celltype.l2 + p_val_category + Chain ~ Chunk, value.var = "value")

# Extract value columns
mat <- as.matrix(heatmap_data[, -(1:4)])

# Set row names
rownames(mat) <- paste(heatmap_data$predicted.celltype.l1, heatmap_data$predicted.celltype.l2, heatmap_data$p_val_category, heatmap_data$Chain, sep = "_")

# Create a matrix of annotations
chain_annotations <- cbind(
  Chain = heatmap_data$Chain
)

# Create a matrix of annotations
type_annotations <- cbind(
  "Cell type" = heatmap_data$predicted.celltype.l1
)

# Create a matrix of annotations
subtype_annotations <- cbind(
  "Cell subtype" = heatmap_data$predicted.celltype.l2
)

# Create a matrix of annotations
feature_annotations <- cbind(
  Feature = heatmap_data$p_val_category
)

# Plot the heatmap without clustering
Heatmap(mat,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
        right_annotation = rowAnnotation("Cell type" = type_annotations,
                                         "Cell subtype" = subtype_annotations,
                                         Chain = chain_annotations,
                                         Feature = feature_annotations,
                                         col = list("Cell type" = c("CD4 T" = "#fde725", "CD8 T" = "#21918c", "other T" = "#440154"),
                                                    "Chain" = c("TRA" = "#fde725", "TRB" = "#440154"),
                                                    "Cell subtype" = c("dnT" = "#440154", "Treg" = "#46327e", "Proliferating" = "#1fa187", "TCM" = "#277f8e",   "TEM" = "#365c8d", "Naive" = "#4ac16d", "MAIT" = "#a0da39", "CTL" = "#fde725", "Trm" = "black"),
                                                    "Feature" = c("CDR3 length (AAs)" = "#21918c", "CDR3 hydrophobicity" = "#fde725", "Probability of generation" = "#440154"))),
        show_row_names = FALSE,
        column_title = "Clonotypes bins\n(% of repertoire across patients)",
        column_title_side = "bottom",
        heatmap_legend_param = list(title = "Wilcox padj val (-log10) for\nyes vs. no colitis irAE"),
        layer_fun = function(j, i, x, y, width, height, fill) {
          v = pindex(mat, i, j)
          l = v > -log10(0.05) & v < -log10(0.01)
          if (any(l)) {
            grid.text("*", x[l], y[l], gp = gpar(fontsize = 10))
          }
          q = v > -log10(0.01)
          if (any(q)) {
            grid.text("**", x[q], y[q], gp = gpar(fontsize = 10))
          }
        }
      )

```

# Prep data for summary plots (downsampled method)

```{r}

prepped_data_downsampled <- downsampled_df %>%
  filter(group != "no ICI") %>%
  left_join(combined_data, by = c("barcode", "Chain", "patient", "predicted.celltype.l1", "predicted.celltype.l2", "group", "pgen", "cdr3_length", "cdr3_hydrophobicity")) %>%
  group_by(patient, clonotype, Chain) %>%
  # look at just unique clonotypes (CDR3 AA - VJ) from each patient
  dplyr::slice(1) %>%
  ungroup() %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2, Chain) %>%
  arrange(-count) %>%
  mutate(chunk_size = ceiling(n() * 0.05),
         chunk = 5*ceiling(row_number() / chunk_size))

prepped_data_downsampled

```

# Perform wilcox rank sum tests within chunks of 5% clonotypes (downsampled method)

```{r}

# List to store results
results_list_downsampled <- list()

# Iterate through chunk cutoffs
for (num in 1:5) {
  result <- prepped_data_downsampled %>%
    perform_wilcox_test_cumulatively(cutoff = num*5)

  results_list_downsampled[[as.character(num*5)]] <- result
}

# Combine results into a single dataframe
results_df_downsampled <- bind_rows(results_list_downsampled, .id = "Chunk")

results_df_downsampled <- results_df_downsampled %>%
  pivot_longer(cols = c("p_val_pgen", "p_val_cdr3_length", "p_val_cdr3_hydrophobicity"), names_to = "p_val") %>%
  rename(p_val_category = p_val) %>%
  mutate(p_val_category = gsub("p_val_", "", p_val_category)) %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category)) %>%
  # adjust pvals for multiple comparisons
  mutate(value = p.adjust(value, method = "BH")) %>%
  arrange(value)

results_df_downsampled

```

# Make heatmap (downsampled method)

```{r}

top_results_downsampled <- results_df_downsampled %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category))

filtered_results_df_downsampled <- results_df_downsampled %>%
  filter(category %in% top_results_downsampled$category) %>%
  mutate(log_val = -log10(value))

filtered_results_df_downsampled$Chunk <- factor(filtered_results_df_downsampled$Chunk, levels = c("5", "10", "15", "20", "25"))

heatmap_df_downsampled <- filtered_results_df_downsampled %>%
  select(-value, -category) %>%
  rename(value = log_val) %>%
  mutate(p_val_category = case_when(
    p_val_category == "pgen" ~ "Probability of generation",
    p_val_category == "cdr3_length" ~ "CDR3 length (AAs)",
    p_val_category == "cdr3_hydrophobicity" ~ "CDR3 hydrophobicity"
  )) %>%
  mutate(predicted.celltype.l2 = gsub("CD4 |CD8 ", "", predicted.celltype.l2))

heatmap_df_downsampled

# Prepare the data in matrix form
heatmap_data_downsampled <- reshape2::dcast(heatmap_df_downsampled, predicted.celltype.l1 + predicted.celltype.l2 + p_val_category + Chain ~ Chunk, value.var = "value")

# Extract value columns
mat_downsampled <- as.matrix(heatmap_data_downsampled[, -(1:4)])

# Set row names
rownames(mat_downsampled) <- paste(heatmap_data_downsampled$predicted.celltype.l1, heatmap_data_downsampled$predicted.celltype.l2, heatmap_data_downsampled$p_val_category, heatmap_data_downsampled$Chain, sep = "_")

# Create a matrix of annotations
chain_annotations_downsampled <- cbind(
  Chain = heatmap_data_downsampled$Chain
)

# Create a matrix of annotations
type_annotations_downsampled <- cbind(
  "Cell type" = heatmap_data_downsampled$predicted.celltype.l1
)

# Create a matrix of annotations
subtype_annotations_downsampled <- cbind(
  "Cell subtype" = heatmap_data_downsampled$predicted.celltype.l2
)

# Create a matrix of annotations
feature_annotations_downsampled <- cbind(
  Feature = heatmap_data_downsampled$p_val_category
)

# highlight rows of interest
#which_row_highlight = which(grepl("CD8 T_TEM_Probability of generation_TRB", rownames(mat_downsampled)))

#split = data.frame(x = c(rep("A", which_row_highlight - 1), "B", rep("C", nrow(mat_downsampled) - which_row_highlight)))

# Plot the heatmap without clustering
Heatmap(mat_downsampled,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
        right_annotation = rowAnnotation("Cell type" = type_annotations_downsampled,
                                         "Cell subtype" = subtype_annotations_downsampled,
                                         Chain = chain_annotations_downsampled,
                                         Feature = feature_annotations_downsampled,
                                         col = list("Cell type" = c("CD4 T" = "#fde725", "CD8 T" = "#21918c", "other T" = "#440154"),
                                                    "Chain" = c("TRA" = "#fde725", "TRB" = "#440154"),
                                                    "Cell subtype" = c("dnT" = "#440154", "Treg" = "#46327e", "Proliferating" = "#1fa187", "TCM" = "#277f8e",   "TEM" = "#365c8d", "Naive" = "#4ac16d", "MAIT" = "#a0da39", "CTL" = "#fde725", "Trm" = "black"),
                                                    "Feature" = c("CDR3 length (AAs)" = "#21918c", "CDR3 hydrophobicity" = "#fde725", "Probability of generation" = "#440154"))),
        show_row_names = FALSE,
        column_title = "Clonotypes bins\n(% of repertoire across patients)",
        column_title_side = "bottom",
        heatmap_legend_param = list(title = "Wilcox padj val (-log10) for\nyes vs. no colitis irAE"))

```

# Prep data for summary plots (per patient method)

```{r}

prepped_data_per_patient <- combined_data %>%
  filter(group != "no ICI") %>%
  group_by(patient, clonotype, Chain) %>%
  # look at just unique clonotypes (CDR3 AA - VJ) from each patient
  dplyr::slice(1) %>%
  ungroup() %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2, Chain, patient) %>%
  arrange(-count) %>%
  mutate(chunk_size = ceiling(n() * 0.05),
         chunk = 5*ceiling(row_number() / chunk_size))

prepped_data_per_patient

```

# Perform wilcox rank sum tests within chunks of 5% clonotypes (per patient method)

```{r}

# List to store results
results_list_per_patient <- list()

# Iterate through chunk cutoffs
for (num in 1:5) {
  result <- prepped_data_per_patient %>%
    perform_wilcox_test_cumulatively(cutoff = num*5)

  results_list_per_patient[[as.character(num*5)]] <- result
}

# Combine results into a single dataframe
results_df_per_patient <- bind_rows(results_list_per_patient, .id = "Chunk")

results_df_per_patient <- results_df_per_patient %>%
  pivot_longer(cols = c("p_val_pgen", "p_val_cdr3_length", "p_val_cdr3_hydrophobicity"), names_to = "p_val") %>%
  rename(p_val_category = p_val) %>%
  mutate(p_val_category = gsub("p_val_", "", p_val_category)) %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category)) %>%
  # adjust pvals for multiple comparisons
  mutate(value = p.adjust(value, method = "BH")) %>%
  arrange(value)

results_df_per_patient

```

# Make heatmap (per patient method)

```{r}

top_results_per_patient <- results_df_per_patient %>%
  mutate(category = paste(predicted.celltype.l2, Chain, p_val_category))

filtered_results_df_per_patient <- results_df_per_patient %>%
  filter(category %in% top_results_per_patient$category) %>%
  mutate(log_val = -log10(value))

filtered_results_df_per_patient$Chunk <- factor(filtered_results_df_per_patient$Chunk, levels = c("5", "10", "15", "20", "25"))

heatmap_df_per_patient <- filtered_results_df_per_patient %>%
  select(-value, -category) %>%
  rename(value = log_val) %>%
  mutate(p_val_category = case_when(
    p_val_category == "pgen" ~ "Probability of generation",
    p_val_category == "cdr3_length" ~ "CDR3 length (AAs)",
    p_val_category == "cdr3_hydrophobicity" ~ "CDR3 hydrophobicity"
  )) %>%
  mutate(predicted.celltype.l2 = gsub("CD4 |CD8 ", "", predicted.celltype.l2))

heatmap_df_per_patient

# Prepare the data in matrix form
heatmap_data_per_patient <- reshape2::dcast(heatmap_df_per_patient, predicted.celltype.l1 + predicted.celltype.l2 + p_val_category + Chain ~ Chunk, value.var = "value")

# Extract value columns
mat_per_patient <- as.matrix(heatmap_data_per_patient[, -(1:4)])

# Set row names
rownames(mat_per_patient) <- paste(heatmap_data_per_patient$predicted.celltype.l1, heatmap_data_per_patient$predicted.celltype.l2, heatmap_data_per_patient$p_val_category, heatmap_data_per_patient$Chain, sep = "_")

# Create a matrix of annotations
chain_annotations_per_patient <- cbind(
  Chain = heatmap_data_per_patient$Chain
)

# Create a matrix of annotations
type_annotations_per_patient <- cbind(
  "Cell type" = heatmap_data_per_patient$predicted.celltype.l1
)

# Create a matrix of annotations
subtype_annotations_per_patient <- cbind(
  "Cell subtype" = heatmap_data_per_patient$predicted.celltype.l2
)

# Create a matrix of annotations
feature_annotations_per_patient <- cbind(
  Feature = heatmap_data_per_patient$p_val_category
)

# highlight rows of interest
#which_row_highlight = which(grepl("CD8 T_TEM_Probability of generation_TRB", rownames(mat_per_patient)))

#split = data.frame(x = c(rep("A", which_row_highlight - 1), "B", rep("C", nrow(mat_per_patient) - which_row_highlight)))

# Plot the heatmap without clustering
Heatmap(mat_per_patient,
        cluster_rows = FALSE,
        cluster_columns = FALSE,
        row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
        right_annotation = rowAnnotation("Cell type" = type_annotations_per_patient,
                                         "Cell subtype" = subtype_annotations_per_patient,
                                         Chain = chain_annotations_per_patient,
                                         Feature = feature_annotations_per_patient,
                                         col = list("Cell type" = c("CD4 T" = "#fde725", "CD8 T" = "#21918c", "other T" = "#440154"),
                                                    "Chain" = c("TRA" = "#fde725", "TRB" = "#440154"),
                                                    "Cell subtype" = c("dnT" = "#440154", "Treg" = "#46327e", "Proliferating" = "#1fa187", "TCM" = "#277f8e",   "TEM" = "#365c8d", "Naive" = "#4ac16d", "MAIT" = "#a0da39", "CTL" = "#fde725", "Trm" = "black"),
                                                    "Feature" = c("CDR3 length (AAs)" = "#21918c", "CDR3 hydrophobicity" = "#fde725", "Probability of generation" = "#440154"))),
        show_row_names = FALSE,
        column_title = "Clonotypes bins\n(% of repertoire across patients)",
        column_title_side = "bottom",
        heatmap_legend_param = list(title = "Wilcox padj val (-log10) for\nyes vs. no colitis irAE"))

```

# Make box plots for specific features at specific chunks

```{r}

cd8_trm_tra_10 <- prepped_data %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 10,
         method = "Normalized by\nclonotype depth")

cd8_trm_tra_15 <- prepped_data %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 15,
         method = "Normalized by\nclonotype depth")

cd8_trm_tra_20 <- prepped_data %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15", "20")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 20,
         method = "Normalized by\nclonotype depth")

cd8_trm_tra_10_downsampled <- prepped_data_downsampled %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 10,
         method = "Downsampled")

cd8_trm_tra_15_downsampled <- prepped_data_downsampled %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 15,
         method = "Downsampled")

cd8_trm_tra_20_downsampled <- prepped_data_downsampled %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15", "20")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 20,
         method = "Downsampled")

cd8_trm_tra_10_per_patient <- prepped_data_per_patient %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 10,
         method = "Per patient")

cd8_trm_tra_15_per_patient <- prepped_data_per_patient %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 15,
         method = "Per patient")

cd8_trm_tra_20_per_patient <- prepped_data_per_patient %>%
  filter(predicted.celltype.l2 == "CD8 Trm" & Chain == "TRA" & chunk %in% c("5", "10", "15", "20")) %>%
  mutate(pgen = log10(pgen),
         new_chunk = 20,
         method = "Per patient")

cd8_trm_tra <- cd8_trm_tra_10 %>%
  full_join(cd8_trm_tra_15) %>%
  full_join(cd8_trm_tra_20) %>%
  full_join(cd8_trm_tra_15_downsampled) %>%
  full_join(cd8_trm_tra_20_downsampled) %>%
  full_join(cd8_trm_tra_10_downsampled) %>%
  full_join(cd8_trm_tra_15_per_patient) %>%
  full_join(cd8_trm_tra_20_per_patient) %>%
  full_join(cd8_trm_tra_10_per_patient)

cd8_trm_tra$group <- factor(cd8_trm_tra$group, levels = c("ICI no colitis", "ICI colitis"))

cd8_trm_tra %>%
  group_by(new_chunk, group, method) %>%
  summarize(count = n())

ggplot(cd8_trm_tra, aes(x = as.factor(new_chunk), y = pgen, fill = group)) +
  geom_boxplot() +
  facet_wrap(~method) +
  labs(x = "Clonotype bins (% of repertoire across patients)", y = "pgen (log10)") +
  theme(strip.text = element_text(size = 12))

```

# Perform feature tests between irAE groups just for converged, public, or private TCRs within each cell type, chain combo

```{r}

converged_tcrs <- read.csv("../saved_data/converged_public_private_tcrs.csv") %>%
  left_join(combined_data, by = c("barcode", "Chain", "cdr3", "v_gene", "d_gene", "j_gene", "predicted.celltype.l1", "predicted.celltype.l2", "group", "c_gene", "patient")) %>%
  # look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  filter(convergence == "Yes",
         group != "no ICI") %>%
  group_by(predicted.celltype.l2, Chain) %>%
  summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
  pivot_longer(cols = matches("^(p_val)"),
               names_to = c(".value", "Feature"),
               names_pattern = "^(p_val)_(.*)$") %>%
  # adjust pvals for multiple comparisons
  mutate(p_val = p.adjust(p_val, method = "BH")) %>%
  arrange(p_val)

converged_tcrs

public_tcrs <- read.csv("../saved_data/converged_public_private_tcrs.csv") %>%
  left_join(combined_data, by = c("barcode", "Chain", "cdr3", "v_gene", "d_gene", "j_gene", "predicted.celltype.l1", "predicted.celltype.l2", "group", "cdr3_nt", "c_gene", "patient")) %>%
  ## look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  filter(publicity == "Yes",
         group != "no ICI") %>%
  group_by(predicted.celltype.l2, Chain) %>%
  summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
  pivot_longer(cols = matches("^(p_val)"),
               names_to = c(".value", "Feature"),
               names_pattern = "^(p_val)_(.*)$") %>%
  # adjust pvals for multiple comparisons
  mutate(p_val = p.adjust(p_val, method = "BH")) %>%
  arrange(p_val)

public_tcrs

private_tcrs <- read.csv("../saved_data/converged_public_private_tcrs.csv") %>%
  left_join(combined_data, by = c("barcode", "Chain", "cdr3", "v_gene", "d_gene", "j_gene", "predicted.celltype.l1", "predicted.celltype.l2", "group", "cdr3_nt", "c_gene", "patient")) %>%
  ## look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  filter(privicity == "Yes",
         group != "no ICI") %>%
  group_by(predicted.celltype.l2, Chain) %>%
  summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
  pivot_longer(cols = matches("^(p_val)"),
               names_to = c(".value", "Feature"),
               names_pattern = "^(p_val)_(.*)$") %>%
  # adjust pvals for multiple comparisons
  mutate(p_val = p.adjust(p_val, method = "BH")) %>%
  arrange(p_val)

private_tcrs

all_tcrs <- read.csv("../saved_data/converged_public_private_tcrs.csv") %>%
  left_join(combined_data, by = c("barcode", "Chain", "cdr3", "v_gene", "d_gene", "j_gene", "predicted.celltype.l1", "predicted.celltype.l2", "group", "cdr3_nt", "c_gene", "patient")) %>%
  ## look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  filter(group != "no ICI") %>%
  group_by(predicted.celltype.l2, Chain) %>%
  summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
  pivot_longer(cols = matches("^(p_val)"),
               names_to = c(".value", "Feature"),
               names_pattern = "^(p_val)_(.*)$") %>%
  # adjust pvals for multiple comparisons
  mutate(p_val = p.adjust(p_val, method = "BH")) %>%
  arrange(p_val)

all_tcrs

# private CD8 TEM TRB pgen and CDR3 length different between irAE groups
# CD4 proliferating TRB pgen different pgen irAE groups

```

# Make box plot for all CD4 proliferating TRB pgen

```{r}

cd4_prolif_trb_pgen <- read.csv("../saved_data/converged_public_private_tcrs.csv") %>%
  left_join(combined_data, by = c("barcode", "Chain", "cdr3", "v_gene", "d_gene", "j_gene", "predicted.celltype.l1", "predicted.celltype.l2", "group", "cdr3_nt", "c_gene", "patient")) %>%
  filter(group != "no ICI",
         Chain == "TRB")

cd4_prolif_trb_pgen

cd4_prolif_trb_pgen$group <- factor(cd4_prolif_trb_pgen$group, levels = c("ICI no colitis", "ICI colitis"))

ggplot(cd4_prolif_trb_pgen, aes(x = predicted.celltype.l2, y = log10(pgen), fill = group)) +
  geom_boxplot() +
  labs(x = "Cell type", y = "pgen (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

prepped_data_downsampled

prepped_data_downsampled$group <- factor(prepped_data_downsampled$group, levels = c("ICI no colitis", "ICI colitis"))

ggplot(prepped_data_downsampled %>% filter(predicted.celltype.l2 == "CD4 Proliferating" & Chain == "TRB"), aes(x = patient, y = log10(pgen), fill = group)) +
  geom_boxplot() +
  labs(x = "Patient ID", y = "pgen (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

```

# Compare pgen of most and least expanded T cells

```{r}

expansion_features <- prepped_data %>%
  ungroup() %>%
  mutate(top_bot = if_else(chunk <= 10, "Highly expanded", if_else(chunk > 90, "Not expanded", "Middle"))) %>%
  filter(top_bot != "Middle")

expansion_features

wilcox.test(pgen ~ top_bot, data = expansion_features, exact = FALSE)

# Comparing top 10 vs. bot 10 and top 5 vs. bot 5 does have significance... 15/85 doesn't

prepped_data

plot <- ggplot(prepped_data, aes(x = as.factor(chunk), y = log10(pgen))) +
  geom_boxplot() +
  facet_wrap(~ predicted.celltype.l2) +
  labs(x = "Clonotype bin", y = "pgen (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8))

plot

ggsave(plot, file = "../figures/expansion_vs_pgen.svg", height = 10)

```

# Test for TCR feature differences within each Seurat cluster

```{r}

cluster_feature_analysis <- combined_data %>%
  # look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  filter(group != "no ICI") %>%
  group_by(seurat_clusters) %>%
  summarize(
    p_val_pgen = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(pgen ~ group, exact = FALSE)$p.value
      }
    },
    p_val_cdr3_hydrophobicity = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
      }
    },
    p_val_cdr3_length = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
      }
    }
  ) %>%
  pivot_longer(cols = matches("^(p_val)")) %>%
  mutate(value = p.adjust(value, method = "BH")) %>%
  #filter(value < 0.05) %>%
  arrange(seurat_clusters) %>%
  rename(padj = value,
         feature = name) %>%
  mutate(feature = gsub("p_val_", "", feature))

cluster_feature_analysis

```

# Instead use SingleR (Dice ref) cell types for TCR feature analysis

```{r}

singler_dice_cell_types <- read.csv("../saved_data/singler_dice_ref_cell_typing.csv") %>%
  select(-X) %>%
  left_join(combined_data, by = "barcode") %>%
  filter(!(is.na(Chain)),
         !(is.na(pgen)),
         !(dice_singler_label %in% c("NK cells", "Monocytes, CD14+", "Monocytes, CD16+", "B cells, naive")))

singler_dice_cell_types

whole_analysis <- singler_dice_cell_types %>%
  filter(group %in% c("ICI colitis", "ICI no colitis")) %>%
  group_by(dice_singler_label, Chain) %>%
  summarize(
    p_val_pgen = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(pgen ~ group, exact = FALSE)$p.value
      }
    },
    p_val_cdr3_hydrophobicity = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
      }
    },
    p_val_cdr3_length = {
      if(length(unique(group)) != 2 | any(table(group) == 1)) {
        NA
      } else {
        wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
      }
    }
  ) %>%
  pivot_longer(cols = matches("^(p_val)")) %>%
  mutate(value = p.adjust(value, method = "BH")) %>%
  arrange(value) %>%
  filter(value < 0.05)

whole_analysis

```

# Prep data for summary plots (normalized method)

```{r}

prepped_data <- singler_dice_cell_types %>%
  filter(group != "no ICI") %>%
  # normalize by sequencing depth
  left_join(seq_depth, by = c("patient", "group")) %>%
  mutate(normalized_count = count / seq_depth) %>%
  # look at just unique clonotypes from each patient
  group_by(patient, clonotype, Chain) %>%
  dplyr::slice(1) %>%
  ungroup() %>%
  group_by(dice_singler_label, Chain) %>%
  arrange(-normalized_count) %>%
  mutate(chunk_size = ceiling(n() * 0.05),
         chunk = 5*ceiling(row_number() / chunk_size))

prepped_data

```

# Define test functions

```{r}

# Function to perform the test cumulativley up to a specific bin of clonotype abundances
perform_wilcox_test_cumulatively <- function(data, cutoff) {
  result <- data %>%
    filter(chunk <= cutoff) %>%
    group_by(dice_singler_label, Chain) %>%    
    summarize(
      p_val_pgen = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(pgen ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_hydrophobicity = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_hydrophobicity ~ group, exact = FALSE)$p.value
        }
      },
      p_val_cdr3_length = {
        if(length(unique(group)) != 2 | any(table(group) == 1)) {
          NA
        } else {
          wilcox.test(cdr3_length ~ group, exact = FALSE)$p.value
        }
      }
    ) %>%
    ungroup()
  
  return(result)
}

```

# Perform wilcox rank sum tests within chunks of 5% clonotypes (normalized method)

```{r}

# List to store results
results_list <- list()

# Iterate through chunk cutoffs
for (num in 1:5) {
  result <- prepped_data %>%
    perform_wilcox_test_cumulatively(cutoff = num*5)

  results_list[[as.character(num*5)]] <- result
}

# Combine results into a single dataframe
results_df <- bind_rows(results_list, .id = "Chunk")

results_df <- results_df %>%
  pivot_longer(cols = c("p_val_pgen", "p_val_cdr3_length", "p_val_cdr3_hydrophobicity"), names_to = "p_val") %>%
  rename(p_val_category = p_val) %>%
  mutate(p_val_category = gsub("p_val_", "", p_val_category)) %>%
  mutate(category = paste(dice_singler_label, Chain, p_val_category)) %>%
  # adjust pvals for multiple comparisons
  mutate(value = p.adjust(value, method = "BH")) %>%
  arrange(value)

results_df

```