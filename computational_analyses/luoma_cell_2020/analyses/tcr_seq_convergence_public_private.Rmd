---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(scales)
library(ggpubr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in final RNA T cell Seurat with TCR metadata

```{r}

combined_data <- read.csv("../saved_data/rna_tcr.csv") %>%
  filter(
    case_when(
      predicted.celltype.l1 == "CD4 T" & str_detect(predicted.celltype.l2, "CD4") | predicted.celltype.l2 == "Treg" ~ TRUE,
      predicted.celltype.l1 == "CD8 T" & str_detect(predicted.celltype.l2, "CD8") ~ TRUE,
      predicted.celltype.l1 == "other T" & predicted.celltype.l2 %in% c("MAIT", "dnT") ~ TRUE,
      TRUE ~ FALSE)) %>%
  pivot_longer(cols = matches("(TRA|TRB)$"),
               names_to = c(".value", "Chain"),
               names_pattern = "^(.*)_(TRA|TRB)$") %>%
  filter(!(is.na(v_gene)),
         !(is.na(d_gene)),
         !(is.na(j_gene)),
         !(is.na(c_gene)),
         !(is.na(cdr3))) %>%
  mutate(group = case_when(
    startsWith(patient, "CT") ~ "no ICI",
    startsWith(patient, "C") ~ "ICI colitis",
    startsWith(patient, "NC") ~ "ICI no colitis")) %>%
  rename(barcode = X)

combined_data

```

# Look at public vs. private

```{r}

public_df_list <- combined_data %>%
  group_by(cdr3) %>%
  filter(n_distinct(patient) > 1) %>%
  mutate(barc_chain = paste(barcode, Chain, sep = ""))

public_df_list

private_df_list <- combined_data %>%
  group_by(cdr3) %>%
  filter(n_distinct(patient) == 1) %>%
  mutate(barc_chain = paste(barcode, Chain, sep = "")) %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # exclude singletons
  filter(n() > 1)

private_df_list

```

# Look at TCR convergence

```{r}

convergence_within_patients <- combined_data %>%
  select(patient, barcode, Chain, cdr3, cdr3_nt, v_gene, d_gene, j_gene, c_gene) %>%
  group_by(cdr3, patient) %>%
  filter(n_distinct(cdr3_nt) > 1) %>%
  group_by(patient, cdr3, cdr3_nt) %>%
  summarize(count = n())

convergence_across_patients <- combined_data %>%
  group_by(cdr3) %>%
  mutate(distinct_cdr3_nt_count = n_distinct(cdr3_nt)) %>%
  filter(distinct_cdr3_nt_count > 1) %>%
  mutate(barc_chain = paste(barcode, Chain, sep = ""))

convergence_across_patients

# do see more convergence across patients as expected, and they are ~mostly in public TCRs also as expected

```

# Look at overlap between public and converged

```{r}

# Create a Venn diagram
#venn.plot <- venn.diagram(
#  x = list(A = public_df$barcode, B = convergence_df$barcode),
#  category.names = c("Public TCRs", "Converged TCRs"),
#  filename = NULL,
#  output = TRUE
#)

# Display the Venn diagram
#grid.draw(venn.plot)

```

# Contingency tables for publicity, privicity, convergence for TRA/TRB comparing irAE groups

```{r}

convergence_publicity_privicity_df <- combined_data %>%
  mutate(barc_chain = paste(barcode, Chain, sep = "")) %>%
  mutate(publicity = if_else(barc_chain %in% public_df_list$barc_chain, "Yes", "No"),
         privicity = if_else(barc_chain %in% private_df_list$barc_chain, "Yes", "No"),
         convergence = if_else(barc_chain %in% convergence_across_patients$barc_chain, "Yes", "No")) %>%
  # get expansion col for later use
  pivot_wider(id_cols = c(barcode, patient, group, predicted.celltype.l1, predicted.celltype.l2, publicity, privicity, convergence), names_from = "Chain", values_from = c("v_gene", "d_gene", "j_gene", "c_gene", "cdr3")) %>%
  filter(!(is.na(v_gene_TRA)),
         !(is.na(j_gene_TRA)),
         !(is.na(cdr3_TRA)),
         !(is.na(v_gene_TRB)),
         !(is.na(j_gene_TRB)),
         !(is.na(cdr3_TRB))) %>%
  mutate(clonotype = paste(v_gene_TRA, v_gene_TRB, j_gene_TRA, j_gene_TRB, cdr3_TRA, cdr3_TRB, sep = "_")) %>%
  group_by(patient, clonotype) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  pivot_longer(cols = matches("(TRA|TRB)$"),
               names_to = c(".value", "Chain"),
               names_pattern = "^(.*)_(TRA|TRB)$") %>%
  group_by(patient, cdr3, Chain, v_gene, j_gene) %>%
  # look at just unique clonotypes from each patient
  dplyr::slice(1)

write.csv(convergence_publicity_privicity_df, "../saved_data/converged_public_private_tcrs.csv")

convergence_publicity_privicity_df

public_counts <- convergence_publicity_privicity_df %>%
  filter(group != "no ICI") %>%
  group_by(publicity, group, predicted.celltype.l2, Chain) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(publicity, Chain, predicted.celltype.l2) %>%
  mutate(fraction = count/sum(count))

public_counts

public_counts$group <- factor(public_counts$group, levels = c("ICI no colitis", "ICI colitis"))

plot <- ggplot(public_counts, aes(x = publicity, y = fraction, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Chain + predicted.celltype.l2) +
  labs(x = "Publicity", y = "Fraction") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.5))

ggsave("../figures/publicity.svg", plot, device = "svg")

private_counts <- convergence_publicity_privicity_df %>%
  filter(group != "no ICI") %>%
  group_by(privicity, group, predicted.celltype.l2, Chain) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(privicity, Chain, predicted.celltype.l2) %>%
  mutate(fraction = count/sum(count))

private_counts$group <- factor(private_counts$group, levels = c("ICI no colitis", "ICI colitis"))

private_counts

plot <- ggplot(private_counts, aes(x = privicity, y = fraction, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Chain + predicted.celltype.l2) +
  labs(x = "Privicity", y = "Fraction") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.5))

ggsave("../figures/privicity.svg", plot, device = "svg")

convergence_counts <- convergence_publicity_privicity_df %>%
  filter(group != "no ICI") %>%
  group_by(convergence, group, Chain, predicted.celltype.l2) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(convergence, Chain, predicted.celltype.l2) %>%
  mutate(fraction = count/sum(count))

convergence_counts

convergence_counts$group <- factor(convergence_counts$group, levels = c("ICI no colitis", "ICI colitis"))

plot <- ggplot(convergence_counts, aes(x = convergence, y = fraction, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Chain + predicted.celltype.l2) +
  labs(x = "Converged", y = "Fraction") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.5))

ggsave("../figures/convergence.svg", plot, device = "svg")

```

# Facet convergence contingency tables by expansion

```{r}

expanded_convergence_counts <- convergence_publicity_privicity_df %>%
  filter(group != "no ICI") %>%
  arrange(-count) %>%
  # look at top 10% expansion of each cell type
  group_by(predicted.celltype.l2) %>%
  dplyr::slice(1:ceiling(0.1 * n())) %>%
  ungroup() %>%
  group_by(convergence, group, Chain, predicted.celltype.l2) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(convergence, Chain, predicted.celltype.l2) %>%
  mutate(fraction = count/sum(count))

expanded_convergence_counts

expanded_convergence_counts$group <- factor(expanded_convergence_counts$group, levels = c("ICI no colitis", "ICI colitis"))

plot <- ggplot(expanded_convergence_counts, aes(x = convergence, y = fraction, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Chain + predicted.celltype.l2) +
  labs(x = "Converged", y = "Fraction") +
  scale_y_continuous(breaks = seq(0, 1, by = 0.5))

ggsave("../figures/expanded_convergence.svg", plot, device = "svg")

```

# Fischers test for convergnece, privicity, publicity

```{r}

fischer <- convergence_publicity_privicity_df %>%
  ungroup() %>%
  filter(predicted.celltype.l2 == "CD4 Naive" & Chain == "TRB") %>%
  group_by(predicted.celltype.l2, Chain) %>% summarize(p_val_convergence = fisher.test(table(fischer$group, fischer$convergence), simulate.p.value = TRUE)$p.val)

fischer

# Create a contingency table
#data <- matrix(c(14, 56, 2, 1), nrow = 2)
#colnames(data) <- c("Not converged", "Converged")
#rownames(data) <- c("ICI colitis", "ICI no colitis")

#print(data)

# Perform Fisher's exact test
#print(fisher.test(data))

```

# Filter public, private, converged dfs for TRA/TRB to simplify downstream analysis

```{r}

public_df_list_tra <- public_df_list %>% filter(Chain == "TRA")

public_df_list_trb <- public_df_list %>% filter(Chain == "TRB")

private_df_list_tra <- private_df_list %>% filter(Chain == "TRA")

private_df_list_trb <- private_df_list %>% filter(Chain == "TRB")

convergence_across_patients_tra <- convergence_across_patients %>% filter(Chain == "TRA")

convergence_across_patients_trb <- convergence_across_patients %>% filter(Chain == "TRB")

```

# Read in T cells RDS

```{r}

T_cells <- readRDS("../saved_data/T_cells.rds")

```

# Overlay convergence, publicity, privicity onto UMAP for TRA

```{r}

metadata <- T_cells@meta.data
  
metadata$barcode <- rownames(metadata)

metadata <- metadata %>%
  mutate(publicity_tra = if_else(barcode %in% public_df_list_tra$barcode, "Yes", "No"),
         privicity_tra = if_else(barcode %in% private_df_list_tra$barcode, "Yes", "No"),
         convergence_tra = if_else(barcode %in% convergence_across_patients_tra$barcode, "Yes", "No"))

T_cells$publicity_tra <- metadata$publicity_tra
T_cells$privicity_tra <- metadata$privicity_tra
T_cells$convergence_tra <- metadata$convergence_tra

DimPlot(T_cells, reduction = "umap", group.by = "publicity_tra", shuffle = TRUE, seed = 123)

DimPlot(T_cells, reduction = "umap", group.by = "privicity_tra", shuffle = TRUE, seed = 123)

DimPlot(T_cells, reduction = "umap", group.by = "convergence_tra", shuffle = TRUE, seed = 123)

```

# Overlay convergence, publicity, privicity onto UMAP for TRB

```{r}

metadata <- T_cells@meta.data
  
metadata$barcode <- rownames(metadata)

metadata <- metadata %>%
  mutate(publicity_trb = if_else(barcode %in% public_df_list_trb$barcode, "Yes", "No"),
         privicity_trb = if_else(barcode %in% private_df_list_trb$barcode, "Yes", "No"),
         convergence_trb = if_else(barcode %in% convergence_across_patients_trb$barcode, "Yes", "No"))

T_cells$publicity_trb <- metadata$publicity_trb
T_cells$privicity_trb <- metadata$privicity_trb
T_cells$convergence_trb <- metadata$convergence_trb

DimPlot(T_cells, reduction = "umap", group.by = "publicity_trb", shuffle = TRUE, seed = 123)

DimPlot(T_cells, reduction = "umap", group.by = "privicity_trb", shuffle = TRUE, seed = 123)

DimPlot(T_cells, reduction = "umap", group.by = "convergence_trb", shuffle = TRUE, seed = 123)

```