---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(tcrGraph)
library(tidyverse)
library(igraph)
library(graphlayouts)
library(ggraph)
library(viridis)
library(gridExtra)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Make highly expanded TCR df

```{r}

tcrs <- read.csv("../saved_data/tcr_graph_input.csv") %>%
  dplyr::select(-X) %>%
  mutate(clonotype = paste(v_gene, j_gene, cdr3, sep = "_")) %>%
  group_by(patient, clonotype, chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  # look at highly expanded per patient
  group_by(patient, chain) %>%
  arrange(-count) %>%
  dplyr::slice_head(n = 350) %>%
  ungroup() %>%
  dplyr::rename(libid = barcode) %>%
  mutate(id = paste(libid, chain, cdr3, sep = "_"))

tcrs

converged_tcrs <- tcrs %>%
  group_by(cdr3) %>%
  mutate(distinct_cdr3_nt_count = n_distinct(cdr3_nt)) %>%
  filter(distinct_cdr3_nt_count > 1) %>%
  mutate(id = paste(libid, chain, cdr3, sep = "_"))

converged_tcrs

```

# Make TCR graph with Igraph: no irAE

```{r}

no_irae_tcrs <- tcrs %>%
  filter(group == "ICI no colitis") %>%
  # exclude singletons
  group_by(libid) %>%
  filter(n() > 1) %>%
  ungroup()

no_irae_tcr_graph <- makeTcrGraph(no_irae_tcrs, link = "nt")

no_irae_tcr_igraph <- tcrGraphToIgraph(no_irae_tcr_graph)

V(no_irae_tcr_igraph)$`Number of Cells` <- V(no_irae_tcr_igraph)$value
V(no_irae_tcr_igraph)$Chain <- V(no_irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(no_irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("no irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(no_irae_tcr_igraph)
num_vertices <- vcount(no_irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (no irAE):", average_connectivity, "\n")
cat("Number of Edges (no irAE):", num_edges, "\n")
cat("Number of Vertices (no irAE):", num_vertices, "\n")

```

# Make TCR graph with Igraph: yes irAE

```{r}

irae_tcrs <- tcrs %>%
  filter(group == "ICI colitis") %>%
  # exclude singletons
  group_by(libid) %>%
  filter(n() > 1) %>%
  ungroup()

irae_tcr_graph <- makeTcrGraph(irae_tcrs, link = "nt")

irae_tcr_igraph <- tcrGraphToIgraph(irae_tcr_graph)

V(irae_tcr_igraph)$`Number of Cells` <- V(irae_tcr_igraph)$value
V(irae_tcr_igraph)$Chain <- V(irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(irae_tcr_igraph)
num_vertices <- vcount(irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (irAE):", average_connectivity, "\n")
cat("Number of Edges (irAE):", num_edges, "\n")
cat("Number of Vertices (irAE):", num_vertices, "\n")

```

# Find nodes in connected structures (irAE)

```{r}

irae_connected_nodes <- irae_tcr_graph$edges %>%
  group_by(from) %>%
  filter(n() > 1) %>%
  slice(1) %>%
  select(from)

irae_connected_nodes

irae_connected_node_info <- irae_tcr_graph$nodes %>%
  filter(id %in% irae_connected_nodes$from)

irae_connected_node_info

```

# Remake graph with just connected structures (irAE) to test filtering

```{r}

connected_irae_tcrs <- tcrs %>%
  filter(nt %in% irae_connected_node_info$nt)

connected_irae_tcr_graph <- makeTcrGraph(connected_irae_tcrs, link = "nt")

connected_irae_tcr_igraph <- tcrGraphToIgraph(connected_irae_tcr_graph)

V(connected_irae_tcr_igraph)$`Number of Cells` <- V(connected_irae_tcr_igraph)$value
V(connected_irae_tcr_igraph)$Chain <- V(connected_irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(connected_irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("Connected irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(connected_irae_tcr_igraph)
num_vertices <- vcount(connected_irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (irAE):", average_connectivity, "\n")
cat("Number of Edges (irAE):", num_edges, "\n")
cat("Number of Vertices (irAE):", num_vertices, "\n")

```

# Find nodes in connected structures (no irAE)

```{r}

no_irae_connected_nodes <- no_irae_tcr_graph$edges %>%
  group_by(from) %>%
  filter(n() > 1) %>%
  slice(1) %>%
  select(from)

no_irae_connected_nodes

no_irae_connected_node_info <- no_irae_tcr_graph$nodes %>%
  filter(id %in% no_irae_connected_nodes$from)

no_irae_connected_node_info

```

# Remake graph with just connected structures (no irAE) to test filtering

```{r}

connected_no_irae_tcrs <- tcrs %>%
  filter(nt %in% no_irae_connected_node_info$nt)

connected_no_irae_tcr_graph <- makeTcrGraph(connected_no_irae_tcrs, link = "nt")

connected_no_irae_tcr_igraph <- tcrGraphToIgraph(connected_no_irae_tcr_graph)

V(connected_no_irae_tcr_igraph)$`Number of Cells` <- V(connected_no_irae_tcr_igraph)$value
V(connected_no_irae_tcr_igraph)$Chain <- V(connected_no_irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(connected_no_irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("Connected no irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(connected_no_irae_tcr_igraph)
num_vertices <- vcount(connected_no_irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (no irAE):", average_connectivity, "\n")
cat("Number of Edges (no irAE):", num_edges, "\n")
cat("Number of Vertices (no irAE):", num_vertices, "\n")

```

# Compare convergence frequencies in connected vs. all TCRs

```{r}

connected_irae_tcrs %>%
  mutate(id = paste(libid, chain, cdr3, sep = "_"),
         converged = if_else(id %in% converged_tcrs$id, "Converged", "Not converged")) %>%
  summarize(convergence_freq = sum(converged == "Converged") / n())

connected_no_irae_tcrs %>%
  mutate(id = paste(libid, chain, cdr3, sep = "_"),
         converged = if_else(id %in% converged_tcrs$id, "Converged", "Not converged")) %>%
  summarize(convergence_freq = sum(converged == "Converged") / n())

tcrs %>%
  mutate(id = paste(libid, chain, cdr3, sep = "_"),
         converged = if_else(id %in% converged_tcrs$id, "Converged", "Not converged")) %>%
  summarize(convergence_freq = sum(converged == "Converged") / n())

```