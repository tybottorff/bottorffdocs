---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(stringr)
library(tidyr)
library(tcrGraph)
library(tidyverse)
library(igraph)
library(graphlayouts)
library(ggraph)
library(viridis)
library(gridExtra)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Make highly expanded TCR df

```{r}

tcrs <- read.csv("../saved_data/tcr_graph_input.csv") %>%
  dplyr::select(-X) %>%
  mutate(clonotype = paste(v_gene, j_gene, cdr3, sep = "_")) %>%
  group_by(patient, clonotype, chain) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  # look at highly expanded per patient
  group_by(patient, chain) %>%
  arrange(-count) %>%
  dplyr::slice_head(n = 350) %>%
  ungroup() %>%
  dplyr::rename(libid = barcode)

tcrs

```

# Make TCR graph with Igraph: no irAE

```{r}

no_irae_tcrs <- tcrs %>%
  filter(group == "ICI no colitis")

no_irae_tcr_graph <- makeTcrGraph(no_irae_tcrs, link = "nt")

no_irae_tcr_igraph <- tcrGraphToIgraph(no_irae_tcr_graph)

V(no_irae_tcr_igraph)$`Number of Cells` <- V(no_irae_tcr_igraph)$value
V(no_irae_tcr_igraph)$Chain <- V(no_irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(no_irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("no irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(no_irae_tcr_igraph)
num_vertices <- vcount(no_irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (no irAE):", average_connectivity, "\n")
cat("Number of Edges (no irAE):", num_edges, "\n")
cat("Number of Vertices (no irAE):", num_vertices, "\n")

```

# # Make TCR graph with Igraph: yes irAE

```{r}

irae_tcrs <- tcrs %>%
  filter(group == "ICI colitis")

irae_tcr_graph <- makeTcrGraph(irae_tcrs, link = "nt")

irae_tcr_igraph <- tcrGraphToIgraph(irae_tcr_graph)

V(irae_tcr_igraph)$`Number of Cells` <- V(irae_tcr_igraph)$value
V(irae_tcr_igraph)$Chain <- V(irae_tcr_igraph)$group

dev.new(width = 9.5, length = 8)
theme_set(theme_bw(20) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.key = element_blank()))
ggraph(irae_tcr_igraph, "fr") +
    geom_edge_link(
        edge_width = 1,
        #edge_color = edgeColor
    ) +
    geom_node_point(
        aes(fill = Chain, size = `Number of Cells`),
        shape = 21,
        color = "black"
    ) +
    #scale_fill_manual(values = nodePalette) +
    guides(fill = guide_legend(override.aes = list(size = 5))) +
    ggtitle("irAE TCRs")

# Compute the average connectivity
num_edges <- ecount(irae_tcr_igraph)
num_vertices <- vcount(irae_tcr_igraph)
average_connectivity <- 2 * num_edges / num_vertices

# Print the results
cat("Average Connectivity (irAE):", average_connectivity, "\n")
cat("Number of Edges (irAE):", num_edges, "\n")
cat("Number of Vertices (irAE):", num_vertices, "\n")

```

# Compute stats for irAE TCRs

```{r}

# Compute the average connectivity
num_edges <- ecount(irae_tcr_graph)
num_vertices <- vcount(irae_tcr_graph)
average_connectivity <- 2 * num_edges / num_vertices

# Other statistics
num_edges
num_vertices

# Print the results
cat("Average Connectivity:", average_connectivity, "\n")
cat("Number of Edges:", num_edges, "\n")
cat("Number of Vertices:", num_vertices, "\n")

```