---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: pdf_document
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(Matrix)
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

melanoma_T_cells_filtered <- readRDS("../saved_data/batch_a_filtered.rds")

```

# Split data by sample, prepare (normalize, find variable features, etc.) before integrating by finding anchors

```{r}

# split the dataset into a list of seurat objects (for each patient sample)
melanoma_T_cells_filtered.list <- SplitObject(melanoma_T_cells_filtered, split.by = "patient.ID")

# normalize and identify variable features for each dataset independently
melanoma_T_cells_filtered.list <- lapply(X = melanoma_T_cells_filtered.list, FUN = SCTransform, method = "glmGamPoi")

```

# Find integration features

```{r}

# select features that are repeatedly variable across datasets for integration
features <- SelectIntegrationFeatures(object.list = melanoma_T_cells_filtered.list, nfeatures = 3000)

# prep step
melanoma_T_cells_filtered.list <- PrepSCTIntegration(object.list = melanoma_T_cells_filtered.list, anchor.features = features)

# run PCA to allow rpca use later
melanoma_T_cells_filtered.list <- lapply(X = melanoma_T_cells_filtered.list, FUN = RunPCA, features = features)

```

# Randomly select a single sample per group to use as a reference

```{r}

# Set a random seed for reproducibility
set.seed(123)

metadata <- melanoma_T_cells_filtered@meta.data %>%
  group_by(patient.ID, `Severe.irAE.status..1.Yes..0.No.`) %>%
  slice(1) %>%
  select(patient.ID, `Severe.irAE.status..1.Yes..0.No.`) %>%
  rename(irAE = `Severe.irAE.status..1.Yes..0.No.`)

# Randomly sample one Seurat object from each irAE group

randomly_selected_seurat <- metadata %>%
  group_by(irAE) %>%
  sample_n(1) %>%
  ungroup()

randomly_selected_seurat

```

# Find integration anchors using the above single sample/group as references

```{r}

# first integrates these references, then aligns other samples within each group to that integrated reference
# this command creates an 'integrated' data assay

immune.anchors <- FindIntegrationAnchors(object.list = melanoma_T_cells_filtered.list, reference = which(names(melanoma_T_cells_filtered.list) %in% randomly_selected_seurat$patient.ID), normalization.method = "SCT", anchor.features = features, reduction = "rpca", k.anchor = 10, dims = 1:30)

```

# Integrate the data

```{r}

immune.combined <- IntegrateData(anchorset = immune.anchors, normalization.method = "SCT")

```

# Save RDS

```{r}

saveRDS(immune.combined, "../saved_data/integrated.rds")

```

# Specify integration, scale data

```{r}

# specify that we will perform downstream analysis on the corrected data note that the
# original unmodified data still resides in the 'RNA' assay
DefaultAssay(immune.combined) <- "integrated"

# scale data
immune.combined <- ScaleData(immune.combined, verbose = FALSE)

```

# Do dimensional reduction, clustering

```{r}

immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)
immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 3)

```

# Read in reference to use for mapping

```{r}

reference <- LoadH5Seurat("../../pbmc_multimodal.h5seurat")

```

# Find reference transfer anchors

```{r}

anchors <- FindTransferAnchors(
  reference = reference,
  query = immune.combined,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

```

# Map reference onto my object

```{r}

immune.combined <- MapQuery(
  anchorset = anchors,
  query = immune.combined,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca",
  reduction.model = "wnn.umap"
)

```

# Plot mapping results and save rds of T cells

```{r}

p1 = DimPlot(immune.combined, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(immune.combined, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

just_T_cells <- immune.combined[, immune.combined@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & immune.combined@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

saveRDS(just_T_cells, "../saved_data/first_pass_reference_mapped.rds")

```

# Re-look at just T cells

 - this doesn't work currently I think due to having subsetted and using Seurat v5

```{r}

just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
just_T_cells <- RunUMAP(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindNeighbors(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindClusters(just_T_cells, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50,
  recompute.residuals = FALSE
)
just_T_cells <- MapQuery(
  anchorset = anchors,
  query = just_T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Look for EOMES, TIGIT+KLRG1+ signatures by irAE group within CD8s

```{r}

non_naive_cd8s <- subset(just_T_cells, subset = predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 %in% c("CD8 TEM", "CD8 TCM", "CD8 Proliferating"))

VlnPlot(non_naive_cd8s, features = c("TIGIT", "KLRG1", "EOMES"), group.by = "Severe.irAE.status..1.Yes..0.No.", pt.size = 0)

```