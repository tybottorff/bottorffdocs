---
title: "Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy"
output: pdf_document
---

 - data mining of https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7415717/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(scales)
library(Seurat)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

feature_df <- read.csv("../saved_data/rna_tcr_no_na_good_cell_typing.csv") %>%
  mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(25, 27), "CD4 Trm", if_else(seurat_clusters %in% c(3, 7, 9, 15, 16), "CD8 Trm", predicted.celltype.l2)))

feature_df

```

# Read in data for UMAP contour plot

```{r}

seurat_obj <- readRDS("../saved_data/T_cells.rds")

new_meta <- seurat_obj@meta.data %>%
  mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(25, 27), "CD4 Trm", if_else(seurat_clusters %in% c(3, 7, 9, 15, 16), "CD8 Trm", predicted.celltype.l2)))

seurat_obj$predicted.celltype.l2 <- new_meta$predicted.celltype.l2

downsampled_df <- read.csv("../saved_data/downsampled_df.csv")

downsampled_seurat <- subset(seurat_obj, cells = downsampled_df$barcode)

```

# Make UMAP contour plot (only for downsampled, too crowded otherwise)

```{r}

DimPlot(downsampled_seurat, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE)

data <- Embeddings(object = downsampled_seurat[["umap"]])[(colnames(downsampled_seurat)), c(1, 2)]
data <- as.data.frame(data)
data$celltype <- downsampled_seurat@meta.data$predicted.celltype.l2
data$patient_ID <- downsampled_seurat@meta.data$orig.ident

data <- data %>%
  filter(!(grepl("^CT", patient_ID))) %>%
  filter(celltype %in% c("CD4 Proliferating")) %>%
  mutate(irAE = if_else(grepl("^NC", patient_ID), "no colitis", "colitis"))

data$irAE <- factor(data$irAE, levels = c("no colitis", "colitis"))

ggplot(data) +
  geom_point(aes(x=umap_1, y=umap_2, color=celltype), show.legend = TRUE, size = 0.01) +
  facet_wrap(~ irAE) +
  geom_density2d(aes(x=umap_1, y=umap_2)) +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14))

```

# Make a plot of cell type abundances within each patient by irAE group (normalized by seq depth)

```{r}

cell_abundance_df <- feature_df %>%
  group_by(patient, predicted.celltype.l2, group) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  group_by(patient) %>%
  mutate(normalized_count = count / sum(count)) %>%
  # filter for just subtypes of interest
  filter(predicted.celltype.l2 %in% c("CD4 Proliferating", "CD8 Proliferating", "CD8 Trm", "CD4 Trm", "CD4 TEM", "CD4 TCM", "CD8 TEM", "CD8 TCM", "CD4 Naive", "CD8 Naive"),
         group != "no ICI")

cell_abundance_df

cell_abundance_df$group <- factor(cell_abundance_df$group, levels = c("no ICI", "ICI no colitis", "ICI colitis"))

ggplot(cell_abundance_df, aes(x = predicted.celltype.l2, y = log10(normalized_count), fill = group)) +
  geom_boxplot() +
  labs(x = "", fill = "group", y = "T cell proportion\n(log10)") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

ggplot(cell_abundance_df, aes(x = patient, y = log10(normalized_count), color = group)) +
  geom_point() +
  facet_wrap(~predicted.celltype.l2, ncol = 2) +
  labs(x = "", fill = "group", y = "T cell proportion\n(log10)") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3)) +
  theme(axis.text.x = element_blank())

# padj
# CD4 Proliferating: 0.00865800

```

# Make a plot of cell type abundances within each patient by irAE group (downsampled)

```{r}

cell_abundance_df_downsampled <- downsampled_df %>%
  group_by(patient, predicted.celltype.l2, group) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  # filter for just subtypes of interest
  filter(predicted.celltype.l2 %in% c("CD4 Proliferating"),
         group != "no ICI")

cell_abundance_df_downsampled

cell_abundance_df_downsampled$group <- factor(cell_abundance_df_downsampled$group, levels = c("no ICI", "ICI no colitis", "ICI colitis"))

ggplot(cell_abundance_df_downsampled, aes(x = predicted.celltype.l2, y = log10(count), fill = group)) +
  geom_boxplot() +
  labs(x = "", fill = "group", y = "Cell counts\n(log10)") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

ggplot(cell_abundance_df_downsampled, aes(x = patient, y = log10(count), color = group)) +
  geom_point() +
  facet_wrap(~predicted.celltype.l2, ncol = 2) +
  labs(x = "", fill = "group", y = "Cell counts\n(log10)") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.5)), breaks = pretty_breaks(n = 3)) +
  theme(axis.text.x = element_blank())

```