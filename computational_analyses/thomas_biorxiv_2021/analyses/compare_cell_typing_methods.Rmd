---
title: "Thomas bioRxiv"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(Matrix)
library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(circlize)
library(vegan)
library(scales)
library(SeuratData)
library(SeuratDisk)
library(SingleR)
library(SingleCellExperiment)
library(EnsDb.Hsapiens.v86)
library(celldex)
library(networkD3)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

rna <- readRDS("../saved_data/T_cells.rds")

rna

```

# Import reference datasets

```{r}

# hpca (primary cell atlas, microarray)
# 713 microarray samples from the Human Primary Cell Atlas
hpca <- HumanPrimaryCellAtlasData(
      ensembl = FALSE,
      cell.ont = c("all", "nonna", "none")
)

# blueprint encode (RNAseq)
# 259 RNA-seq samples of pure stroma and immune cells
blueprint <- BlueprintEncodeData(
      rm.NA = c("rows", "cols", "both", "none"),
      ensembl = FALSE,
      cell.ont = c("all", "nonna", "none"))

# normalized expression values of 1561 bulk RNA-seq samples generated by DICE from pure populations of human immune cells
dice <- DatabaseImmuneCellExpressionData(
      ensembl = FALSE,
      cell.ont = c("all", "nonna", "none")
)

```

# Get Seurat assay data

```{r}

test_assay <- GetAssayData(rna@assays$SCT)

test_assay

```

# Map cells to HPCA

```{r}

pred.hpca <- SingleR(test = test_assay, ref = hpca, assay.type.test=1,
    labels = hpca$label.fine)

```

# Inspect mapping from HPCA

```{r}

hpca_mapping <- as_tibble(pred.hpca)

hpca_mapping$barcode <- rownames(pred.hpca)

hpca_mapping <- hpca_mapping %>%
  dplyr::select(barcode, labels) %>%
  dplyr::rename(hpca_singler_label = labels) %>%
  mutate(hpca_singler_label = case_when(
    hpca_singler_label == "T_cell:CD8+" ~ "CD8 T",
    hpca_singler_label == "T_cell:CD8+_naive" ~ "CD8 Naive",
    hpca_singler_label == "T_cell:CD8+_Central_memory" ~ "CD8 TCM",
    hpca_singler_label == "T_cell:CD8+_effector_memory" ~ "CD8 TEM",
    hpca_singler_label == "T_cell:CD8+_effector_memory_RA" ~ "CD8 TEMRA",
    hpca_singler_label == "T_cell:CD4+" ~ "CD4 T",
    hpca_singler_label == "T_cell:CD4+_Naive" ~ "CD4 Naive",
    hpca_singler_label == "T_cell:CD4+_central_memory" ~ "CD4 TCM",
    hpca_singler_label == "T_cell:CD4+_effector_memory" ~ "CD4 TEM",
    hpca_singler_label == "T_cell:Treg:Naive" ~ "Treg",
    hpca_singler_label == "NK_cell" ~ "NK cells",
    TRUE ~ hpca_singler_label  # Keep other values unchanged
  ))

hpca_mapping

```

# Map cells to blueprint

```{r}

pred.blueprint <- SingleR(test = test_assay, ref = blueprint, assay.type.test=1,
    labels = blueprint$label.fine)

```

# Inspect mapping from blueprint

```{r}

blueprint_mapping <- as_tibble(pred.blueprint)

blueprint_mapping$barcode <- rownames(pred.blueprint)

blueprint_mapping <- blueprint_mapping %>%
  dplyr::select(barcode, labels) %>%
  dplyr::rename(blueprint_singler_label = labels) %>%
  mutate(blueprint_singler_label = case_when(
    blueprint_singler_label == "CD8+ Tcm" ~ "CD8 TCM",
    blueprint_singler_label == "CD4+ Tcm" ~ "CD4 TCM",
    blueprint_singler_label == "CD8+ Tem" ~ "CD8 TEM",
    blueprint_singler_label == "CD4+ Tem" ~ "CD4 TEM",
    blueprint_singler_label == "CD8+ T-cells" ~ "CD8 T",
    blueprint_singler_label == "CD4+ T-cells" ~ "CD4 T",
    TRUE ~ blueprint_singler_label  # Keep other values unchanged
  ))

blueprint_mapping

```

# Map cells to dice, inspect mapping

```{r}

pred.dice <- SingleR(test = test_assay, ref = dice, assay.type.test=1,
    labels = dice$label.fine)

# Inspect mapping from dice

dice_mapping <- as_tibble(pred.dice)

dice_mapping$barcode <- rownames(pred.dice)

dice_mapping <- dice_mapping %>%
  dplyr::select(barcode, labels) %>%
  dplyr::rename(dice_singler_label = labels) %>%
  mutate(dice_singler_label = case_when(
    dice_singler_label == "T cells, CD4+, naive" ~ "CD4 Naive",
    dice_singler_label == "T cells, CD8+, naive" ~ "CD8 Naive",
    TRUE ~ dice_singler_label  # Keep other values unchanged
  ))
  
dice_mapping

```

# Export dice mapping results (contains Th subsets)

```{r}

write.csv(dice_mapping, "../saved_data/singler_dice_ref_cell_typing.csv")

```

# Join mapping results to compare by barcode

```{r}

seurat_mapping <- as_tibble(rna@meta.data)

seurat_mapping$barcode <- rownames(rna@meta.data)

seurat_mapping <- seurat_mapping %>%
  #mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD4 T", "CD4 Trm", if_else(seurat_clusters %in% c(3, 7, 9, 15, 16, 25, 27) & predicted.celltype.l1 == "CD8 T", "CD8 Trm", predicted.celltype.l2)))
  dplyr::select(barcode, predicted.celltype.l2) %>%
  dplyr::rename(seurat_label = predicted.celltype.l2)

mapping_results <- hpca_mapping %>%
  full_join(blueprint_mapping, by = "barcode") %>%
  full_join(seurat_mapping, by = "barcode") %>%
  full_join(dice_mapping, by = "barcode")

mapping_summary <- mapping_results %>%
  group_by(hpca_singler_label, blueprint_singler_label, dice_singler_label, seurat_label) %>%
  summarize(count = n()) %>%
  arrange(-count)

mapping_summary

```

# Count perfect, ok, and bad matches

```{r}

all_agree <- mapping_results %>%
  dplyr::filter(hpca_singler_label == blueprint_singler_label & hpca_singler_label == seurat_label & hpca_singler_label == dice_singler_label)
  # 0

non_dice_agree <- mapping_results %>%
  dplyr::filter(hpca_singler_label == blueprint_singler_label & hpca_singler_label == seurat_label & hpca_singler_label != dice_singler_label)
  # 7298

non_seurat_agree <- mapping_results %>%
  dplyr::filter(hpca_singler_label == blueprint_singler_label & hpca_singler_label != seurat_label & hpca_singler_label == dice_singler_label)
  # 1161

non_blue_agree <- mapping_results %>%
  dplyr::filter(hpca_singler_label != blueprint_singler_label & hpca_singler_label == seurat_label & hpca_singler_label == dice_singler_label)
  # 153

non_hpca_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label == seurat_label & blueprint_singler_label == dice_singler_label)
  # 0

dice_and_blue_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label != seurat_label & blueprint_singler_label == dice_singler_label & seurat_label != hpca_singler_label & seurat_label != dice_singler_label & hpca_singler_label != dice_singler_label)
# 646

dice_and_seurat_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label != seurat_label & blueprint_singler_label != dice_singler_label & seurat_label != hpca_singler_label & seurat_label == dice_singler_label & hpca_singler_label != dice_singler_label)
# 464

dice_and_hpca_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label != seurat_label & blueprint_singler_label != dice_singler_label & seurat_label != hpca_singler_label & seurat_label != dice_singler_label & hpca_singler_label == dice_singler_label)
# 1954

blue_and_seurat_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label == seurat_label & blueprint_singler_label != dice_singler_label & seurat_label != hpca_singler_label & seurat_label != dice_singler_label & hpca_singler_label != dice_singler_label)
# 12370

blue_and_hpca_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label == hpca_singler_label & blueprint_singler_label != seurat_label & blueprint_singler_label != dice_singler_label & seurat_label != hpca_singler_label & seurat_label != dice_singler_label & hpca_singler_label != dice_singler_label)
# 4972

hpca_and_seurat_agree <- mapping_results %>%
  dplyr::filter(blueprint_singler_label != hpca_singler_label & blueprint_singler_label != seurat_label & blueprint_singler_label != dice_singler_label & seurat_label == hpca_singler_label & seurat_label != dice_singler_label & hpca_singler_label != dice_singler_label)
# 6344

# 51396 cells
# all 4 methods agree: 0
# 3/4 methods agree: 8612
# 2/4 methods agree: 26750
# all 4 methods different: 16034

```

# Write object to use for unicell deconvolve (in python)

```{r}

rna.sce <- as.SingleCellExperiment(CreateSeuratObject(rna@assays$SCT))

sceasy::convertFormat(rna.sce, from="sce", to="anndata",
                       outFile='../saved_data/t_cells_rna.h5ad')

```