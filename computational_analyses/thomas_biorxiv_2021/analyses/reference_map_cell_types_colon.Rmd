---
title: "Molly Fisher Thomas colitis data"
output: pdf_document
---

 - data mining of https://villani.mgh.harvard.edu/ircolitis/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(SeuratDisk)
library(Matrix)
library(ggplot2)
library(dplyr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in RDS of QC filtered data

```{r}

immune.combined <- readRDS("../saved_data/integrated_transformed_reduced_clustered.rds")

```

# Read in reference to use for mapping

```{r}

reference <- LoadH5Seurat("../../pbmc_multimodal.h5seurat")

```

# Plot reference UMAP

```{r}

DimPlot(object = reference, reduction = "umap", group.by = "celltype.l2", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

```

# Find reference transfer anchors

```{r}

anchors <- FindTransferAnchors(
  reference = reference,
  query = immune.combined,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50
)

```

# Map reference onto my object

```{r}

immune.combined <- MapQuery(
  anchorset = anchors,
  query = immune.combined,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

```

# Plot mapping results

```{r}

p1 = DimPlot(immune.combined, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(immune.combined, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Look at just T cells

```{r}

just_T_cells <- just_T_cells[, just_T_cells@meta.data$predicted.celltype.l1 %in% c("CD4 T", "CD8 T", "other T") & just_T_cells@meta.data$predicted.celltype.l2 %in% c("CD8 TEM", "CD4 TEM", "CD8 TCM", "CD4 TCM", "Treg", "CD4 Naive", "CD8 Naive",  "dnT", "CD4 Proliferating", "CD8 Proliferating", "MAIT", "CD4 CTL", "CD8 CTL")]

```

# Iterate through more T cell filtering

```{r}

just_T_cells <- RunPCA(just_T_cells, npcs = 30, verbose = FALSE)
just_T_cells <- RunUMAP(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindNeighbors(just_T_cells, reduction = "pca", dims = 1:30)
just_T_cells <- FindClusters(just_T_cells, resolution = 3)
anchors <- FindTransferAnchors(
  reference = reference,
  query = just_T_cells,
  normalization.method = "SCT",
  reference.reduction = "pca",
  dims = 1:50,
  recompute.residuals = FALSE
)
just_T_cells <- MapQuery(
  anchorset = anchors,
  query = just_T_cells,
  reference = reference,
  refdata = list(
    celltype.l1 = "celltype.l1",
    celltype.l2 = "celltype.l2",
    predicted_ADT = "ADT"
  ),
  reference.reduction = "pca", 
  reduction.model = "wnn.umap"
)

p1 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()

p2 = DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

p1 + p2

```

# Save RDS of mapped cell types

```{r}

saveRDS(just_T_cells, "../saved_data/T_cells.rds")

DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", label = TRUE, label.size = 3 , repel = TRUE) + NoLegend()

just_T_cells@meta.data %>%
  group_by(predicted.celltype.l1, predicted.celltype.l2) %>%
  summarise(count = n()) %>%
  arrange(-count)

```

# Look for clusters with high Trm marker expression

```{r}

# Human TRM are typically associated with the expression of the surface markers CD69 and CD103 (ITGAE, integrin αE), maybe also CD49a (integrin α1, ITGA1)

VlnPlot(just_T_cells, features = c("ITGA1"), pt.size = 0)

# CD69
# 7, 17, 22, 23, 28 
# ITGAE/CD103
# 0, 1, 3, 4, 8, 14, 18, 21, 23, 26, 28, 29, 31
# ITGA1/CD49a
# 0, 1, 3, 4, 8, 14, 18, 21

# 0, 1, 3, 4, 8, 14, 18, 21, 23, 28 seem to appear high in >= 2 of these 3 markers

```

# Remake UMAPs with new Trm cell types

```{r}

t_cell_metadata <- just_T_cells@meta.data %>%
  mutate(predicted.celltype.l2 = if_else(seurat_clusters %in% c(0, 1, 3, 4, 7, 8, 14, 18, 21, 23, 28) & predicted.celltype.l1 == "CD4 T", "CD4 Trm", if_else(seurat_clusters %in% c(0, 1, 3, 4, 7, 8, 14, 18, 21, 23, 28) & predicted.celltype.l1 == "CD8 T", "CD8 Trm", predicted.celltype.l2)))

t_cell_metadata

just_T_cells$predicted.celltype.l2 <- t_cell_metadata$predicted.celltype.l2

p1 <- DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l1", shuffle = TRUE, seed = 728, label = TRUE, repel = TRUE) + NoLegend()

p2 <- DimPlot(just_T_cells, reduction = "umap", group.by = "predicted.celltype.l2", shuffle = TRUE, seed = 728, label = TRUE, repel = TRUE) + NoLegend()

p1 + p2

```

# Make UMAP colored by patient ID just for T cells

```{r}

plot <- DimPlot(just_T_cells, reduction = "umap", group.by = "orig.ident", shuffle = TRUE, seed = 400) + theme(legend.position="none")

plot

```

# Bring in irAE group into metadata for Seurat object

```{r}

just_T_cells <- readRDS("../saved_data/T_cells_with_irae_groups.rds")

```

# Look for EOMES, TIGIT+KLRG1+ signatures by irAE group within CD8s

```{r}

non_naive_cd8s <- subset(just_T_cells, subset = predicted.celltype.l1 == "CD8 T" & predicted.celltype.l2 %in% c("CD8 TEM", "CD8 TCM", "CD8 Proliferating"))

VlnPlot(non_naive_cd8s, features = c("TIGIT", "KLRG1", "EOMES"), group.by = "group", pt.size = 0)

```