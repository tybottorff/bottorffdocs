---
title: "Molly Fisher Thomas colitis data"
output: pdf_document
---

 - data mining of https://villani.mgh.harvard.edu/ircolitis/
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Matrix)
library(ggplot2)
library(dplyr)
library(stringr)
library(scales)
library(tidyr)
library(ComplexHeatmap)
library(viridis)
library(readxl)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in data

```{r}

flow_data <- read_excel("../raw_data/holly_flow_data.xlsx") %>%
  select(`Subject ID`, `General irAE Classification 9-8-24`, `Cell population`, `Cell Frequency`) %>%
  rename(patient_id = `Subject ID`, group = `General irAE Classification 9-8-24`, sort = `Cell population`, freq = `Cell Frequency`) %>%
  mutate(group = case_when(
    group == "Autoimmune" ~ "AID",
    group == "Healthy" ~ "HC",
    TRUE ~ group
  )) %>%
  # remove 71 NAs of patient ID (all AID group)
  filter(!(is.na(patient_id)),
         freq > 0) %>%
  mutate(parent_population = gsub(".*_of_", "", sort),
         parent_population = gsub("_", " ", parent_population),
         sort = gsub("pct_", "", sort),
         sort = gsub("_", " ", sort),
         log10_freq = log10(freq),
         parent_parent_population = str_extract(parent_population, "[^ ]+$")) %>%
  arrange(parent_parent_population)

flow_data

```

# Stats tests

```{r}

stats_test <- flow_data %>%
  mutate(simpler_group = case_when(
    group %in% c("non-irAE", "irAE/SAE") ~ "Cancer",
    group == "HC" ~ "HC",
    group == "AID" ~ "AID")) %>%
  filter(group %in% c("HC", "irAE/SAE")) %>%
  group_by(sort) %>%
  summarize(pval = wilcox.test(freq[group == "irAE/SAE"], freq[group == "HC"], paired = FALSE, exact = FALSE)$p.value) %>%
  mutate(adj_pval = p.adjust(pval, method = "BH")) %>%
  arrange(adj_pval)

# there are some subsets w/ different freqs in cancer (cancer vs. HC), 0.01 < p < 0.05
# CD38hiCD127neg of NN CD8 Tcells
# Treg of CD4 Tcells
# so make a heatmap with 3 groups (irae, no irae, HC) with these 2 split off?

# no subsets w/ different freqs in irAE vs. no irAE

# many subsets w/ different freqs in cancer vs. AID
# p < 0.01
# Treg of CD4 Tcells, naive of CD8 Tcells, Tcells of nonGrans, NKcells of nonGrans, Tfh of NN Tconv Tcells, CXCR3pos of NN CD8 Tcells	
# 0.01 < p < 0.05
# CD11cpos of Bcells, MAIT of NN CD8 Tcells, naive of Treg Tcells, CRTH2pos of NN CD8 Tcells, unswMem of Bcells, Bcells of nonGrans, CCR4pos of NN Tconv Tcells	
# so make heatmap with 3 groups (irae, no irae, AID) with these groups split off?

# HC vs. AID: no subset freq differences

# irAE vs. AID 0.01 < p < 0.05
# CD11cpos of Bcells, NKcells of nonGrans, Tcells of nonGrans, Tfh of NN Tconv Tcells, Tfh of NN Tconv Tcells, naive of CD8 Tcells, unswMem of Bcells, Bcells of nonGrans, CXCR3pos of NN CD8 Tcells, naive of Treg Tcells, DN of Bcells

# non-irAE vs. AID
# p < 0.001
# Treg of CD4 Tcells
# 0.001 < p < 0.01
# naive of CD8 Tcells, CCR4pos of NN Tconv Tcells, CRTH2pos of NN CD8 Tcells	
# 0.01 < p < 0.05
# ICOSpos of Tfh Tconv Tcells, CRTH2pos of NN Tconv Tcells, SCM of Tconv Tcells, EMRA of CD8 Tcells, KLRG1posTIGITpos of CD8 Tcells, Tcells of nonGrans	

# non-irAE vs. HC
# 0.01 < p < 0.05
# CRTH2pos of NN Tconv Tcells, Treg of CD4 Tcells, CD38hiCD127neg of NN CD8 Tcells, CRTH2pos of NN CD8 Tcells, SCM of Tconv Tcells

# irAE vs. HC: none

stats_test

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for HC vs. cancer

```{r}

flow_data_filtered <- flow_data %>%
  filter(group != "AID")

# Define the order of groups
group_order <- c("HC", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("HC" = "black", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (HC vs. cancer, 2)
sig_list <- c("CD38hiCD127neg of NN CD8 Tcells", "Treg of CD4 Tcells")

# Create a dataframe for sorting rows based on if significant for HC vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(69, 2)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nHC vs. cancer", "Significant HC\nvs. cancer"), row.subsections))
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_HC_vs_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for AID vs. cancer

```{r}

flow_data_filtered <- flow_data %>%
  filter(group != "HC")

# Define the order of groups
group_order <- c("AID", "irAE/SAE", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID" = "blue", "irAE/SAE" = "red", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. cancer, 13)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "Tcells of nonGrans", "NKcells of nonGrans", "Tfh of NN Tconv Tcells", "CXCR3pos of NN CD8 Tcells", "CD11cpos of Bcells", "MAIT of NN CD8 Tcells", "naive of Treg Tcells", "CRTH2pos of NN CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CCR4pos of NN Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. cancer
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(58, 13)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. cancer", "Significant AID\nvs. cancer"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_AID_vs_cancer.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for irAE vs. AID

```{r}

flow_data_filtered <- flow_data %>%
  filter(group %in% c("AID", "irAE/SAE"))

# Define the order of groups
group_order <- c("AID", "irAE/SAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID" = "blue", "irAE/SAE" = "red")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. irAE/SAE, 11)
sig_list <- c("CD11cpos of Bcells", "NKcells of nonGrans", "Tcells of nonGrans", "Tfh of NN Tconv Tcells", "Tfh of NN Tconv Tcells", "naive of CD8 Tcells", "unswMem of Bcells", "Bcells of nonGrans", "CXCR3pos of NN CD8 Tcells", "naive of Treg Tcells", "DN of Bcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(60, 11)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. irAE", "Significant AID\nvs. irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_AID_vs_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. AID

```{r}

flow_data_filtered <- flow_data %>%
  filter(group %in% c("AID", "non-irAE"))

# Define the order of groups
group_order <- c("AID", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("AID" = "blue", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (AID vs. non-irAE, 10)
sig_list <- c("Treg of CD4 Tcells", "naive of CD8 Tcells", "CCR4pos of NN Tconv Tcells", "CRTH2pos of NN CD8 Tcells", "ICOSpos of Tfh Tconv Tcells", "CRTH2pos of NN Tconv Tcells", "SCM of Tconv Tcells", "EMRA of CD8 Tcells", "KLRG1posTIGITpos of CD8 Tcells", "Tcells of nonGrans")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(61, 10)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nAID vs. non-irAE", "Significant AID\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_AID_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```

# Heatmap (using Z scores of freqs in subsets across patients) for significant hits for non-irAE vs. HC

```{r}

flow_data_filtered <- flow_data %>%
  filter(group %in% c("HC", "non-irAE"))

# Define the order of groups
group_order <- c("HC", "non-irAE")

# Reorder the patient_group factor by group
flow_data_filtered$group <- factor(flow_data_filtered$group, levels = group_order)

# Recreate the patient_group column to reflect the new order
flow_data_filtered$patient_group <- paste(flow_data_filtered$patient_id, flow_data_filtered$group, sep = "_")

# Reshape the data to wide format (rows: sort, cols: patient_id + group)
heatmap_data <- reshape2::dcast(flow_data_filtered, sort ~ patient_group, value.var = "freq")

# Convert to matrix format for the heatmap
mat <- as.matrix(heatmap_data[, -1])
rownames(mat) <- heatmap_data$sort

# Compute Z-scores for the matrix
mat_z <- t(scale(t(mat)))  # Scale (across rows)

# Extract patient ID and group from column names
col_names <- colnames(mat)
patient_ids <- sub("_(.*)", "", col_names)  # Extract patient ID
groups <- sub("^[^_]*_", "", col_names)     # Extract group

# Create a dataframe for sorting columns
col_info <- data.frame(
  patient_id = patient_ids,
  group = factor(groups, levels = group_order),
  col_name = col_names
)

# Order by group first and then by patient ID
sorted_col_info <- col_info %>%
  arrange(group, patient_id)

# Reorder the matrix based on sorted columns
sorted_columns <- sorted_col_info$col_name
mat_z <- mat_z[, sorted_columns]

# Create column annotations
col_annotations <- data.frame(Group = sorted_col_info$group)

# Define colors for column annotations
annotation_colors <- list(
  Group = c("HC" = "black", "non-irAE" = "green")
)

# Create HeatmapAnnotation for columns
col_anno <- HeatmapAnnotation(
  Group = col_annotations$Group,
  col = annotation_colors
)

# significant populations (HC vs. non-irAE, 5)
sig_list <- c("CRTH2pos of NN Tconv Tcells", "Treg of CD4 Tcells", "CD38hiCD127neg of NN CD8 Tcells", "CRTH2pos of NN CD8 Tcells", "SCM of Tconv Tcells")

# Create a dataframe for sorting rows based on if significant for AID vs. irAE/SAE
row_info <- data.frame(
  sort = rownames(mat_z),
  parent_pop = gsub(".* of ", "", rownames(mat))
) %>%
  mutate(special = if_else(sort %in% sig_list, "Yes", "No"),
        # Trim leading/trailing spaces and standardize capitalization
        parent_pop = trimws(parent_pop),
        parent_pop = tolower(parent_pop)) %>%
  # Reorder rows based on if in significant list above + parent pop
  arrange(special, parent_pop)

sorted_rows <- row_info$sort
mat_z <- mat_z[match(sorted_rows, rownames(mat_z)), ]

# Create row annotations
row_annotations <- data.frame(ParentPop = row_info$parent_pop)

# Alphabetize the unique parent_pop values
sorted_parent_pops <- sort(unique(row_info$parent_pop))

# Define Viridis colors for the alphabetized parent_pop values
viridis_colors <- viridis::viridis(length(sorted_parent_pops))

# Map colors to alphabetized ParentPop values
row_annotation_colors <- setNames(viridis_colors, sorted_parent_pops)

# Ensure ParentPop factor levels are ordered alphabetically
row_annotations$ParentPop <- factor(row_annotations$ParentPop, levels = sorted_parent_pops)

# Create HeatmapAnnotation for rows
row_anno <- rowAnnotation(
  ParentPop = row_annotations$ParentPop,
  col = list(ParentPop = row_annotation_colors)
)

row.subsections <- c(66, 5)

# Plot the heatmap
heatmap_obj <- Heatmap(
  mat_z,
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  row_names_gp = gpar(fontsize = 8),  # Adjust font size if needed
  top_annotation = col_anno,  # Annotation for columns
  right_annotation = row_anno,  # Annotation for rows
  col = colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
  show_row_names = TRUE,
  show_column_names = FALSE,
  heatmap_legend_param = list(title = "Z-score"),
  row_split = data.frame(rep(c("Not significant\nHC vs. non-irAE", "Significant HC\nvs. non-irAE"), row.subsections)),
  border = FALSE  # remove borders between splits
)

# Save the heatmap to a PDF file
pdf(file = "../saved_data/holly_wip_heatmap_z_scores_HC_vs_non_irAE.pdf", width = 10, height = 8)  # Adjust width and height as needed
draw(heatmap_obj)  # Render the heatmap
dev.off()  # Close the PDF device

```