---
title: "Pgen score generation for Peter"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(ggpubr)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Read in TCR-seq data (no nt seq), make unique identifier

```{r}

peter_tcr <- read.csv("../raw_data/pgen_for_Peter_Table_S2_Compiled_and_filtered_TCR_sequences_used_in_this_study.csv") %>%
  mutate(TCR_name = paste(libid, v_gene, j_gene, junction, sep = "_")) %>%
  group_by(TCR_name) %>%
  mutate(row_id = row_number()) %>%
  ungroup() %>%
  mutate(TCR_name = paste(TCR_name, "_", row_id, sep = "")) %>%
  select(-row_id)

peter_tcr

```

# Prep stitchr dfs, there are 33 rows of delta/gamma v/j genes, not sure how to stitch...

```{r}

stitchr_alpha_data <- peter_tcr %>%
  filter(grepl("^TRA", v_gene) & grepl("^TRA", j_gene)) %>%
  dplyr::rename(TRAV = v_gene, TRAJ = j_gene, TRA_CDR3 = junction) %>%
  mutate(TRAC = NA,
         TRBV = NA,
         TRBJ = NA,
         TRB_CDR3 = NA,
         TRBC = NA,
         TRA_leader = NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC, TRA_leader, TRB_leader, Linker, Link_order, TRA_5_prime_seq, TRA_3_prime_seq, TRB_5_prime_seq, TRB_3_prime_seq)

stitchr_alpha_data

# 3,960 rows

write.table(stitchr_alpha_data, file = "../saved_data/tcrseq_tra_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE, na = "")

stitchr_beta_data <- peter_tcr %>%
  filter(grepl("^TRB", v_gene) & grepl("^TRB", j_gene)) %>%
  dplyr::rename(TRBV = v_gene, TRBJ = j_gene, TRB_CDR3 = junction) %>%
  mutate(TRBC = NA,
         TRAV = NA,
         TRAJ = NA,
         TRA_CDR3 = NA,
         TRAC = NA,
         TRA_leader = NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC, TRA_leader, TRB_leader, Linker, Link_order, TRA_5_prime_seq, TRA_3_prime_seq, TRB_5_prime_seq, TRB_3_prime_seq)

stitchr_beta_data

# 3,734 rows

write.table(stitchr_beta_data, file = "../saved_data/tcrseq_trb_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE, na = "")

```

# Read in stitchr output, 634 failed to stitch (621 have error "(TRA) Error: a LEADER sequence region has not been found for gene in the IMGT data for this chain/species. Please check your TCR and species data. Cannot stitch a sequence for TRA")

```{r}

stitchr_alpha_output <- read.delim("../saved_data/stitchr_tra_out.tsv", header = TRUE, sep = "\t")

stitchr_beta_output <- read.delim("../saved_data/stitchr_trb_out.tsv", header = TRUE, sep = "\t")

stitchr_output <- stitchr_alpha_output %>%
  full_join(stitchr_beta_output, by = colnames(stitchr_alpha_output)) %>%
  filter(!(grepl("Cannot stitch", Warnings.Errors)))

stitchr_output

```

# Prep IGoR input

```{r}

stitchr_output_alpha_df <- stitchr_output %>%
  filter(!(is.na(TRA_nt)),
         nchar(TRA_nt) > 1)

stitchr_output_alpha_df
# 3,335 rows

write.csv(stitchr_output_alpha_df, file = "../saved_data/igor_alpha_input.csv", row.names = FALSE)

stitchr_output_beta_df <- stitchr_output %>%
  filter(!(is.na(TRB_nt)),
         nchar(TRB_nt) > 1)

stitchr_output_beta_df
# 3,725 rows

write.csv(stitchr_output_beta_df, file = "../saved_data/igor_beta_input.csv", row.names = FALSE)

```

# Read in IGoR output

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  left_join(peter_tcr, by = "TCR_name")

igor_alpha

# 139 NA pgen for alpha, 76 NA pgen for beta

igor_combined <- read.csv("../saved_data/igor_output_beta.csv") %>%
  left_join(peter_tcr, by = "TCR_name") %>%
  full_join(igor_alpha) %>%
  select(-TCR_name, -TRA_nt, -TRB_nt, -TRA_aa, -TRB_aa, -TRAV, -TRAJ, -TRA_CDR3, -TRBV, -TRBJ, -TRB_CDR3, -TRAC, -TRBC, -TRA_leader, -TRB_leader, -Linker, -Link_order, -TRA_5_prime_seq, -TRA_3_prime_seq, -TRB_5_prime_seq, -TRB_3_prime_seq, -Linked_nt, -Linked_aa, -Warnings.Errors)

igor_combined

write.csv(igor_combined, "../saved_data/Table_S2_Compiled_and_filtered_TCR_sequences_used_in_this_study_with_pgen.csv")

```

# Read in TCR-seq data (with nt seq), make unique identifier

```{r}

peter_tcr_with_nt <- read.csv("../raw_data/Table_S4_Compiled_and_filtered_TCR_sequences_used_in_this_study_w_nucleotide.csv") %>%
  mutate(TCR_name = paste(libid, v_gene, j_gene, junction, sep = "_")) %>%
  group_by(TCR_name) %>%
  mutate(row_id = row_number()) %>%
  ungroup() %>%
  mutate(TCR_name = paste(TCR_name, "_", row_id, sep = "")) %>%
  select(-row_id, -X)

peter_tcr_with_nt

```

# Prep IGoR input from data with TCRseq (not stitched)

 - these seqs are ~300 nt while stitched TCRs were longer (~800-900), if pgen different this may be why

```{r}

alpha_tcrs_with_nt <- peter_tcr_with_nt %>%
  filter(grepl("^TRA", v_gene) & grepl("^TRA", j_gene)) %>%
  select(TCR_name, full_nt_sequence)
  # placing nt seq at 2nd col to keep script same

alpha_tcrs_with_nt

# 5544 alpha TCRs

write.csv(alpha_tcrs_with_nt, file = "../saved_data/igor_alpha_input.csv", row.names = FALSE)

beta_tcrs_with_nt <- peter_tcr_with_nt %>%
  filter(grepl("^TRB", v_gene) & grepl("^TRB", j_gene)) %>%
  select(TCR_name, libid, full_nt_sequence)
  # placing nt seq at 3rd col to keep script same

beta_tcrs_with_nt

# 5244 beta TCRs

write.csv(beta_tcrs_with_nt, file = "../saved_data/igor_beta_input.csv", row.names = FALSE)

```

# Read in IGoR output from data with TCRseq (not stitched)

```{r}

igor_alpha_with_nt <- read.csv("../saved_data/igor_output_alpha_no_stitchr.csv") %>%
  left_join(peter_tcr_with_nt, by = c("TCR_name", "full_nt_sequence"))

igor_alpha_with_nt

# 294 NaN pgens for TRA

igor_combined_with_nt <- read.csv("../saved_data/igor_output_beta_no_stitchr.csv") %>%
  select(-libid) %>%
  left_join(peter_tcr_with_nt, by = c("TCR_name", "full_nt_sequence")) %>%
  full_join(igor_alpha_with_nt) %>%
  select(-TCR_name)

# 152 NaN pgens for TRA

igor_combined_with_nt

write.csv(igor_combined_with_nt, "../saved_data/Table_S4_Compiled_and_filtered_TCR_sequences_used_in_this_study_w_nucleotide_with_pgen.csv")

```

# Test correlation between +/- stitchr pgen

```{r}

both_igors <- igor_combined %>%
  dplyr::rename(pgen_stitched = pgen) %>%
  full_join(igor_combined_with_nt, by = c("v_gene", "j_gene", "junction", "libid", "project", "donor_id", "set", "study_group", "studyGroup")) %>%
  filter(!(is.na(pgen)),
         !(is.na(pgen_stitched)),
         pgen != "NaN",
         pgen_stitched != "NaN")

both_igors

ggplot(both_igors, aes(x = log10(pgen), y = log10(pgen_stitched))) +
  geom_point(alpha = 0.2) +
  labs(x = "log10(pgen, not stitched)", y = "log10(pgen, stitched)") +
  stat_cor(method = "pearson") +
  
  # Add the best-fit line with equation
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  annotate("text", x = 1.5, y = 3, label = "y = 1.1*x - 0.09", color = "red", hjust = 0.8)

# Perform linear regression
model <- lm(log10(pgen_stitched) ~ log10(pgen), data = both_igors)

# Get the coefficients
coefficients <- coef(model)

# Extract m (slope) and b (intercept)
m <- coefficients["log10(pgen)"]
b <- coefficients["(Intercept)"]

# Print the values of m and b
cat("Slope (m):", m, "\n")
cat("Intercept (b):", b, "\n")

```

# Calculate more pgen scores for Peter/Shubam (2025 summer)

```{r}

input_tcrs <- read.csv("../raw_data/shubham_vdjdb_tcrs.tsv", sep = "\t")

stitchr_alpha_data <- input_tcrs %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3) %>%
  mutate(TRAC = NA,
         TRBV = NA,
         TRBJ = NA,
         TRB_CDR3 = NA,
         TRBC = NA,
         TRA_leader = NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC, TRA_leader, TRB_leader, Linker, Link_order, TRA_5_prime_seq, TRA_3_prime_seq, TRB_5_prime_seq, TRB_3_prime_seq)

stitchr_alpha_data

write.table(stitchr_alpha_data, file = "../saved_data/tcrseq_tra_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE, na = "")

stitchr_beta_data <- input_tcrs %>%
  select(TCR_name, TRBV, TRBJ, TRB_CDR3) %>%
  mutate(TRBC = NA,
         TRAV = NA,
         TRAJ = NA,
         TRA_CDR3 = NA,
         TRAC = NA,
         TRA_leader = NA,
         TRB_leader = NA,
         Linker = NA,
         Link_order = NA,
         TRA_5_prime_seq = NA,
         TRA_3_prime_seq = NA,
         TRB_5_prime_seq = NA,
         TRB_3_prime_seq = NA) %>%
  select(TCR_name, TRAV, TRAJ, TRA_CDR3, TRBV, TRBJ, TRB_CDR3, TRAC, TRBC, TRA_leader, TRB_leader, Linker, Link_order, TRA_5_prime_seq, TRA_3_prime_seq, TRB_5_prime_seq, TRB_3_prime_seq)

stitchr_beta_data

write.table(stitchr_beta_data, file = "../saved_data/tcrseq_trb_for_stitchr.tsv", sep = "\t", quote = FALSE, row.names = FALSE, na = "")

# terminal commands
# thimble -i tcrseq_tra_for_stitchr.tsv -o stitchr_tra_out.tsv
# thimble -i tcrseq_trb_for_stitchr.tsv -o stitchr_trb_out.tsv

```

# Read in stitchr output

```{r}

stitchr_alpha_output <- read.delim("../saved_data/stitchr_tra_out.tsv", header = TRUE, sep = "\t")

stitchr_beta_output <- read.delim("../saved_data/stitchr_trb_out.tsv", header = TRUE, sep = "\t")

stitchr_output <- stitchr_alpha_output %>%
  full_join(stitchr_beta_output, by = colnames(stitchr_alpha_output)) %>%
  filter(!(grepl("Cannot stitch", Warnings.Errors)))

# this has duplicate rows for each TCR (one with TRA info, other with TRB's)

stitchr_output

# there are some errors, but they're rather rare (few thousand out of ~40k TCRs)

```

# Prep IGoR input

```{r}

stitchr_output_alpha_df <- stitchr_output %>%
  filter(!(is.na(TRA_nt)),
         nchar(TRA_nt) > 1)

stitchr_output_alpha_df

write.csv(stitchr_output_alpha_df, file = "../saved_data/igor_alpha_input.csv", row.names = FALSE)

stitchr_output_beta_df <- stitchr_output %>%
  filter(!(is.na(TRB_nt)),
         nchar(TRB_nt) > 1)

stitchr_output_beta_df

write.csv(stitchr_output_beta_df, file = "../saved_data/igor_beta_input.csv", row.names = FALSE)

```

# Read in IGoR output

```{r}

igor_alpha <- read.csv("../saved_data/igor_output_alpha.csv") %>%
  rename(TRA_pgen = pgen) %>%
  select(TCR_name, TRA_pgen)

igor_combined <- read.csv("../saved_data/igor_output_beta.csv") %>%
  rename(TRB_pgen = pgen) %>%
  select(TCR_name, TRB_pgen) %>%
  full_join(igor_alpha)

igor_combined

write.csv(igor_combined, file = "../saved_data/igor_output_combined.csv", row.names = FALSE)

```