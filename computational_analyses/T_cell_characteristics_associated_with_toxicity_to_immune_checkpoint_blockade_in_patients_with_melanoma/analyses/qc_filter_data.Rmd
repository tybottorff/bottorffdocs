---
title: "T cell characteristics associated with irAE from ICI in melanoma"
output: pdf_document
---

 - data reproduction of https://www.nature.com/articles/s41591-021-01623-z
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary libraries

```{r}

library(Seurat)
library(ggplot2)
library(dplyr)
library(readr)
library(readxl)

```

# Set theme

```{r}

theme_set(
  theme_bw(20) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_rect(colour="black", fill = NA, size = 1),
          axis.text = element_text(colour="black"),
          axis.ticks = element_line(colour="black"),
          axis.text.x = element_text(angle=0),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 7)))

```

# Import supplementary data

```{r}

supp_data_1 <- read_excel("../raw_data/41591_2021_1623_MOESM3_ESM.xlsx", sheet = "cleaned_table_s1")

supp_data_2 <- read_excel("../raw_data/41591_2021_1623_MOESM3_ESM.xlsx", sheet = "cleaned_table_s3") %>%
  mutate(`Highest irAE grade` = as.character(`Highest irAE grade`)) %>%
  rename(`ICI Regimen` = `ICI regimen`)

supp_data <- inner_join(supp_data_1, supp_data_2, by = c("Patient ID", "Cohort", "Prior ICI treatment", "Site of highest irAE grade", "Highest irAE grade", "ICI Regimen"))

supp_data <- supp_data %>%
  rename(`patient.ID` = `Patient ID`)

supp_data

```

# Process metadata

```{r}

batch_a_metadata <- read.table("../raw_data/GSE189125_5prime_scRNAseq_seqbatchA_metadata.txt", sep = "\t")

# rename columns with first row values
colnames(batch_a_metadata) <- batch_a_metadata[1, ]

# remove first row
batch_a_metadata <- batch_a_metadata[-1, ]

# Set row names from the values in the 'barcode' column
rownames(batch_a_metadata) <- batch_a_metadata$barcode

# Remove the 'barcode' column from the data frame, standardize patient ID naming
batch_a_metadata <- select(batch_a_metadata, -barcode) %>%
  rename(`patient.ID` = `patient ID`)

# make rownames from metadata match colnames from count data
rownames(batch_a_metadata) <- gsub("-", ".", rownames(batch_a_metadata))

# join with supplemental metadata
merged_batch_a_metadata <- left_join(batch_a_metadata, supp_data, by = "patient.ID") %>%
  # filter for scRNAseq data
  filter(`scRNA-seq` == 1)

# regenerate rownames lost in merging
rownames(merged_batch_a_metadata) <- rownames(batch_a_metadata)

batch_a_metadata

```

# Create a Seurat object for each scRNAseq batch

```{r}

batch_a <- CreateSeuratObject(counts = read.table("../raw_data/GSE189125_5prime_scRNAseq_seqbatchA_counts.txt", sep = ""), project = "batch_a", assay = "RNA", meta.data = merged_batch_a_metadata)

# batch_b doesn't have any scRNAseq data

```

# Calculate percent mitochondrial, ribosomal, hemoglobin features

```{r}

batch_a[["percent_mito"]] <- PercentageFeatureSet(batch_a, pattern = "^MT-")
batch_a[["percent_ribo"]] <- PercentageFeatureSet(batch_a, pattern = "^RP[SL]")
batch_a[["percent_hb"]] <- PercentageFeatureSet(batch_a, pattern = "HB[^(P)]")

```

# Count number of cells from all samples

```{r}

length(colnames(batch_a)) # 24087 cells

```

# Count cells per each of the 13 samples

```{r}

cell_capture <- batch_a@meta.data %>%
  group_by(patient.ID) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Visualize QC metrics across all patient samples

```{r}

vln_plot <- VlnPlot(batch_a, features = c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo"), ncol = 4, pt.size=0)

vln_plot

ggsave(vln_plot, file = "../figures/vln_plot_qc.svg")

```

# Set author QC metric thresholds

```{r}

qcMetricsThresholds <-
  c(
    "nFeature_RNA_min" = 100,
    
    "nFeature_RNA_max_1" = 1500,
    # YUCARD, YUENZO, YUFUB, YUPIXEL, YUTAUR, YUTHEA, YUVARDO
    
    "nFeature_RNA_max_2" = 2000,
    # YUGRUS
    
    "nFeature_RNA_max_3" = 3000,
    # YUFURL, YUHERN, YUROD, YUTORY
    
    "percent_mito" = 25
  )

# Author statement on methods: "Outlier cells were identified and removed based on the following criteria: (1) >25% mitochondrial content or (2) cells with less than 100 or greater than 1,500â€“3,000 expressed genes, depending on sample-level distributions"

# they didn't mention a percent_hb cutoff but one sample has rather high percent_hb

```

# Plot distributions of nFeature_RNA across samples with nFeature_RNA_max cutoff of 1500

```{r}

nFeature_RNA_QC <- ggplot(batch_a@meta.data %>% filter(batch_a_metadata$patient.ID %in% c("YUCARD", "YUENZO", "YUFUB", "YUPIXEL", "YUTAUR", "YUTHEA", "YUVARDO","YUKEND")), mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_max_1"],
             color = "red", linetype = "dashed")
ggsave(nFeature_RNA_QC, file = "../figures/nFeature_RNA_1.svg")

nFeature_RNA_QC

```

# Plot distributions of nFeature_RNA across samples with nFeature_RNA_max cutoff of 2000

```{r}

nFeature_RNA_QC <- ggplot(batch_a@meta.data %>% filter(batch_a_metadata$patient.ID %in% c("YUGRUS")), mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_max_2"],
             color = "red", linetype = "dashed")
ggsave(nFeature_RNA_QC, file = "../figures/nFeature_RNA_2.svg")

nFeature_RNA_QC

```

# Plot distributions of nFeature_RNA across samples with nFeature_RNA_max cutoff of 3000

```{r}

nFeature_RNA_QC <- ggplot(batch_a@meta.data %>% filter(batch_a_metadata$patient.ID %in% c("YUFURL", "YUHERN", "YUROD", "YUTORY")), mapping = aes(x = nFeature_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_min"],
             color = "red", linetype = "dashed") +
  geom_vline(xintercept = qcMetricsThresholds["nFeature_RNA_max_3"],
             color = "red", linetype = "dashed")
ggsave(nFeature_RNA_QC, file = "../figures/nFeature_RNA_3.svg")

nFeature_RNA_QC

```

# Plot distributions of nCount_RNA across samples

```{r}

nCount_RNA_QC <- ggplot(batch_a@meta.data, mapping = aes(x = nCount_RNA)) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10()
ggsave(nCount_RNA_QC, file = "../figures/nCount_RNA.svg")

nCount_RNA_QC

```

# Plot distributions of percent mito across samples

```{r}

percent_mt_QC <- ggplot(batch_a@meta.data, mapping = aes(x = percent_mito + 1/length(colnames(batch_a)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  geom_vline(xintercept = qcMetricsThresholds["percent_mito"],
             color = "red", linetype = "dashed") +
  xlab("percent_mito (with pseudocount)")
ggsave(percent_mt_QC, file = "../figures/percent_mt.svg")

percent_mt_QC

```

# Plot distributions of percent ribo across samples

```{r}

percent_rb_QC <- ggplot(batch_a@meta.data, mapping = aes(x = percent_ribo + 1/length(colnames(batch_a)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  xlab("percent_ribo (with pseudocount)")
ggsave(percent_rb_QC, file = "../figures/percent_rb.svg")

percent_rb_QC

```

# Plot distributions of percent hemoglobin across samples

```{r}

percent_hb_QC <- ggplot(batch_a@meta.data, mapping = aes(x = percent_hb + 1/length(colnames(batch_a)))) +
  geom_density(mapping = aes(color = patient.ID), size = 0.5) +
  scale_x_log10() +
  xlab("percent_hb (with pseudocount)")

ggsave(percent_hb_QC, file = "../figures/percent_hb.svg")

percent_hb_QC

# authors didn't mention cutoff for this

```

# Split Seurat object based on samples to perform sample-specific QC filtering

```{r}

batch_a_1 <- subset(batch_a, subset = patient.ID %in% c("YUCARD", "YUENZO", "YUFUB", "YUPIXEL", "YUTAUR", "YUTHEA", "YUVARDO", "YUKEND"))

length(colnames(batch_a_1))

batch_a_2 <- subset(batch_a, subset = patient.ID %in% c("YUGRUS"))

length(colnames(batch_a_2))

batch_a_3 <- subset(batch_a, subset = patient.ID %in% c("YUFURL", "YUHERN", "YUROD", "YUTORY"))

length(colnames(batch_a_3))

```

# Test a more systematic way of setting sample-specifc nFeature_RNA_max thresholds

```{r}

# < 3 median absolute deviations (MADs) away from the median in any of the variables we use for QC

df <- as_tibble(batch_a_1$nFeature_RNA)

median_value <- median(df$value)

mad_value <- mad(df$value)

print(median_value + 3*mad_value)

# for batch_a_1 and batch_a_2, this median + 3*mad value is < 1500, so I'll just stick with 1500 (smallest author max cutoff)

```

# Filter first group of cells based on sample-specific QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    batch_a_1, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      batch_a_1, expression = nFeature_RNA <= qcMetricsThresholds["nFeature_RNA_max_1"])) %>%
  intersect(
    WhichCells(
      batch_a_1, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(batch_a_1), cellsKeep)
length(cellsDrop) # 0 cells dropped from analysis

# X cells dropped due to nFeature_RNA threshold
cellsDropped_nFeature <- sum(
  batch_a_1$nFeature_RNA < qcMetricsThresholds["nFeature_RNA_max_1"]
)

# X cells dropped due to percent_mito threshold
cellsDropped_percentMito <- sum(
  batch_a_1$percent_mito > qcMetricsThresholds["percent_mito"]
)

batch_a_1_filtered <-
  subset(batch_a_1, cells = cellsKeep)

length(colnames(batch_a_1_filtered)) # 19346 cells left behind in filtered data

```

# Filter second group of cells based on sample-specific QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    batch_a_2, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      batch_a_2, expression = nFeature_RNA <= qcMetricsThresholds["nFeature_RNA_max_2"])) %>%
  intersect(
    WhichCells(
      batch_a_2, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(batch_a_2), cellsKeep)
length(cellsDrop) # 0 cells dropped from analysis

# X cells dropped due to nFeature_RNA threshold
cellsDropped_nFeature <- sum(
  batch_a_2$nFeature_RNA < qcMetricsThresholds["nFeature_RNA_max_1"]
)

# X cells dropped due to percent_mito threshold
cellsDropped_percentMito <- sum(
  batch_a_2$percent_mito > qcMetricsThresholds["percent_mito"]
)

batch_a_2_filtered <-
  subset(batch_a_2, cells = cellsKeep)

length(colnames(batch_a_2_filtered)) # 1713 cells left behind in filtered data

```

# Filter third group of cells based on sample-specific QC metrics, track how many drop out

```{r}

cellsKeep <-
  WhichCells(
    batch_a_3, expression = nFeature_RNA >= qcMetricsThresholds["nFeature_RNA_min"]) %>%
  intersect(
    WhichCells(
      batch_a_3, expression = nFeature_RNA <= qcMetricsThresholds["nFeature_RNA_max_3"])) %>%
  intersect(
    WhichCells(
      batch_a_3, expression = percent_mito <= qcMetricsThresholds["percent_mito"]))
cellsDrop <-
  setdiff(colnames(batch_a_3), cellsKeep)
length(cellsDrop) # 0 cells dropped from analysis

# 0 cells dropped due to nFeature_RNA threshold
cellsDropped_nFeature <- sum(
  batch_a_3$nFeature_RNA < qcMetricsThresholds["nFeature_RNA_max_1"]
)

# 0 cells dropped due to percent_mito threshold
cellsDropped_percentMito <- sum(
  batch_a_3$percent_mito > qcMetricsThresholds["percent_mito"]
)

batch_a_3_filtered <-
  subset(batch_a_3, cells = cellsKeep)

length(colnames(batch_a_3_filtered)) # 3748 cells left behind in filtered data

```

# Rejoin cells

```{r}

batch_a_filtered <- merge(x = batch_a_1_filtered, y = list(batch_a_2_filtered, batch_a_3_filtered))

```

# Count cells after QC filtering

```{r}

cell_capture <- batch_a_filtered@meta.data %>%
  group_by(orig.ident) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Count cells per sample after QC filtering

```{r}

cell_capture <- batch_a_filtered@meta.data %>%
  group_by(patient.ID) %>%
  dplyr::count()

cell_capture %>% arrange(n)

```

# Save the resulting QC filtered Seurat object

```{r}

saveRDS(batch_a_filtered, file="../saved_data/batch_a_filtered.rds")

```